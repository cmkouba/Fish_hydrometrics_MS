---
title: A watershed-specific formula to predict salmon reproduction using functional flow metrics
author: "Claire Kouba, Jason Wiener, Leland Scantlebury and Thomas Harter"
date: "Feb. 2025"
output: 
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
bibliography: draft_library.bib
---

```{r setup_dirs_load_data, include = FALSE}


knitr::opts_chunk$set(echo = TRUE)


library(lubridate)
library(httr)
library(ggplot2) # for barplots 
library(gridExtra)
library(corrplot)  # for data exploration/correlation plots
library(dataRetrieval) # for usgs data
library(data.table) #month function
library(zoo) # rolling means
library(sf)
library(terra)
library(tmap)
library(grid) # for inset maps
library(cowplot) # for inset maps
library(ggthemes) # for colorblind palette
library(flextable)
library(glmnet) # lasso regression
library(MARSS)
library(here)

# Directories
ms_dir = here::here()
scratch_dir = file.path(ms_dir, "scratch_work")
data_dir = file.path(ms_dir, "Data")
graphics_dir = file.path(ms_dir, "Graphics and Supplements")

# Load spatial and tabular data

# If the data files don't exist locally,
# pull data from internet and local files
if(!file.exists(file.path(ms_dir,"manuscript_data.RData"))){
  source(file.path(ms_dir,"01_DataRetrieval_Cleaning_SaveLocal.R")) 
}
load(file.path(ms_dir, "manuscript_data.RData")) # Load data layers/tables
source(file.path(ms_dir,"02_Figure_Functions.R"))   # Load figure and table functions

#Append supplement?
INCLUDE_SUPP = F
# Save figures as images, yes or no?
save_figs_here = graphics_dir
save_imgs=T # generate the figures in the folder
include_figs = T
replace_setting_fig = F# setting to F can save time if no need to re-render map
fig_i = 1

# pick last water year for the HB function to calculate a value for
last_wy = 2023
```

```{r load_FF_metrics, include = FALSE}
fflows = read_fflows_FJ(calculator = "Flashy")
# fflows = read_fflows_FJ(calculator = "Regular")
# data transformations
log_transform_eco_metrics = T
zscore_flow_metrics = T

```


```{r select_eco_metric_3, echo = F, warning =F, comment = F}

  # Based on the need for a normalized metric, going to select the juvenile per adult metric.
  # y_val_chinook = "chinook_juv_per_adult"
  # y_val_coho = "coho_smolt_per_fem"
y_val_chinook = "chinook_juvenile_abundance"
y_val_coho = "coho_smolt_abun_est"

# MAKE SURE y-axis label matches y-value name in plotting script on line ~1203

```

# Abstract {-}

In many rural areas of arid and semi-arid regions, balancing agricultural and environmental water needs is a key challenge facing resource managers. This is complicated  by the tendency for the water needs of cultivated crops to be better understood than those of aquatic ecosystems. In particular, the timing and magnitude of flow needed to sustain key ecological functions remain poorly quantified in many regions. This work aims to quantify hydrologic conditions that support persistence of key ecosystem species using a functional flows framework. We use the coho (*Oncorhynchus kisutch*) and Chinook (*Oncorhynchus tshawytscha*) salmon run in Scott Valley, a 2,109 km^2^ undammed rural watershed in northern California, USA, as a case study.

Taking advantage of a nearly two-decade ecological monitoring dataset and long-term stream gauge measurements, we used lasso regression to build predictive models of coho and Chinook salmon reproductive success based on hydrologic metrics. To control for cohort effects, we chose normalized ecological response metrics for coho and Chinook (number of outmigrating smolt per spawning adult or spawning adult female). For both species, we calculated optimal prediction models using a cross-validation bootstrapping approach to resample and test on unsampled observations. Lambda values, a key fitting parameter in the lasso models, were selected based on an **average relative test error threshold of 1.0.** Selected lambda values were used to calculate a final predictive model, or Hydrologic Benefit function, using the full dataset for each species. Hydrology could explain a greater degree of variance in relative coho reproduction than in Chinook. The hydrologic metrics that explain the greatest variance in coho reproduction values occur during the window of their parents' spawning and, to a lesser extent, in the spring and fall of their year of rearing in freshwater. This supports an interpretation that spawning conditions may exert a significant influence on the mortality rates of the hatching juveniles.

Robustness of the results indicate that this method for empirically deriving hydrologic metrics with the highest ecological benefit for a threatened species may be useful in other watersheds, where sufficient ecological data records are available, to evaluate trade-offs and support water management decisions in human-altered novel ecosystems. 

\newpage

# Practitioner points {-}

1. Eco metrics correlation
2. Hydrology could explain a greater degree of variance in relative coho reproduction than in Chinook. 
3. The hydrologic metrics that explain the greatest variance in coho reproduction values occur during the window of their parents' spawning and, to a lesser extent, in the spring and fall of their year of rearing in freshwater. This supports an interpretation that spawning conditions may exert a significant influence on the mortality rates of the hatching juveniles.

\newpage

# Introduction


## Motivation and objectives 

Reconciliation ecology posits that some human-impacted ecosystems should be considered irrevocably-altered, "novel" systems [@MoyleNOVEL2014], with their own specific management concerns. To implement this philosophy, rather than working to restore novel ecosystems to pre-human conditions, a natural resource manager would actively manage biodiversity in human-altered landscapes as a co-equal goal with extracting and cultivating natural resources to provide for human material needs [e.g., @RobertsonSwintonReconciling2005; @ArthingtonEtAlTEMPORARY2014; @AcremanEtAlEnvironmental2014; @YarnellEtAlFunctional2015]. However, in many river ecosystems, though general methods to characterize environmental flows have been in wide use for at least a decade [e.g., @PoffZimmermanEcological2010; @ShentonEtAlPutting2012; @SolansGarciaDeJalonBasic2016], the regional-scale conditions that would maintain biodiversity are as yet unquantified or highly uncertain [@PoffEtAlEcological2010; @BarbourEtAlOptimisation]. Higher certainty in quantitative ecological targets could support more robust decision making and trade-off analysis, potentially answering questions like: how close can managers get to the desired ecological conditions, and at what cost, particularly in a changing climate?

In practice, these questions are often asked and answered locally [@TarlockLocal1993]. Reflecting this reality, the authors of this study have posed research questions tailored to conserving two specific salmon species, the threatened coho salmon (*Oncorhynchus kisutch*) and the less-threatened Chinook salmon (*Onchorhynchus tshawytscha*), in a specific study area: the Scott River watershed in northern California, USA. In this undammed, rural watershed, water use is primarily managed by managing land use. Balancing the competing water needs of fish and farmers is a key challenge for local water managers [@SiskiyouCountyScott2021]. Agricultural water needs are well-known and can be estimated and scheduled [@SiskiyouResourceConservationDistrictScott1994; @ParryEvaluation2013; CDFW -@CaliforniaDepartmentofWaterResourcesAgricultural2021], but, in spite of decades of investigation by local, state and federal actors [e.g., SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilSiskiyouResourceConservationDistrictScott2003; NMFS -@NationalMarineFisheriesServiceFinal2014; CDFW et al. -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015; CDFW -@CaliforniaDepartmentofFishandWildlifeScott2021], the ecological water needs in this balancing act are not as well constrained. 

One method for estimating ecological water needs is the functional flows framework [@YarnellEtAlFunctional2015; @GranthamEtAl2020Making] [@PoffEtAlNatural1997; @PoffEtAlEcological2010]. Functional flow metrics (hydrologic metrics) are used to quantify potential ecological services provided by river flow in terms of flowrate amplitude, timing, frequency, and duration in distinct seasons of a water year, where water year is here defined to begin on October 1 of the year preceding the calendar year of the same number (i.e., water year 2020 begins on October 1, 2019). Recent work has refined these metrics specific to California hydrology [@SteinEtAl2021California] and made the metric-calculating algorithms publicly available [@YarnellEtAlFunctional2020; @PattersonEtAlHydrologic2020].

In this study we examine correlations between several dozen hydrologic metrics and local salmon observations to determine the potential to empirically quantify a hydrologic regime that meets the ecological needs of specific species (coho and Chinook salmon) in a specific ecological region (the Scott River watershed). Using lasso regression, hydrologic metrics (predictors) were selected that best explain variation in salmon outcomes. The result of the predictor selection was a Hydrologic Benefit function for each species, conceptually translating the various ecological services provided by hydrology across different seasons into a single value (in units of ecological observations) per water year. This work sets the stage for a quantitative comparison of competing natural resource management alternatives.

## History of flow-ecology relationships

[@TharmeGlobal2003]
[@HorneEtAlOptimization2016]
[@JagerThinking2014]
[@JagerRoseDesigning2003]
[@TharmeGlobal2003]
[@TurnerStewardsonHydrologic2014]

A river's flow regime is often referred to as a "master variable" controlling geomorphic, chemical, and other conditions in its aquatic ecosystems, and organisms that have evolved to persist in specific flow regimes are commonly negatively affected by flow alteration [@BunnArthingtonBasic2002; @PoffEtAlEcological2010]. Consequently, in recent decades a diverse body of research has sought to identify and quantify ecological responses to changes in flow. 

Work on this topic spans multiple categories of ecological response, hydrologic predictor, and ultimate cause of hydrologic alteration. Two widely studied ecological response metric categories are, firstly, the stream health index, based on density and species richness of macroinvertebrates observed at designated sampling sites [e.g., @MonkEtAlFlow2006; @GuareschiEtAlHow2014; @KevicEtAlEffects2018; @MazorEtAlTools2018; @LarsenEtAlCombining2021; @PeekEtAlIdentifying2022], and secondly, fish diversity and community assemblage [e.g., @McManamayEtAlApplication2013; @PetersonFreemanIntegrating2016; @CartwrightEtAlPutting2017; @SinnathambyEtAlEcohydrological2018; @HainEtAlUsing2018; @GuedesEtAlArtificial2020; @YaoEtAlIdentifying2021]. Ecological responses can also be based on the abundance of a single or a few species, often of fish [@Stewart-KosterEtAlFish2011; @BoothEtAlDetermining2014; @DeWeberPetersonComparing2020; @HaleEtAlMy2023], as well as the extent of habitat types [@ChowdhuryDriverEcohydrological2007; @ArrianaBrandEtAlProjecting2011] and the presence of organisms including vegetation and plankton [@RiisEtAlVegetation2008; @CatfordEtAlSpecies2014; @QianEtAlEffects2016; @TesfayeEtAlClimatic2017; @SabyEtAlSensitivity2022]. Hydrologic predictors range widely, with a heavy emphasis on extreme (low or high) flow events and the duration of components of the flow regime [e.g., @AyllonEtAlSpatiotemporal2014; @LamourouxOlivierTesting2015; @McManamayFrimpongHydrologic2015; @BowerEtAlQuantifying2022]. Causes of the change in hydrology include the operation of dams, changes in human water use, climate change, and natural flow variability [e.g., @AlomiaHerreraCarreraBurneoEnvironmental2017; @GaoEtAlHydrological2020; @WhiteEtAlMacroinvertebrate2018; @DaneshvarEtAlResponse2017; @HerbstEtAlDrought2019].

Investigations of flow-ecology relationships can also be grouped by approach [as in @BrummerEtAlQuantitative2016]. In experimental flow studies the flow is directly manipulated with dam releases and biological responses are monitored [e.g., @KonradEtAlLargescale2011]. In longitudinal studies, long-term ecological and hydrological records can be used to infer local or regional correlations [e.g., @Mellado-DiazEtAlExploring2019]. Finally, in space-for-time approaches, the hydrology of multiple river systems in a region is used to populate the distribution of different hydrologic behavior, and ecological monitoring is related to flow differences between streams [e.g., @MonkEtAlMacroinvertebrate2008; @RiisEtAlVegetation2008; @CatfordEtAlSpecies2014; @BowerEtAlQuantifying2022]. Space-for-time analyses require considerably fewer resources than experimental flows and longitudinal studies, and thus are more numerous [@BrummerEtAlQuantitative2016]. 

Bridging the gap between science and policy has been a persistent challenge in this field. In many cases a key research motivation is to support decision-making in a variety of contexts, including dam operation, river restoration, and regulations of water extraction and land use [@RichterEtAlCollaborative2006; @HanEtAlEcohydrological2015; @SinnathambyEtAlEcohydrological2018; @BradleyEtAlHydroecological2017; @BrummerEtAlQuantitative2016]. But historical approaches based on relationship-finding are several steps removed from the policy-making process [@WebbEtAlAdaptive2018]. For example, the Ecological Limits of Hydrologic Alteration (ELOHA) framework or similar approaches can generate flow-ecology relationships or flow standards for particular rivers, but cannot translate specific management decisions into hydrologic or ecological outcomes [@RichterEtAlCollaborative2006; @CartwrightEtAlPutting2017]. 

An ideal framework for supporting decision-making would involve two key steps, firstly connecting land and water management actions to flow changes, and secondly connecting flow changes to ecological responses [@PetersonFreemanIntegrating2016; @DeWeberPetersonComparing2020; @AceroTrianaEtAlAssessing2021]. Both steps can involve complex models and substantial uncertainty, often representing an interdisciplinary challenge. Threshold values for "sufficient" flows would be ideal for a management context [@RosenfeldDeveloping2017], but can be difficult to identify and in some cases may not exist [@LuedersMcManamaySpecies2023].  Additionally, identifying natural flow regimes may be less immediately relevant to water resource management than an approach which can quantify ecological responses to "designer" or functional flows (which can often be controlled or influenced by dam releases) [@ArthingtonEtAlTEMPORARY2014; @WebbEtAlAdaptive2018], with the caveat that the designer flows approach may risk overlooking ecological flow needs that are not currently monitored [@BowerEtAlQuantifying2022]. Finally, stakeholders in at least one study requested flow-ecology relationships based on empirical monitoring, rather than more easily-simulated proxies like flow changes or thermal exposure [@DeWeberPetersonComparing2020].

The present study is a longitudinal analysis, using empirical data and a case study, to address the second of the two key links identified above. We use empirical data to develop a predictive model of a biological response to measurable (and simulatable) changes in flow metrics. We refer to this model as a "hydrologic benefit function" (i.e., intending to quantify the ecological services provided by flow) for a single species. This provides the critical link to evaluate fish outcomes resulting from future alternative watershed management practices which affect the hydrology of a stream ecosystem. A forthcoming companion study will investigate the other link, simulating flow changes from watershed management actions using an appropriate hydrologic model, then use hydrologic benefit functions to summarize the ecologic outcomes of a portfolio of water and land use scenarios.

## Historical assessments of Scott River flow-ecology relationships

Flow-ecology relationships have been investigated in the Scott River Watershed, but the ideal framework described above has not been quantified. Over the past three decades, several organizations and agencies have conducted extensive monitoring and published a series of reports and plans regarding the salmon fisheries in the Scott River watershed. **Klamath run estimates** In the 1990s, fall flows in the Scott River were reported to be too low in some years to allow for Chinook spawning in September-November [CRMP and SRWC -@CoordinatedResourceManagementPlanningCommitteeScottRiverWatershedCouncilFINAL2000], but in the mid-2000s it was reported that low fall flows rarely affected the later (November-January) spawning runs of steelhead and coho salmon [SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilSiskiyouResourceConservationDistrictInitial2005]. More recently, fall flows have affected coho salmon as well as Chinook, as the late onset of winter storms has delayed coho spawning in some water years [e.g., CDFW -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015]. In the mid-2000s, a local conservation organization identified the lack of suitable summer and winter rearing habitat as a probable limitation on Scott River coho smolt production [SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilLimiting2005]. Several years later, in a NOAA Fisheries Coho Recovery Plan, NMFS identified the juvenile life stage as the most limited in the population [NMFS -@NationalMarineFisheriesServiceFinal2014]. **EDIT THIS PARAGRAPH TO REDUCE REDUNDANCY**


# Methods: Case study setting and species of concern

Exploring the empirical relationship between river hydrology and an ecological response requires both spatial and temporal overlap in a study area's hydrologic and ecological monitoring data. 

These requirements are met to some degree in Scott Valley, though as is typical, ecological data is the limiting factor. Hydrologic data is provided by daily river flow monitoring, which has been ongoing since the 1940s at the USGS stream gauge downstream of the town of Fort Jones (Station ID #11519500, or the Fort Jones Gauge or FJ Gauge; Figure \@ref(fig:ScottWatershedMap)). The flow at this gauge is correlated with flow in tributary streams [@FogliaEtAlScott2013], and though a single monitoring location may not be able represent flow status in the full stream system at all times, it has been used in recent water planning documents as an indicator of overall hydrologic conditions [Siskiyou County -@SiskiyouCountyScott2021]. Because most water use in Scott Valley occurs upgradient of this gauge, its measurements are used to inform water management decisions in the populated areas of the valley (see *Supplement* for more detail on Scott Valley management history, geography and climate).

**add RST and FCF** Ecologic data in Scott Valley is available due to routine monitoring of spawning anadromous fish, which has been ongoing in the broader Klamath basin since at least 1978 [@KnechtleChesneyScott2013]. More in-depth monitoring of multiple salmonid life stages in the Scott River watershed has occurred since 2003 [e.g., @MaurerScott2003; @KnechtleGiudice20222023]. This study takes advantage of this nearly two-decade record of adult spawner and juvenile salmon abundance observations to draw preliminary conclusions regarding this hydrology-ecology relationship.


```{r ScottWatershedMap, echo = F, message = F, warning =F, fig.height = 8.5, fig.cap = "The Scott River watershed, with regional geographic context (see inset) and local features.\\label{fig:ScottWatershedMap}"}

if(replace_setting_fig == TRUE){save_setting_figure()}

if(save_imgs==T){
  file.copy(from = file.path(graphics_dir, "Graphics source","scott valley setting.png"),
            to = file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

if(include_figs==T){
  knitr::include_graphics(file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

fig_i = fig_i +1

```



## Species of concern: coho and Chinook salmon

This study intends to predict the hydrologic needs of two species, coho and Chinook salmon. To this end, we used several decades worth of hydrologic and ecological data collected in the Scott River watershed. Although both species need fall flows to migrate from the ocean to natal spawning streams, the life history strategies of these two salmonids are distinct in several ways, and consequently are expected to have different functional flow requirements (see Supplement for additional life history information). 
Chinook and coho salmon are distinct in several ways relevant to this study and to management considerations:

<!-- * Chinook in this watershed hatch in the spring and migrate to the ocean in their first year of life, in contrast to coho, which spend a full year in the stream before migrating  . -->

* The vast majority (**XX%**) of coho salmon outmigrate at 1+ years and return to spawn at 2+ years of age, producing a distinct cohort every 3 years (**CITE**), while the amount of time spent by Chinook in the ocean is more variable and more dependent on ocean conditions, and distinct cohort structure is not observed (**CITE**).
* Juvenile coho salmon are affected by 2 years of freshwater conditions, while juvenile Chinook are affected by only one year of freshwater conditions (Figure \@ref(fig:cohoLifeCycleFigure) [@AgrawalEtAlPREDICTING2005; @KnechtleGiudice20192020].
* In most years Chinook spawning migration takes place earlier (September-December) than coho (October-January).
* Coho salmon prefer to spawn in reaches with smaller spawning gravels than Chinook salmon. Consequently the majority of coho redds are found in Scott River tributaries, while Chinook redds are more commonly found in the mainstem Scott River [e.g., @MagranetYokelScott2017; @MagranetScott2017].
* Declining populations of coho salmon have been noted in the Klamath basin and more broadly in coastal California streams since the 1990s [e.g., @BrownEtAlHistorical1994], while regional Chinook populations have historically been more robust [@WainwrightEtAlCCIEA2013]. However, a declining trend was observed in the Klamath run of Chinook in the 2010s, and this trend was more significant in the Scott River system than the broader Klamath basin [@KnechtleGiudice20222023]. These trends have prompted additional monitoring of Scott Valley Chinook in the past decade [e.g., spawning surveys such as @MagranetScott2015; @MagranetScott2017].

```{r cohoLifeCycleFigure, echo = F, message = F, warning =F, out.height= "8.5in", fig.cap = "Seasons (as defined in the California Environmental Flows Framework; Yarnell et. al 2020) and life stages experienced by a coho and a Chinook salmon cohort in the Scott River watershed. Season identifiers listed here are used throughout the document."}

if(include_figs==T){
knitr::include_graphics(file.path(graphics_dir, "Graphics source", 
                                  "Salmon life cycle and seasons graphic.jpg"))
}
```

# Methods: Quantitative analysis

We used lasso regression [@; EtAlIntroduction2013; @RanstamCookLASSO2018] to assess the feasibility of predicting an ecological response, in this case coho and Chinook reproductive outcomes, using dozens of potential hydrologic predictor metrics. The objectives of the lasso exercise were to 1) perform predictor selection, i.e., empirically estimate which hydrologic metrics were most related to coho and Chinook reproductive outcomes; 2) estimate the degree of variation that could be predicted by the hydrology; and 3), develop a predictive Hydrologic Benefit formula, in which the selected set of hydrologic predictors and their calculated coefficients are used to predict the ecological response. Each step in the analysis is numbered and explained below.


**notes from papers** 

Parameter screening based on the 0.7 *R* threshold (based on system understanding) can reduce the confounding effects of collinearity, especially when combined with a regularization method to penalize model complexity and thereby reduce the risk of overfitting [@DormannEtAlCollinearity2013].

Purpose of this paper: generate hypotheses? Or produce a predictive model? Can I do both?? Discuss with Leland? [@TredennickEtAlPractical2021]

Multi-species forecasts convey no advantage over single-species forecasts. [@WardEtAlLeveraging2024] Simple linear regression or GAM models are as good or better than more complex models such as lasso at predicting recruitment among ocean fisheries  [@WardEtAlLeveraging2024]! Environmental variables (which ones?) can predict X % of variation in fish recruitment. [@WardEtAlLeveraging2024] 

"Ridge and lasso are risk-averse model strategies that can be expected to perform well under a wide range of underlying species-habitat relationships, particularly at small sample sizes." [@ReinekingSchroderConstrain2006]

**notes about forecasting papers**

[@WardEtAlLeveraging2024]
[@DietzeEtAlIterative2018]
[@PennekampEtAlPractice2017]
[@DaugaardEtAlForecasting2022]
[@SeeHolmesReducing2015] (MARSS)

## Step 1. Calculate predictors and screen for collinearity: Flow metrics to describe Scott River flow regime

Firstly, we calculated set of hydrologic predictor metrics characterizing the Scott Valley hydrologic regime. An initial set of metrics was selected from the catalog of California-specific functional flows (as illustrated in Figure 4) [@YarnellEtAlFunctional2020; @PattersonEtAlHydrologic2020] to highlight the history and salient characteristics of the Scott River flow regime over the past eight decades. These hydrologic predictors were calculated from the daily flow record at the Fort Jones river gauge from 1942-2023 using the approach of Patterson et al. [-@PattersonEtAlHydrologic2020]. The full suite of **XX** metrics is calculated on a water-year basis (i.e., each type of metric produces one value for each water year; *Supplemental Table 1*). Abbreviations, relevant time periods (including salmon life stage alignment; see Section 3.3), and metric calculation details are listed in Table \@ref(tab:funcFlowTermsTab). Additional information is available in @PattersonEtAlHydrologic2020 and supporting documentation.

All selected functional flow metrics have some known ecological function or interpretation: Total annual flow is used to evaluate water year type. Phenomena measured with fall metrics, such as fall pulse magnitude and fall pulse timing, provide olfactory migration signals and spawning access to anadromous fish; however, a discrete fall pulse does not occur in every water year. Wet season metrics, such as wet season onset timing and baseflow magnitude, can be used to gauge conditions during egg incubation or the overwintering period for juvenile coho salmon. In particular, frequency and duration of wet season high-flow events (i.e. daily average flow above exceeding a 2-, 5- and 10-year flood) indicate the potential presence of scouring flows. Spring metrics, such as spring flow recession rate of change, occur during the transition from wet to dry season, and indicate conditions during early juvenile salmon rearing as well as the flow available for outmigration from Scott Valley to the ocean. Finally, metrics like the duration and median flow of the dry season indicate the timing and severity of low-flow conditions in which spatial habitat is constrained and connectivity between reaches may be limited. 

Secondly, two additional metrics were devised for this study area related to timing of anadromous fish access to preferred spawning habitat (illustrated in Figure \@ref(fig:reconnectExplainerHydrograph)). These metrics are referred to as "reconnection" and "disconnection" dates. They assume a flow threshold, defined at the Fort Jones gauge, that corresponds to a certain degree of "connectivity" in the Scott River stream system (with the assumption that higher connectivity corresponds to salmon access to more and better spawning  habitat). The date on which this connectivity is lost in the spring/summer or gained in the fall has implications for whether salmon passage exists during the preferred migrating time window. These metrics are related to the California-specific functional flows, namely, the timing and slope of spring recess and the timing of a fall pulse flow (Table \@ref(tab:customHydroMetricsTab)). More importantly, they add value to this analysis because of their direct relation to fish passage in the watershed.

Finally, to identify the presence of scouring flows [i.e., storm events that can mobilize large amounts of sediment and either bury or wash away salmonid eggs; @ScottRiverWatershedCouncilRestoring2018], which presumably have a detrimental effect on egg survival, we calculated the number of days in each year with average daily flow greater than the 90th flow percentile (for the full Fort Jones hydrologic record) (Table \@ref(tab:customHydroMetricsTab)). 

### Selecting flow thresholds for dis- and re-connection timing

**REVISE: NOW INCLUDING ONLY 3. 20, 40 AND 120. these correspond approximately to mainstem connectivity and full tributary connectivity.**

In average-to-dry water years, after portions of the Scott River run dry, the timing of fall river reconnection determines when salmon can access mainstem and tributary spawning habitat (**CITE**). [**sentence about whether salmon can wait?**] To calculate the timing of river connectivity, two discrete thresholds were selected from the continuum of flows to represent a partially and a fully connected stream system. The thresholds correspond to two distinct events: first, 20 cfs (0.57 cms), corresponding to connectivity within mainstem Scott River; and second, 120 cfs (3.4 cms) connectivity of the full stream network, allowing access to tributary habitat. Because these flows are measured at the Fort Jones gauge, they are a proxy for conditions in the full stream network; however, [**evidence for why this works**] [@KoubaHarterSeasonal2024].

The re- and disconnection timing of proximate flow thresholds is somewhat correlated. Lasso regression is an appropriate method for this type of data because it can eliminate some redundancy in predictor information [@; EtAlIntroduction2013]. 

When calculating the timing of river connectivity, discrete thresholds were selected from the continuum of flows, ranging between a minimum value of 8 cfs and a (conservatively high) maximum value of 1000 cfs. At the lowest value all tributaries are known to be disconnected and significant dry reaches exist along the main stem, while the highest value is associated with winter storm events in a fully-connected river system [@TolleyEtAlSensitivity2019].

The re- and disconnection timing of proximate flow thresholds is somewhat correlated. Lasso regression is an appropriate method for this type of data because it can eliminate some redundancy in predictor information [@; EtAlIntroduction2013]. 

### Screen predictors for collinearity

Because many metrics are influenced by the same phenomena taking place in wet and dry years, significant collinearity was present in the hydrologic metrics used in this predictive exercise. To account for this, collinear predictors,defined as predictors correlated with a Spearman's *R* greater than 0.7 [@DormannEtAlCollinearity2013], were grouped, and one predictor was selected to represent each group. Below and in Table \@ref(tab:predCorrScreeningTable), we describe each group and the ultimate selected predictors in conceptual terms. **(SUPPLEMENT)**


## Step 2. Assemble responses: Ecological monitoring data

Multiple observed quantities were evaluated as candidates to represent the ecological response (dependent variable) in the flow-ecology relationship. 

Factors influencing the population size of anadromous fish include ocean conditions and freshwater conditions. In this study focused on the conditions in their natal streams, we have focused on fish population metrics that are influenced by the freshwater system. The ecological observations considered for use in the final flow-ecology relationship are:

1. Number of adults migrating from the ocean to freshwater natal streams to spawn. This quantity, the 'escapement', is measured at a CDFW counting facility **(FIG 1)**, using a resistance board weir and video counting flume in the Scott River [e.g., @KnechtleGiudice20222023]. 
2. Number of juvenile yearling, or smolt, salmon. Smolt are counted as outmigrants, often from rotary screw trap observations [e.g., @MassieMorrow20202021]. **(FIG 1)**
3. Number of salmon gravel nests, or redds, observed during spawning window [e.g., @MagranetScott2015] (for coho only).

Two combined metrics historically calculated and reported by regional agencies [@KnechtleGiudice20222023] were also considered. These metrics use data from multiple years to capture multiple life stages for a given cohort:

4. The number of outmigrating coho smolt produced per spawning female (coho spf) and the outmigrating Chinook juveniles per adult (Chinook jpa).

**figure out order of this paragraph in this section?** These time series of observations are the result of decades of investment in local ecological monitoring. Monitoring activity in the past 20 years has included population estimates from a video counting flume and a rotary screw trap operated by CDFW [CDFW -@CaliforniaDepartmentofFishandWildlifeRecovery2015; @MassieMorrow20202021; @KnechtleGiudice20222023], and spawning surveys for Chinook [@MagranetScott2015a; @MagranetScott2017; @MagranetScott2018] and coho [@MaurerScott2003; Siskiyou RCD -@SiskiyouResourceConservationDistrictFinal2004; @QuigleyScott2005; @QuigleyFinal2006; @QuigleyFinal2007; @SiskiyouResourceConservationDistrictScott2010; @YokelScott2011; @FranklinScott2012; @YokelScott2013; @YokelScott2014; @MagranetScott2015; @MagranetYokelScott2017]. Recent management activity has included the leasing of surface water rights from landowners to enhance summer flows [e.g., SRWT -@Magranet20172018], the prioritization of stream reaches for habitat restoration [SRWC -@ScottRiverWatershedCouncilRestoring2018], several pilot projects to construct and assess the impact of beaver dam analogs (BDAs) on aquatic habitat and fish populations [Yokel -@YokelEtAlScott2018], a coordinated rescue effort to relocate juvenile salmon that were cut off from outmigrating by disconnected river reaches [CDFW -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015], and the development of long-term groundwater management plan by Siskiyou County and local stakeholders [Siskiyou County -@SiskiyouCountyScott2021].

```{r ecoMetricsMonitoringTab, echo = FALSE, results = 'asis'}

em_tab = read.csv(file.path(data_dir,"Ecological Monitoring Data Source Information.csv"))

#Create caption and column labels
caption_text = "Description and source information for ecological observations of the two salmonid species of concern."
column_labels = c("Obs. ID","Abbrev.","Description", "Monitoring Details", "Source(s)", "Predictor Seasons")
colnames(em_tab) = column_labels

em_tab_ft = flextable(data=em_tab)
em_tab_ft = set_caption(em_tab_ft, caption = caption_text)
em_tab_ft = flextable::width(em_tab_ft,j=1,  width = .5)
em_tab_ft = flextable::width(em_tab_ft,j=2,  width = 1.5)
em_tab_ft = flextable::width(em_tab_ft,j=3, width = 1.5)
em_tab_ft = flextable::width(em_tab_ft,j=4,  width = 1.5)
em_tab_ft = flextable::width(em_tab_ft,j=5,  width = 1.2)
em_tab_ft = flextable::width(em_tab_ft,j=6,  width = 0.7)
em_tab_ft

```  

## Step 3. Align predictor and response metrics with timing of species cohorts

The empirical basis for this predictive modeling exercise is a table of hydrologic metrics (one per water year) and ecological observations influenced by this hydrology (*Supplemental Table 2*). However, the row-by-row basis for the table is somewhat complex due to the life history of the two species under consideration.

A water year is a useful time unit for water managers and a common unit used in decision-support tools. However, a cohort of coho salmon will experience conditions during multiple water years while residing in their spawning habitat. For coho salmon the life cycle is largely regular in Scott Valley, with 3 defined cohorts in which the vast majority of individuals return to natal streams at 3 years of age [e.g., CDFW -@CaliforniaDepartmentofFishandWildlifeScott2021]. Conversely, the majority of Chinook salmon return to spawn when they are 2 to 6 years old [@BourretEtAlDiversity2016], resulting in less of a cohort structure than for coho. Here we define the alignment (i.e., mapping) of a specific generation of fish (ecological outcome) with hydrologic metrics (predictors) observed across the portion of their life cycle spent in the Scott River system (*Supplemental Table 2*).

### Data alignment - coho

The relevant unit of time for identifying the impacts of freshwater hydrology on a coho salmon cohort is defined here as a Coho Freshwater Life Period (CFLP), a duration of 21 months beginning the September of the year their parents spawned and ending the July of their outmigration from the watershed as smolts. This time period is conservatively wide; most spawning occurs in October or later, and most outmigration occurs in June or earlier [@MoyleCoho2002], but the September-July duration was chosen to capture critical life stages even in extreme water years. 

**add text about new season naming system**

<!-- For convenience in referring to hydrologic metrics in different water years, this Coho Freshwater Life Period has been broken up into three subperiods (as shown in Figure \@ref(fig:cohoLifeCycleFigure) and described in Table \@ref(tab:funcFlowTermsTabLifePeriods)): -->

<!-- * Brood Year (BY), September-December of the year of the cohort's parents' spawning -->
<!-- * Rearing Year (RY), January-December of the full year the cohort spends in the watershed -->
<!-- * Smolt Year (SY), January-July of the year of the cohort's smolt outmigration -->

<!-- Coho Freshwater Life Periods overlap, e.g., the fall pulse flows in year $i$ take place during one cohort's Brood Year, and the same fall flows occur during the end of the Rearing Year for the cohort born in year $i-1$. In some rare cases, flow metrics may fall outside their designated subperiods (e.g., the extreme dry water year of 2014, in which the "fall reconnection" of flows in Brood Year 2013 did not occur until February of the cohort's Rearing Year). Nonetheless, for consistency, even a January or February reconnection date will be referred to by the previous fall year designation. -->

To build empirical relationships between hydrology and biology, ecological response variables were indexed by Brood Year of the affected cohort and hydrologic metrics tabulated accordingly (*Supplemental Table 2*). For example, the value for fall reconnection timing (100 cfs flow threshold) in fall of 2011 was assigned to the column "BY_recon_100" for the Brood Year 2011 cohort. The same value was assigned to the column "RY_recon_100" for the Brood Year 2010, which experienced fall 2011 as rearing juveniles.

Each brood year is associated with (at most) one data point per ecological response variable (i.e. "fish outcome" observation types), including number of Chinook and coho spawners observed and the estimated number of smolt observed at the end of their CFLP. Ecological response data were available and compiled for brood years 2004 through 2019. We note that because the Brood Year period only covers the fall and early winter,  ecological outcome in water year $wy$ is obtained for $wy = BY + 1$ for both salmon species.



### Data alignment - Chinook

Because spawning occurs in the fall for both coho and Chinook salmon in the Scott River watershed [@CaliforniaDepartmentofFishandWildlifeScott2021], Chinook ecological data was aligned with hydrologic metrics in the same manner as coho observations. Distinct life histories produced one significant difference: because Chinook migrate to the ocean in their first year of life, the duration of freshwater residence for each Chinook cohort is shorter than for coho, ranging from fall spawning to the subsequent spring or summer. Thus, only metrics from the Brood Year and from the Rearing Year wet season, spring recession and dry season were considered for the Chinook model.


```{r smolt_year_metrics_master_tab, echo = F, warning =F}

# retrieve hydrology tabulated by STP
brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1999:2022,
                                                             smolt_years = 2001:2024)
# brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1978:2022,
#                                                              smolt_years = 1980:2024)

# thresh_for_corr_fig = c(8, 10, 15, 20, 40, 
#                         70, 100, 150, 200, 300, 
#                         400, 500, 750, 1000)
thresh_for_corr_fig = c(20,40,120)

metrics_tab = calc_metrics_hydro_by_affected_brood_year(
  hydro_by_brood_year = brood_year_hydro_tab,
  thresholds = thresh_for_corr_fig) 

# Clean metrics tab:
# 1) factorize water year category
metrics_tab$wy1_WY_Cat = as.numeric(factor(metrics_tab$wy1_WY_Cat,
                                   levels = c("dry year", "mod year", "wet year")))
metrics_tab$wy2_WY_Cat = as.numeric(factor(metrics_tab$wy2_WY_Cat,
                                   levels = c("dry year", "mod year", "wet year")))
# 2) remove outlier FA_Diff?

write.csv(x = metrics_tab, quote = F, row.names = F,
  file = file.path(graphics_dir,
                   "Supplemental Table 2. Flow Metrics by Brood Year.csv"))

# calculate number of predictors for text below

yvlt = y_val_label_tab()
non_preds = c("brood_year", "smolt_year", yvlt$y_val)


num_predictors = length(colnames(metrics_tab))- length(non_preds)
preds_all = colnames(metrics_tab[,!colnames(metrics_tab) %in% non_preds])

```



```{r metrics_tab_diagnostics, echo = F, warning =F}

# log_transform_flow_metrics = F

if(log_transform_eco_metrics == T){
  metrics_tab[,yvlt$y_val] = log10(metrics_tab[,yvlt$y_val])
}

# zscore_column_na_rm = function(x){
#   mean_x = mean(x, na.rm=T)
#   sd_x = sd(x, na.rm=T)
#   return((x - mean_x) / sd_x)
# }

if(zscore_flow_metrics == T){
  zscore_these = !(colnames(metrics_tab) %in% non_preds)
  metrics_mean = apply(X = metrics_tab[,zscore_these], MARGIN = 2, FUN = mean, na.rm=T)
  metrics_sd = apply(X = metrics_tab[,zscore_these], MARGIN = 2, FUN = sd, na.rm=T)
  metrics_tab[,zscore_these] = apply(X = metrics_tab[,zscore_these],
                                     MARGIN = 2, FUN = zscore_column_na_rm)
}

# if(log_transform_flow_metrics == T){
#   log_these = !(colnames(metrics_tab) %in% non_preds)
#   metrics_tab[,log_these] = log10(metrics_tab[,log_these])
# }

```

## Step 4. Calculate correlation coefficients and rule out temporally impossible relationships

After aligning the hydrologic predictors and ecological responses, we calculated Pearson correlation coefficients [@PearsonNote1895] $R$ between each predictor and each response. A significant number of potential predictor-response pairs do not represent a temporally plausible relationship: e.g., the wet season values in water year 2011 would not influence the number of spawners that arrived the previous season, in fall of 2010. These implausible pairs were excluded from the resulting $R$ matrix.

## Step 5. Select ecological response metrics

**rethink this based on conversation with Betsy?** 

To generate predictive models, we make an assumption of independence for each year of ecological observation data. Cohort effects may reduce the validity of this assumption (i.e. the number of coho spawners in year 2009 may be partly dependent on the number of spawners in 2006). In order to control somewhat for cohort effects, we selected the normalized metric available for each species as the ecological response variable: coho smolts per female spawner (coho spf) and Chinook juveniles per adult spawner (Chinook jpa). We used the correlation coefficents between the hydrologic metrics and ecological observations to assess the relatedness of the two species outcomes with hydrology, and determined that one was significantly less related. For completeness, we also compared the $R$ values of the two selected metrics to the other (non-normalized) ecological data types.

## Step 6. Generate predictive model with lasso regression 

With hydrologic metrics assigned to each salmon generation, indexed by brood-year (*Supplemental Table 2*), we assessed the potential for hydrologic metrics to predict biological outcomes by performing lasso regression [@; EtAlIntroduction2013; @RanstamCookLASSO2018] between `r num_predictors` (standardized) hydrologic predictors and the two ecological data types selected in the previous step (one for coho and one for Chinook). 

### General approach

We used the R programming environment [@TheRFoundationProject2025] and the linear modeling function `glmnet()` [@FriedmanEtAlRegularization2010] to perform variable selection using lasso regression. Lasso regression is less flexible than the classic least squares regression, and is commonly used in high-dimensional data settings, where the number of possible predictors approaches or exceeds the number of observations [@; EtAlIntroduction2013]. Because the solution can set some coefficients to 0, thereby removing their associated predictors from the final model, lasso regression can also perform predictor selection. Additionally, the `glmnet()` function standardizes the predictor values to have a unit variance before the lasso analysis, and then un-standardizes the resulting coefficients [@FriedmanEtAlRegularization2010].


Lasso (Least Absolute Shrinkage and Selection Operator) regression minimizes the following quantity:

$$\sum_{i=1}^{n}{(y_i-\beta_0-\sum_{j=1}^{p}{\beta_jx_{ij}})^2}+\lambda\sum_{j=1}^{p}{|\beta_j|}$$

Where:

* $n$ is the number of ecological observations;
* $i$ enumerates the brood years;
* $p$ is the number of predictors;
* $j$ enumerates the hydrologic predictors;
* $x_{ij}$ is the observed value of hydrologic predictor $j$ for brood year $i$ (independent variable);
* $y_i$ is the observed value of ecological response in the salmon cohort with brood year $i$ (dependent variable);
* $\beta_0$ is the intercept value for the resulting linear model;
* $\beta_j$ is the coefficient value for hydrologic predictor $j$ in the resulting linear model; and
* $\lambda$ is a tuning parameter, referred to as a shrinkage penalty.

In this formulation, sufficiently large values of lambda generally shrink the values of all coefficients to 0 (the infinite-lambda case). The infinite-lambda case produces a model consisting solely of the $\beta_0$ intercept term, which takes on a value that is the average of all the observed $y$ values. Conversely, sufficiently small values of $\lambda$ will produce linear models incorporating information from many predictors. 
The selection of the appropriate $\lambda$ value is a critical step in the regression procedure, and is best done using cross-validation within the training dataset [@; EtAlIntroduction2013]. In this analysis a range of $\lambda$ values was explored for each species.

### Predictor restriction based on sample size

Some ecological records have gaps (e.g., when funding was not available in one year to conduct a redd survey). Additionally, some predictor metrics are not available in all years (for example, FA_Mag, or magnitude of a fall pulse flow, cannot be calculated if no discrete fall pulse flow is observed). For the lasso regression exercise, we restricted the set of considered predictors to those which had at least 10 years of overlap with the selected ecological response.

**Reconsider these methods and potentially use k-fold cross validation instead to ID best lambda val**

### Modified lambda selection method

In parameterizing lasso regression, the goal is to select a lambda value (referred to as the "shrinkage penalty" or "tuning parameter") that uses available predictor data to explain the largest possible amount of variability observed in the response while avoiding overfitting. With high-dimensional data, it is typically possible to perfectly fit the observations (explaining 100% of variability) by incorporating data from as many or more predictors as there are observations [@; EtAlIntroduction2013]. The predictive models that result from this type of overfitting typically perform poorly when applied to new data, since they tend to incorporate random noise to achieve a perfect fit [@; EtAlIntroduction2013].

#### Standard method to select lambda value

The standard method to pick the optimal value of lambda is to divide a dataset into a "training" and a "test" set, and use the training set to generate a series of regression models based on a range of lambda values. In one popular textbook example, the range of lambdas used to produce models consists of 100 values from 0.01 to 10,000 (i.e., 100 equidistant numbers ranging from -2 to 5, and then used as an exponent of 10) [@; EtAlIntroduction2013]. These 100 models are then used to predict the values of the test set, and the total difference between predicted and observed quantities is known as the test error. This is often summarized as the root mean squared error value (RMSE). The lambda value that produces the regression model with the minimum test error is selected as optimal; using this optimal value, a final regression model is generated based on the full data set [@; EtAlIntroduction2013]. 

#### Modified method: resampling to identify range of possible optimal lambda values using hundreds of test-train dataset splits

However, we decided this was not appropriate for the small size of the available ecological datasets, which ranged from 13 to 21 years of observations: we could not be confident that the single optimal lambda value was an indicator of the ideal balance point between incorporating useful information and overfitting, since it could just be an artifact of the way we divided the dataset into test and training sets. To address the limited number of observations, instead of identifying a single optimal lambda value, we used resampling to identify a range of optimal lambda values. Specifically, we divided the dataset into non-repeating random sets of half test and half training data hundreds or thousands of times, and performed the standard method for optimal lambda identification on each test set. For coho spf, we identified optimal lambda values for all 1,716 possible 50% splits of the 13 data points; for Chinook, which had a larger sample size, we capped the number of test sets at 10,000.

#### Focus lasso results on potential optimal range

Then, using the full dataset, we calculated regression models produced by the full range of optimal lambda values identified in the test-train step. To generate a smooth set of curves for coefficient values and percent of deviation, the regression models were calculated at a series of 100 equidistant values between the two ends of the optimal lambda range. This smaller set of regressions (rather than calculating regression models at all 1,716 or all 10,000 optimal values) is possible because regression coefficients and percent deviation change smoothly with change in lambda values.

### Selection of final lambda value

Since the standard method was deemed unsuitable for this dataset, we required a modified method to select the final lambda value, and thus generate a single final predictive regression model, for each species. In our modified method we considered the percentage of deviation explained (in the results for the full dataset) and the test error (of the 1,716 [coho] and 10,000 [Chinook] randomly sampled test and training sets). Our objective was to select a lambda value that explained the largest percent of deviation but also produced a reasonable average test error. In both cases we ultimately selected the lambda value associated with an average relative test error of 1.0, or a test error of 100% of the average observation value (see further details in Results).

## Step 7. Formulate Hydrologic Benefit function

The final lambda value selection produced the linear model which can be used to predict ecological outcomes with hydrologic predictors. We referred to this model as the Hydrologic Benefit (HB) function. The predicted HB value, with units of the selected ecological response type, in Brood Year $i$ is calculated as:

$$HB_i = \beta_0 +\sum_{j=1}^{p}{\beta_j x_{ij}}$$

Where:
$x_{ij}$ is the value of hydrologic predictor $j$ in the cohort with Brood Year $i$.

As noted above, the ecological outcome in water year $wy$ is obtained for $wy = BY + 1$ for both salmon species.

# Results

## Flow history of the Scott River, described in functional flow metrics

Diagnostic metrics of Scott River flow have demonstrated clear trends over the past 8 decades. Between 1942 and 2021, total annual flow measured at the Fort Jones gauge has dropped from an average of approximately 600 to 400 thousand acre-feet (TAF, or from >800 to <600 million m^3^) (Figure \@ref(fig:funcFlowTimeseries), panel A). Annual flows have always shown large variability, ranging across an order of magnitude, from 67 TAF (in water year 1977) to 1,336 TAF (in water year 1974). More recently, the frequency of years with low annual flows (200 TAF or less) has significantly increased: 3 such years over the first four decades of the gage record, but 10 such years over the second four decades. In contrast, very high annual flows of over 600 TAF were exceeded in at least five years for each two-decade period between 1941 and 2000, but only twice in the most recent two-decade record. 

Ecosystem functional flow metrics, calculated with signal-processing techniques [@PattersonEtAlHydrologic2020] (illustrated in Figure \@ref(fig:fig2Yarnell2020)), also show clear trends over time (Figure \@ref(fig:funcFlowTimeseries), panels B-H). The fall pulse onset date has trended slightly later (though a distinct fall pulse flow does not occur every year), and the magnitude of the fall pulse flows has decreased. Remarkably, a fall pulse onset during the first half of October occurred four times between 1940 and 1980, but not since then (Figure \@ref(fig:funcFlowTimeseries), panel C). Reflecting the large variability in annual flows, the magnitude of the fall pulse flow varies widely, across 2.5 orders of magnitude, from less than 50 cfs to 1500 cfs. Extremely high fall pulse flows (>800 cfs), occurring three times in the earlier period, were missing in the second half of the 80-year record.  Years with a fall pulse flow magnitudes of less than 400 cfs have become more frequent, resulting in a visible downward trend in fall pulse magnitude over the period of record (Figure \@ref(fig:funcFlowTimeseries), panel B).

The onset of the wet season has trended slightly later, though wet season median baseflows (i.e., flows not occurring during storm pulses) have remained stable on average (with a very slight downward trend). Wet season baseflow rates vary from less than 50 cfs (1977) to over 2000 cfs (1997) with typical winter flow ranging from 400 to 1000 cfs (Figure \@ref(fig:funcFlowTimeseries), panel E).

After April, the chance of large precipitation events becomes minimal leading to a gradual, near-exponential decline of streamflow rates during May through July as the snowpack in the upper watershed melts off. While a very consistent feature in the annual hydrograph (e.g., Figure \@ref(fig:reconnectExplainerHydrograph)), the rate of flow reduction (i.e., the exponential decline) during the spring has increased over the period of record. The spring recession curve has grown steeper and accelerated the annual recession process: the rate of decline was just above 0.05%/day in 1940, and it was nearly 0.07%/day in 2020 (Figure \@ref(fig:funcFlowTimeseries), panel EF).

The median dry season flow has dropped by approximately 50%, with many years since 1977 seeing flows below 30 cfs, a condition not seen prior to 1977 and largely related discontinuation of inefficient flood irrigation with surface water during the 1970s and the introduction of efficient sprinkler irrigation with groundwater allowing for an extended irrigation season [@TolleyEtAlSensitivity2019]. The onset of the dry season is earlier, and the duration of the dry season has increased, in some of the most recent years to over 200 days (Figure \@ref(fig:funcFlowTimeseries), panels G and H). 

The reconnection and disconnection dates also show significant trends over time, especially at lower flowrates. As a result, the wet season has notably narrowed over time with (approximate) fall onset trending later and the spring flow recession trending to begin earlier. In 2020, the expected reconnection at the 100 cfs threshold occurs more than a month later than in 1940, the expected summer disconnection more than two weeks earlier (Figure \@ref(fig:reAndDisconTimeseries)).

In aggregate over the past 80 years, these metrics show an increasing prevalence of unfavorable hydrologic conditions for salmonids, in terms of the flows needed during critical life stages. The primary causes of this reduced ecological functionality are a changing climate (especially a reduced snowpack and earlier snowmelt) and long-term changes in local consumptive water uses [@DrakeEtAlAnalysis2000; @VanKirkNamanRelative2008; @FogliaEtAlScott2013].


```{r funcFlowTimeseries, echo = F, warning =F, fig.height = 8.6, fig.cap = "Total annual flow volume (panel A) and functional flow metrics (panels B-H; Patterson et al. 2020), derived from daily average flow measurements at the Fort Jones USGS flow gauge (ID 11519500) for water years 1942-2023.\\label{fig:funcFlowTimeseries}"}

fflows_hist_obs = read_fflows_FJ(calculator = "Flashy")#read_fflows_csv(scen_id = "hist_obs")

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 9, units = "in", res = res_dpi)
  
func_flow_timeseries_fig(fj_flow = fj_flow, fflows = fflows_hist_obs)
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


```{r reAndDisconTimeseries, echo = F, warning =F, fig.height = 8, fig.cap = "Disconnection and reconnection dates for the 120 cfs (3.4 cms) flow threshold, water years 1942-2023. The disconnection date refers to the first day in the spring on which flow drops below the designated threshold (120 cfs); the reconnection date refers to the first date in the fall on which flow rises above the designated threshold. Trends over the past 80 years suggest that the spring flow recession is trending earlier, and the fall river reconnection is trending later. \\label{fig:reAndDisconTimeseries}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 6, units = "in", res = res_dpi)
  
re_and_discon_timeseries_figure()
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


## Hydrology-ecology correlations


```{r suppEcoVSTimeFigs, echo = F, warning =F, fig.height = 8, fig.cap = "Explanatory plots of Chinook spawner abundance versus various hydro metrics and over time. \\label{fig:suppEcoVSTimeFigs}"}

# fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
# if(save_imgs == TRUE){
# png(filename = fig_path, width = 7, height = 6, units = "in", res = res_dpi)

resave_eco_hydro_scatter_plots = F

if(resave_eco_hydro_scatter_plots == T){
  for(id in yvlt$y_val){
    eco_vs_pred_figs(y_val_id = id)
    
    eco_vs_time_figs(y_val_id = id)
  }
  
}


# dev.off()

# }
# if(include_figs==T){knitr::include_graphics(fig_path)}
# fig_i = fig_i +1



```

```{r inter_corr_matrix_supp_fig, echo = F, warning =F, comment = F}

nthresh = length (thresh_for_corr_fig)
nthresh_gt_70 = sum(thresh_for_corr_fig >= 70)

# Calculate correlation matrix 
corr_tab_all_metrics = cor(metrics_tab, use = "pairwise.complete.obs",
                           method = "spearman")

# and remove values that don't make temporal sense 
# (i.e., the wet season values in water year 2011 would not influence the
# number of spawners that arrived in fall of 2010)

pred_season = substr(x = colnames(metrics_tab[,preds_all]), start = 1, stop = 2)
names(pred_season) = colnames(metrics_tab[,preds_all])
for(i in 1:nrow(yvlt)){
  # possible to do: figure out how the wy1 and wy2 metrics would map out here. 
  # for which eco responses do they get NA vals?
  pred = yvlt$y_val[i]
  season_set = unlist(strsplit(yvlt$influencing_seasons[i], split = ", "))
  keep_these = c(non_preds, names(pred_season)[pred_season %in% season_set])
  exclude_these = colnames(metrics_tab)[!(colnames(metrics_tab) %in% keep_these)]
  corr_tab_all_metrics[pred, exclude_these] = NA
}

# set up for plot
metrics_tab_column_colors = c(rep("black", 2),  # brood and smolt years
                              rep("darkgray",8), # fish outcome metrics
                              rep(fall_col,nthresh), # BY fall recon 
                              rep(spring_col,nthresh), # RY spring discon
                              rep(fall_col,nthresh),   # RY fall discon
                              rep(spring_col, nthresh_gt_70), #SY spring discon
                              # rep("darkorchid",3), # min. flow metrics
                              # rep("peachpuff3",4),    # total flow metrics
                              # rep("peachpuff4", 4),    # log total flow metrics
                              rep(c(
                                rep(dry_sn_col, 4),
                                rep(fall_col, 4),
                                rep(wet_sn_col, 16),
                                rep(spring_col, 5),
                                rep("peachpuff3",2)), 2),    # annual metrics
                              rep("peachpuff4",2)        # scouring flow days
)

if(save_imgs==T){
  pdf(file = file.path(graphics_dir, "Supplemental Figure 1. Correlation Matrix.pdf"), width = 40, height = 40)
par(mar=c(5,4,6,2))
corrplot(corr_tab_all_metrics,
         tl.col = metrics_tab_column_colors, tl.cex = 1.1, 
         # col.lim = rev(c(-1.1,1.1)),
         # col.lim = c(-1, -0.7, -0.4, -0.1, 0.1, 0.4, 0.7, 2),
         col = c(rep("orangered3"), rep("lightpink",2),rep("mistyrose",2),
                 # rep("white",2), 
                 rep("lightcyan",2), 
                 rep("lightskyblue",2),rep("deepskyblue4")),
         na.label = "--", main = NA) # diag = F
# text(x=30,y=107, cex=3, label="Correlations highlighted for coho (pink box, dashed) and Chinook (purple box, dot dash)")
# x1 = 9; x2 = 97; y1 = 88; y2=y1+4; y3=y2+3
# polygon(x=c(x1,x2,x2,x1,x1)+.5, y = c(y1,y1,y2,y2,y1)+.4, border = "deeppink", lwd = 6, lty = 2)
# polygon(x=c(x1,x2,x2,x1,x1)+.5, y = c(y2,y2,y3,y3,y2)+.6, border = "darkviolet", lwd = 6, lty = 4)
# dev.off()

}

```


```{r predictor_correlation_screening, echo = F, warning =F, comment = F}

# Exclude predictors with too small a sample size
mt_years_count = apply(X=metrics_tab, MARGIN = 2, FUN = function(x){sum(!is.na(x))})
minimum_years = 10
too_few_years = names(mt_years_count)[mt_years_count < minimum_years]

# Select high correlation threshold (0.7 after Baruch et al 2024)
high_corr_threshold = 0.7

# Make new table of corr. coeffs, excluding index years, eco responses, 
# and predictors with too-small sample size
corr_tab_screener = corr_tab_all_metrics
diag(corr_tab_screener) = NA # exclude 1.0 R values along diagonal

exclude_these = colnames(corr_tab_screener) %in% too_few_years +
  colnames(corr_tab_screener) %in% c("brood_year","smolt_year") + 
  grepl(pattern = "coho", x = colnames(corr_tab_screener)) | 
  grepl(pattern = "chinook", x = colnames(corr_tab_screener)) 

corr_tab_screener = corr_tab_screener[!exclude_these, ]
corr_tab_screener = corr_tab_screener[ ,!exclude_these]

# Convert remaining corr. coefs into a long-form table
corr_tab_long = melt(corr_tab_screener)
ctl = corr_tab_long
ctl = ctl[!(is.na(ctl$value)),] # remove NA values

# explore the predictors correlated with the highest number of other predictors

# To find the most parsimonious explainer, pick one predictor from each group of
# collinears, and eliminate the remaining ones until no abs(R)> threshold remain

# Sort predictors according to highest number of collinears > threshold
preds_sort = sort(table(ctl$Var1[abs(ctl$value) > high_corr_threshold]), decreasing = T)
# identify the predictors collinear with the top-correlated predictor
collin_preds = preds_sort[preds_sort > 0]
# Initialize the while loop and structures to record the collinear groups
loop = 1; collinear_group = list(); selected_pred = list()

while(length(collin_preds)>0){
  most_collin_pred = names(collin_preds[1]) # pick predicter with highest number of collinears
  collinear_with = unique(ctl$Var2[ctl$Var1 == most_collin_pred &
                                     abs(ctl$value) > high_corr_threshold])
  
  # Record the groups of collinear predictors and the ultimate selected one
  if(zscore_flow_metrics == F){
    collinear_group[[loop]] = c(most_collin_pred, as.character(collinear_with))
    if(loop==1){selected_pred[[loop]] = "w1_Wet_BFL_Mag_50"} # How wet the wet season (year 1)
    if(loop==2){selected_pred[[loop]] = "w2_Wet_BFL_Mag_50"} # How wet the wet season (year 2)
    if(loop==3){selected_pred[[loop]] = "d1_DS_Mag_50"} # How dry the dry season (pre-spawning)
    if(loop==4){selected_pred[[loop]] = "w1_Wet_BFL_Dur"} # How long the wet season (rearing juv)
    if(loop==5){selected_pred[[loop]] = "w2_Wet_BFL_Dur"} # Dry to wet transition timing (rearing juv)
    if(loop==6){selected_pred[[loop]] = "d1_DS_Dur_WS"} # Fall pulse magnitude during spawning (diff has higher sample size)
    if(loop==7){selected_pred[[loop]] = "f1_FA_Mag"} # Fall pulse magnitude (rearing juv) (diff has higher sample size)
    if(loop==8){selected_pred[[loop]] = "f2_FA_Mag"} # Fall pulse magnitude (rearing juv) (diff has higher sample size)
  }
  
  if( zscore_flow_metrics == T){
    collinear_group[[loop]] = c(most_collin_pred, as.character(collinear_with))
    collinear_group[[loop]]
    loop
    if(loop==1){selected_pred[[loop]] = "w1_Wet_BFL_Mag_50"} # How wet the wet season (year 1)
    if(loop==2){selected_pred[[loop]] = "w2_Wet_BFL_Mag_50"} # How wet the wet season (year 2)
    if(loop==3){selected_pred[[loop]] = "d1_DS_Mag_50"} # How dry the dry season (pre-spawning)
    if(loop==4){selected_pred[[loop]] = "w2_Wet_Tim"} # Dry to wet transition timing (rearing juv)
    if(loop==5){selected_pred[[loop]] = "w1_Wet_BFL_Dur"} # How long the first wet season
    if(loop==6){selected_pred[[loop]] = "f1_FA_Dif_num"}#"f1_FA_Mag"} # Fall pulse magnitude (rearing juv) (diff has higher sample size)
    if(loop==7){selected_pred[[loop]] = "f2_FA_Dif_num"}#"f2_FA_Mag"} # Fall pulse magnitude (rearing juv) (diff has higher sample size)
    selected_pred[[loop]]
  }
  
  # Remove the other collinears 
  keep = selected_pred[[loop]] # Keep this one
  dont_keep = collinear_group[[loop]][collinear_group[[loop]] != keep] # exclude these ones
  ctl = ctl[!(ctl$Var1 %in% dont_keep |
                ctl$Var2 %in% dont_keep),]
  # Recalculate the number of remaining collinear predictors with R > threshold
  preds_sort = sort(table(ctl$Var1[abs(ctl$value) > high_corr_threshold]), decreasing = T)
  collin_preds = preds_sort[preds_sort>0]
  loop = loop + 1
  loop
}

```

```{r predCorrScreeningTable, echo = F, warning =F, comment = F}

# Restructure the groups and eliminated predictors in a table
elim_pred_tab_col1 = unlist(lapply(X=collinear_group, FUN = function(x){paste(x, collapse = ", ")}))
if(zscore_flow_metrics == F){
  elim_pred_tab_col2 = c("How wet was the wet season? (year 1, as eggs and fry)",
                         "How wet was the wet season? (year 2, as rearing juv.)",
                         "How dry was the dry season? (pre-spawning)",
                         "How long was the wet season? (year 1, as eggs and fry)",
                         "How long was the wet season? (year 2, as rearing juv.)",
                         "How long was the dry season? (pre-spawning)",
                         "Fall pulse magnitude (year 1, during parents' spawning)",
                         "Fall pulse magnitude (year 2, as rearing juv.)")
}
if(zscore_flow_metrics == T){
  elim_pred_tab_col2 = c("How wet was the wet season? (year 1, as eggs and fry)",
                         "How wet was the wet season? (year 2, as rearing juv.)",
                         "How dry was the dry season? (pre-spawning",
                         "Dry to wet season transition timing (as rearing juv.)",
                         "How long was the wet season (as eggs and fry)",
                         "Fall pulse magnitude (parents' spawning)",
                         "Fall pulse magnitude (rearing juv.)")
}


elim_pred_tab_col3 = unlist(selected_pred)

elim_pred_tab = data.frame(collin_group=elim_pred_tab_col1,
                           interp = elim_pred_tab_col2,
                           selected_pred = elim_pred_tab_col3)

caption_text = "Groups of collinear predictors (absolute value of R greater than 0.7), interpretation of their hydrologic significance, and the predictor selected from each group to reduce collinearity."

column_labels = c("Group of Collinear Predictors","Hydrologic Significance",
                  "Predictor Selected from Group")
colnames(elim_pred_tab) = column_labels

ept_tab_ft = flextable(data=elim_pred_tab)
ept_tab_ft = set_caption(ept_tab_ft, caption = caption_text)
ept_tab_ft = flextable::width(ept_tab_ft,j=1,  width = 2.8)
ept_tab_ft = flextable::width(ept_tab_ft,j=2,  width = 2)
ept_tab_ft = flextable::width(ept_tab_ft,j=3,  width = 1.8)
ept_tab_ft
```




**revise**
Correlations between hydrologic and ecologic metrics were not particularly strong (*Supplemental Figure 1*; with selected metrics shown in Figure \@ref(fig:corrMatrixFig)). The maximum absolute $R$ value was 0.58, calculated between rearing year spring disconnection timing at 400 cfs (`RY_discon_400`) and coho smolt abundance, and only nine absolute $R$ values were greater than 0.5. This is consistent with the understanding that hydrology is only one factor influencing salmonid reproductive outcomes. 

The correlation coefficients do not show uniform effects of hydrology on both species: for example, the brood year reconnection timing produces strong negative correlations with coho spf and weak positive correlations with Chinook jpa (Figure \@ref(fig:corrMatrixFig)). Furthermore, hydrology tends to have different effects on different life stages: for both species the sign of $R$ with brood year reconnection timing is the opposite for spawning adults and outmigrating juveniles (though brood year reconnection correlations are much weaker for Chinook than for coho). 



```{r corrMatrixFig, echo = F, warning =F, fig.height = 8.5, fig.width = 7, fig.cap = "Correlations between 18 predictors and 7 ecological monitoring metrics: the two normalized metrics (left two columns), three additional metrics for coho (center), and two additional metrics for Chinook (right). Red colors indicate a negative correlation and blue colors indicate a positive correlation; the size and color of the circle in each box are both scaled to the value of the correlation coefficient. Large blue circles indicate that the quantity (such as the Brood Year fall pulse magnitude, or BY FA_Mag) is positively correlated with observed fish metrics. For dates, a blue dot indicates that a later date is correlated with higher fish values, while a red dot indicates that an earlier date is correlated with higher fish values. Predictors that produced an absolute R value of at least 0.45 with at least one observed value are shown here; the full suite of calculated R values is shown in Supplemental Figure 1.\\label{fig:corrMatrixFig}"}

# CURRENTLY HERE: add spawners to corr. matrix

# identify which columns we should keep in our correlation analysis
keepers_co = c(non_preds, as.character(unique(ctl$Var1)))
metrics_tab_screened = metrics_tab[,keepers_co]

# Addl screening for temporal relevance to Chinook freshwater period
metrics_before_chinook_outmigrate = 
  colnames(metrics_tab_screened) %in% non_preds |
  grepl(pattern = "d1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "f1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "w1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "s1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "wy1", x = colnames(metrics_tab_screened)) 
keepers_ch = intersect(x = keepers_co, colnames(metrics_tab_screened)[metrics_before_chinook_outmigrate])

metrics_tab_screened_chinook = metrics_tab_screened[,keepers_ch]

# Run correlations for all metrics in coho table (which includes all metrics in chinook table)
corr_matrix_pearson = calc_corr_matrix(metrics_tab_screened, preds_all = preds_all, corr_method = "pearson")


# find prediction subset for figure.
inclusion_threshold = 0.45
greater_than_thresh_finder = apply(X= corr_matrix_pearson, MARGIN = 1,
                                function(x){sum(abs(x) >= inclusion_threshold,
                                                na.rm=T) > 0})
# pred_subset = row.names(corr_matrix_pearson)[greater_than_thresh_finder]
pred_subset = row.names(corr_matrix_pearson)

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  
corr_matrix_fig_2(corr_matrix = corr_matrix_pearson, 
                  pred_subset = pred_subset,
                  preds_in_order = preds_all)
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


## Lasso regression

Lasso regression findings included results from the 50% test-train subsets and from the full dataset (Figures \@ref(fig:lassoResultsCoho) and \@ref(fig:lassoResultsChinook); Tables \@ref(tab:predAppearTabCoho) and \@ref(tab:predAppearTabChinook)). During the test-train step, each of the 1,716 and 10,000 (coho and Chinook, respectively) subsets produced an optimal lambda value and associated regression model with a number of non-zero coefficients (degrees of freedom). The test errors informed the selection of the final lambda value, while the order of appearance of the non-zero coefficients in their optimal regression models allowed us to assess general predictor rank stability. During the full dataset analysis, we examined predictor coefficient values and percent of variability (deviation from the mean) in ecological data explained by hydrology across a range of lambda values. 

Finally, we used the final lambda value and the full dataset to generate a regression model to be used as a predictive tool (the Hydrologic Benefit function). As mentioned in Methods, we selected normalized values of reproductive success for both species as the ecological response variable: coho smolts per female spawner (coho spf) and Chinook juveniles per adult spawner (Chinook jpa). These metrics isolate the effects of the freshwater environment on a given salmon cohort and minimize the importance of ocean conditions or cohort strength. 

### Cross-validation and selection of penalty value (lambda)

* cross-validation using $k$ folds, in which the data is split into to test and training data sets. default number of folds is 10; reduced number of folds to the maximum number in which the 

```{r kfold_lambda_finding, echo = FALSE}

# without spawners

# # calculate lasso regression model and cross-validation objects
# # (lasso: alpha = 1; ridge: alpha = 0)
# mod_obj_co = kfold_cv(mt = metrics_tab_screened, y_val = y_val_coho, alpha = 1)
# mod_co = mod_obj_co$mod; cv_co = mod_obj_co$cv
# 
# mod_obj_ch = kfold_cv(mt = metrics_tab_screened_chinook, alpha = 1, 
#                       y_val = y_val_chinook)
#                       # y_val = "chinook_juv_per_adult")
# mod_ch = mod_obj_ch$mod; cv_ch = mod_obj_ch$cv
# 
# # extract coefficients from the model using the optimal lambda value found in cross-validation
# alt_lambda_co = .135
# coefs_co = get_pred_coefs(mod = mod_co, cv = cv_co, coef_digits = 3, alt_lambda = alt_lambda_co)
# coefs_ch = get_pred_coefs(mod = mod_ch, cv = cv_ch, coef_digits = 3)


### With spawners
mod_obj_co = kfold_cv_plus_spawn(mt = metrics_tab_screened, 
                                 y_val = y_val_coho,
                                 alpha = 1)
mod_co = mod_obj_co$mod; cv_co = mod_obj_co$cv

mod_obj_ch = kfold_cv_plus_spawn(mt = metrics_tab_screened_chinook, alpha =1, 
                      y_val = y_val_chinook)
mod_ch = mod_obj_ch$mod; cv_ch = mod_obj_ch$cv
coefs_co = get_pred_coefs(mod = mod_co, cv = cv_co, coef_digits = 3)
coefs_ch = get_pred_coefs(mod = mod_ch, cv = cv_ch, coef_digits = 3)
```


```{r lassoResultsCohoChinook, echo = F, warning = F, fig.height = 8, fig.cap = "Results of lasso regression to predict log-transformed coho and Chinook outcomes with Z-scored hydrologic metrics. Models with more coefficients explain a greater fraction of deviance in the dataset (middle panel), but also produce higher test errors (top panel), indicating some overfitting at lower lambda values. Higher values of lambda tend to shrink the absolute values of regression coefficients toward 0 (bottom panel).\\label{fig:lassoResultsChinook}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)}

lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, mod_ch = mod_ch
              # ,alt_lambda_co = alt_lambda_co
              )
# par(mfrow = c(3,2))
# # Row 1: CV error and min lambda
# plot(cv_co); grid()
# title(main = yvlt$y_val_label[yvlt$y_val==y_val_coho], line = 3)
# abline(v=log(cv_co$lambda.min), lty = 2, lwd = 2, col = "brown")
# abline(v = log(alt_lambda_co), lty = 3, lwd = 3, col = "dodgerblue")
# legend(x = "topright", legend = "A", bty = "n") # panel label
# 
# plot(cv_ch); grid()
# title(main = yvlt$y_val_label[yvlt$y_val==y_val_chinook], line = 3)
# abline(v=log(cv_ch$lambda.min), lty = 2, lwd = 2, col = "brown")
# legend(x = "topright", legend = "B", bty = "n") # panel label
# 
# 
# #Row 2: variance explained
# plot(log(mod_co$lambda), mod_co$dev.ratio, type = "l",
#      xlab = expression(Log(lambda)), ylab = "Fraction of null deviance explained")
# grid()
# abline(v=log(cv_co$lambda.min), lty = 2, lwd = 2, col = "brown")
# abline(v = log(alt_lambda_co), lty = 3, lwd = 3, col = "dodgerblue")
# legend(x="bottomleft", lwd = 2, lty = c(2,3), col= c("brown", "dodgerblue"), 
#        legend = c(expression(Min.~err.~lambda~from~CV), expression(Alternative~lambda)))
# legend(x = "topright", legend = "C", bty = "n") # panel label
# 
# plot(log(mod_ch$lambda), mod_ch$dev.ratio, type = "l", ylim = c(0,1),
#      xlab = expression(Log(lambda)), ylab = "Fraction of null deviance explained")
# grid()
# abline(v=log(cv_ch$lambda.min), lty = 2, lwd = 2, col = "brown")
# legend(x = "topright", legend = "D", bty = "n") # panel label
# 
# 
# #Row 3: coefficients
# plot(mod_co, xvar = "lambda", xlab = expression(Log(lambda))); grid()
# abline(v=log(cv_co$lambda.min), lty = 2, lwd = 2, col = "brown")
# abline(v = log(alt_lambda_co), lty = 3, lwd = 3, col = "dodgerblue")
# legend(x = "topright", legend = "E", bty = "n") # panel label
# 
# plot(mod_ch, xvar = "lambda", xlab = expression(Log(lambda))); grid()
# abline(v=log(cv_ch$lambda.min), lty = 2, lwd = 2, col = "brown")
# legend(x = "topright", legend = "F", bty = "n") # panel label

if(save_imgs == TRUE){
  dev.off()
  # save predictor appearance tab
  pred_tab_filename = "Supplemental Table 3. Coho Salmon Lasso Coefficients.csv"
  write.csv(x=coefs_co$coef_all, file=file.path(graphics_dir,pred_tab_filename),
            quote=F, row.names = F)
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1

```



### Test error and selection of final lambda value


### Regression coefficients and fraction of deviation (full dataset)

As mentioned in the methods, using the full dataset, 100 equidistant values were used within the potential optimal range (identified in step 6) to generate a series of regression models to predict ecological outcomes for coho and Chinook. As is typical in lasso regression, coefficient values in these models approach 0 as lambda values increase (Figures \@ref(fig:lassoResultsCoho) and \@ref(fig:lassoResultsChinook), lower panels). Notably, a common interpretation is that the order of disappearance (from left to right) or appearance (from right to left) reflects the order of predictor importance; i.e., the single non-zero coefficient remaining at the highest lambda value is the most important predictor in the dataset (`BY_recon_200` in the case of coho spf).

The fraction of the deviation of the observed values from the mean is a function of the lambda value. For the full dataset, this fraction ranges from 0% of (with all coefficients set to 0) to 100% of deviation. The number of non-0 coefficients explaining 100% of variation is 12 and 20 for coho and Chinook respectively (Figures \@ref(fig:lassoResultsCoho) and \@ref(fig:lassoResultsChinook), middle panels). This matches the general rule of thumb that with high-dimensional data, it is often possible to explain 100% of deviation by incorporating data from as many or more predictors than the number of observations [@; EtAlIntroduction2013]. 

To explain 20% of Chinook deviation, the regression model needed 5 non-0 coefficients (or degrees of freedom), while for coho only 1 was necessary. Similarly, to explain 50% of variation required 8 and 5 degrees of freedom for Chinook and coho respectively (Figures \@ref(fig:lassoResultsCoho) and \@ref(fig:lassoResultsChinook), middle panel). 

## Hydrologic Benefit Function

For each species, the predictive model of ecological observations was based on the selected final lambda values, and refered to as the Hydrologic Benefit (HB) function. The HB function for coho is composed of an intercept and five non-zero coefficients, while for Chinook it includes only one non-zero coefficient (Tables \@ref(tab:coefTableCoho) and \@ref(tab:coefTableChinook)). While many coefficients (as well as $R$ values in the correlation analysis) match the current understanding of local flow-ecology relationships, some do not (see Discussion).


```{r coefTableCoho, echo = F, warning =F, results = 'asis'}

# Retrieve coefficients from lasso model

coefs_interp_names = names(coefs_co$coef_non0_only)
coefs_interp = as.character(coefs_co$coef_non0_only)
names(coefs_interp) = coefs_interp_names
# add interpretation to each non-0 coefficient
if(y_val_coho == "coho_smolt_per_fem" & log_transform_eco_metrics == F & zscore_flow_metrics == T){
  coefs_interp$f1_recon_120 = "Earlier full-system reconnection (120 cfs, fall of parents' spawning)"
  coefs_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_interp$f2_FA_Dif_num = "Smaller fall flow increase (as juvenile fish)"
}
if(y_val_coho == "coho_smolt_per_fem" & log_transform_eco_metrics == T & zscore_flow_metrics == T){
    coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
    coefs_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and hatchlings)"
    coefs_interp$f2_FA_Dif_num = "Smaller fall pulse (as juvenile fish)"
    coefs_interp$s2_SP_ROC = "Faster rate of change (as outmigrating smolt)"
}
if(y_val_coho == "coho_smolt_abun_est" & log_transform_eco_metrics == F & zscore_flow_metrics == T){
  coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
  coefs_interp$f2_FA_Dif_num = "Smaller fall flow increase (as juvenile fish)"
}
if(y_val_coho == "coho_smolt_abun_est" & log_transform_eco_metrics == T & zscore_flow_metrics == T){
  # coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
  coefs_interp$f2_FA_Dif_num = "Smaller fall flow increase (as juvenile fish)"
  coefs_interp$f1_FA_Dif_num = "Larger fall flow increase (during parents' spawning)"
  coefs_interp$s2_SP_ROC = "Faster rate of change, spring recession (as outmigrating smolt)"
}

coefs_co_vals = c(round(coefs_co$int_and_coefs$coef, 3))
coefs_co_interp = c("(Intercept)", unlist(coefs_interp[coefs_co!="0"]))
coefs_co_ft = data.frame(Predictor = c(names(coefs_co_interp)),
                         Value = as.vector(coefs_co_vals),
                         Description = coefs_co_interp)

caption_text = "Values for the intercept and coefficient terms in the Hydrologic Benefit function for coho spf, including a description of which phenomena are associated with higher ecological outcome values."

coco_tab_ft = flextable(data=coefs_co_ft)
coco_tab_ft = set_caption(coco_tab_ft, caption = caption_text)
coco_tab_ft = flextable::width(coco_tab_ft,j=1,  width = 1.5)
coco_tab_ft = flextable::width(coco_tab_ft,j=2,  width = 1)
coco_tab_ft = flextable::width(coco_tab_ft,j=3,  width = 3)
coco_tab_ft = flextable::set_header_labels(coco_tab_ft,
                                           values = list(
                                             Predictor ="Predictor", 
                                             Value = "Value",
                                             Description = "Greater Hydrologic Benefit value associated with"))
coco_tab_ft


```



```{r coefTableChinook, echo = F, warning =F, results = 'asis'}

# Retrieve coefficients from lasso model
coefs_interp_names = names(coefs_ch$coef_non0_only)
coefs_ch_interp = as.character(coefs_ch$coef_non0_only)
names(coefs_ch_interp) = coefs_interp_names

# add interpretation to each coefficient
if(y_val_chinook == "chinook_juv_per_adult"){
  coefs_ch_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
  coefs_ch_interp$s1_SP_ROC_Max = "Slower max. spring recession rate (as outmigrating smolt)"
}
if(y_val_chinook == "chinook_juvenile_abundance"){
  # coefs_ch_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
  # coefs_ch_interp$w2_Wet_BFL_Dur = "Longer wet season (wet season 2, they're not here)"
}


coefs_ch_vals = coefs_ch$int_and_coefs$coef
coefs_ch_interp = c("Intercept", unlist(coefs_ch_interp[coefs_ch!="0"]))
coefs_ch_ft = data.frame(Predictor = c(names(coefs_ch_interp)),
                         Value = as.vector(round(coefs_ch_vals,3)),
                         Description = coefs_ch_interp)


caption_text = "Values for the intercept and coefficient terms in the Hydrologic Benefit function for Chinook juvenile abundance, including a description of which phenomena are associated with higher ecological outcome values."

coch_tab_ft = flextable(data=coefs_ch_ft)
coch_tab_ft = set_caption(coch_tab_ft, caption = caption_text)
coch_tab_ft = flextable::width(coch_tab_ft,j=1,  width = 1.5)
coch_tab_ft = flextable::width(coch_tab_ft,j=2,  width = 1)
coch_tab_ft = flextable::width(coch_tab_ft,j=3,  width = 3)
coch_tab_ft = flextable::set_header_labels(
  coch_tab_ft,
  values = list(
    Predictor ="Predictor", 
    Value = "Value",
    Description = "Greater Hydrologic Benefit value associated with"))
coch_tab_ft
```



### Predictors and coefficients in the selected models

The predictive model of coho spf included one positive coefficient, for predictor `RY_discon_200`. This indicates that delayed river disonnection in the spring is related to higher relative coho reproduction. All other coeficients are negative, including three metrics related to reconnection timing, indicating that earlier reconnections at the end of the dry season are related to higher relative coho reproduction. The range of flow values indicate possibly differential sensitivity to different flow phenomena: 8 cfs only occurs at the end of a very dry water year, while 120 cfs typically means that coho salmon have access to some of their preferred tributary habitat [@SiskiyouCountyScott2021]. One coefficient is somewhat counterintutive, suggesting that a higher rearing year dry season flow magnitude is associated with reduced coho reproduction; in our experience we would expect the opposite to be true.

The predictive model of Chinook jpa contains one non-zero coefficient, which is associated with predictor `log_by_tot_flow_sepdec`. This suggests that the order-of-magnitude of brood year total flow is negatively related to relative reproduction of Chinook. It's possible that this relationship is driven by high-flow events in wet years that could produce scouring flows, negatively impacting Chinook eggs laid in the mainstem of the Scott River.

```{r calc_hbf_values_tabs, echo = F, warning =F}


# retrieve hydrology for all years of FJ flow
brood_year_hydro_tab_long = tabulate_hydro_by_affected_brood_year(
  brood_years = 1942:2022, smolt_years = 1944:2024)

metrics_tab_long = calc_metrics_hydro_by_affected_brood_year(
  hydro_by_brood_year = brood_year_hydro_tab_long,
  thresholds = thresh_for_corr_fig, 
  reduce_to_eco_data_years_only = F) 

metrics_tab_long = metrics_tab_long[,intersect(colnames(metrics_tab_screened), 
                                               colnames(metrics_tab_long))]

if(log_transform_eco_metrics == T){
  metrics_tab_long[,yvlt$y_val] = log10(metrics_tab_long[,yvlt$y_val])
}

if(zscore_flow_metrics == T){
  zscore_these = !(colnames(metrics_tab_long) %in% non_preds)
  metrics_tab_long[,zscore_these] = apply(X = metrics_tab_long[,zscore_these],
                                     MARGIN = 2, FUN = zscore_column_na_rm)
}


# metrics_tab_long = metrics_tab_long[ , keepers_co]

# calculate hbf for all years in which there are hydrodata
hbf_coho = get_hbf_tab(mt = metrics_tab_long, 
                       coefs = coefs_co$coef_non0_only, 
                       int = coefs_co$intercept)
hbf_chinook = get_hbf_tab(mt = metrics_tab_long, 
                          coefs = coefs_ch$coef_non0_only, 
                          int = coefs_ch$intercept)

# convert to absolute ecological observation numbers
if(log_transform_eco_metrics == T){
  hbf_coho$hbf_total_log = hbf_coho$hbf_total
  hbf_coho$hbf_total = 10^(hbf_coho$hbf_total_log)
  hbf_chinook$hbf_total_log = hbf_chinook$hbf_total
  hbf_chinook$hbf_total = 10^(hbf_chinook$hbf_total_log)
}
# calculate lowest hbf value
lowest_coho_spf_pred=min(hbf_coho$hbf_total)

```



### Predicted Hydrologic Benefit value over time

The visual match between predicted and observed values for coho spf is rather poor: predicted values do not range either as low or as high as observed values (Figure \@ref(fig:hbfOverTime), top panel). This matches the expectation that the selected regression model will explain only ~50% of the deviation from the mean (Figure \@ref(fig:lassoResultsCoho), middle panel). The visual match for Chinook, however, is significantly worse (Figure \@ref(fig:hbfOverTime), lower panel), corresponding to a regression model that explains <10% of deviation (Figure \@ref(fig:lassoResultsChinook), middle panel). 

Matching the historical flow trends discussed above (and tabulated in *Supplemental Table 2*), the predicted value of coho spf-equivalent produced by a given water year has trended downward over time (Figure \@ref(fig:hbfOverTime), top panel). The lowest predicted value, `r round(lowest_coho_spf_pred,1)` coho spf in brood year 2013, corresponds to the severe drought year of 2014. Conditions were so extreme in water year 2014 that emergency measures were taken by local agencies and conservation organizations to facilitate transport of salmon around disconnected river reaches [CDFW et al. -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015].

Conversely, for Chinook, because such an inflexible model was selected, no trend is visible in predicted values (Figure \@ref(fig:hbfOverTime), lower panel). 


```{r hbfOverTime, echo = F, warning = F, fig.height = 8, fig.cap = "Annual observed and predicted values of coho smolt produced per female spawner (coho spf, top panel) and Chinook juveniles produced per adult spawner (Chinook jpa, lower panel). Predicted quantities (black dots) are shown as Hydrologic Benefit (HB) function values. The predicted and observed values are plotted by each cohort's Brood Year. \\label{fig:hbfOverTime}"}

# Negative prediction values (considered physically impossible) are flagged but are retained to visually demonstrate the uncertainty in the exercise of predicting fish outcomes from hydrologic metrics alone, based on a small sample size.

# convert to absolute ecological observation numbers
if(log_transform_eco_metrics == T){
  metrics_tab_screened[,paste0(y_val_coho,"_log")] = metrics_tab_screened[,y_val_coho]
  metrics_tab_screened[,y_val_coho] = 10^metrics_tab_screened[,paste0(y_val_coho,"_log")]
  metrics_tab_screened[,paste0(y_val_chinook,"_log")] = metrics_tab_screened[,y_val_chinook]
  metrics_tab_screened[,y_val_chinook] = 10^metrics_tab_screened[,paste0(y_val_chinook,"_log")]
}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_coho]
  par(mfrow=c(2,1))
  # Panel 1. Coho
  hbf_over_time_fig(mt = metrics_tab_screened,
                    hbf_tab = hbf_coho, y_val = y_val_coho,
                    y_val_axis = y_axis_label)
  
  # Panel 2. Chinook
  hbf_chinook$hbf_total[!is.finite(hbf_chinook$hbf_total)]=NA
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_chinook] 
  hbf_over_time_fig(mt = metrics_tab_screened,
                    hbf_tab = hbf_chinook, 
                    y_val = y_val_chinook,
                    y_val_axis = y_axis_label) 
  
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1


```

<!-- ```{r hbfPredVObs, echo = F, warning = F, fig.height = 8, fig.cap = "PredVObs. \\label{fig:predVObs}"} -->

<!-- # Negative prediction values (considered physically impossible) are flagged but are retained to visually demonstrate the uncertainty in the exercise of predicting fish outcomes from hydrologic metrics alone, based on a small sample size. -->

<!-- fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png")) -->
<!-- if(save_imgs == TRUE){ -->
<!--   png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi) -->
<!--   y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_coho] -->
<!--   par(mfrow=c(2,1)) -->
<!--   # Panel 1. Coho -->
<!--   hbf_over_time_fig(mt = metrics_tab_screened, -->
<!--                     hbf_tab = hbf_coho, y_val = y_val_coho, -->
<!--                     y_val_axis = y_axis_label) -->

<!--   # Panel 2. Chinook -->
<!--   hbf_chinook$hbf_total[!is.finite(hbf_chinook$hbf_total)]=NA -->
<!--   y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_chinook]  -->
<!--   hbf_over_time_fig(mt = metrics_tab_screened, -->
<!--                     hbf_tab = hbf_chinook,  -->
<!--                     y_val = y_val_chinook, -->
<!--                     y_val_axis = y_axis_label)  -->


<!--   dev.off() -->
<!-- } -->
<!-- if(include_figs==T){knitr::include_graphics(fig_path)} -->
<!-- fig_i = fig_i +1 -->

<!-- ``` -->


### Hydrologic Benefit function component contributions

The predicted HB values can be broken out into the value contributed by each predictor (Figure \@ref(fig:hbfBarchart); the intercept term is excluded for ease of visualization). For coho spf, the largest contributions are from brood year fall reconnection timing (`BY_recon_200` and `BY_recon_100`); a negative value indicates that earlier reconnection timing is associated with higher relative smolt production. The next largest contribution is from spring disconnection in the rearing year: higher smolt production is predicted from later disconnection timing. Two other predictors, `RY_recon_8` and `RY_DS_Mag_90` contribute only minor amounts, although occasionally, in years with very low dry season flow and delayed fall reconnections, predictor RY_recon_8 contributes a meaningful negative value (Figure \@ref(fig:hbfBarchart), top panel). For Chinook, all variation is introduced by the predictor `log_BY_tot_flow_sepdec`, since the model includes only one non-zero coefficient.


```{r hbfBarchart, echo = F, warning = F, fig.height = 8, fig.cap = "Contributions to annual Hydrologic Benefit values (coho spf-equivalent, top panel, and Chinook jpa-equivalent, lower panel). A positive value indicates that a greater quantity contributes a positive value to the predicted ecological outcome in that cohort (e.g., a later spring disconnection produces more predicted coho spf). A negative value indicates that a larger number contributes a negative value to the predicted outcome (e.g., a later fall reconnection date produces fewer predicted coho spf in that cohort).\\label{fig:hbfBarchart}"}

# arrange data - Coho
# only plot if there are at least 1 non-0 coefficient

hbf_coho$hbf_total = NULL # remove this column for this figure
hbf_coho$hbf_total_log = NULL # remove this column for this figure
is_it_0 = apply(X=hbf_coho, MARGIN = 2, FUN = mean, na.rm=T)
keep_cols = colnames(hbf_coho[abs(is_it_0)>0])
comp_names_co = keep_cols[keep_cols != "brood_year"]
y_text_co = paste0("Contrib. to HB value (",
                   yvlt$y_val_label[
                     yvlt$y_val==y_val_coho],")")
if(length(comp_names_co)>0){
  bar_data_co = hbf_coho[,keep_cols]
  graph_cols = c("Brood Year", comp_names_co)
  colnames(bar_data_co) = graph_cols
  bd_melt_co = reshape2::melt(dat = bar_data_co, id.vars = "Brood Year")
  colnames(bd_melt_co)[3] = y_text_co
}

# Arrange data - chinook
hbf_chinook$hbf_total = NULL # remove this column for this figure
hbf_chinook$hbf_total_log = NULL # remove this column for this figure
is_it_0 = apply(X=hbf_chinook, MARGIN = 2, FUN = mean, na.rm=T)
keep_cols = colnames(hbf_chinook)[abs(is_it_0)>0]
comp_names_ch = keep_cols[keep_cols != "brood_year"]
y_text_ch = paste0("Contrib. to HB value (",
                   yvlt$y_val_label[
                     yvlt$y_val==y_val_chinook],")")
if(length(comp_names_ch)>0){
  bar_data_ch = hbf_chinook[,keep_cols]
  graph_cols = c("Brood Year", comp_names_ch)
  colnames(bar_data_ch) = graph_cols
  bd_melt_ch = reshape2::melt(dat = bar_data_ch, id.vars = "Brood Year")
  colnames(bd_melt_ch)[3] = y_text_ch
}
# Bar charrrt

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs==T){
  if(length(comp_names_co)>0){
    y_text = colnames(bd_melt_co)[3]
    hbf_bar_co = ggplot(data = bd_melt_co, 
                        aes(x = `Brood Year`, 
                            # y = `Contrib. to HB value (Coho smolt per fem. spawner)`,
                            y = `Contrib. to HB value (Est. num. coho smolt)`,
                            fill = variable)) + 
      geom_bar(stat = "identity") + 
      scale_fill_brewer(palette = "Spectral") +
      theme(legend.position = "right", legend.direction = "vertical")
  }
  
  if(length(comp_names_ch)>0){
        y_text = colnames(bd_melt_ch)[3]
        hbf_bar_ch = ggplot(data = bd_melt_ch, 
                        aes(x = `Brood Year`, 
                            # y = `Contrib. to HB value (Chinook juv. per adult)`,
                            y = `Contrib. to HB value (Num. Chinook juveniles)`,
                            fill = variable)) + 
      geom_bar(stat = "identity") + 
      scale_fill_brewer(palette = "Spectral") +
      theme(legend.position = "right", legend.direction = "vertical")
  }
  
  if(length(comp_names_co)>0 & length(comp_names_ch)>0){
        hbf_bar = arrangeGrob(hbf_bar_co, hbf_bar_ch, 
                               nrow=2, ncol=1)
                              # nrow=1,ncol=2) # for ppt slide
  } else if(length(comp_names_co)>0 & length(comp_names_ch)==0){
        hbf_bar =  hbf_bar_co
  } else if(length(comp_names_co)==0 & length(comp_names_ch)>0){
        hbf_bar =  hbf_bar_ch
  }
  
    ggsave(filename = fig_path, plot = hbf_bar, width = 7, height = 8, units="in")
  # ggsave(filename = fig_path, plot = hbf_bar, width = 11.5, height = 4.2, units="in")
}
  

if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1

```



## MARSS


```{r marss, echo = F, warning = F, fig.height = 8, fig.cap = "marss results. \\label{fig:marss}"}

# Negative prediction values (considered physically impossible) are flagged but are retained to visually demonstrate the uncertainty in the exercise of predicting fish outcomes from hydrologic metrics alone, based on a small sample size.

# fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
# if(save_imgs == TRUE){
#   png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)

# y_obs_tab = get_obs_data_for_MARSS(metrics_tab = metrics_tab,
#                                    # y_val_names = c("coho_smolt_abun_est", "chinook_juvenile_abundance",
#                                    #                 "coho_smolt_per_fem", "chinook_juv_per_adult"))
#                                    y_val_names = c(y_val_coho, y_val_chinook))
# mod.fit = get_model_fit_for_MARSS(y_obs_tab = y_obs_tab, method = "BFGS")
# plot(mod.fit)

# y_obs_tab_co = get_obs_data_for_MARSS(metrics_tab = metrics_tab,
#                                    y_val_names = y_val_coho)
# y_obs_tab_ch = get_obs_data_for_MARSS(metrics_tab = metrics_tab,
#                                    y_val_names = y_val_chinook)
# mod_co = get_model_fit_for_MARSS(y_obs_tab = y_obs_tab_co, method = "BFGS")
# plot(mod_co)
# mod_ch = get_model_fit_for_MARSS(y_obs_tab = y_obs_tab_ch, method = "BFGS")
# plot(mod_ch)
# 
# # coef(mod_co)
# 
# ggplot2::autoplot(mod_co)
# 
# ggplot2::autoplot(mod_ch)

# x = metrics_atb
#   dev.off()
# }
# if(include_figs==T){knitr::include_graphics(fig_path)}
# fig_i = fig_i +1

```



# Discussion

The findings described above suggest that, in this case study, hydrology can explain about half of the variation in a key ecological outcome for coho salmon, though as a predictive tool it has some limitations. 

## Previous work and limitations of a hydrologic predictor approach

In many previous studies of flow-ecology relationships (especially related to fisheries), predictors used to model the ecological response are flow-derived metrics, because flow data is often continuous and more abundant than other data types. Such models rely on the assumption that flow, directly or as a proxy for other variables (e.g., habitat) is the limiting factor in ecological recruitment, and thus that changes in flow can be directly translated to a population response. However, this ignores ecological theory. Under many circumstances, complex internal population feedbacks (such as high juvenile fish density leading to some juvenile fish mortality) or community dynamics (food webs) will be the limiting factors on fish population size. Consequently, many authors have argued that models of fish population responses to hydrologic changes should explicitly include ecological population modeling in addition to physical factors such as flow or geomorphology [@RosenfeldAssessing2003; @AndersonEtAlInstream2006; @LancasterDownesLinking2010; @AcremanEtAlEnvironmental2014; @ShentonEtAlPutting2012]. Additionally, in at least one case, fish population differences were not successfully predicted with a model based only on flow metrics; other variables such as water temperature were necessary to capture population shifts [@McManamayEtAlApplication2013].

In spite of these known limitations, the HB function proposed here uses only hydrologic predictors. In part this is a pragmatic approach, as this work is intended to set the foundation for assessing flow conditions in speculative hydrologic models, which do not simulate non-hydrologic, ecologically-relevant factors such as water quality or internal population dynamics. Furthermore, previous work suggests that seasonal flow availability is a major limiting factor on the local coho salmon fishery, supporting the hydrologic predictor only approach in this case [SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilLimiting2005; NMFS -@NationalMarineFisheriesServiceFinal2014]. Lastly, the proposed HB function avoids some of the disadvantages of the snapshot method of comparing the two states of natural and altered flows [@WheelerEtAlStates2018], because the hydro-ecological dataset is relatively long. This temporal structure, covering a wide range of water year types, makes it possible to test the hypothesis that a measurable relationship exists between hydrologic signal and ecologic response, even within an otherwise more complex relationship involving many non-hydrologic factors.


## Correlations and predictor selection results suggest potential mechanisms for flow-ecology relationships

The correlation and predictor selection analyses support several findings (wet season duration, scouring flows, fall flow timing and outmigrants) that match existing understanding of coho ecohydrology, as well as one finding (fall flow timing and spawners) that does not match the current understanding. Mechanisms supporting some flow-ecology relationships are discussed below.

Experiencing a longer wet season as newly hatched fry (`RY_Wet_BFL_Dur`, or rearing year wet season baseflow duration) is associated with higher juvenile abundance for both species (Figure \@ref(fig:corrMatrixFig)). Relatedly, a later rearing year dry season onset, and a later spring disconnection (in both the rearing and smolt years) are also associated with more outmigrating coho smolt. These correlations suggest that a longer initial wet season has a beneficial effect on the hatching cohort. Additionally, a higher number of RY scouring days seems to be related to lower Chinook outmigrants, whereas it has no relationship with coho outmigrants, matching the understanding of which species' preferred habitat types are more vulnerable to scouring.

Additionally, in one of the strongest correlation signals, earlier fall reconnection timing (earlier fall spawning flows) is associated with higher coho spf. In general, earlier fall flows in the brood year are thought to be beneficial to coho salmon, but here it appears that this is only true for the absolute number of outmigrating juveniles. Corroborating the correlation results, among the predictors selected by lasso regression, metrics contributing the most to predicted coho spf values occur during the window of their parents' spawning (`BY_recon_200` and `BY_recon_100`) and, to a lesser extent, in the spring and fall of their rearing year (`RY_discon_200` and `RY_recon_8`) (Figure \@ref(fig:hbfBarchart)). This supports an interpretation that spawning conditions may exert a significant influence on the mortality rates of the hatching juveniles. One potential mechanism is that during dry water years, when fall reconnection dates are delayed, coho have been known to spawn in suboptimal habitat [e.g., @MagranetScott2015]. Eggs laid in suboptimal conditions suffer from higher mortality rates for multiple reasons, including egg burial by transported sediment, channel bed scouring, or unfavorable water quality [@BjornnReiserInfluences1991]. In wetter years, early reconnection flows and related access to more and higher-quality habitat may allow spawning salmon to select more favorable nesting sites.

However, a higher number of *spawners* is in fact associated with *later* fall flows (Figure \@ref(fig:corrMatrixFig)). Relatedly and consistent with these results, the total flow volume in the four months of the brood year period is also negatively correlated with the number of coho spawners. An explanation for this counterintuitive finding may be beyond the scope of the present study: the correlation for later flow-spawner correlation is weaker than for early flow-juveniles, and the returning spawners may also be affected by ocean conditions. In any case, these findings suggest that earlier fall reconnection may allow the spawning population the best opportunity for reproductive success.

## Reconnection at different flow thresholds may represent distinct ecological events

In this watershed, flow thresholds at the Fort Jones gauge can be closely tied to physical access for spawning. Salmon passage to access the lower mainstem is possible at a Fort Jones flowrate of ~20-40 cfs (though this is subject to some debate), while access to upper tributaries is generally associated with a Fort Jones flowrate of >100 cfs  [*pers. comm.*, @Sommarstrom2020]. The fact that the lasso method identified multiple flow thresholds in the coho spf model suggests that the coho may experience these different degrees of river connectivity and/or flow conditions as events with different ecological consequences.

The river reconnection dates of multiple flow thresholds are correlated with each other and, to varying degrees, with biological monitoring data (see Results). The correlations with ecological observations support the current scientific understanding that the timing of restoration of habitat connectivity after dry periods in the Scott River is related to the reproductive success of spawning salmon [e.g., Siskiyou County -@SiskiyouCountyScott2021; SRWC -@ScottRiverWatershedCouncilRestoring2018]. However, the details, such as which specific numerical flow threshold was identified as the most important in the minimization of the equation in Section 3.6.1, are probably somewhat artifactual and would be sensitive to the addition of new future data points.

## Differences in model flexibility possibly driven by biology

At a given relative test error, the Chinook model explains a smaller fraction of deviation than the coho model  (Figures \@ref(fig:lassoResultsCoho) and \@ref(fig:lassoResultsChinook)). This could be interpreted as a meaningful finding; i.e., it may be due to Chinook being less sensitive than coho to flow conditions. Or, it could be a statistical artifact: the Chinook model, with a larger sample size, may produce higher relative test errors in general. Given the size of the difference between the species (i.e., five non-zero coefficients for coho at 1.0 relative test error versus one for Chinook), it is possible both effects are present.

If we adopt the interpretation that hydrologic metrics have a greater capacity to predict relative reproduction in coho salmon than in Chinook, this difference can be attributed to any number of distinctions in the life history and reproductive strategies of the two species  (see Section 2.2.4). Some possibilities include:

* Chinook prefer larger spawning gravels found on the mainstem of the Scott River, while coho salmon prefer smaller tributary streams, meaning that coho salmon must travel farther through the stream system to access their preferred spawning habitat. Consequently, coho salmon may be more sensitive to the amount and timing of river connectivity during their spawning window.
* Chinook populations tend to be larger than coho, which could mean they are more limited by internal population dynamics, while coho reproduction limits may be more determined by flow conditions.
* Chinook typically do not oversummer in the freshwater system, potentially making them less vulnerable than coho to dry season conditions.
* Chinook populations may be more strongly affected by ocean conditions than coho salmon, possibly due to behavior differences during their period of ocean residence, which is not examined here. This factor may exert a more powerful control on the number of returning spawners than freshwater conditions. 

Regardless of the ultimate cause(s), this difference in predictability underscores the fact that the prediction exercise undertaken in this study can only be performed successfully for some species and some regions.


## Implications for water and fisheries management

This study contributes a novel approach and insights to the large body of work seeking to understand and conserve aquatic ecosystems in the Klamath basin, and in aquatic ecosystems in Mediterranean climates more generally. The threshold of a 1.0 average relative test error generated a much more flexible model for coho spf than for Chinook jpa (Tables \@ref(tab:coefTableCoho) and \@ref(tab:coefTableChinook)). The Chinook model has virtually no utility for predicting salmon outcomes (Figure \@ref(fig:hbfOverTime)); therefore, only the coho model will be evaluated as a predictive tool.

The predictive exercise for coho spf suggests that using flow alone to predict fish outcomes involves non-negligible uncertainties: HB function error terms (predicted minus observed values) are substantial (Figure \@ref(fig:hbfOverTime)). The coho spf HB function can somewhat accurately indicate a high or a low year (if we define the boundary between the two domains as 55 coho spf), though the range of predictions does not match the variability in the observations. This is partly a consequence of lasso regression imposing a penalty on model flexibility, and represents a conservative estimate of the degree of variation in ecological outcomes that can be explained with flow metrics.

At a regional scale, this predictive tool could be used to assess simulated hydrologic outcomes of management actions in terms of the direct effect they would have on coho salmon reproduction. If used in that context, its limitations should be highlighted, including its average test error (100% of the average coho spf observation) and the fact that the hydrology explains only about 50% of the variation in the ecological data.

We expect that the proposed approach could be employed in other regional studies, though in systems with shorter or minimal ecological monitoring records, opportunities to find correlations between flow and biological metrics may be sample size-limited to an even greater degree than in this study. However, this study may show the value of even a dozen years of monitoring data in a range of water year types, and could provide motivation to continue investing in data collection and the monitoring of sensitive species. 

# Conclusions

This case study uses the functional flow framework and long-term biological monitoring to relate hydrologic conditions to watershed-scale anadromous fish reproduction rates. The empirical flow-biology relationships evaluated here also suggest hypotheses regarding the watershed- and species-specific mechanisms of ecological response to flow variability.

To learn if it was possible to empirically quantify a hydrologic regime that meets the ecological needs of coho salmon in the Scott River watershed, we examined correlations between several dozen hydrologic metrics and local salmon observations. We found several metrics, both from prior studies [@PattersonEtAlHydrologic2020; @YarnellEtAlFunctional2020] and designed for this study (e.g. Figure \@ref(fig:reconnectExplainerHydrograph)), that appeared correlated with the number of coho smolts produced per female spawner (coho spf) and the number of Chinook juveniles produced per adult spawner (Chinook jpa) (Figure \@ref(fig:corrMatrixFig)). The metrics contributing the most to predicted coho spf values occur during the window of their parents' spawning and, to a lesser extent, in the spring and fall of their rearing year (Figure \@ref(fig:hbfBarchart)). This supports an interpretation that spawning conditions may exert a significant influence on the mortality rates of the hatching juveniles.

Using lasso regression, we calculated a predictive model of annual normalized reproduction for each salmon species (Figures \@ref(fig:lassoResultsCoho) and \@ref(fig:lassoResultsChinook)). With a relative test error threshold of 1.0, the model for Chinook was virtually useless as a predictive tool. Conversely, the model for coho could explain about 50% of the variation in the ecological data. This suggests that the utility of this type of analysis is both region- and species-dependent.

With continuing trends of a narrowing wet season in the Scott River watershed (e.g., Figure \@ref(fig:reAndDisconTimeseries)), entities aiming to sustain local fisheries may find themselves working with ever-thinner margins for error. Globally, in communities living and working with local natural resources, climate change may transform biodiversity-preservation activities into long-term engineering of novel ecosystems. If this occurs, long-term monitoring and frequently re-evaluated flow-ecology relationships will be necessary to support such efforts.

\newpage


# References

<div id="refs"></div>

```{r, child=if (INCLUDE_SUPP) 'Kouba_2024_Fish_hydrometrics_Supplement.Rmd'}
```


---
title: A watershed-specific formula to predict coho salmon reproduction using river flow metrics
author: "Claire Kouba, Jason Weiner and Thomas Harter"
date: "Nov. 2023"
output: 
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
bibliography: library.bib
---

```{r setup_dirs_load_data, include = FALSE}


knitr::opts_chunk$set(echo = TRUE)

# library(rpostgis)
# library(postGIStools)
# library(stringr)
# library(rstudioapi)
# library(PerformanceAnalytics) # for data exploration/correlation plots
# library(tidyverse) #for read_field_data function
# # library(readxl) # for read_field_data function
# library(qpcR) # for AICc function
# #spatial data libraries
# library(rgdal)
# library(rgeos)
# library(lwgeom)
# library(maptools)
# library(RANN)
# library(RColorBrewer)
# library(raster)
# library(plyr)  # for barplots for climate fig
# library(xtable)

library(lubridate)
library(httr)
library(ggplot2) # for barplots 
library(gridExtra)
library(corrplot)  # for data exploration/correlation plots
library(dataRetrieval) # for usgs data
library(data.table) #month function
library(zoo) # rolling means
library(sf)
library(terra)
library(tmap)
library(grid) # for inset maps
library(cowplot) # for inset maps
library(ggthemes) # for colorblind palette
library(flextable)
library(glmnet) # lasso regression
library(here)

# Directories
ms_dir = here::here()
scratch_dir = file.path(ms_dir, "scratch_work")
data_dir = file.path(ms_dir, "Data")
graphics_dir = file.path(ms_dir, "Graphics and Supplements")

# Load spatial and tabular data

# If the data files don't exist locally,
#pull data from internet and local files
if(!file.exists(file.path(ms_dir,"manuscript_data.RData"))){
  source(file.path(ms_dir,"01_DataRetrieval_Cleaning_SaveLocal.R")) 
}
load(file.path(ms_dir, "manuscript_data.RData")) # Load data layers/tables
source(file.path(ms_dir,"02_Figure_Functions.R"))   # Load figure functions

# Save figures as images, yes or no?
save_figs_here = graphics_dir
save_imgs=T
replace_setting_fig = F
fig_i = 1

# pick last water year for the HB function to calculate a value for
last_wy = 2023
```

# Abstract {-}

In many rural areas in arid and semi-arid regions, balancing agricultural and environmental water demands is a key challenge facing resource managers. Although flow-ecology relationships are well-studied, the water needs of cultivated crops are generally better understood than those of aquatic ecosystems. In particular, the timing and magnitude of flow needed to sustain key ecological functions remain poorly quantified in many regions. This work aims to quantify hydrologic conditions that support persistence of key ecosystem species. We use the coho (*Oncorhynchus kisutch*) and Chinook (*Oncorhynchus tshawytscha*) salmon run in Scott Valley, a 2,109 km^2^ undammed rural watershed in northern California, USA, as a case study. We applied the functional flows framework to characterize the hydrology of each water year measured at a key long-term stream gauge. Taking advantage of a nearly two-decade ecological monitoring dataset, we **built linear models to predict coho and Chinook salmon reproductive success using combinations of one and two hydrologic metric predictors. We found that reproduction in coho salmon was more related to hydrology than in Chinook salmon. For coho, we used an ensemble of the three best linear models (based on predictors related to the timing of the dry-to-wet season transition and wet season duration) to formulate a Hydrologic Benefit function, summarizing the ecological services provided by the hydrology in different seasons into a single index value per water year.** This method for empirically deriving the highest-priority hydrologic functions for a threatened species could be used in other watersheds (if sufficient ecological data records are available, and if flow-hydrology relationships are identifiable for a given species) to evaluate trade-offs and support water management decisions in human-altered novel ecosystems. 

\newpage


<!-- # To Do list -->

<!-- *writing* -->

<!-- * make sure OCAR, and the 2-3-1 formula, is reflected in each subsection. what's the point of each section? -->
<!-- * Do the methods follow a lead/development structure? -->
<!-- * add to discussion: identifies the limiting factors in salmon reproduction. If fall flows were adequately addressed, perhaps the strongest correlations would be found in other seasons. -->

<!-- *comments from Noelle* -->

<!-- * possibly add note about value of reach-specific flow metrics in ecohydro analysis ("although the standard func flow metrics can be a good starting point, flow metrics fit to a site's reach morphology are highly valuable") -->

<!-- *comments from Thomas review* -->

<!-- * possibly mention 3 eras of flow data (pre-1970s, 70s-2000, 2000-present [megadrought]) -->

<!-- *comments from Jason* -->

<!-- * add transition statements related to objective at end of intro -->
<!-- * Discussion should be ~1000 words. mine is 2000 -->
<!-- * Conclusion, 300-500 words -->
<!-- * Total paper is 10,000 words. Probably need to cut some from Section 2 -->


# Introduction


## Motivation and objectives 

Reconciliation ecology posits that some human-impacted ecosystems should be considered irrevocably-altered, "novel" systems [@Moyle2014], with their own specific management concerns. To implement this philosophy, rather than working to restore novel ecosystems to pre-human conditions, a natural resource manager would embrace a role as earth system engineer, and would actively manage biodiversity in human-altered landscapes as a co-equal goal with extracting and cultivating natural resources to provide for human material needs [e.g., @RobertsonSwinton2005; @Arthington2014; @Acreman2014]. But critical knowledge gaps are abundant and make this dual objective seem intractable. In many river ecosystems, though general methods to characterize environmental flows have been in wide use for at least a decade [e.g., @Poff2010a; @Shenton2012; @Solans2016a], the regional-scale conditions that would maintain biodiversity are as yet unquantified or highly uncertain [@Poff2010b]. Higher certainty in quantitative ecological targets could support more robust decision making and trade-off analysis, potentially answering questions like: how close can managers get to the desired ecological conditions, and at what cost, particularly in a changing climate?

In practice, these questions are often asked and answered locally [@Tarlock1993]. The entities managing natural resources, and thus determining the regional persistence of non-human species, are typically the communities living and working with local resources. Reflecting this reality, the authors of this study have posed research questions tailored to conserving two specific salmon species, the threatened coho salmon (*Oncorhynchus kisutch*) and the less-threatened Chinook salmon (*Onchorhynchus tshawytscha*), in a specific study area: the Scott River watershed in northern California, USA. In this undammed, rural watershed, the primary way to manage water use is by managing land use, and balancing the competing water needs of fish and farmers is a key challenge for local water managers [Siskiyou County -@SiskiyouCounty2021]. Agricultural water needs are well-known and can be estimated and scheduled [@SiskiyouRCD1994; @Parry2013; DWR -@DWR2021], but, in spite of decades of investigation by local, state and federal actors [e.g., @SRWC_RCD2003; NMFS -@NMFS2014; CDFW -@CDFW2015b; CDFW -@CDFW2021b], the ecological water needs in this balancing act are not as well constrained. 

One method for estimating ecological water needs is the functional flows framework [@Poff1997; @Poff2010a]. Functional flow metrics are used to quantify potential ecological services provided by river flow in terms of flowrate amplitude, timing, frequency, and duration in distinct seasons of a water year, where water year is here defined to begin on October 1 of the year preceding the calendar year of the same number (i.e., water year 2020 begins on October 1, 2019). Recent work has refined these metrics for California hydrology and made the metric-calculating algorithms publicly available [@Yarnell2020; @Patterson2020].

To learn if it is possible to empirically quantify a hydrologic regime that meets the ecological needs of specific species (coho and Chinook salmon) in a specific ecological region (the Scott River watershed), we examine correlations between several dozen hydrologic metrics and local salmon observations. **We then used lasso regression to select the hydrologic metric predictors used to predict salmon outcomes. The result of the predictor selection was a Hydrologic Benefit function for each species, conceptually translating the various ecological services provided by hydrology across different seasons into a single value (in units of ecological observations) per water year. This work sets the stage for a quantitative comparison of competing natural resource management alternatives.

## History of flow-ecology relationships

A river's flow regime is often referred to as a "master variable" controlling geomorphic, chemical, and other conditions in its aquatic ecosystems, and organisms that have evolved to persist in specific flow regimes are commonly negatively affected by flow alteration [@Bunn2002a; @Poff2010a]. Consequently, in recent decades a diverse body of research has sought to identify and quantify ecological responses to changes in flow. Work on this topic spans multiple categories of ecological response, hydrologic predictor, and ultimate cause of hydrologic alteration. Two widely studied ecological response metric categories are, firstly, the stream health index, based on density and species richness of macroinvertebrates observed at designated sampling sites [e.g., @Monk2006; @Guareschi2014; @Kevic2018; @Mazor2018; @Larsen2021; @Peek2022], and secondly, and fish diversity and community assemblage [e.g., @McManamay2013; @Peterson2016; @Cartwright2017; @Sinnathamby2018; @Hain2018; @Guedes2020; @Yao2021). Ecological responses can also be based on the abundance of a single or a few species, often of fish [@Stewart-Koster2011; @Booth2014; @DeWeber2020; @Hale2023], as well as the extent of habitat types [@Chowdhury2007; @Brand2011] and the presence of organisms including vegetation and plankton [@Riis2008; @Catford2014; @Qian2016; @Tesfaye2017; @Saby2022]. Hydrologic predictors range widely, with a heavy emphasis on extreme (low or high) flow events and the duration of components of the flow regime [e.g., @Ayllon2014; @Lamouroux2015; @McManamay2015; @Bower2022]. Causes of the change in hydrology include the operation of dams, changes in human water use, climate change, and natural flow variability [e.g., @AlomiaHerrera2017; @Gao2020; @White2018; @Daneshvar2017; @Herbst2019].

Investigations of flow-ecology relationships can also be grouped by approach [as in @Brummer2016]. In experimental flow studies the flow is directly manipulated with dam releases and biological responses are monitored [e.g., @Konrad2011]. In longitudinal studies, long-term ecological and hydrological records can be used to infer local or regional correlations [e.g., @Medallo-Diaz2019]. Finally, in space-for-time approaches, the hydrology of multiple river systems in a region is used to populate the distribution of different hydrologic behavior, and ecological monitoring in this region is assumed to be related to flow differences between streams [e.g., @Monk2008; @Riis2008; @Catford2014; @Bower2022]. Space-for-time analyses require considerably fewer resources than experimental flows and longitudinal studies, and thus are more numerous [@Brummer2016]. Frequently in space-for-time analyses the flow change is quantified in terms of hydrologic alteration from a natural or historical regime, as in the Ecological Limits of Hydrologic Alteration (ELOHA) framework [@Richter2006; @Poff2010b]. ELOHA and other methods to identify natural flow regimes are adaptable and have been applied widely to many distinct regional systems [e.g., @Knight2014; @Brummer2016; @Bower2022]. 

Bridging the gap between science and policy has been a persistent challenge in this field. In many cases a key research motivation is to support decision-making in a variety of contexts, including dam operation, river restoration, and regulations of water extraction and land use [@Richter2006; @Han2015; @Sinnathamby2018; @Bradley2017; @Brummer2016]. But historical approaches based on relationship-finding are several steps removed from the policy-making process [@Webb2018]. For example, ELOHA or similar approaches can generate flow-ecology relationships or flow standards for particular rivers, but cannot translate specific management decisions into hydrologic or ecological outcomes [@Cartwright2017]. Additionally, studies of multiple stressors on river systems suggest that flow changes alone are not enough to predict ecological response at regional, multi-basin scales [e.g., @Worrall2014; @Knight2014; @McManamay2013; @McManamay2015] or in some single basins [e.g., @AceroTriana2021]. Finally, many flow-ecology relationships are based on insufficient data. Methods have been proposed to mitigate this, but the exercise is generally inhibited by small sample size of relevant ecological metrics [@Gwinn2016].

An ideal framework for supporting decision-making would involve two key steps, firstly connecting management actions to flow changes, and secondly connecting flow changes to ecological responses [@Peterson2016; @DeWeber2020; @AceroTriana2021]. Both steps can involve complex models and substantial uncertainty, often representing an interdisciplinary challenge. Threshold values for "sufficient" flows would be ideal for a management context [@Rosenfeld2017], but can be difficult to identify and in some cases may not exist [@Lueders2023].  Additionally, identifying natural flow regimes may be less immediately relevant to water resource management than an approach which can quantify ecological responses to "designer" or functional flows (which can often be controlled or influenced by dam releases) [@Arthington2014; @Webb2018], though some may suggest that all possible historical flow components should be preserved [e.g., @Bower2022], as the designer flows approach may risk overlooking ecological flow needs that are not currently monitored. Finally, stakeholders in at least one study requested flow-ecology relationships based on empirical monitoring, rather than more easily-simulated proxies like flow changes or thermal exposure [@DeWeber2020].

The present study is a longitudinal analysis, using empirical data and a case study, to address the second of the two key links identified above. We use empirical data to predict a biological response to measurable (and simulatable) changes in flow metrics. We refer to this prediction as a "hydrologic benefit function" (i.e., intending to quantify the ecological services provided by flow) for a single species. This provides the critical link to evaluate fish outcomes resulting from future alternative watershed management practices which affect the hydrology of a stream ecosystem. A forthcoming companion study will investigate the other link, predicting flow changes from watershed management actions using an appropriate hydrologic model, then use hydrologic benefit functions to summarize the ecologic outcomes of a portfolio of water and land use scenarios.


# Methods: Case study setting and species of concern

Exploring the empirical relationship between river hydrology and an ecological response requires overlapping geography, and sufficient record length, in a study area's hydrologic and ecological monitoring data. Ecological data is typically more sparse and is usually the limiting factor. Geographically, the ecological monitoring must be within an area that is plausibly affected by the hydrology at the point of river observation. Temporally, in order to go beyond static snapshot analyses [e.g. @Wheeler2018], the species-level observations of life stages which are facilitated by specific flow rates (such as spawning and rearing for salmonids) must cover a wide range of dry to wet water year conditions, which usually means decades of time-intensive and costly aquatic data collection. 

These requirements are met to some degree in Scott Valley. Hydrologic data is provided by daily river flow monitoring, which has been ongoing since the 1940s at the USGS stream gauge downstream of the town of Fort Jones (Station ID #11519500, or the Fort Jones Gauge or FJ Gauge; Figure \@ref(fig:ScottWatershedMap)). The flow at this gauge is correlated with flow in tributary streams [@Foglia2013a], and though a single monitoring location may not be able represent flow status in the full stream system at all times, it has been used in recent water planning documents as an indicator of overall hydrologic conditions [Siskiyou County -@SiskiyouCounty2021]. Because most water use in Scott Valley occurs upgradient of this gauge, its measurements are used to inform water management decisions in the populated areas of the valley.

Ecologic data is available due to routine monitoring of spawning anadromous fish, which has been ongoing in the broader Klamath basin since at least 1978 [@Knechtle2012]. More in-depth monitoring of multiple salmonid life stages in the Scott River watershed has occurred since 2003 [e.g., @Maurer2003; @CDFW2021a]. In this study we will take advantage of this nearly two-decade record of adult spawner and juvenile salmon abundance observations to draw preliminary conclusions regarding this hydrology-ecology relationship.

<!-- Local aquatic monitoring has included observations of steelhead and lamprey, but for purposes of this study we will focus on coho and Chinook salmon. -->

```{r ScottWatershedMap, echo = F, message = F, warning =F, fig.height = 8.5, fig.cap = "The Scott River watershed, with regional geographic context (see inset) and local features. Scott River flows generally from south to north and joins the Klamath after flowing through a steep canyon. \\label{fig:ScottWatershedMap}"}

# this stupid inset map thing made it not play nice with knitr. so have to include it as a png.
if(replace_setting_fig == TRUE){save_setting_figure()}

if(save_imgs==T){
  file.copy(from = file.path(graphics_dir, "scott valley setting.png"),
            to = file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

knitr::include_graphics(file.path(graphics_dir, "scott valley setting.png"))
# knitr::include_graphics(file.path(graphics_dir, "scott valley setting_old2.png"))

fig_i = fig_i +1

```


## Scott River watershed setting and water use

### Geography, climate and hydrology

The Scott River drains a 2,109 km^2^ (814 square mile) watershed known as Scott Valley, and is a major tributary to the Klamath River, which drains an area spanning sections of Northern California and Southern Oregon (Figure \@ref(fig:ScottWatershedMap)). Scott Valley has a Mediterranean climate with distinctive seasons of cool, wet winters and warm, dry summers. This seasonality in water input creates highly seasonal flow in the Scott River and tributary streams (Figure \@ref(fig:fjFlowFigure)). The beginning of a water year therefore coincides with the late low flow season and immediately precedes the onset of first winter precipitation.

In most dry-to-average water years, sections of the Scott River become seasonally dewatered [NCRWQCB -@NCRWQCB2005; Figure 5 in @Tolley2019]. This occurs when the elevation of the water table drops below the bottom of the river channel, as streams and groundwater are highly interconnected in the Scott River watershed. Tributary streams, particularly along their alluvial fan apeces, and the Scott River are sources of recharge to the aquifer [@Mack1958; @Harter2008a]. Groundwater discharge sustains streamflow in some areas, especially during the dry season of August through October or November [@Tolley2019].  

```{r fjFlowFigure, echo=FALSE, fig.cap="The Mediterranean climate produces highly seasonal flows in the Scott River. Each translucent line traces one annual hydrograph measured at the Fort Jones gauge, and the darker lines illustrate the 30-day smoothed median daily flow in Dry, Below Average, Above Average, and Wet water year types, for water years 1942-2021. The water year type is defined by quartiles of the distribution of total annual flow.", warning=F}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 6, units = "in", res = 300)
  
  fj_flow_figure(roll_window = 30)
  
  dev.off()
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1

```

### Water uses and management objectives

Water in Scott Valley is used for agricultural, domestic, and municipal supply. It also facilitates recreation and provides Native American cultural services, among other designated beneficial uses [NCRWQCB -@NCRWQCB2006b]. Because the watershed is undammed, managers and water users influence Scott River flow primarily via diversion of surface waters and pumping of groundwater. Consequently, the most powerful tool available to manage Scott River water flow is regulation of land use and thus water demand [Siskiyou County -@SiskiyouCounty2021]. 

Scott Valley is not a census-designated place and therefore does not have an official population estimate; however, census block-level population data, area-weighted according to the fraction of each block that overlaps with the watershed, indicate that in 2020 the population of the Scott River watershed was approximately 5,186 [@USCensus2021]. Most reside outside the boundaries of the two incorporated towns Fort Jones and Etna, with estimated populations of 695 and 678, respectively [@USCensus2021].

Historically, local regulation of land use has focused on maintaining the rural and agricultural character of Scott Valley [@SVAP1980]. Regulating land use to improve ecological outcomes would entail significant economic, political and social risks, because much of the economic activity in this area is related to agriculture. The primary crops grown in Scott Valley are pasture for cattle feed and alfalfa [Siskiyou County -@SiskiyouCounty2021]. In addition to local economic impact, Scott River conditions influence fish population dynamics both within the watershed and in the broader Klamath system. The health of the Klamath salmon run has implications for commercial fishing, recreational activities, and cultural practices of Native American tribes in the region, including the Quartz Valley Indian Community and the Karuk and Yurok Tribes [@Graham2012].

All of the regulatory and management programs in this region, including recommended instream flows [CDFW -@CDFW2017], recent emergency drought measures [SWRCB -@SWRCB2022], and legal rights governing surface water diversion [@SuperiorCourtofSiskiyouCounty1980], are tabulated in units of cubic feet per second (cfs). For consistency, this document will also use primarily cfs units.


## Species of concern: coho and Chinook salmon

This study intends to predict the hydrologic needs of two species, coho and Chinook salmon. To this end, we used several decades worth of hydrologic and ecological data collected in the Scott River watershed. Although both species need fall flows to migrate from the ocean to natal spawning streams, the life history strategies of these two salmonids are distinct in several ways, and consequently we anticipate some differences in the functional flows needed to sustain the two species. 

### Salmon management and monitoring in the Scott River watershed

Over the past three decades, several organizations and agencies have conducted extensive monitoring and published a series of reports and plans regarding the salmon fisheries in the Scott River watershed. In the 1990s, fall flows in the Scott River were reported to be too low in some years to allow for Chinook spawning in September-November [CRMP and SRWC -@CRMP2000], but in the mid-2000s it was reported that low fall flows rarely affected the later (November-January) spawning runs of steelhead and coho salmon [SRWC -@SRWC2005]. More recently, fall flows have affected coho salmon as well as Chinook, as the late onset of winter storms has delayed coho spawning in some water years [e.g., CDFW -@CDFW2015a]. In the mid-2000s, a local conservation organization identified the lack of suitable summer and winter rearing habitat as a probable limitation on Scott River coho smolt production [SRWC and Siskiyou RCD -@SRWC2005]. Several years later, in a NOAA Fisheries Coho Recovery Plan, NMFS identified the juvenile life stage as the most limited in the population [NMFS -@NMFS2014].

Monitoring activity in the past 20 years has included population estimates from a video counting flume and a rotary screw trap operated by CDFW [CDFW -@CDFW2015b; @Massie2020; @CDFW2023a], and spawning surveys for Chinook [@SiskiyouRCD2015b; @SiskiyouRCD2017a; @SiskiyouRCD2018] and coho [@Maurer2003; @SiskiyouRCD2005; @Quigley2006; @Quigley2007; @SiskiyouRCD2010; @Yokel2011; @SiskiyouRCD2012; @SiskiyouRCD2013; @SiskiyouRCD2014; @SiskiyouRCD2015a; @SiskiyouRCD2017b]. Recent management activity has included the leasing of surface water rights from landowners to enhance summer flows [e.g., SRWT -@SRWT2018], the prioritization of stream reaches for habitat restoration [SRWC -@SRWC2018], several pilot projects to construct and assess the impact of beaver dam analogs (BDAs) on aquatic habitat and fish populations [Yokel -@Yokel2018], a coordinated rescue effort to relocate juvenile salmon that were cut off from outmigrating by disconnected river reaches [CDFW -@CDFW2015a], and the development of long-term groundwater management plan by Siskiyou County and local stakeholders [Siskiyou County -@SiskiyouCounty2021].


### Life cycle and status of coho salmon (*Oncorhynchus kisutch*)

Returning adult coho spawn in natal streams between November and January [@CDFW2020], and juvenile coho spend approximately one full year in freshwater streams before migrating to the ocean as smolts [@Moyle2002; @McMahon1983]. In the Scott River system these natal streams are the tributaries along the margins of the valley floor [@SiskiyouRCD2004].

<!-- Their habitat needs are somewhat different during summer and winter: in summer, coho are found most commonly in cool pools, more than 1 meter deep, with abundant cover (e.g., woody debris or undercut banks) [@Moyle2002; @Giannico2007; @Nickelson1992]. In winter, coho are most abundant in areas with flow refugia, such as alcoves and beaver ponds [@Nickelson1992] or riverine ponds [@Peterson1982], and complex cover such as low velocities, shade, and complex woody debris [@McMahon1989; @Bustard1975]. In winter, without such refugia, juvenile coho risk being swept downstream or out to sea by storm flows before they are physiologically ready to live in ocean conditions [@McMahon1983].  -->

<!-- Coho salmon can be harmed by acute or chronic thermal stress, by exposure to suspended solids, and (at a population level) by hatchery effects. Critical thermal maxima of coho (the temperature at which acute exposure is fatal) has been measured between 28.21 and 29.23 ÂºC [@Konecki1995]. Below critical thermal maxima, chronic exposure to elevated temperatures (above a threshold of approximately 16Âº-18ÂºC) can increase prevalence of disease and reduce survival rates [@Miller2014]; however, if sufficient food resources are available to sustain the faster growth that takes place at higher temperatures, chronic thermal stresses may be mitigated [@Lusardi2020]. Similarly, juvenile coho exposed to high levels (2-3 g/L) of suspended solids have exhibited higher stress levels, lower feeding rates, and lower resistances to disease [@Redding1987]. Additionally, hatchery fish tend to have lower fitness than wild-reared fish, and releasing them into wild populations can negatively impact wild coho salmon populations [@Quinones2014a]; one proposed cause is that the lack of sexual selection in hatchery fish populations leads to a higher number of less fit individuals competing for resources [@Theriault2011]. -->

In previous studies, the strongest predictor of juvenile coho abundance in a stream system was spatial habitat [@Bradford2016; @Nickelson1992; @Bustard1975], although adequate food and cover were also important [@McMahon1983]. The primary mechanism for spatial constraints on abundance appears to be that juvenile coho become more territorial as they grow [@McMahon1983].

<!-- , and those that cannot hold a territory typically emigrate downstream or all the way to the ocean in their first summer or spring.  -->

<!-- These early migrators are not well suited to ocean conditions and are much less likely to return as spawning adults [@McMahon1983], though there is evidence that some of these fish may be able to rear in non-natal habitats [@Gorman2016]. -->

An average coho life cycle is illustrated in Figure \@ref(fig:cohoLifeCycleFigure). Some coho salmon return to spawn at age 2 as grilse, but the majority (e.g., 92.4% in 2020) return after more than one year in the ocean, giving the Scott coho salmon run its characteristic 3-year cohort return interval [@CDFW2021a].

Coho salmon in the Scott Valley are listed as threatened under the federal and California Endangered Species Acts (ESAs). They belong to the Southern Oregon / Northern California Coast (SONCC) Evolutionarily Significant Unit (ESU), which was listed as threatened under the federal and state ESAs in 1997 and 2005, respectively. State-wide, coho populations have declined more than 90% since the 1940s [@Brown1994]. 

```{r cohoLifeCycleFigure, echo = F, message = F, warning =F, out.height= "8.5in", fig.cap = "Typical life stage progression of coho salmon in the Scott River watershed."}

knitr::include_graphics(file.path(graphics_dir, "coho life cycle table_2022.02.03.jpg"))

```

### Life cycle and status of Chinook salmon (*Onchorhynchus tsawytscha*)

Chinook salmon in the Scott Valley are a candidate for listing under the federal ESA, and are not listed under the California ESA. They belong to the Southern Oregon / Northern California Coast (SONCC) Evolutionarily Significant Unit (ESU). 

Typically, adult Chinook salmon return to spawn in Scott Valley streams in the fall months September-December when flows are sufficient for salmon passage [@CDFW2020; @SiskiyouRCD2015a; @SiskiyouRCD2017a]. Chinook in this watershed hatch in the spring and migrate to the ocean in their first year of life [@NMFS2005]. Chinook spend the majority of their life in the ocean, and return to their natal streams shortly before spawning [@Healey1991]. However, substantial variability exists within this broader structure: Chinook salmon exhibit variation in multiple life stages, including time of seaward migration, age of maturity, and timing of return to natal stream [@Healey1991; @Bourret2016]. Consequently, a diagram of the Chinook life cycle would include more variability than the more structured coho life cycle reflected in Figure \@ref(fig:cohoLifeCycleFigure).

As recently as 2013, the SONCC Chinook population was stable and becoming more complex [@Wainwright2013]. However, in monitoring from 2015-2020, the number of returning adults (the escapement) was 65% below historical average, and the change in the Scott River Chinook population has been more rapid than the decline in the overall Klamath Basin Chinook run [@CDFW2021b]. Ocean conditions may have contributed to a broad decline in Chinook populations from Alaska to California [@Welch2021]. Some studies have found that the leading cause of declining Chinook populations are ocean conditions, including including temperature, upwelling currents and food resources [@Hunt1999], while others have identified hatchery practices as the primary cause [@Quinones2014]. 

### Relevant distinctions in Chinook and coho life histories

Chinook and coho salmon are distinct in several ways relevant to this study and to management considerations:

* In most years Chinook spawning migration takes place earlier (September-December) than coho (October-January).
* Chinook in this watershed hatch in the spring and migrate to the ocean in their first year of life, in contrast to coho, which spend a full year in the stream before migrating  [@NMFS2005; @CDFW2020].
* Coho salmon prefer to spawn in reaches with smaller spawning gravels than Chinook salmon. Consequently the majority of coho redds are found in Scott River tributaries, while Chinook redds are more commonly found in the mainstem Scott River [e.g., @SiskiyouRCD2017a; @SiskiyouRCD2017a].
* Declining populations of coho salmon have been noted in the Klamath basin and more broadly in coastal California streams since the 1990s [e.g., @Brown1994], while regional Chinook populations have historically been more robust [@Wainwright2013]. However, a declining trend was observed in the Klamath run of Chinook in the 2010s, and this trend was more significant in the Scott River system than the broader Klamath basin [@CDFW2021a]. These trends have prompted additional monitoring of Scott Valley Chinook in the past decade [e.g., spawning surveys such as @SiskiyouRCD2015b; @SiskiyouRCD2017a].


# Methods: Quantitative analysis

We used lasso regression [@James2013; @Ranstam2018] to assess the feasibility of predicting an ecological response using dozens of potential hydrologic predictor metrics. The objectives of the lasso exercise were to 1) perform predictor selection, i.e., empirically estimate which hydrologic flows were most related to coho and Chinook reproductive outcomes and 2) estimate the uncertainty of a predictive Hydrologic Benefit formula, using the selected set of predictors and their calculated coefficients. Each step in the analysis is numbered and explained below.

## Step 1. Calculate predictors: Flow metrics to describe Scott River flow regime

Hydrologic predictors consist of flow metrics calculated from the daily flow record at the Fort Jones river gauge from 1942-2021. The full suite of metrics is calculated on a water-year basis (i.e., each type of metric produces one value for each water year). All annual water metrics considered in this study are included in *Supplemental Table 1*. Abbreviations, relevant time periods and metric calculation details are listed in Table \@ref(tab:funcFlowTermsTab).

Firstly, a series of metrics from the catalog of California-specific functional flows (as illustrated in Figure \@ref(fig:fig2Yarnell2020)) [@Yarnell2020; @Patterson2020] were selected to highlight the history and salient characteristics of the Scott River flow regime over the past eight decades. Additional information is available in @Patterson2020 and supporting documentation. All selected functional flow metrics have some known ecological function or interpretation: Total annual flow is used to evaluate water year type. Phenomena measured with fall metrics, such as fall pulse magnitude and fall pulse timing, provide olfactory migration signals and spawning access to anadromous fish; however, a discrete fall pulse does not occur in every water year. Wet season metrics, such as wet season onset timing and baseflow magnitude, can be used to gauge conditions during egg incubation or the overwintering period for juvenile coho salmon. In particular, frequency and duration of wet season high-flow events (i.e. daily average flow above exceeding a 2-, 5- and 10-year flood) indicate the potential presence of scouring flows. Spring metrics, such as spring flow recession rate of change, occur during the transition from wet to dry season, and indicate conditions during early juvenile salmon rearing as well as the flow available for outmigration from Scott Valley to the ocean. Finally, metrics like the duration and median flow of the dry season indicate the timing and severity of low-flow conditions in which spatial habitat is constrained and connectivity between reaches may be limited. 

Secondly, we devised two additional metrics for this study area related to timing of anadromous fish access to preferred spawning habitat (illustrated in Figure \@ref(fig:reconnectExplainerHydrograph)). These metrics are referred to as "reconnection" and "disconnection" dates. They assume a flow threshold, defined at the Fort Jones gauge, that corresponds to a certain degree of "connectivity" in the Scott River stream system. The date on which this connectivity is lost in the spring/summer or gained in the fall has implications for whether salmon passage exists during the preferred migrating time window. These metrics are related to the California-specific functional flows, namely, the timing and slope of spring recess and the timing of a fall pulse flow (Table \@ref(tab:funcFlowTermsTab)). More importantly, they add value to this analysis because of their direct relation to fish passage in the watershed.

Finally, to identify the presence of scouring flows [i.e., storm events that can mobilize large amounts of sediment and either bury or wash away salmonid eggs; @SRWC2018], we calculated the number of days in each year with average daily flow greater than the 90th flow percentile (for the full Fort Jones hydrologic record). 

### Selecting flow thresholds for dis- and re-connection timing

A discrete number of thresholds were selected from the continuum of flows, ranging between a lowest value of 10 cfs and highest value of **100 cfs**. At the lowest value all tributaries are known to be disconnected and significant dry reaches exist along the main stem [@Tolley2019]. **At the highest value, most tributaries connect with the mainstem and the mainstem Scott River is flowing contiguously, including the "tailings" section, a boulder sediment substrata section of the mainstem that is most susceptible to falling dry** [@Tolley2019; @SiskiyouCounty2021].

The reconnection timing of proximate flow thresholds is somewhat correlated. It was therefore necessary to reduce the number of flow thresholds under consideration in the **linear model selection process** to a) identify flow thresholds with the greatest impact on salmon reproduction (to the extent possible with such a small dataset), and b) avoid the inclusion of redundant hydrologic information [@Olden2003]. **To identify the threshold(s) with the highest predictive power and potentially the lowest redundancy, we examined correlations between reconnection dates and biological monitoring data (see methods part 4 below).**

```{r funcFlowTermsTab, echo = FALSE, results = 'asis'}

ff_tab = read.csv(file.path(data_dir,"Hydro metrics explanation table.csv"))

ff_tab = ff_tab[!(ff_tab$Abbreviation %in% 
                     c("BY", "RY","SY","CFLP")),]

#Create caption and column labels
caption_text = "Explanation of hydrologic metrics used in this analysis. Each type of metric, for each threshold value (e.g., 100 cfs or 50th flow percentile), produces one value per water year."
column_labels = c("Abbrev.","Full Name", "Thresholds","Description")
colnames(ff_tab) = column_labels

ff_tab_ft = flextable(data=ff_tab)
ff_tab_ft = set_caption(ff_tab_ft, caption = caption_text)
# autofit(ff_tab_ft)
# ff_tab_ft = fit_to_width(ff_tab_ft, max_width = 7)
# ff_tab_ft = flextable::hline(ff_tab_ft, i = 4)
ff_tab_ft = flextable::width(ff_tab_ft,j=1,  width = 1.1)
ff_tab_ft = flextable::width(ff_tab_ft,j=2,  width = 1.5)
ff_tab_ft = flextable::width(ff_tab_ft,j=3, width = 1)
ff_tab_ft = flextable::width(ff_tab_ft,j=4,  width = 3.2)
ff_tab_ft

``` 


```{r funcFlowTermsTabLifePeriods, echo = FALSE, results = 'asis'}

ff_tab = read.csv(file.path(data_dir,"Hydro metrics explanation table.csv"))

ff_tab_lp = ff_tab[ff_tab$Abbreviation %in% 
                     c("BY", "RY","SY","CFLP"),
                   c("Abbreviation","Full.Name","Description")]

#Create caption and column labels
caption_text = "Explanation of time period definitions used in this analysis."
column_labels = c("Abbrev.","Full Name","Description")
colnames(ff_tab_lp) = column_labels

ff_tab_lp_ft = flextable(data=ff_tab_lp)
ff_tab_lp_ft = set_caption(ff_tab_lp_ft, caption = caption_text)
ff_tab_lp_ft = flextable::width(ff_tab_lp_ft,j=2,  width = 1.5)
ff_tab_lp_ft = flextable::width(ff_tab_lp_ft,j=3, width = 3.2)
ff_tab_lp_ft

``` 

```{r fig2Yarnell2020, echo = F, message = F, warning =F, fig.height = 8.5, fig.cap = "Figure 2 from Yarnell et al., 2020. Illustration of five functional flow categories identified for a mixed rain-snowmelt runoff river in California."}

knitr::include_graphics(file.path(graphics_dir, "Yarnell2020_Fig2.png"))

if(save_imgs==T){
  file.copy(from = file.path(graphics_dir, "Yarnell2020_Fig2.png"),
            to = file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

fig_i = fig_i +1

```



```{r reconnectExplainerHydrograph, echo = F, warning =F, fig.cap = "Reconnection and disconnection dates are highlighted for one water year. Two example thresholds, 10 and 100 cfs (0.28 and 2.8 cms, respectively) are highlighted, which correspond to distinct river connectivity (and salmon habitat access) conditions in the Scott River watershed as observed at the Fort Jones gauge (see Results for more detail on selection of flow thresholds)."}


fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 5, units = "in", res = 300)
  
recon_and_discon_explainer_hydrograph(
  water_year = 2016, tot_flow_annotate = F, 
  connection_date_annotate = "10_and_100_only")
  
  dev.off()
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1

```

## Step 2. Assemble responses: Ecological monitoring data

Multiple observed quantities were evaluated as candidates to best represent the ecological response in the flow-ecology relationship. 

Factors influencing the population size of anadromous fish include ocean conditions and freshwater conditions. In this study, because we are interested only in the conditions in their natal streams, we have focused on fish population metrics that are influenced by the freshwater system. The key ecological observations used in this study are:

1. Number of adults migrating from the ocean to freshwater natal streams to spawn. This quantity, the 'escapement', is measured at a CDFW counting facility, using a resistance board weir and video counting flume in the Scott River [e.g., @CDFW2021a]. 
2. Number of juvenile yearling, or smolt, salmon. Smolt are counted as outmigrants, often from rotary screw trap observations [e.g., @Massie2020]. 
3. Number of salmon gravel nests, or redds, observed during spawning window [e.g., @SiskiyouRCD2017b] (for coho only).

Based on these observations, two other combined metrics have historically been calculated and reported by regional agencies [@CDFW2023a]. These metrics use data from multiple years to capture multiple life stages for a given cohort:

4. The number of outmigrating coho smolt produced per spawning female (coho spf) and the outmigrating Chinook juveniles per adult (Chinook jpa).
5. The percent of each smolt cohort which survived its freshwater dwelling period and migrated to the ocean as smolt (for coho only).

## Step 3. Align predictor and response metrics with timing of species cohorts

A water year is a useful time unit for water managers and a common unit used in decision-support tools. However, a cohort of, e.g., coho salmon experiences conditions during multiple water years while residing in their spawning habitat. For coho salmon the life cycle is largely regular in Scott Valley, with 3 defined cohorts in which the vast majority of individuals return to natal streams at 3 years of age [e.g., CDFW -@CDFW2021b]. Conversely, the majority of Chinook salmon return to spawn when they are 2 to 6 years old [@Bourret2016], resulting in less of a cohort structure than for coho. Here we define the alignment (i.e., mapping) of a specific generation of fish (ecological outcome) with hydrologic metrics (predictors) observed across the portion of their life cycle spent in the Scott River system (*Supplemental Table 2*).


### Data alignment - coho

The relevant unit of time for identifying the impacts of freshwater hydrology on a coho salmon cohort is defined here as a Coho Freshwater Life Period (CFLP), a duration of 21 months beginning the September of the year their parents spawned and ending the July of their outmigration from the watershed as smolts. This time period is conservatively wide; most spawning occurs in October or later, and most outmigration occurs in June or earlier [@Moyle2002], but the September-July duration was chosen to capture critical life stages even in extreme water years. 

For convenience in referring to hydrologic metrics in different water years, this Coho Freshwater Life Period has been broken up into three subperiods (as shown in Figure \@ref(fig:cohoLifeCycleFigure) and described in Table \@ref(tab:funcFlowTermsTabLifePeriods)):

* Brood Year (BY), September-December of the year of the cohort's parents' spawning
* Rearing Year (RY), January-December of the full year the cohort spends in the watershed
* Smolt Year (SY), January-July of the year of the cohort's smolt outmigration

Coho Freshwater Life Periods overlap, e.g., the fall pulse flows in water year $i$ take place during one cohort's Brood Year, and the same fall flows occur during the end of the Rearing Year for the cohort born in water year $i-1$. In some rare cases, flow metrics may fall outside their designated subperiods (e.g., the extreme dry water year of 2014, in which the "fall reconnection" of flows in Brood Year 2013 did not occur until February of the cohort's Rearing Year). Nonetheless, for consistency, even a January or February reconnection date will be referred to by the previous fall year designation.

To build empirical relationships between hydrology and biology, ecological response variables were indexed by Brood Year of the affected cohort and hydrologic metrics tabulated accordingly (*Supplemental Table 2*). For example, the value for fall reconnection timing (100 cfs flow threshold) in fall of 2011 was assigned to the column "BY_recon_100" for the Brood Year 2011 cohort. The same value was assigned to the column "RY_recon_100" for the Brood Year 2010, which experienced fall 2011 as rearing juveniles.

Each brood year is associated with multiple ecological response variable, i.e., "fish outcome" observation types, including number of Chinook and coho spawners observed and the estimated number of smolt observed at the end of their CFLP. Data were available and compiled for brood years 2004 through 2019.

### Data alignment - Chinook

Because spawning occurs in the fall for both coho and Chinook salmon in the Scott River watershed [@CDFW2021b], Chinook ecological data was aligned with hydrologic metrics in the same manner as coho observations. Distinct life histories produced one significant difference: because Chinook migrate to the ocean in their first year of life, the duration of freshwater residence for each Chinook cohort is shorter than for coho, ranging from fall spawning to the subsequent spring or summer. Thus, only metrics from the Brood Year and from the Rearing Year wet season, spring recession and dry season were considered for Chinook predictions.


```{r smolt_year_metrics_master_tab, echo = F, warning =F}

# retrieve hydrology tabulated by STP
brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1999:2022,
                                                             smolt_years = 2001:2024)

thresh_for_corr_fig = c(8, 10, 15, 20, 40, 
                        70, 100, 150, 200, 300, 
                        400, 500, 750, 1000)

metrics_tab = calc_metrics_hydro_by_affected_brood_year(
  hydro_by_brood_year = brood_year_hydro_tab,
  thresholds = thresh_for_corr_fig) 

write.csv(x = metrics_tab, quote = F, row.names = F,
  file = file.path(graphics_dir,
                   "Supplemental Table 2 - Flow Metrics by Brood Year.csv"))

# calculate number of predictors for text below

y_val_label_tab = data.frame(y_val = c("chinook_spawner_abundance",
                                       "chinook_juvenile_abundance",
                                       "chinook_juv_per_adult",
                                       "coho_spawner_abundance",
                                       "coho_smolt_per_fem", 
                                       "coho_smolt_abun_est",
                                       "percent_coho_smolt_survival",
                                       "coho_redds_in_brood"),
                             y_val_title = c("Chinook escapement", 
                                             " Chinook juv. abundance",
                                             "Chinook jpa","coho escapement",
                                             "coho spf",
                                             "est. coho smolt abundance",
                                             "percent coho smolt survival",
                                             "coho redd abundace"),
                             y_val_label = c("Num. Chinook spawners (escapement)",
                                             "Num. Chinook juveniles",
                                             "Chinook juv. per adult",
                                             "Num. coho spawners (escapement)",
                                             "Coho smolt per female spawner",
                                             "Est. num. coho smolt",
                                             "% coho smolt survival",
                                             "Num. obs. coho redds"),
                             remove_sy = c(T,T,T,T,F,F,F,T),
                             remove_ry = c(T,F,F,T,F,F,F,T))
yvlt = y_val_label_tab
non_preds = c("brood_year", "smolt_year", yvlt$y_val)


num_predictors = length(colnames(metrics_tab))- length(non_preds)



```


## Step 4. Calculate correlation coefficients and rule out temporally impossible relationships

After aligning the hydrologic predictors and ecological responses, we calculated Pearson correlation coefficients [@Pearson1895] $R$ between each predictor and each response. A significant number of potential predictor-response pairs do not represent a temporally plausible relationship: e.g., the wet season values in water year 2011 would not influence the number of spawners that arrived the previous season, in fall of 2010. These implausible pairs were excluded from the resulting $R$ matrix.

## Step 5. Select ecological response metrics

For each of the two species of concern, we wanted to find the ecological metric most related to the measured hydrology. We used the full suite of correlation coefficients to select one ecological metric for further analysis: the ecological metric that generated the **highest mean $R$ value** (i.e., the ecological metric that appears to be the most predictable).

* **mean of top-10 predictors **
* **clear selection for chinook. less clear for coho**

## Step 6. Lasso regression 

With hydrologic metrics assigned to each salmon generation, indexed by brood-year and corresponding smolt year (*Supplemental Table 2*), we assessed the potential for hydrologic metrics to predict biological outcomes by performing lasso regression [@James2013; @Ranstam2018] between `r num_predictors` hydrologic predictors and the two ecological metrics selected in the previous step (one for coho and one for Chinook).  

### General approach

We used the R programming environment [@RManual] and the linear modeling function `glmnet()` [@Friedman2010] to perform variable selection using lasso regression. Lasso regression is less flexible than the classic least squares regression, and is commonly used in high-dimensional data settings, where the number of possible predictors approaches or exceeds the number of observations [@James2013]. Because the solution can set some coefficients to 0, thereby removing their associated predictors from the final model, lasso regression can also perform predictor selection.

Lasso (Least Absolute Shrinkage and Selection Operator) regression minimizes the following quantity:

$$\sum_{i=1}^{n}{(y_i-\beta_0-\sum_{j=1}^{p}{\beta_jx_{ij}})^2}+\lambda\sum_{j=1}^{p}{|\beta_j|}$$

Where:

* $n$ is the number of observations;
* $p$ is the number of predictors;
* $x$ are the observed predictor (independent variable) values;
* $y$ are the observed response (dependent variable) values;
* $\beta_0,~\beta_j$ are the intercept and coefficient values for each predictor; and
* $\lambda$ is a tuning parameter, referred to as a shrinkage penalty.

<!-- This formulation penalizes Each distinct lamba value produces a linear model with different coefficients.  -->

In this formulation, sufficiently large values of lambda generally shrink the values of all coefficients to 0 (the infinite-lambda case). The infinite-lambda case produces a model consisting solely of the $\beta_0$ intercept term, which takes on a value that is the average of all the observed $y$ values. Conversely, sufficiently small values of $\lambda$ will produce linear models incorporating information from many predictors. 
 <!-- The infinite-lambda  case can be interpreted in the following manner: under the constraint imposed by the high lambda value, no information added by predictor values outperformed a simple average value of response values.  -->
 <!-- If you perform the minimization calculation for a range of lambda values, you can identify points along the range at which it becomes favorable to include one, two, and then three or more predictors - these reprent the points when the information introduced by those predictors .  -->
The selection of the appropriate $\lambda$ value is a critical step in the regression procedure, and is best done using cross-validation within the training dataset [@James2013]. In this analysis a range of $\lambda$ values was explored for each species.

### Predictor restriction based on overlapping sample size

Some ecological records have gaps (e.g., when funding was not available in one year to conduct a redd survey). Additionally, some predictor metrics are not available in all years (i.e., FA_Mag, or magnitude of a fall pulse flow, cannot be calculated if no discrete fall pulse flow is observed). For the lasso regression exercise, we restricted the set of considered predictors to those which had at least 10 years of overlap with the selected ecological response.

### Test error and range of lambda values

In lasso regression, the standard method to pick the value of lambda (the "shrinkage penalty") is to divide a dataset into a "training" and a "test" set, and use the training set to generate a series of regression models using a range of lambda values. These models are then used to predict the values of the test set, and the total difference between predicted and observed quantities is known as the test error. This is often summarized as the root mean squared error (RMSE). The lambda value that produces the regression model with the minimum test error is selected, and using this value, a final regression model is generated based on the full data set [@James2013]. 

However, we decided this was not appropriate for the size of the available ecological datasets, which ranged from 15 to 20 years of observations. To address this, we generated 10,000 non-repeating random sets of testing and training data, and calculated the optimal lambda value for each set. 

Then, using the full dataset, we calculated regression models produced by the full range of optimal lambda values identified in the test-train step. The number of predictors incorporated in these models ranged from zero (i.e., the model consisted of the intercept value only) to a maximum of 20 and 27 (**predictors**) for coho and Chinook respectively.  

### Selection of final lambda values 

To select a final lambda value, we considered the percentage of deviation explained, 

## Step 7. Formulate Hydrologic Benefit

The final lambda value selection produced the linear model which can be used to predict ecological outcomes with hydrologic predictors. We referred to this model as the Hydrologic Benefit (HB) function. The predicted HB value, with units of the selected ecological response type, in Brood Year $i$ is calculated as:

$$HB_i = \beta_0 +\sum_{j=1}^{p}{\beta_j x_{ij}}$$

Where:
$x_{ij}$ is the value of predictor $j$ in the cohort with Brood Year $i$.

We note that ecological outcome in water year $wy$ is obtained for $BY = wy - 1$ for both salmon species. 


## Step 8. Hydrologic Benefit Function sensitivity

**To further explore the uncertainty associated with such a small dataset, the sensitivity of the predictive ensemble average model was estimated by adding an additional data point. Specifically, a hypothetical value of "observed" coho spf was assigned to brood year 2015 (influenced by conditions in water year 2016). This is a missing value in the existing observational dataset. The missing value for brood year 2015 was replaced by 0, as well as the minimum, mean and maximum values of observed coho spf (5.8, 60.0, and 101.8 coho spf, respectively). The ensemble average coefficients in the HB function were recalculated based on each revised dataset. This sensitivity analysis was not implemented for Chinook (see Results).
**

* make metrics_tab_sa

# Results

## Flow history of the Scott River, described in functional flow metrics

Diagnostic metrics of Scott River flow have demonstrated clear trends over the past 8 decades. Between 1942 and 2021, total annual flow measured at the Fort Jones gauge has dropped from an average of approximately 600 to 400 thousand acre-feet (TAF, or from >800 to <600 million m^3^) (Figure \@ref(fig:funcFlowTimeseries), panel A). Annual flows have always shown large variability, ranging across an order of magnitude, from 67 TAF (in water year 1977) to 1,336 TAF (in water year 1974). More recently, the frequency of years with low annual flows (200 TAF or less) has significantly increased: 3 such years over the first four decades of the gage record, but 10 such years over the second four decades. In contrast, very high annual flows of over 600 TAF were exceeded in at least five years for each two-decade period between 1941 and 2000, but only twice in the most recent two-decade record. 

Ecosystem functional flow metrics, calculated with signal-processing techniques [@Patterson2020] (illustrated in Figure \@ref(fig:fig2Yarnell2020)), also show clear trends over time (Figure \@ref(fig:funcFlowTimeseries), panels B-H). The fall pulse onset date has trended slightly later (though a distinct fall pulse flow does not occur every year), and the magnitude of the fall pulse flows has decreased. Remarkably, a fall pulse onset during the first half of October occurred four times between 1940 and 1980, but not since then (Figure \@ref(fig:funcFlowTimeseries), panel C). Reflecting the large variability in annual flows, the magnitude of the fall pulse flow varies widely, across 2.5 orders of magnitude, from less than 50 cfs to 1500 cfs. Extremely high fall pulse flows (>800 cfs), occurring three times in the earlier period, were missing in the second half of the 80-year record.  Years with a fall pulse flow magnitudes of less than 400 cfs have become more frequent, resulting in a visible downward trend in fall pulse magnitude over the period of record (Figure \@ref(fig:funcFlowTimeseries), panel B).

The onset of the wet season has trended slightly later, though wet season median baseflows (i.e., flows not occurring during storm pulses) have remained stable on average (with a very slight downward trend). Wet season baseflow rates vary from less than 50 cfs (1977) to over 2000 cfs (1997) with typical winter flow ranging from 400 cfs to about 1000 cfs (Figure \@ref(fig:funcFlowTimeseries), panel E).

After April, the chance of large precipitation events becomes minimal leading to a gradual, near-exponential decline of streamflow rates during May through July as the snowpack in the upper watershed melts off. While a very consistent feature in the annual hydrograph (e.g., Figure \@ref(fig:reconnectExplainerHydrograph)), the rate of flow reduction (i.e., the exponential decline) during the spring has increased over the period of record. The spring recession curve has grown steeper and accelerated the annual recession process: hhe rate of decline was just above 0.05%/day in 1940, and it was nearly 0.07%/day in 2020 (Figure \@ref(fig:funcFlowTimeseries), panel EF).

The median dry season flow has dropped by approximately 50%, with many years since 1977 seeing flows below 30 cfs, a condition not seen prior to 1977 and largely related discontinuation of inefficient flood irrigation with surface water and the introduction of efficient sprinkler irrigation with groundwater during the 1970s [@Tolley2019]. The onset of the dry season is earlier, and the duration of the dry season has increased, in some of the most recent years to over 200 days (Figure \@ref(fig:funcFlowTimeseries), panels G and H). 

The reconnection and disconnection dates also show significant trends over time. As a result, the wet season has notably narrowed over time with (approximate) fall onset trending later and the spring flow recession trending to begin earlier. In 2020, the expected reconnection at the 100 cfs threshold occurs more than a month later than in 1940, the expected summer disconnection more than two weeks earlier (Figure \@ref(fig:reAndDisconTimeseries)).

In aggregate over the past 80 years, these metrics show an increasing prevalence of unfavorable hydrologic conditions for salmonids, in terms of the flows needed during critical life stages. The primary causes of this reduced ecological functionality are a changing climate (especially a reduced snowpack and earlier snowmelt) and long-term changes in local consumptive water uses [@Drake2000a; @VanKirk2008a; @Foglia2013a].


```{r funcFlowTimeseries, echo = F, warning =F, fig.height = 8.6, fig.cap = "Total annual flow volume (panel A) and functional flow metrics (panels B-H; Patterson et al. 2020), derived from daily average flow measurements at the Fort Jones USGS flow gauge (ID 11519500) for water years 1942-2021.\\label{fig:funcFlowTimeseries}"}

fflows_hist_obs = read_fflows_csv(scen_id = "hist_obs")

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 9, units = "in", res = 300)
  
func_flow_timeseries_fig(fj_flow = fj_flow, fflows = fflows_hist_obs)
  
  dev.off()
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1



```


```{r reAndDisconTimeseries, echo = F, warning =F, fig.height = 8, fig.cap = "Disconnection and reconnection dates for the 100 cfs (2.8 cms) flow threshold, water years 1942-2021. The disconnection date refers to the first day in the spring on which flow drops below the designated threshold (100 cfs); the reconnection date refers to the first date in the fall on which flow rises above the designated threshold. Trends over the past 80 years suggest that the spring flow recession is trending earlier, and the fall river reconnection is trending later. \\label{fig:reAndDisconTimeseries}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 6, units = "in", res = 300)
  
re_and_discon_timeseries_figure()
  
  dev.off()
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1



```


## Ecological response metric selection

In the correlation analysis we assessed relatedness of ecological outcome metrics with all types of hydrologic metric (reconnection/disconnection timing and functional flows). Degree of correlation was evaluated broadly: a threshold of $|R|>0.5$ (Figure \@ref(fig:corrMatrixFig); *Supplemental Figure 1*) was selected to identify the best candidates among those available, even if it does not denote particularly strong predictive power on its own.

* **correlations between ecological metrics**
* **coho smolt per fem vs coho % smolt survival metrics - why negatively correlated? which is worse? Possibly smolt survival, since smolt estimation is less constrained than the camera trap method at the counting station. **
* **smolt abundance estimates bias high or low?**

```{r inter_corr_matrix_supp_fig, echo = F, warning =F, comment = F}

nthresh = length (thresh_for_corr_fig)
nthresh_gt_70 = sum(thresh_for_corr_fig >= 70)

# Calculate correlation matrix and remove values that don't make temporal sense 
# (i.e., the wet season values in water year 2011 would not influence the
# number of spawners that arrived in fall of 2010)
corr_tab_all_metrics = cor(metrics_tab, use = "pairwise.complete.obs")


metrics_tab_column_colors = c(rep("black", 2),  # brood and smolt years
                              rep("darkgray",8), # fish outcome metrics
                              rep(fall_col,nthresh), # BY fall recon 
                              rep(spring_col,nthresh), # RY spring discon
                              rep(fall_col,nthresh),   # RY fall discon
                              rep(spring_col, nthresh_gt_70), #SY spring discon
                              rep("darkorchid",3), # min. flow metrics
                              rep("peachpuff3",4),    # total flow metrics
                              rep("peachpuff4", 4),    # log total flow metrics
                              rep(fall_col,3),
                              rep(wet_sn_col, 3),
                              spring_col,
                              rep(dry_sn_col, 2),
                              rep(fall_col,3),
                              rep(wet_sn_col,2),
                              rep(dry_sn_col,1),
                              spring_col,
                              rep(dry_sn_col,1),
                              rep(peak_col,6),
                              rep(wet_sn_col,2),
                              spring_col
                              )

if(save_imgs==T){
  pdf(file = file.path(graphics_dir, "corr_explorer_2.pdf"), width = 40, height = 40)
par(mar=c(5,4,6,2))
corrplot(corr_tab_all_metrics,
         tl.col = metrics_tab_column_colors, tl.cex = 1.1,
         col = c("orangered3", "lightpink", "lightskyblue","deepskyblue4"),
         na.label = "--", main = NA)#"Correlation Matrix of Hydrologic and Fish Outcome Metrics")
text(x=30,y=68, cex=3, label="Correlations highlighted for coho (pink box, dashed) and Chinook (purple box, dot dash)")
polygon(x=c(10,59,59,10,10)+.5, y = c(49,49,54,54,49)+.4, border = "deeppink", lwd = 6, lty = 2)
polygon(x=c(10,59,59,10,10)+.5, y = c(54,54,57,57,54)+.6, border = "darkviolet", lwd = 6, lty = 4)
dev.off()

}

```



```{r select_eco_metric, echo = F, warning =F, comment = F}

# 1. Restrict flow thresholds to avoid redundant info

# select one flow threshold for each recon and discon category
get_best_flow_threshold_tab = function(corr_tab_all_metrics,
                                       species = c("coho", "chinook"),
                                       categories = c("BY_recon", 
                                                      "RY_discon",
                                                      "RY_recon",
                                                      "SY_discon")){
  output_tab = data.frame(species = sort(rep(species,length(categories))),
                          category = rep(categories, length(species)),
                          threshold_col_name = NA,
                          mean_threshold_R_val = NA)
  
  for(i in 1:nrow(output_tab)){
    species = output_tab$species[i]
    category = output_tab$category[i]
    y_names = colnames(metrics_tab)[grep(x=colnames(metrics_tab), 
                                         pattern = species)]
    x_names = colnames(metrics_tab)[grep(x=colnames(metrics_tab), 
                                         pattern = category)]
    flow_threshold_corr_values = corr_tab_all_metrics[x_names,y_names]
    flow_threshold_corr_mean_abs = apply(X = flow_threshold_corr_values,
                                         MARGIN = 1,
                                         function(x){mean(abs(x),na.rm=T)})
    max_mean_index = which.max(flow_threshold_corr_mean_abs)
    max_mean_val = max(flow_threshold_corr_mean_abs, na.rm=T)
    selected_threshold = names(flow_threshold_corr_mean_abs[max_mean_index])
    output_tab$threshold_col_name[i] = selected_threshold
    output_tab$mean_threshold_R_val[i] = max_mean_val
    # flow_threshold_corr_max_index = apply(X = flow_threshold_corr_values,
    #                                 MARGIN = 2, 
    #                                 function(x){which.max(abs(x))})
    
    # flow_threshold_corr_max_vals = x_names[flow_threshold_corr_max_index]
  }
  
  return(output_tab)
  
  
}

best_flow_thresholds = get_best_flow_threshold_tab(corr_tab_all_metrics = corr_tab_all_metrics)

recon_discon_cols = colnames(metrics_tab)[grepl(x=colnames(metrics_tab), "recon") | grepl(x=colnames(metrics_tab), "discon") ]

remove_these = setdiff(x=recon_discon_cols,
                       y=best_flow_thresholds$threshold_col_name)
keep_these = !(colnames(metrics_tab) %in% remove_these)



metrics_tab2 = metrics_tab[,keep_these]
corr_tab_2 = cor(x=metrics_tab2, use="pairwise.complete.obs",)
corr_tab_2[corr_tab_2==1] = NA # remove self-correlation values of 1

# corrplot(corr_tab_2,
#          tl.col = metrics_tab_column_colors, tl.cex = 1.1,
#          col = c("orangered3", "lightpink", "lightskyblue","deepskyblue4"),
#          na.label = "--", main = NA) 

# 2. pick eco response metric with highest mean R value with hydro metrics

y_vals = colnames(corr_tab_2)[grepl(pattern = "coho", x = colnames(corr_tab_2)) |
                                grepl(pattern = "chinook", x = colnames(corr_tab_2))]
corr_summary = data.frame(y_vals = y_vals, mean_R_top_pred = NA)
num_top_pred =4

for(i in 1:length(y_vals)){
  y_val = y_vals[i]
  top10 = sort(abs(corr_tab_2[,y_val]), decreasing = T)[1:num_top_pred]
  corr_summary$mean_R_top_pred[i] = mean(top10)
}

corr_co = corr_summary[grep(x=corr_summary$y_vals, pattern = "coho"),]
corr_ch = corr_summary[grep(x=corr_summary$y_vals, pattern = "chinook"),]

y_val_chinook = corr_ch$y_vals[which.max(corr_ch$mean_R_top_pred)]
y_val_coho = corr_co$y_vals[which.max(corr_co$mean_R_top_pred)]

```


**revise rest of text in this section. discuss predictability for all ecological data types and why they might be different.**

For coho salmon number of spawners, the only hydrologic predictor exceeding the correlation threshold is the brood year reconnection date, BY_recon. day, at 100 cfs. No significant correlations are found between coho salmon number of redds and any of the hydrologic variables. Two hydrologic variables show significant predictive power for the coho salmon number of smolt: rearing year fall pulse duration, RY FA_Dur, and rearing year dry season onset timing, RY DS_Tim.

In contrast, nine of the hydrologic variables considered show significant predictive power for the normalized number of coho smolts, the smolt per female spawner (coho spf). This ecologic metric is negatively correlated with BY_recon at all thresholds (higher coho spf for earlier reconnection in the brood year). To a lesser degree, it is positively correlated with rearing year disconnection date (RY_discon at all thresholds; higher coho spf for later RY_discon), and negatively correlated with RY_recon at all thresholds but one. 

Among functional flow metrics, coho spf was positively correlated above the threshold ($R > 0.5$) with the log of total Brood Year flow and the duration of the Rearing Year wet season. Coho spf was negativey correlated (with $R<-0.5$) with the Rearing Year wet season onset timing. Fall pulse metrics also yielded several $|R|>0.5$ correlations. These were excluded from the linear modeling exercise due to insufficient sample size. 

The structure of these correlations (Figure \@ref(fig:corrMatrixFig)) support the current scientific understanding that earlier fall reconnection in the fall and later disconnection in the spring/summer are related to higher relative fish production, or, more fundamentally, that wet years produce good conditions for coho spawning and rearing.

Of the ecological response variables that were evaluated for coho, the coho spf variable clearly showed a higher degree of correlation with hydrologic metrics than other ecological outcome variables. One reason for this metric outperforming the other three (coho salmon spawner abundance, juvenile abundance and number of observed redds) may be that the normalization to the number of spawners makes the three cohorts more comparable, as the spawner cohort size is quite variable among the three 3-year cohort generations, but also between generations of the same cohort. This normalized metric has also been identified by state agency analysts as indicative of freshwater ecosystem conditions at coho salmon populations below carrying capacity [CDFW -@CDFW2021a]. Consequently, we focus the remainder of the hydro-ecological modeling analysis for coho on the coho smolt per female (coho spf) metric as response variable.

For Chinook, conversely, none of the three available ecological response variables stood out as being substantially more correlated with hydrologic metrics than the others (*Supplemental Figure 1*). Furthermore, they all appeared less correlated with the hydrology than the coho variable, i.e., the coho-hydrology correlations, for the same set of predictor variables, generated more $|R|>0.5$ than did correlations between Chinook and hydrology. To be consistent with the coho spf, the Chinook juvenile per adult metric (Chinook jpa) was retained for linear modeling.**

```{r corrMatrixFig, echo = F, warning =F, fig.height = 8.5, fig.width = 7, fig.cap = "Correlations between 41 predictors and 4 coho monitoring metrics. Red colors indicate a negative correlation and blue colors indicate a positive correlation; the size and color of the circle in each box are both scaled to the value of the correlation coefficient. Large blue circles indicate that the quantity (such as the Brood Year fall pulse magnitude, or BY FA_Mag) is positively correlated with observed fish metrics; for dates, a blue dot indicates that a later date is correlated with higher fish values, while a red dot indicates that an earlier dot is correlated with higher fish values. \\label{fig:corrMatrixFig}"}

corr_matrix_pearson = calc_corr_matrix(metrics_tab, corr_method = "pearson")



# find prediction subset for figure.
# include all predictors that 
inclusion_threshold = 0.45
greater_than_thresh_finder = apply(X= corr_matrix_pearson, MARGIN = 1,
                                function(x){sum(abs(x) >= inclusion_threshold,
                                                na.rm=T) > 0})
pred_subset = row.names(corr_matrix_pearson)[greater_than_thresh_finder] 

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = 300)
  
corr_matrix_fig_2(corr_matrix = corr_matrix_pearson, 
                  pred_subset = pred_subset)
  
  dev.off()
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1



```


### Selection of thresholds for flow reconnection and disconnection dates

* selected one flow threshold (the one with the highest $R$) from each category (BY discon, RY recon, etc) for each species (averaged over multiple types of outcome data)
* while it's possible that multiple flow thresholds can carry independent information, for this watershed, for each species, we narrowed it to one flow threshold per category. This decision could be revisited for different watersheds.

Discussion

* We did this because the correlation analysis did not identify multiple 
* In this watershed, salmon passage to access the lower mainstem is possible at a Fort Jones flowrate (~20-40 cfs), while access to upper tributaries is generally associated with a Fort Jones flowrate of 100 cfs [@Sommarstrom2020]. 

**revise text below this section**

We examined relationships between reconnection dates and biological monitoring data to identify the flow threshold(s) with the highest predictive power and potentially the lowest redundancy
(shown for BY_recon and coho spf in Figure \@ref(fig:explanationForBYReconCFSSelection)). The trends in slope value and $R^2$ suggest that the date of crossing lower flow thresholds such as 10 and 15 cfs has greater biological significance than the date of crossing thresholds like 40 cfs, with 20 cfs being somewhat intermediate. In the context of this watershed, it suggests that a Fort Jones gauge flowrate of 10 cfs is a critical threshold for coho passage into the mainstem Scott River.

For Chinook, no significant relationships were obtained between the three ecological observation types and the Brood Year reconnection dates (i.e., no $R^2$ values exceeded 0.1).

It should be noted that for this metric, at very low flows such as 8 and 10 cfs, a data censoring problem emerges, as the flow never drops below the threshold in some years (equivalent to a non-detect datum). "Reconnection" as flows rise above that threshold cannot occur in such years. For these water years, the date of September 1st was selected as the "threshold crossing day". This is considered to represent the earliest date that a spawning coho salmon would require spawning flows measurable at the Fort Jones gauge. Thus, in average and wet years (and, in the mid-20th century, most years) the distribution of values for this threshold-exceeding date for low flowrates would be heavily skewed to September 1st. This data processing method retains the information that the flow in a high-baseflow year may have served the spawning needs of the salmon, but conveys no other information about flow timing. 

At reconnection dates for 100 cfs, the $R^2$ of the relationship is higher than at 40 cfs. In previous monitoring, a Fort Jones gauge flowrate of 100 cfs has corresponded with the reconnection of a key river reach impacted by mine tailings, allowing coho passage to favorable tributary stream habitat upstream of this reach [*pers. comm.*, @Sommarstrom2020]. The relatively high $R^2$ value between the 100 cfs Brood Year reconnection date and coho spf (0.434) suggests that earlier access to this additional habitat improves watershed-wide reproductive outcomes. 

Choosing the two models with the highest $R^2$, we selected the reconnection and disconnection date flow thresholds of 10 cfs and 100 cfs for further analysis (Figure \@ref(fig:explanationForBYReconCFSSelection)). This decision could be revisited if additional years of data become available.

## Lasso regression

```{r lassoResultsCoho, echo = F, warning = F,  fig.height = 8, fig.cap = "Results of lasso regression to predict coho outcomes with hydrologic metrics. Higher values of lambda tend to shrink the absolute values of regression coefficients toward 0 (top panel). Models with more coefficients explain a greater degree of variation in the dataset (middle panel), but also produce higher test errors (lower panel), indicating some overfitting at lower lambda values.\\label{fig:lassoResults}"}


if(y_val_coho=="percent_coho_smolt_survival") {lam_co = 5.3} 
if(y_val_coho=="coho_redds_in_brood"){lam_co = 54}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = 300)
  
  pred_tab_co = lasso_regression_plots(metrics_tab = metrics_tab, 
                                       y_val = y_val_coho,
                                       remove_SY_metrics =
                                         yvlt$remove_sy[yvlt$y_val==y_val_coho],
                                       remove_RY_metrics =
                                         yvlt$remove_ry[yvlt$y_val==y_val_coho],
                                       yvlt=yvlt,
                                       selected_lam = lam_co)

  dev.off()

  # save predictor appearance tab
  pred_tab_filename = "Supplemental Table 3. Coho Salmon Lasso Coefficients.csv"
  write.csv(x=pred_tab_co, file=file.path(graphics_dir,pred_tab_filename),
            quote=F, row.names = F)
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1


```


```{r lassoResultsChinook, echo = F, warning = F,  fig.height = 8, fig.cap = "Results of lasso regression to predict Chinook outcomes with hydrologic metrics. Higher values of lambda tend to shrink the absolute values of regression coefficients toward 0 (top panel). Models with more coefficients explain a greater degree of variation in the dataset (middle panel), but also produce higher test errors (lower panel), indicating some overfitting at lower lambda values.\\label{fig:lassoResultsChinook}"}


# select chinook lambda value
if(y_val_chinook == "chinook_juv_per_adult"){lam_ch = 40} # for Chinook jpa
if(y_val_chinook == "chinook_juvenile_abundance"){lam_ch = 15000} # for Chinook jpa


fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = 300)

  pred_tab_ch = lasso_regression_plots(metrics_tab = metrics_tab, 
                         y_val = y_val_chinook, 
                         remove_SY_metrics =
                                         yvlt$remove_sy[yvlt$y_val==y_val_coho],
                                       remove_RY_metrics =
                                         yvlt$remove_ry[yvlt$y_val==y_val_coho],
                         yvlt = yvlt,
                                       selected_lam = lam_ch)

  dev.off()
  
    # save predictor appearance tab
  pred_tab_filename = "Supplemental Table 4. Chinook Salmon Lasso Coefficients.csv"
  write.csv(x=pred_tab_ch, file=file.path(graphics_dir,pred_tab_filename),
            quote=F, row.names = F)

}
knitr::include_graphics(fig_path)
fig_i = fig_i +1




```


### Ranked predictor importance

* Discuss 

```{r predAppearTabCoho, echo = FALSE, results = 'asis'}

pred_tab_co$lambda_non0_val_appears =
  round(pred_tab_co$lambda_non0_val_appears, 2)
pred_tab_co = pred_tab_co[!is.na(pred_tab_co$lambda_non0_val_appears),]

#Create caption and column labels
caption_text = paste0("Predictors informing the lasso regression for ",
                      yvlt$y_val_title[yvlt$y_val==y_val_coho],
                      "at decreasing lambda values (also referred to as a shrinkage penalty). Lambda values represent the point at which a non-0 coefficient appears for the designated predictor.")
column_labels = c("Predictor","Lambda value")
colnames(pred_tab_co) = column_labels

ptch_ft = flextable(data = pred_tab_co)
ptch_ft = set_caption(ptch_ft, caption = caption_text)
ptch_ft = autofit(ptch_ft)
ptch_ft
```

```{r predAppearTabChinook, echo = FALSE, results = 'asis'}

pred_tab_ch$lambda_non0_val_appears =
  round(pred_tab_ch$lambda_non0_val_appears, 2)
pred_tab_ch = pred_tab_ch[!is.na(pred_tab_ch$lambda_non0_val_appears),]

#Create caption and column labels
caption_text = paste0("Predictors informing the lasso regression for ",
                      yvlt$y_val_title[yvlt$y_val==y_val_chinook],
                      "at decreasing lambda values (also referred to as a shrinkage penalty). Lambda values represent the point at which a non-0 coefficient appears for the designated predictor.")
column_labels = c("Predictor","Lambda value")
colnames(pred_tab_ch) = column_labels

ptc_ft = flextable(data = pred_tab_ch)
ptc_ft = set_caption(ptc_ft, caption = caption_text)
ptc_ft = autofit(ptc_ft)
ptc_ft
```

### Variation explained at different lambda values

* coho - more variation explained with fewer coefficients
* possible interp: in this watershed, Chinook outcomes are less sensitive to flow (or less limited by flow) than coho outcomes

## Hydrologic Benefit Function

### Predictors and coefficients in the selected models


```{r calc_hbf_values_tabs, echo = F, warning =F}

# calculate lasso model based on lambda value selected earlier
lasso_coho = get_lasso_mod(metrics_tab,
                                  y_val = y_val_coho,
                                  lambda_val = lam_co,
                                  remove_extra_recon_thresholds = F,
                                  remove_SY_metrics = F)
lasso_chinook = get_lasso_mod(metrics_tab,
                                  y_val = y_val_chinook,
                                  lambda_val = lam_ch,
                                  remove_extra_recon_thresholds = F,
                                  remove_SY_metrics = T)


# retrieve hydrology for all years of FJ flow
brood_year_hydro_tab_long = tabulate_hydro_by_affected_brood_year(
  brood_years = 1942:2022, smolt_years = 1944:2024)

metrics_tab_long = calc_metrics_hydro_by_affected_brood_year(
  hydro_by_brood_year = brood_year_hydro_tab_long,
  thresholds = thresh_for_corr_fig, 
  reduce_to_eco_data_years_only = F) 

# calculate hbf for all years in which there are hydrodata
hbf_coho = get_hbf_tab(metrics_tab = metrics_tab_long, lasso_mod = lasso_coho)
hbf_chinook = get_hbf_tab(metrics_tab = metrics_tab_long, lasso_mod = lasso_chinook)

# calculate rmse and relative rmse

coho_pred_minus_obs_squared = (hbf_coho$hbf_total -
  metrics_tab_long[,y_val_coho])^2
rmse_coho = sqrt(mean(coho_pred_minus_obs_squared, na.rm=T))
mean_coho = mean(metrics_tab[,y_val_coho], na.rm=T)
rel_rmse_co = rmse_coho / mean_coho

chinook_pred_minus_obs_squared = (hbf_chinook$hbf_total -
  metrics_tab_long[,y_val_chinook])^2
rmse_chinook = sqrt(mean(chinook_pred_minus_obs_squared,
                         na.rm=T))
mean_chinook = mean(metrics_tab[,y_val_chinook], na.rm=T)
rel_rmse_ch = rmse_chinook / mean_chinook

```

Coho lambda: `r lam_co`
Coho RMSE: `r rmse_coho`
Coho relative RMSE: `r rel_rmse_co`

Chinook lambda: `r lam_ch`
Chinook RMSE: `r rmse_chinook`
Chinook relative RMSE: `r rel_rmse_ch`

### Hydrologic Benefit value over time and component contributions

Matching the historical flow trends discussed above (and tabulated in *Supplemental Table 2*), the predicted value of coho spf-equivalent produced by a given water year has trended downward over time (Figure \@ref(fig:hbfOverTime)). The hydrology of a severe drought in water years 2012-2016 is reflected in three consecutive years (2014-2016) of predicted coho spf being lower than 40.

Since 1990, the low predicted coho spf values in dry water years have become progressively lower, culminating in three years, all occurring after water year 2000, in which < 0 coho spf are predicted. Though a negative value for coho reproduction has no physical meaning, we chose to retain these impossible values to visually represent uncertainty associated with this modeling exercise (see Discussion for more information).

The relative influence of different terms in the ensemble average model varies over time: most variability in the 1940s-1970s is due to changes in wet season onset and wet season baseflow duration, but starting in the 1980s the fall flow reconnection timing tends to dominate predictions, especially during low-coho spf years (Figure \@ref(fig:hbfBarchart); the intercept term is excluded for ease of visualization).


```{r hbfOverTime, echo = F, warning = F, fig.height = 8, fig.cap = "Annual observed and predicted values of coho smolt produced per female spawner (coho spf). Predicted coho spf quantities are shown as Hydrologic Benefit (HB) function values. The coho spf values are plotted in the water year spanning each cohort's Brood and Rearing Year. Negative prediction values (considered physically impossible) are flagged but are retained to visually demonstrate the uncertainty in the exercise of predicting fish outcomes from hydrologic metrics alone, based on a small sample size.\\label{fig:hbfOverTime}"}


fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = 300)
   # png(filename = fig_path, width = 11.5, height = 4.2, units = "in", res = 300)
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_coho]
  par(mfrow=c(2,1))
  # par(mfrow = c(1,2))
  # Panel 1. Coho
  hbf_over_time_fig(metrics_tab = metrics_tab,
                    hbf_tab = hbf_coho, y_val = y_val_coho,
                    y_val_axis = y_axis_label)
  
  # Panel 2. Chinook
  hbf_chinook$hbf_total[!is.finite(hbf_chinook$hbf_total)]=NA
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_chinook] 
  hbf_over_time_fig(metrics_tab = metrics_tab,
                    hbf_tab = hbf_chinook, 
                    y_val = y_val_chinook,
                    y_val_axis = y_axis_label) 
  
  
  dev.off()
}
knitr::include_graphics(fig_path)
fig_i = fig_i +1

```


```{r hbfBarchart, echo = F, warning = F, fig.height = 8, fig.cap = "Contributions to annual Hydrologic Benefit values (coho spf-equivalent). A positive value (i.e., one associated with a water year's Wet Season Baseflow Duration) indicates that a longer wet season baseflow duration contributes a positive value to the predicted number of coho spf produced in that cohort. A negative value (e.g., one associated with a water year's Fall Reconnection Day at 10 cfs) indicates that a later reconnection date contributes a negative value to the predicted number of coho spf produced in that cohort.\\label{fig:hbfBarchart}"}

# arrange data - Coho
# only plot if there are at least 1 non-0 coefficient

hbf_coho$hbf_total = NULL # remove this column for this figure
is_it_0 = apply(X=hbf_coho, MARGIN = 2, FUN = mean, na.rm=T)
keep_cols = colnames(hbf_coho[abs(is_it_0)>0])
comp_names_co = keep_cols[keep_cols != "brood_year"]
if(length(comp_names_co)>0){
  bar_data_co = hbf_coho[,keep_cols]
  graph_cols = c("Brood Year", comp_names_co)
  colnames(bar_data_co) = graph_cols
  bd_melt_co = melt(dat = bar_data_co, id.vars = "Brood Year")
  colnames(bd_melt_co)[3] = paste0("Contrib. to Hyd. Ben. value (",
                                  yvlt$y_val_label[
                                    yvlt$y_val==y_val_coho],")")
}

# Arrange data - chinook
hbf_chinook$hbf_total = NULL # remove this column for this figure
is_it_0 = apply(X=hbf_chinook, MARGIN = 2, FUN = mean, na.rm=T)
keep_cols = colnames(hbf_chinook[abs(is_it_0)>0])
comp_names_ch = keep_cols[keep_cols != "brood_year"]
if(length(comp_names_ch)>0){
  bar_data_ch = hbf_chinook[,keep_cols]
  graph_cols = c("Brood Year", comp_names_ch)
  colnames(bar_data_ch) = graph_cols
  bd_melt_ch = melt(dat = bar_data_ch, id.vars = "Brood Year")
  colnames(bd_melt_ch)[3] = paste0("Contrib. to Hyd. Ben. value (",
                                  yvlt$y_val_label[
                                    yvlt$y_val==y_val_chinook],")")
}
# Bar charrrt

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs==T){
  if(length(comp_names_co)>0){
    y_text = colnames(bd_melt_co)[3]
    hbf_bar_co = ggplot(data = bd_melt_co, 
                        aes(x = `Brood Year`, 
                            y = `Contrib. to Hyd. Ben. value (% coho smolt survival)`,
                            fill = variable)) + 
      geom_bar(stat = "identity") + 
      scale_fill_brewer(palette = "Spectral") +
      theme(legend.position = "right", legend.direction = "vertical")
  }
  
  if(length(comp_names_ch)>0){
        y_text = colnames(bd_melt_ch)[3]
        hbf_bar_ch = ggplot(data = bd_melt_ch, 
                        aes(x = `Brood Year`, 
                            y = `Contrib. to Hyd. Ben. value (Chinook juv. per adult)`,
                            fill = variable)) + 
      geom_bar(stat = "identity") + 
      scale_fill_brewer(palette = "Spectral") +
      theme(legend.position = "right", legend.direction = "vertical")
  }
  
  if(length(comp_names_co)>0 & length(comp_names_ch)>0){
        hbf_bar = arrangeGrob(hbf_bar_co, hbf_bar_ch, 
                               nrow=2, ncol=1)
                              # nrow=1,ncol=2) # for ppt slide
  } else if(length(comp_names_co)>0 & length(comp_names_ch)==0){
        hbf_bar =  hbf_bar_co
  } else if(length(comp_names_co)==0 & length(comp_names_ch)>0){
        hbf_bar =  hbf_bar_ch
  }
  
    ggsave(filename = fig_path, plot = hbf_bar, width = 7, height = 8, units="in")
  # ggsave(filename = fig_path, plot = hbf_bar, width = 11.5, height = 4.2, units="in")
}
  

knitr::include_graphics(fig_path)
fig_i = fig_i +1

```


<!-- ```{r hbfBarchartChinook, echo = F, warning = F, fig.height = 8, fig.cap = "Contributions to annual Hydrologic Benefit values. A positive value (i.e., one associated with a water year's Wet Season Baseflow Duration) indicates that a longer wet season baseflow duration contributes a positive value to the predicted number of coho spf produced in that cohort. A negative value (e.g., one associated with a water year's Fall Reconnection Day at 10 cfs) indicates that a later reconnection date contributes a negative value to the predicted number of coho spf produced in that cohort.\\label{fig:hbfBarchartChinook}"} -->

<!-- # arrange data -->
<!-- hbf_chinook$hbf_total = NULL # remove this column for this figure -->
<!-- is_it_0 = apply(X=hbf_chinook, MARGIN = 2, FUN = mean, na.rm=T) -->
<!-- keep_cols = colnames(hbf_chinook[is_it_0>0]) -->
<!-- comp_names = keep_cols[keep_cols != "brood_year"] -->
<!-- bar_data = hbf_chinook[,keep_cols] -->

<!-- graph_cols = c("Brood Year", comp_names) -->
<!-- colnames(bar_data) = graph_cols -->
<!-- bd_melt = melt(dat = bar_data, id.vars = "Brood Year") -->
<!-- colnames(bd_melt)[3] = "Contribution to Hydrologic Benefit value" -->


<!-- # Bar charrrt -->

<!-- fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png")) -->
<!-- if(save_imgs==T){ -->

<!-- ggsave(filename = fig_path, plot = hbf_bar, width = 7, height = 7, units="in") -->
<!-- } -->

<!-- knitr::include_graphics(fig_path) -->
<!-- fig_i = fig_i +1 -->

<!-- ``` -->



### Sensitivity of the Hydrologic Benefit function to one additional data point


```{r lasso_SA, echo = F, warning =F}

metrics_tab_sa = metrics_tab
repl_row = which(metrics_tab_sa$brood_year==2015)
two_y_vals = data.frame(y_vals = c(y_val_coho, y_val_chinook),
                        lambda_vals = c(lam_co,lam_ch))

for(i in 1:2){
  y_val = two_y_vals$y_vals[i]
  lam_val = two_y_vals$lambda_vals[i]
  obs = metrics_tab_sa[,y_val]
  repl_range = c(0, min(obs,na.rm=T), mean(obs,na.rm=T),
                 max(obs,na.rm=T))

  for(j in 1:length(repl_range)){
    repl_val = repl_range[j]
    metrics_tab_sa = metrics_tab
    metrics_tab_sa[repl_row, y_val] == repl_val
    
    lasso_mod = get_lasso_mod(metrics_tab_sa,
                                  y_val = y_val,
                                  lambda_val = lam_val,
                                  remove_extra_recon_thresholds = F,
                                  remove_SY_metrics = F)
  }
}

```

Testing different values for the missing coho spf observation for brood year 2015 suggests that the best-fit HB function weights are relatively sensitive to the addition of one new data point, as can be expected for a small dataset. Flow conditions in and just before water year 2016 (affecting brood year 2015) were very dry, and the hydrologic predictors for water year 2016 generated the lowest predicted coho spf value of the entire Fort Jones gauge flow record (-35.9; see Figure \@ref(fig:hbfOverTime)). 

Replacing this predicted negative value in 2016 (brood year 2015) with an "observed" coho spf value of 0 changes the coefficient (or conceptual weight) of the predictor BY_recon_10 from -1.15 to -0.88 (a difference of 24%). Replacing it with higher numbers produces less and less negative coefficient values. Specifically, a 1-coho spf increase in the missing value makes the coefficient less negative by 0.007 coho spf per day of 10-cfs reconnection delay, such that if it is replaced with the maximum observed coho spf value (101.8), the coefficient is calculated as -0.09 coho spf/day. The other three coefficients are not as sensitive to the new value, ranging from -0.17 -- -0.19, -0.20 -- -0.18, and 0.12 -- 0.13 for BY_recon_100, RY_Wet_Tim, and RY_Wet_BFL_Dur, respectively, when the missing value is replaced by a range from 0 to 101.8.






# Discussion

## Previous work on hydrologic indices and ecological responses

<!-- A river's flow regime is often referred to as a "master variable" controlling geomorphic, chemical, and other conditions in its aquatic ecosystems, and organisms that have evolved to  persist in specific flow regimes are commonly negatively affected by flow alteration [@Bunn2002; @Poff2010]. Consequently, a diversity of methods have been used to predict regional ecological responses to changes in key flow metrics. Many regional case studies predict ecological responses in terms of species richness or macroinvertebrate composition at dozens or hundreds of bioassessment sites [e.g., @Mazor2018; @McManamay2013; @Hain2018; @White2018; @Larsen2021; @Peek2022], and the temporal framework is often a snapshot of the biological changes between natural and altered flow conditions [@Wheeler2018; @Peek2022]. Methods of generating the predictive models include boosted regression trees [@Mazor2018; @Hain2018], stochastic matrix models [@Sakaris2010a], and probabilistic Bayesian Network models [@Bestgen2020], among others. -->

In many previous studies of flow-ecology relationships, all the predictors used to model the ecological response are flow-derived metrics, because flow data is often continuous and more abundant than other data types. Such models rely on the assumption that spatial habitat extent (with flow as its proxy) or flow availability is the limiting factor in ecological recruitment, and thus that change in flow can be directly translated to a fish population response. However, this ignores ecological theory. Under many circumstances, complex internal population feedbacks (such as high juvenile fish density leading to some juvenile fish mortality) will be the limiting factor on fish population size. Consequently, many authors have argued that models of fish population responses to hydrologic changes should explicitly include ecological population modeling in addition to physical factors such as flow or geomorphology [@Rosenfeld2003; @Anderson2006; @LancasterDownes2014; @Acreman2014; @Shenton2012]. Additionally, in at least one case, fish population differences were not successfully predicted with a model based only on a predictor of  flows; other variables such as water temperature were necessary to capture population shifts [@McManamay2013].

In spite of these known limitations, the HB function proposed here uses only hydrologic predictors. In part this is a pragmatic approach, as this work is intended to set the foundation for assessing flow conditions in speculative hydrologic models, which do not simulate non-hydrologic, ecologically-relevant factors such as water quality or internal population dynamics. Furthermore, the hydrologic-only predictor approach may be more valid in this watershed than in a general case, as previous work suggests that flow availability is the major limiting factor on the local salmon fishery [SRWC and Siskiyou RCD -@SRWC2005; NMFS -@NMFS2014]. Lastly, the proposed HB function avoids some of the disadvantages of the snapshot method of comparing the two states of natural and altered flows [@Wheeler2018], because the hydro-ecological dataset is relatively long. This temporal structure, covering a wide range of water year types, makes it possible to test the hypothesis that a measurable relationship exists between hydrologic signal and ecologic response, even within an otherwise more complex relationship involving many non-hydrologic factors.

## Critical flow thresholds

The river reconnection dates of multiple flow thresholds are correlated, to varying degrees, with biological monitoring data (see Results). These correlations support the current scientific understanding that the timing of restoration of habitat connectivity after dry periods in the Scott River is related to the reproductive success of spawning salmon [e.g., Siskiyou County -@SiskiyouCounty2021; *pers. comm.*, @Sommarstrom2020; SRWC -@SRWC2018]. 

The selection of 10 and 100 cfs thresholds for fall flow reconnection dates is informed by both the empirical relationship between thresholds and coho spf observations (Figure \@ref(fig:explanationForBYReconCFSSelection)) and professional judgment regarding which flows typically facilitate coho spawning passage into the valley and access to a large amount of tributary habitat. However, multiple caveats apply to these thresholds. First, though the timing of the 10 cfs reconnection had the strongest correlation with observed coho spf values, a flow of 18 to 25 cfs has been reported in stakeholder meetings as the minimum flowrate during which fish can pass upriver into Scott Valley [SVGAC -@SVGAC_2020_Nov]. Second, the extent to which the flow at the Fort Jones gauge represents conditions in the rest of the watershed depends on the speed of hydrologic processes taking place. When the transition from the dry season to the wet season is especially abrupt, flow in the tributaries may increase hours before the Fort Jones gauge flow responds (e.g. as was observed in response to the storm in late October of 2021).

Additional fish population monitoring in future water years will be instrumental in better constraining the nuances of these hydro-ecological relationships and the conditions in which hydrology can be used to predict outcomes for anadromous fish.

## Predictability of Chinook versus coho salmon

In the dataset evaluated here, hydrologic metrics have a much greater capacity to predict reproduction in coho salmon than in Chinook. This difference may be due to any number of distinctions in the life history and reproductive strategies of the two species  (see Section 2.2.4). Some possibilities include:

* Coho salmon prefer smaller tributary stream habitat for spawning, while Chinook prefer larger gravels found on the mainstem of the Scott River. Consequently, coho salmon may be more sensitive to the amount of river connectivity and thus total salmon-accessible habitat during their spawning window.
* Chinook typically do not oversummer in the freshwater system, potentially making them less vulnerable than coho to dry season conditions.
* Chinook populations may be more strongly affected by ocean conditions than coho salmon, possibly due to behavior differences during their period of ocean residence, which is not examined here. This factor may exert a more powerful control on the number of returning spawners than freshwater conditions. 

Regardless of the ultimate cause(s), this difference in predictability underscores the fact that the prediction exercise undertaken in this study can only be performed successfully for some species and some regions.

## Hydrologic Benefit (HB) function predictive performance and sensitivity

For the 11 years in which observed coho spf values are available, the HB function was reasonably accurate in its predictions (Figure \@ref(fig:hbfOverTime)). In particular, it succeeded in predicting whether a coho spf year would be above or below 40 (an arbitrary threshold based on visual inspection of the grouping of the 11 observed values). A more conservative use of this model would be to assign a high-low threshold, and categorize each water year as a "high-coho spf" or "low-coho spf" year based on its relation to this threshold. However, for purposes of this discussion we retain the full distribution of values.

These linear models have been developed for a Coho Freshwater Life Period (see Figure \@ref(fig:cohoLifeCycleFigure) ), but the relevant time period for decisionmakers is typically a water year or shorter. It was possible to select a set of best models that fit within one water year, in that they range from the fall of the Brood Year through the wet season of the immediately following Rearing Year. With this formulation, a prediction could be made each fall, using the flow record of the preceding water year and the estimated number of female spawners during the previous fall-winter, regarding the number of smolts to be observed in the coming spring. This smolt abundance prediction could be made to test the model quality when confronted with new data. 

The predictive power of the Hydrologic Benefit formula beyond the hydrologic conditions of water years 2007-2020 remains untestable; for this reason the coho spf prediction values of water years pre-2007 should be treated with skepticism. Notably, the hydrologic phenomena that constitute the limiting factors on salmon reproduction might have been very different in the watershed in past decades (e.g., if fall flows were not a major constraint, then spring rearing habitat, or possibly scouring storm flows in winter, might show stronger correlations with coho reproduction).

Additionally, the sensitivity exercise indicated that even one additional data point can alter the ensemble coefficient, or weight, of the most important predictor (Brood Year reconnection timing, 10 cfs) by at least 24%; thus it is reasonable to assume that if more data is collected in the future, the HB function coefficients and possibly even the set of best hydrologic predictors may shift. Nevertheless, the limited data available can be used to draw some preliminary conclusions regarding bio-hydrologic relationships in the Scott River watershed.

## Metric weights and importance

The relative contributions of each metric, shown in Figure \@ref(fig:hbfBarchart), indicate that the weighted metric introducing the greatest variability in coho spf predictions is the reconnection date at the 10 cfs threshold; in other words, an important common feature of the water years that yield very low coho spf predictions is a relatively long fall period of flow <10 cfs.

Figure \@ref(fig:hbfBarchart) also highlights that three of the four selected hydrologic metrics are negatively correlated with coho spf values. This means the HB function relies on a positive intercept value to generate positive coho spf predictions, and because the intercept value can be outweighed by combinations of flow metric values that are within the range of possibility, this formulation allows the prediction of negative values. A negative value, or a prediction of coho smolt consumption rather than production, is obviously not possible based on our understanding of the coho salmon life cycle (Figure \@ref(fig:cohoLifeCycleFigure)).

Unfortunately, observed coho spf values are not available for any of the water years in which a negative value is predicted (2002, 2016 and 2021; Figure \@ref(fig:hbfOverTime)), so a direct comparison of prediction accuracy is not possible in these water years. However, given that the coho run persisted in the Scott River watershed beyond the 3-year cohort-return interval (i.e., water years 2005 and 2019), some smolt production greater than 0 in these years is highly likely.

The metrics most related to watershed-scale coho spf occur during the window of their parents' spawning and, to a lesser extent, in the winter through summer of their early rearing. At least three potential mechanisms have been hypothesized regarding the importance of fall flow timing and magnitude to coho salmon. During dry water years, when fall reconnection dates are delayed, coho have been known to spawn in suboptimal habitat [e.g., @SiskiyouRCD2014]. Eggs laid in suboptimal conditions suffer from higher mortality rates for multiple reasons, including egg burial by transported sediment, channel bed scouring, or unfavorable water quality [@BjornnReiser1991]. Additionally, anadromous fish do not eat during spawning, and a delayed reconnection date, with a corresponding longer waiting period before spawning habitat becomes accessible, leads to higher rates of exhaustion and potentially higher mortality during spawning in long high-elevation spawning migrations [e.g., sockeye salmon in @Crossin2004]. Finally, early reconnection flows and related access to more and higher-quality habitat may allow spawning salmon to select more favorable nesting sites, which could exert a controlling influence on the mortality rates of the young produced that year.

It is also notable that the metrics with the highest predictive power are associated with negative values, or coho spf penalties. One possible interpretation is that hydrologic metrics can be useful for identifying unfavorable conditions for coho salmon, but are not sufficient to describe favorable conditions. The ecological theory that may explain this further is beyond the scope of this paper, but could be a focus of future studies.

## Implications for water and fisheries management

This study represents a contribution to the large body of work seeking to understand and conserve aquatic ecosystems in the Klamath basin, and in aquatic ecosystems in Mediterranean climates more generally. Viability of the SONCC ESU population of coho salmon has been examined at a regional scale in the past, though conclusions were preliminary, due to data limitations [@Williams2006; @Williams2008]. A proposed framework to assess viability included the following factors [@Williams2008]:

* Effective population size
* Population size per generation
* Population decline (rate of decline)
* Catastrophic decline (order of magnitude decline within 1 generation)
* Spawner density
* Potential spatial habitat capacity, in units of Intrinsic Potential (IP)
* Hatchery influence
* Extinction risk from population viability analysis model

This work can potentially help managers understand some of the mechanisms driving the population size per generation dimension of this viability schematic - though its predictive power is limited to being relative to the size of the escapement.

We note also that any adaptive management other than flow management (e.g., water use or habitat restoration) will introduce (and surely has already introduced) confounding factors into this modeling exercise. For example, extreme dry conditions and high occurrence of fish stranding in water year 2014 led agencies and local organizations to conduct an unprecedented juvenile salmon rescue operation [CDFW -@CDFW2015a]. It is possible the coho spf for water year (and Rearing Year) 2014 would have been even lower without that intervention (although this is hard to judge; it is also possible that the translocation stressed the fish and may have led to increased mortality rates). Future work may be able to estimate the independent coho population impact of these non-flow adaptive management tactics. 

We expect pieces of this approach could be employed in other regional studies, though in systems with shorter or minimal ecological monitoring records, opportunities to find correlations between flow and biological metrics may be sample size-limited to an even greater degree than in this study. However, this study may show the value of even a dozen years of monitoring data in a range of water year types, and could provide motivation to continue investing in data collection and the monitoring of sensitive species. 

# Conclusions

This case study uses the functional flow framework and long-term biological monitoring to relate hydrologic conditions to watershed-scale anadromous fish reproduction rates. The empirical flow-biology relationships evaluated here also suggest hypotheses regarding the watershed-specific mechanisms of ecological response to flow variability.

To learn if it was possible to empirically quantify a hydrologic regime that meets the ecological needs of coho salmon in the Scott River watershed, we examined correlations between several dozen hydrologic metrics and local salmon observations. We found several metrics, both from prior studies [@Patterson2020; @Yarnell2020] and designed for this study (Figure \@ref(fig:reconnectExplainerHydrograph)), that appeared correlated with the number of coho smolts produced per female spawner (coho spf). The two flow metrics most correlated with the coho spf of a given smolt cohort were the first date after the dry season of flows rising above 10 and 100 cfs, respectively, during the spawning window for the cohort's parents. This suggests that in the Scott River watershed, flow conditions and habitat access during spawning may be the greatest single factor in a brood's success, affecting the cohort from the egg stage through outmigration to the ocean. 

We used linear models to predict coho spf values for each water year based on potential combinations of one and two hydrologic metric predictors. The intercept and slopes of the three best of these linear models were aggregated to formulate a Hydrologic Benefit function (Figure \@ref(fig:hbfOverTime)). With this formulation, a prediction could be made each fall, using the flow hydrology of the preceding water year and the estimated number of female spawners during the previous fall-winter, regarding the number of smolts to be observed in the coming spring. It can also be applied to the river flow output of hydrologic models simulating various management scenarios, to estimate the impact of infrastructure or regulation on local salmon reproduction.

Conversely, we did not find that Chinook reproduction observations could be predicted with as much success as coho using the same set of hydrologic data. This suggests that the utility of this type of analysis is both region- and species-dependent. 

With continuing trends of a narrowing wet season in the Scott River watershed (e.g., Figure \@ref(fig:reAndDisconTimeseries)), entities aiming to sustain local fisheries may find themselves working with ever-thinner margins for error. Globally, in communities living and working with local natural resources, climate change may transform biodiversity-preservation  activities into long-term engineering of novel ecosystems. If this occurs, long-term monitoring and frequently re-evaluated flow-ecology relationships will be necessary to support such efforts.

\newpage


<!-- # 7. References -->

# scratch work

## linear modeling

<!-- ## Linear modeling -->

<!-- ### Hydrologic predictors and model structure  -->

<!-- With two disconnection/reconnection flow thresholds (10 cfs, 100 cfs), a total of 36 hydrologic predictor variables are available for analysis. All hydrologic predictors were used to generate the set of possible 1- and 2-predictor linear models of the relative reproduction for Chinook (Chinook jpa) and coho (coho spf) salmon. Coho reproduction rates appear to be correlated with some hydrologic metrics, based on the hydrologic conditions and coho observations in brood years 2004 - 2019, corresponding to water years 2007-2020. Relative reproduction in Chinook was less predictable than in coho, using the same set of hydrologic predictors: for Chinook, maximum $R^2$ values were 0.2 and 0.5 for single- and two-predictor models, respectively, while for coho they were 0.5 and 0.9 (Figure \@ref(fig:allLMsCohoChinook)). Given the limited strength of the Chinook data, the development of the HB function was conducted only for coho salmon, yielding 36 + 36^2^ = 1,332 linear models. -->

<!-- To select the most relevant models from the ensemble of 1,332 models, we first considered their $R^2$ and $p$ values. Most models for either coho spf or Chinook jpf produce unacceptable $p$ values, $p > 0.2$. Single predictor models with $p$ values of less than 0.2 reach $R^2$ values as high as 0.5 for coho spf, but only 0.2 for Chinook jpf (Figure \@ref(fig:allLMsCohoChinook)). As established already by simple correlation analysis for the original 49 hydrologic predictors, above, coho spf are significantly correlated with some of these hydrologic metrics, based on the hydrologic conditions and coho observations in brood years 2004-2019, corresponding to water years 2005-2020. Specifically, brood year reconnection, BY reconn. Day at 10 cfs and 100 cfs, brood year total flow, log of BY Tot. Flow Sep-Dec, brood year fall pulse magnitude and duration, BY_FA_Mag and BY_FA_Dur, rearing year fall pulse magnitude, RY FA_tim, and rearing year wet season timing and baseflow duration, RY Wet_Tim and RY BFL_Dur, exceed the correlation threshold criterion. Relative reproduction in Chinook was less predictable than in coho, using the same set of hydrologic predictors. -->

<!-- **Explain negative R^2^ values** -->


<!-- ```{r lm_diagnostics_supp_tabs, echo = F, warning =F} -->

<!-- supp_tab_titles = c("Supplemental Table 3 - One Predictor Models of Coho spf.csv", -->
<!--                     "Supplemental Table 4 - One Predictor Models of Chinook jpa.csv", -->
<!--                     "Supplemental Table 5 - Two Predictor Models of Coho spf.csv", -->
<!--                     "Supplemental Table 6 - Two Predictor Models of Chinook jpa.csv") -->

<!-- if(sum(file.exists(file.path(graphics_dir, supp_tab_titles))) < 4){ -->
<!--   save_lm_diagnostics_tables(metrics_tab = metrics_tab) -->
<!-- } -->

<!-- ``` -->



<!-- ```{r allLMsCohoChinook, echo = F, warning =F, fig.cap = "The adjusted R square and P values of all possible linear models (1- and 2-predictors) for Chinook and coho relative reproduction, using all hydrologic metrics described above. Based on the much lower predictability of Chinook outcomes, the flow-ecology prediction exercise was carried out only for coho salmon.\\label{fig:allLMsCohoChinook}"} -->

<!-- #Reset metrics tab to include only values with coho smolt per fem obs -->
<!-- # metrics_tab_all_yrs = metrics_tab # store table with all years -->
<!-- # metrics_tab_ch = metrics_tab_all_yrs[!is.na(metrics_tab_all_yrs$chinook_juv_per_adult),] -->
<!-- # # metrics_tab_ch = metrics_tab_all_yrs[!is.na(metrics_tab_all_yrs$chinook_juvenile_abundance),] -->
<!-- # metrics_tab_co = metrics_tab_all_yrs[!is.na(metrics_tab_all_yrs$coho_smolt_per_fem),] -->

<!-- fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png")) -->
<!-- if(save_imgs == TRUE){ -->

<!--   png(filename = fig_path, width = 7, height = 6, units = "in", res = 300) -->

<!--     par(mfrow =c(2,2),mar = c(4,4,3,2)) -->
<!-- test = all_lms_tab_and_plot(data_tab = metrics_tab_ch,  -->
<!--                             y_name = "chinook_juv_per_adult",  -->
<!--                             num_xs = 1, -->
<!--                             ylab_text = "Adj. R squared") -->
<!-- test = all_lms_tab_and_plot(data_tab = metrics_tab_co,  -->
<!--                             y_name = "coho_smolt_per_fem",  -->
<!--                             num_xs = 1) -->
<!-- test = all_lms_tab_and_plot(data_tab = metrics_tab_ch,  -->
<!--                             y_name = "chinook_juv_per_adult",  -->
<!--                             num_xs = 2,  -->
<!--                             alpha_val = .1, -->
<!--                             ylab_text = "Adj. R squared",  -->
<!--                             xlab_text = "linear model P value") -->
<!-- test = all_lms_tab_and_plot(data_tab = metrics_tab_co,  -->
<!--                             y_name = "coho_smolt_per_fem",  -->
<!--                             num_xs = 2,  -->
<!--                             alpha_val = .1, -->
<!--                             xlab_text = "linear model P value") -->
<!--   dev.off() -->

<!-- } -->
<!-- knitr::include_graphics(fig_path) -->
<!-- fig_i = fig_i +1 -->

<!-- ``` -->
<!-- For coho, the best single-predictor models (Brood Year fall reconnection dates for 10 and 100 cfs, or BY_recon_10 and BY_recon_100) are both related to the timing of rising fall flows in the Brood Year of each salmon cohort (Table \@ref(tab:bestLMSummaryTab)). Not surprisingly then, the predictor BY_FA_Mag was also highly correlated with coho spf (Figure \@ref(fig:corrMatrixFig)). However, because a distinct fall pulse does not occur every year, including any fall pulse (FA) metrics would reduce the sample size to an unacceptable level (i.e., a total of six water years with a complete set of predictors and response observations). Because of this sample size limitation, but also because some of the information about this pulse is strongly embedded in the reconnection date metric, FA metrics were not further considered potential predictors. -->

<!-- Two predictor models provided significantly better results than single-predictor models: for Chinook, maximum $R^2$ valuse never exceeded 0.5, even at very low $p$ values. For coho spf, two-predictor linear models achieved maximum values of 0.9 with simultaneously very low $p$ values ($p<0.5$; Figure \@ref(fig:allLMsCohoChinook) and *Supplemental Tables 3* through *6*). -->

<!-- **AIC results** -->

<!-- **F-statistics results** -->

<!-- _Tasks for making 4.2 more systematic_ -->

<!-- * Pre-filter out FA metrics (and recon and discon? thresholds) for inclusion in Fig \@ref(fig:allLMsCohoChinook) -->
<!-- * Clarify number of predictors going into full lm exercise (36?)  -->
<!-- * check unit on Spring ROC for Fig 5 -->
<!-- * add LOOCV column to Supp Tabs. **DONE** -->



<!-- , as well as in the increased $R^2$ values, reduced AIC~c~ values, and reduced average error when comparing models lm2a and lm2b versus lm1a and lm1b (Tables \@ref(tab:bestLMSummaryTab) and \@ref(tab:modelErrorTab); Figure \@ref(fig:lmPredVObs)).  -->


<!-- Given the limited strength of the Chinook data, the development of the HB function was conducted only for coho salmon. -->

<!-- ### Model selection criteria  -->

<!-- Similar to the thresholds used to discern the power of basic correlations between hydrologic predictor variables and ecologic outcomes, minimum performance criteria were established to select the final set of best linear model were: adjusted $R^2$ value of >0.6, a p-value of <0.2, an F-statistic of more than 10, and a LOOCV value of less than 747 (i.e., the LOOCV value of the best one-predictor model). The predictors and slopes of the three models which met these criteria (lm2a, lm2b, and lm2c) are shown in Table \@ref(tab:bestLMSlopesTab).  -->

<!-- These criteria were selected using professional judgment based on the features of the available models, and the diversity of predictors in the resulting ensemble model. For example, the selection of a p-value criteria of <0.2 allowed the inclusion of lm2c (Table \@ref(tab:bestLMSummaryTab)), with a p-value of 0.18, but excluded lm2d, with a p-value of 0.64. The authors felt that this was a reasonable cutoff in statistical significance for such a small sample size of observed response variable. Additionally, the three models that met these criteria incorporate information from the end of a dry season (BY_recon_10 and 100), the onset of the wet season (RY_Wet_Tim), and the wet season duration (Wet_BFL_Dur), which supports the professional judgment of the authors that the degree of hydro-ecological services provided each water year is best evaluated using information from multiple seasons.  -->

<!-- For coho, because the predictor BY_recon_10 (Brood Year reconnection date, 10 cfs) performed so much better than all other metrics in the one-predictor model set, all two-predictor models evaluated included that predictor (Table 2). Specifically, each of the three two-predictor models which met the selection criterio included BY_recon_10 and an indication of the onset or duration of the following wet season: Brood Year reconnection date for 100 cfs (BY_recon_100), wet season onset or duration for the Rearing Year (RY_Wet_Tim and RY_Wet_BFL_Dur). (Though they both occur as the Brood Year transitions to the Rearing Year, the two metrics BY_recon_100 and RY_Wet_Tim are not highly correlated, due to the more complex criteria needed for a flow event to qualify as the wet season onset.) -->

<!-- ```{r lmPredVObs, echo = F, warning = F, fig.cap = "Predicted vs observed values for coho smolt production per female in the linear models with one through four hydrologic predictors. A dashed 1:1 line is included for reference."} -->

<!-- # Select best 1 predictor model for coho -->
<!-- pred1= make_table_of_all_lms(data_tab = metrics_tab, graph_p_adjR=F, -->
<!--                               y_name = "coho_smolt_per_fem", num_xs = 1) -->
<!-- colnames(pred1)[1]="pred1" -->
<!-- best_1 = pred1[pred1$Fstat>10,] -->

<!-- ### 2a. Selection of best 2 predictor model for coho -->
<!-- pred2 = make_table_of_all_lms(data_tab = metrics_tab, graph_p_adjR=F, -->
<!--                               y_name = "coho_smolt_per_fem", num_xs = 2) -->
<!-- pred2 = pred2[!is.na(pred2$pval),] # get rid of NA rows -->
<!-- colnames(pred2)[1:2] = c("pred1", "pred2") -->

<!-- best_2 = pred2[pred2$Rsquare>.6 & pred2$pval < .2 & -->
<!--                  pred2$Fstat > 10 & -->
<!--                  !grepl(pattern = "FA", x = pred2$pred1) & -->
<!--                  !grepl(pattern = "FA", x = pred2$pred2),] -->
<!-- best_2 = best_2[!duplicated(round(best_2$Fstat,4)),] # remove duplicates -->

<!-- best_for_fig = data.frame(model_id = c("lm1a","lm2a","lm2b","lm2c"),  -->
<!--                        x1=c(best_1$pred1,best_2$pred1),  -->
<!--                        x2 = c(NA,best_2$pred2)) -->

<!-- fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png")) -->
<!-- if(save_imgs == TRUE){ -->
<!--   png(filename = fig_path, width = 7, height = 8, units = "in", res = 300) -->

<!-- lm_pred_v_obs_fig(best_tab = best_for_fig,  -->
<!--                   metrics_tab = metrics_tab, plot_rowscols = c(2,2)) -->

<!--   dev.off() -->
<!-- } -->
<!-- knitr::include_graphics(fig_path) -->
<!-- fig_i = fig_i +1 -->


<!-- ``` -->

## threshold selection


<!-- ```{r explanationForBYReconCFSSelection, echo = F, warning = F,  fig.height = 8, fig.cap = "Correlations between the 'reconnection' dates, or dates of fall flow rising above the designated flow threshold, for six flowrates.  X-axis units are days after Aug. 31 of the coho salmon cohort Birth Year.\\label{fig:explanationForBYReconCFSSelection}"} -->


<!-- #rerun metrics tab with mostly-low cfs thresholds for these explainer figures -->
<!-- thresh_for_explain_fig = c(10,40,100, 200) -->

<!-- metrics_tab_for_explainer = calc_metrics_hydro_by_affected_brood_year( -->
<!--   hydro_by_smolt_year = brood_year_hydro_tab, -->
<!--   thresholds = thresh_for_explain_fig)  -->


<!-- fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png")) -->
<!-- if(save_imgs == TRUE){ -->
<!--   png(filename = fig_path, width = 7, height = 8, units = "in", res = 300) -->

<!-- threshold_explainer_trendlines(data_tab = metrics_tab_for_explainer, -->
<!--                                thresholds = thresh_for_explain_fig, -->
<!--                                y_name = "coho_smolt_per_fem") -->

<!-- # threshold_explainer_trendlines(data_tab = metrics_tab_for_explainer, -->
<!-- #                                thresholds = thresh_for_explain_fig, -->
<!-- #                                # y_name = "chinook_juvenile_abundance", -->
<!-- #                                # y_name = "chinook_spawner_abundance", -->
<!-- #                                y_name = "chinook_juv_per_adult", -->
<!-- #                                print_r2 = T) -->

<!--   dev.off() -->
<!-- } -->
<!-- knitr::include_graphics(fig_path) -->
<!-- fig_i = fig_i +1 -->

<!-- ``` -->


## best LM summary

<!-- ```{r bestLMSummaryTab, echo = FALSE, results = 'asis'} -->


<!-- #Create caption and column labels -->
<!-- caption_text = "Summary statistics of an example set of linear models predicting the number of coho smolt produced per female in a given water year. Because the Brood Year reconnection date for 10 cfs was by far the best single-predictor model, it is included in all two-predictor models under consideration." -->
<!-- column_labels = c("Model","Predictor(s)", "F-stat.", "P-value", "R squared", "Adj. R squared", "AICc") -->

<!-- # #Reset metrics tab to include only values with salmon relative reproduction values -->
<!-- metrics_tab_co = metrics_tab[!is.na(metrics_tab$coho_smolt_per_fem),] -->

<!-- best_for_demo_tab = read.csv(file.path(data_dir,"best_model_predictors_2022.03.30_demo extras.csv")) -->
<!-- best_vals = make_lm_table_for_rmd(best_tab = best_for_demo_tab, data_tab = metrics_tab_co) -->
<!-- colnames(best_vals) = column_labels -->

<!-- best_vals_ft = flextable(data = best_vals)#, col_keys = column_labels) -->
<!-- best_vals_ft = colformat_double(x = best_vals_ft, j=3, digits = 1) -->
<!-- best_vals_ft = colformat_double(x = best_vals_ft, j=4, digits = 5) -->
<!-- best_vals_ft = colformat_double(x = best_vals_ft, j=5, digits = 3) -->
<!-- best_vals_ft = colformat_double(x = best_vals_ft, j=6, digits = 3) -->
<!-- best_vals_ft = colformat_double(x = best_vals_ft, j=7, digits = 1) -->
<!-- best_vals_ft = set_caption(best_vals_ft, caption = caption_text) -->
<!-- best_vals_ft = autofit(best_vals_ft) -->
<!-- best_vals_ft = width(x = best_vals_ft, j=2, width = 1.5) -->
<!-- best_vals_ft = hline(best_vals_ft, i=4) -->
<!-- best_vals_ft -->

<!-- ``` -->



<!-- ```{r bestLMSlopesTab, echo = F, results = 'asis'} -->



<!-- # build slopes table for all predictors -->
<!-- best_for_slopes_tab = best_for_fig[!(is.na(best_for_fig$x2)),] -->
<!-- coef_tab = best_lms_slopes_table(best_tab = best_for_slopes_tab, data_tab = metrics_tab) -->

<!-- # Add averaged row for HBF weights -->
<!-- mean_row = colSums(coef_tab, na.rm=T) / nrow(coef_tab) -->
<!-- coef_tab = rbind(coef_tab, mean_row) -->
<!-- rownames(coef_tab)[nrow(coef_tab)] = "Ensemble Avg." -->

<!-- # Record for use in Ch. 2 -->
<!-- write.csv(coef_tab, file.path(graphics_dir, -->
<!--                               "best linear model coefficients table_2022 march.csv")) -->


<!-- #Create caption and column labels -->
<!-- caption_text = "Summary of slope values (coho smolt per female per relevant unit) for predictors included in the three best linear models. The ensemble average values are used as weights in the Hydrologic Benefit function." -->

<!-- preds = unique(unlist(best_for_slopes_tab[,colnames(best_for_slopes_tab)!="model_id"])) -->
<!-- preds = preds[preds!="" & !is.na(preds)] # take out the blanks -->

<!-- column_labels =c("Model ID","Intercept", preds) #c("Model ID", preds) -->

<!-- coef_tab$model_id = c("lm2a","lm2b","lm2c","Ensemble Avg.") -->
<!-- coef_tab = coef_tab[,c("model_id",colnames(coef_tab)[1:(ncol(coef_tab)-1)])] -->
<!-- colnames(coef_tab) = column_labels -->

<!-- lm_coef_ft = flextable(data = coef_tab) -->
<!-- lm_coef_ft = colformat_double(x = lm_coef_ft, j = 1, digits = 1) -->
<!-- lm_coef_ft = colformat_double(x = lm_coef_ft, j = 2, digits = 2) -->
<!-- lm_coef_ft = colformat_double(x = lm_coef_ft, j = 3, digits = 2) -->
<!-- lm_coef_ft = colformat_double(x = lm_coef_ft, j = 4, digits = 2) -->
<!-- lm_coef_ft = colformat_double(x = lm_coef_ft, j = 5, digits = 2) -->
<!-- lm_coef_ft = hline(lm_coef_ft, i=3) -->
<!-- lm_coef_ft = set_caption(lm_coef_ft, caption = caption_text) -->
<!-- autofit(lm_coef_ft) -->
<!-- ``` -->


## loocv scribbling



<!-- ```{r modelErrorTab, echo = FALSE, results = 'asis'} -->


<!-- rmse_tab = data.frame(lambda_val = best_for_demo_tab$model_id, -->
<!--                             rmse = NA) -->


<!-- homebrew_loocv2 = function(data_tab, lasso_mod, -->
<!--                            y_val, lambda_val){ -->

<!--   coefs = as.data.frame(t(as.matrix(coef(lasso_mod)))) -->
<!--   #isolate intercept -->
<!--   int_picker = which(colnames(coefs)=="(Intercept)") -->
<!--   intercept = coefs[int_picker] -->
<!--   coefs = coefs[-int_picker] -->
<!--   preds_lasso = coefs[,coefs>0] -->

<!--   output_tab = data_tab -->

<!--   # # store relevant metric values in an intermediate table -->
<!--   # intermed_tab=data_tab -->
<!--   # intermed_tab=intermed_tab[,colnames(intermed_tab) %in% -->
<!--   #                             c(colnames(coefs),"brood_year")] -->
<!--   # match metrics tab to coefficients -->
<!--   term_matcher = match( colnames(coefs), colnames(output_tab)) -->

<!--   # record HB contribution values in an output tab. initialize all values to NA -->
<!--   # output_tab = intermed_tab -->
<!--   # output_tab[,term_matcher] = NA -->
<!--   output_tab$loocv_obs_minus_predicted = NA -->

<!--   for(i in 1:nrow(output_tab)){ -->
<!--     loop_tab = data_tab[-i,] -->

<!--     lasso_loop = get_lasso_mod(metrics_tab = loop_tab,  -->
<!--                                y_val = y_val, -->
<!--                                lambda_val = lambda_val, -->
<!--                                ) -->
<!--     hb_components = by_vals [term_matcher] * coefs -->
<!--     output_tab[i,term_matcher] = hb_components -->
<!--   } -->

<!--   # sum all components for annual HB values -->
<!--   brood_year_col = which(colnames(output_tab)=="brood_year") -->
<!--   output_tab$hbf_total = as.numeric(intercept) + apply(X=output_tab[,-brood_year_col], -->
<!--                                                        MARGIN = 1, FUN=sum,na.rm=T) -->








<!--   for(i in 1:nrow(data_tab)){ -->
<!--     obs_i = data_tab[i,y_val] -->
<!--     predictor_vals_i = as.numeric(data_tab[i, preds_lasso]) -->

<!--     # build lm from subset -->
<!--     data_sub = data_tab[-i,] # leave this one out -->
<!--     lm_sub = lm(data = data_sub, f1) -->

<!--     coeffs = data.frame(summary(lm_sub)$coefficients) -->

<!--     lm_int = coeffs$Estimate[row.names(coeffs)=="(Intercept)"] -->
<!--     slopes = as.numeric(coeffs$Estimate[row.names(coeffs)!="(Intercept)"]) -->

<!--     predicted_val_i = lm_int + sum(slopes * predictor_vals_i) -->

<!--     output_tab$loocv_obs_minus_predicted[i] = obs_i - predicted_val_i -->
<!--   } -->

<!--   output_tab$MSE = (output_tab$loocv_obs_minus_predicted)^2 -->
<!--   CV_n = 1/nrow(output_tab) * sum(output_tab$MSE) -->

<!--   if(output_type == "table"){return(output_tab)} -->
<!--   if(output_type == "LOOCV"){return(CV_n)} -->
<!-- } -->

<!-- test = homebrew_loocv2(data_tab = metrics_tab, -->
<!--                        lasso_mod = lasso_coho,  -->
<!--                        y_val = y_val_coho) -->

<!-- # Build test error table -->

<!-- for(i in 1:nrow(best_for_demo_tab)){ -->
<!--   preds = best_for_demo_tab[i,colnames(best_for_demo_tab)!="model_id"] -->
<!--   preds_i = preds[preds!="" & !is.na(preds)] -->

<!--   loocv_i = homebrew_loocv(data_tab = metrics_tab_co, preds_lasso = preds_i) -->
<!--   # store error values in table -->
<!--   test_error_tab$loocv[i] = round(loocv_i) -->
<!--   test_error_tab$avg_pred_error[i] = round(sqrt(loocv_i),1) -->

<!-- } -->

<!-- #Create caption and column labels -->
<!-- caption_text = "Average model prediction error, based on leave-one-out cross-validation (James et al., 2013)." -->
<!-- column_labels = c("Model","LOOCV value", "Average error (coho spf-equiv.)") -->
<!-- colnames(test_error_tab) = column_labels -->

<!-- loocv_ft = flextable(data = test_error_tab) -->
<!-- loocv_ft =  set_table_properties(loocv_ft, opts_word = list(split=F, keep_with_next=T)) -->
<!-- loocv_ft = set_caption(loocv_ft, caption = caption_text) -->
<!-- loocv_ft = autofit(loocv_ft) -->
<!-- loocv_ft = width(x = loocv_ft, j=3, width = 1.5) -->
<!-- loocv_ft -->
<!-- ``` -->


## HB formula
<!-- To avoid over-interpreting results based on the small ecological dataset of coho reproduction, the coefficients of the three best two-predictor linear models ($n = 3$ in Equation 1) were averaged into the coefficients of an ensemble model shown in Table 4. The ensemble model coefficients provide the formulation of the Hydrologic Benefit function (Equation 2). -->


<!-- $$ -->
<!-- HB_{wy} = b + m_{1}*metric_{1,~wy} + ... + m_{4}*metric_{4,~wy} -->
<!-- $$ -->

<!-- Where: -->

<!-- $HB_{wy} = Hydrologic~Benefit~value~for~a~given~water~year~(coho~spf~equiv.)$ -->

<!-- $b = 93.4 ~spf~equiv.$ -->

<!-- $m_{1} = -1.15~spf~equiv. / (day~of~reconnection~after~Aug.~31,~10~cfs)$ -->

<!-- $m_{2} = -0.17~spf~equiv. / (day~of~reconnection~after~Aug.~31,~100~cfs)$ -->

<!-- $m_{3} = -0.20~spf~equiv. / (day~of~wet~season~onset~after~Sep.~30)$ -->

<!-- $m_{4} = 0.12~spf~equiv. / (day~of~wet~season~baseflow~duration)$ -->



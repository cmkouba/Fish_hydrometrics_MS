---
title: A watershed-specific formula to predict salmon reproduction using functional flow metrics
author: "Claire Kouba, Jason Wiener, Leland Scantlebury and Thomas Harter"
date: "June 2025"
output: 
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
bibliography: draft_library.bib
---

```{r setup_dirs_load_data, include = FALSE}

# biblio-style: "apalike"

knitr::opts_chunk$set(echo = TRUE)


library(lubridate)
library(httr)
library(ggplot2) # for barplots 
library(gridExtra)
library(corrplot)  # for data exploration/correlation plots
library(dataRetrieval) # for usgs data
library(data.table) #month function
library(zoo) # rolling means
library(sf)
library(terra)
library(tmap)
library(grid) # for inset maps
library(cowplot) # for inset maps
library(ggthemes) # for colorblind palette
library(flextable)
library(glmnet) # LASSO regression
library(MARSS)
library(here)

# Directories
ms_dir = here::here()
scratch_dir = file.path(ms_dir, "scratch_work")
data_dir = file.path(ms_dir, "Data")
graphics_dir = file.path(ms_dir, "Graphics and Supplements")

# Load spatial and tabular data

# If the data files don't exist locally,
# pull data from internet and local files
if(!file.exists(file.path(ms_dir,"manuscript_data.RData"))){
  source(file.path(ms_dir,"01_DataRetrieval_Cleaning_SaveLocal.R")) 
}
load(file.path(ms_dir, "manuscript_data.RData")) # Load data layers/tables
source(file.path(ms_dir,"02_Figure_Functions.R"))   # Load figure and table functions

#Append supplement?
INCLUDE_SUPP = T
# Save figures as images, yes or no?
save_figs_here = graphics_dir
save_imgs=T # generate the figures in the folder
include_figs = T
replace_setting_fig = F# setting to F can save time if no need to re-render map
fig_i = 1

# pick last water year for the HB function to calculate a value for
last_wy = 2023
```

```{r load_FF_metrics, include = FALSE}
fflows = read_fflows_FJ(calculator = "Flashy")
# fflows = read_fflows_FJ(calculator = "Regular")
# data transformations
log_transform_eco_metrics = T
zscore_flow_metrics = T

```


```{r select_eco_metric_3, echo = F, warning =F, comment = F}

# predict_eco = "juvenile abundance, hydro and spawners" #"juveniles per spawner" # "juveniles per spawner"
# predict_eco = "juveniles per spawner"
# predict_eco = "juvenile abundance, hydro only"

predict_eco = "final eco prediction selection"
  # Based on the need for a normalized metric, going to select the juvenile per adult metric.

# Hydro-only predictors
# Hydro-only predictors
if(predict_eco == "juveniles per spawner"){
  y_val_chinook = "chinook_juvenile_abundance"
  y_val_coho = "coho_smolt_per_fem"
}
if(predict_eco == "juveniles per spawner"){
  y_val_chinook = "chinook_juv_per_adult"
  y_val_coho = "coho_smolt_per_fem"
}
if(predict_eco == "juvenile abundance, hydro only"){
  y_val_chinook = "chinook_juvenile_abundance"
  y_val_coho = "coho_smolt_abun_est"
  }
# Number of spawners included as predictor
if(predict_eco == "juvenile abundance, hydro and spawners"){
  y_val_chinook = "chinook_juvenile_abundance"
  y_val_coho = "coho_smolt_abun_est"
  }


#table of ecological record identifiers
yvlt = y_val_label_tab()
spawner_z_records = c("coho_spawners_zscored", "chinook_spawners_zscored")

```

# Abstract {-}

In many rural areas of arid and semi-arid regions, balancing agricultural and environmental water needs is a key challenge facing resource managers. This is complicated by the tendency for the water needs of cultivated crops to be better understood than those of aquatic ecosystems. This work aims to quantify hydrologic conditions that support persistence of key ecosystem species using a functional flows framework, not in the context of a prescribed flow regime, but in terms of which features of the hydrograph are empirically correlated with specific ecological outcomes. We use the coho (*Oncorhynchus kisutch*) and Chinook (*Oncorhynchus tshawytscha*) salmon runs in Scott Valley, a 2,109 km^2^ undammed rural watershed in northern California, USA, as a case study.

Taking advantage of a nearly two-decade ecological monitoring dataset and long-term stream gauge measurements, we first examined hydrological-ecological correlations, then implemented four different statistical modeling exercises. Of these, we selected LASSO regression to generate a final predictive model for each species. This model is referred to as a "hydrologic benefit" function and uses hydrologic metrics (Z-scored for better inter-metric comparison) to predict units of $log_{10}(outmigrant/spawner)$. In the LASSO regressions, to balance the explanatory power of the models with the risk of overfitting, we used k-fold cross-validation to find the lowest-error value of the tuning parameter lambda. 

Correlation coefficients indicate that hydrologic factors and spawner abundance both exert influence on juvenile fish production. In low-test-error LASSO regression models of $log_{10}(outmigrant/spawner)$, hydrology could explain a greater degree of variance for Chinook than for coho (approximately 60% and 40%, respectively). The hydrologic metric with the highest coefficient is earlier river reconnection during parents' spawning for coho, and lower wet season baseflow for Chinook (though this could change with additional years of data, especially for the smaller coho dataset). This suggests that conditions during their parents' spawning or as eggs and hatchlings may exert a significant influence on the mortality rates of the hatching juveniles in this study area.

The simplicity of this approach for empirically identifying hydrologic metrics with high ecological importance for a threatened species may make it useful in other watersheds, where sufficient ecological data are available. The hydrologic benefit function is intended to set the stage for evaluating trade-offs and supporting water management decisions in human-altered novel ecosystems.


\newpage

# Practitioner points {-}

1. Correlation coefficients indicate that juvenile fish production is not dominantly controlled by hydrologic factors or by spawner abundance but is influenced by both.
2. In statistical models, hydrology could explain a greater degree of variance in relative Chinook reproduction than in coho (60% versus 40%), suggesting that Chinook outcomes may be more sensitive to hydrology than coho.
3. The most important single hydrologic metric was earlier river reconnection/preferred habitat access during parents' spawning for coho, and lower wet season median baseflow for Chinook. This supports an interpretation that conditions during their parents' spawning (potentially, more time to find better nesting habitat) or as eggs and hatchlings (potentially, lower average winter flowrates producing less burial or scour of eggs laid in the mainstem Scott River) may exert a significant influence on the mortality rates of the hatching juveniles in this study area.
4. Finally, in models of juvenile abundance based on hydrology and spawner abundance, spawner abundance was identified as one of the 3 most important predictors for Chinook but not for coho. The important hydrologic predictors identified in all 8 statistical modeling approaches are listed below in order of season and life stage.
* Full list for coho:
    + higher first dry season high flows,
    + earlier first fall reconnection, 
    + longer first wet season, 
    + higher first wet season average baseflow,
    + larger first fall flow increase, 
    + smaller second fall flow increase, 
    + slower first spring recession, and
    + faster second spring recession.
* Full list for Chinook: 
    + higher top 10% of flows in the dry season, 
    + earlier fall reconnection,
    + lower wet season baseflows,
    + longer wet season, and
    + slower maximum spring recession rate.



\newpage

# Introduction


## Motivation and objectives 

Reconciliation ecology posits that some human-impacted ecosystems should be considered irrevocably-altered, "novel" systems [@MoyleNOVEL2014;@YarnellEtAlFunctional2015], with their own specific management concerns. To implement this philosophy, rather than working to restore novel ecosystems to pre-human conditions, a natural resource manager would actively manage biodiversity in human-altered landscapes as a co-equal goal with extracting and cultivating natural resources to provide for human material needs [e.g., @RobertsonSwintonReconciling2005; @ArthingtonEtAlTEMPORARY2014; @AcremanEtAlEnvironmental2014; @YarnellEtAlFunctional2020]. Ideally this management would be based on an empirical or mechanistic understanding of two key links: firstly, how management actions affect availability and quality of water, and secondly, how those hydrologic changes affect human beneficial uses and ecological receptors [@RosenfeldDeveloping2017]. 
 <!-- (management-to-flow and flow-to-ecology) -->
<!-- Better quantitative ecological targets could support more robust decision making and trade-off analysis, potentially answering questions like: how close can managers get to desired ecological conditions, and at what cost, particularly in a changing climate? -->
<!-- **Rephrase: case studies are good to support international river conservation efforts?** However, in many river ecosystems, though general methods to characterize environmental flows have been in wide use for at least a decade [e.g., @PoffZimmermanEcological2010; @ShentonEtAlPutting2012; @SolansGarciaDeJalonBasic2016], the regional-scale conditions that would maintain biodiversity are as yet unquantified or highly uncertain [@PoffEtAlEcological2010; @BarbourEtAlOptimisation2016]. -->

A large body of research has focused on general methods for quantifying connections between water management, flow, and ecological responses, as discussed below; however, in practice, such natural resource management is often local [@TarlockLocal1993]. Accordingly, the authors of this study have posed research questions tailored to conserving two specific salmon species, the threatened coho salmon (*Oncorhynchus kisutch*) and the less-threatened Chinook salmon (*Onchorhynchus tshawytscha*), in a specific study area: the Scott River watershed in northern California, USA. In this undammed, rural watershed, water use is primarily managed by managing land use. Balancing the competing water needs of fish and farmers is a key challenge for local water managers [@SiskiyouCountyScott2021]. Agricultural water needs are well-known and can be estimated and scheduled [@SiskiyouResourceConservationDistrictScott1994; @ParryEvaluation2013; CDFW -@CaliforniaDepartmentofWaterResourcesAgricultural2021], but, in spite of decades of investigation by local, state and federal actors [e.g., SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilSiskiyouResourceConservationDistrictScott2003; NMFS -@NationalMarineFisheriesServiceFinal2014; CDFW et al. -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015; CDFW -@CaliforniaDepartmentofFishandWildlifeScott2021], the ecological water needs in this balancing act are not as well constrained. 

One method for estimating ecological water needs, developed for the hydrologic setting of California,is the functional flows framework [@Escobar-AriasPasternackHydrogeomorphic2010; @YarnellEtAlFunctional2015; @GranthamEtAlMaking2020; @YarnellEtAlFunctional2020; @SteinEtAlCalifornia2021]. Functional flow metrics are used to quantify potential ecological services provided by river flow in terms of flowrate magnitude, timing, frequency, and duration in distinct seasons of a water year, where water year is here defined to begin on October 1 of the year preceding the calendar year of the same number (i.e., water year 2020 begins on October 1, 2019). These metrics can be calculated for any location with daily river data using noise-processing algorithms [@PattersonEtAlHydrologic2020; @YarnellMeeting2025] **(MORE APPROPRIATE CITATION FOR FLASHY CALCULATOR?)**. While much functional flows work has been dedicated to "top down" approaches [@TharmeGlobal2003] that characterize a natural or altered flow regime in its entirety [e.g., @YarnellEtAlFunctional2020; @SteinEtAlCalifornia2021], in this study we propose to break apart the hydrograph and assess the relative importance of individual functional flow types. In addition to functional flows, we define several other hydrologic metrics for purposes of this study.

Here, we address the second ("flow-to-ecology") link referenced above: we assess the potential to empirically identify and prioritize hydrologic features that support the ecological needs of specific species (coho and Chinook salmon) in a specific ecological region (the Scott River watershed). We focus on the questions: while we expect both biotic (e.g., number of spawners) and abiotic (e.g., hydrological) factors to influence fishery success [@WardEtAlLeveraging2024], which ecological observations are most correlated with hydrology, and thus amenable to this predictive exercise? Is the predictive power of hydrology different for two different species? Can we identify and prioritize important hydrologic metrics and use them as benchmarks for evaluating the effects of different management actions on this aquatic ecosystem? 

<!-- This work sets the stage for a quantitative comparison of competing natural resource management alternatives that may have an influence on river flows. -->

<!-- To do this, we first examine correlations between dozens of hydrologic metrics and local salmon observations. Then, using two regression methods, hydrologic metrics (predictors) were selected that best explain variation in salmon outcomes while minimizing the risk of overfitting. The result of the predictor selection was a Hydrologic Benefit function for each species, conceptually translating the various ecological services provided by hydrology across different seasons into a single value, in units of $log_{10}(ecological~observations)$, per water year.  -->


## Utility of modeling ecological responses to flow

Juvenile outmigrant production is one of the most obvious indicators of the health of an anadromous fishery [@JagerRoseDesigning2003], but is predicting outmigrant production (or any ecological response) using flow alone a worthwhile exercise, given the many interacting non-hydrologic factors (channel geomorphology, water quality, food resources, internal population dynamics) influencing a fishery [@McMahonHabitat1983; @BradfordEtAlEmpirical1997; @Escobar-AriasPasternackHydrogeomorphic2010; @WillisInstream2015]?

For some applications, it is not. Flow observations alone cannot represent site-specific hydraulics, which dictate the physical conditions for aquatic life; indeed, in different geomorphology, the same flow can produce very different hydraulic environments (Turner and Stewardson 2014). Flow observations also fail to capture other critical ecological drivers such as water quality, habitat quality, or food resources [e.g., @WillisInstream2015]. Thus it is often fruitless to attempt to predict numerical fish recruitment based solely on hydrologic data; more complex approaches such as combining hydraulics with bioenergetic models [@Bellido-LeivaEtAlModeling2021], fish population and mortality [@JagerRoseDesigning2003] or considering flow and water temperature [@NislowArmstrongLifehistorybased2012] may produce better recruitment forecasts.

Nevertheless, in the absence of data such as site-specific flow-hydraulic relationships and dynamic population models, hydrologic-only approaches may be suitable for some types of natural resource planning (assuming the objective is more abstract than predicting numerical fish recruitment) [@NislowArmstrongLifehistorybased2012; @TurnerStewardsonHydrologic2014]. Furthermore, they could enhance efforts to balance environmental and resource-extraction objectives [@JagerSmithSustainable2008] while being  based on relatively cheap and abundant hydrologic data. Among hydrologic-only methods, "top-down" approaches aim to support the flow needs of the entire ecosystem, often based on alteration of calculated hydrologic metrics from a pre-development flow regime [e.g., @PoffEtAlEcological2010; @ArthingtonEnvironmental2012; @YarnellEtAlFunctional2020], while "bottom-up" approaches aim to identify the individual flow features most critical to supporting a given objective [@TharmeGlobal2003]. This study falls into the latter category.

## Previous findings on California salmon flow requirements

Even within the geographic context of California, specific flows identified as being important to salmonids have varied by the study region, objective, and species under consideration. They include, in Central Valley rivers, winter minimum flows [@JagerRoseDesigning2003] and early summer pulse flows and late winter overbank pulse flows [@JagerThinking2014]; and an indication that juvenile survival was highest in an intermediate flow range in the Sacramento River [@MichelEtAlNonlinear2021]. In one adaptive management retrospective, two individual dam release pulse events improved habitat conditions for rearing juveniles during a critically dry year [@SellheimEtAlInformed2020]. Optimal flow regimes are also different for different species-specific environmental objectives, and vary based on water year type (provide high spring flows in wet years) [@JagerRoseDesigning2003]. Conversely, in at least one study, flow differences had little effect on migration timing or growth of South Fork Eel River steelhead [@KelsonCarlsonPrecipitation2019]. 

This variability reflects that in different geomorphic and hydroclimate contexts, the habitat and ecological effects of identical flowrates is highly variable. This study aims to contribute to this body of work by proposing a simple method for identifying empirical relationships between flows and species focusing on the scale of a single watershed at which several other types of management choices are made.

<!-- Implementing functional flows is theoretically more straightforward on a regulated river, since there is direct control of dam releases (subject to many constraints), than it is in a watershed with no major dams, such as Scott Valley, where land use is the most direct mechanism for water management.  -->


<!-- [@TharmeGlobal2003] methods: hydrological, hydraulic rating, habitat simulation, holistic (plus combo and other). -->
<!-- Hydrologic methods most appropriate for planning-level water resources, or preliminary flow targets. -->
<!-- Hydraulic rating: plot wetted perimeter or max depth against flow. Identify a flow point below which habitat function is no longer viable to calculate min. flow. -->
<!-- Habitat rating: simulate instream physical habitat at range of flows. Often produce seasonal habitat suitability curves. Usually specific to a species? -->
<!-- Holistic: this one is best. uh, decide holistically which flow features are important for maintaining the whole ecosystem. Can be bottom-up (which features do we want?) or top down (what degree of alteration from natural is acceptable?). -->


## History of flow-ecology relationships

A river's flow regime is often referred to as a "master variable" controlling geomorphic, chemical, and other conditions in its aquatic ecosystems, and organisms that have evolved to persist in specific flow regimes are commonly negatively affected by flow alteration [@BunnArthingtonBasic2002; @PoffEtAlEcological2010]. Consequently, in recent decades a diverse body of research has sought to identify and quantify ecological responses to changes in flow. 

<!-- Work on this topic spans multiple categories of ecological response, hydrologic predictor, and ultimate cause of hydrologic alteration.  -->
<!-- Two widely studied ecological response metric categories are, firstly, the stream health index, based on density and species richness of macroinvertebrates observed at designated sampling sites [e.g., @MonkEtAlFlow2006; @GuareschiEtAlHow2014; @KevicEtAlEffects2018; @MazorEtAlTools2018; @LarsenEtAlCombining2021; @PeekEtAlIdentifying2022], and secondly, fish diversity and community assemblage [e.g., @McManamayEtAlApplication2013; @PetersonFreemanIntegrating2016; @CartwrightEtAlPutting2017; @SinnathambyEtAlEcohydrological2018; @HainEtAlUsing2018; @GuedesEtAlArtificial2020; @YaoEtAlIdentifying2021]. Ecological responses can also be based on the abundance of a single or a few species, often of fish [@Stewart-KosterEtAlFish2011; @BoothEtAlDetermining2014; @DeWeberPetersonComparing2020; @HaleEtAlMy2023], as well as the extent of habitat types [@ChowdhuryDriverEcohydrological2007; @ArrianaBrandEtAlProjecting2011] and the presence of organisms including vegetation and plankton [@RiisEtAlVegetation2008; @CatfordEtAlSpecies2014; @QianEtAlEffects2016; @TesfayeEtAlClimatic2017; @SabyEtAlSensitivity2022]. Hydrologic predictors range widely **insert IHA and ELOHA**, with a heavy emphasis on extreme (low or high) flow events and the duration of components of the flow regime [e.g., @AyllonEtAlSpatiotemporal2014; @LamourouxOlivierTesting2015; @McManamayFrimpongHydrologic2015; @BowerEtAlQuantifying2022]. Causes of the change in hydrology include the operation of dams, changes in human water use, climate change, and natural flow variability [e.g., @AlomiaHerreraCarreraBurneoEnvironmental2017; @GaoEtAlHydrological2020; @WhiteEtAlMacroinvertebrate2018; @DaneshvarEtAlResponse2017; @HerbstEtAlDrought2019]. -->

<!-- Investigations of flow-ecology relationships can also be grouped by approach [as in @TharmeGlobal2003; @BrummerEtAlQuantitative2016]. In experimental flow studies the flow is directly manipulated with dam releases and biological responses are monitored [e.g., @KonradEtAlLargescale2011]. In longitudinal studies, long-term ecological and hydrological records can be used to infer local or regional correlations [e.g., @Mellado-DiazEtAlExploring2019]. Finally, in space-for-time approaches, the hydrology of multiple river systems in a region is used to populate the distribution of different hydrologic behavior, and ecological monitoring is related to flow differences between streams [e.g., @MonkEtAlMacroinvertebrate2008; @RiisEtAlVegetation2008; @CatfordEtAlSpecies2014; @BowerEtAlQuantifying2022]. Space-for-time analyses require considerably fewer resources than experimental flows and longitudinal studies, and thus are more numerous [@BrummerEtAlQuantitative2016]. **bottom up versus top down**  -->

Bridging the gap between science and policy has been a persistent challenge and ongoing focus of work in this field. In many cases a key research motivation is to support decision-making in a variety of contexts, including dam operation, river restoration, and regulations of water extraction and land use [@RichterEtAlCollaborative2006; @HanEtAlEcohydrological2015; @SinnathambyEtAlEcohydrological2018; @BradleyEtAlHydroecological2017; @BrummerEtAlQuantitative2016]. But historical approaches based on relationship-finding are several steps removed from the policy-making process [@WebbEtAlAdaptive2018]. For example, the Indicators of Hydrologic Alteration [@RichterEtAlMethod1996; @RichterEtAlProtection2017] and Ecological Limits of Hydrologic Alteration (ELOHA) [@PoffEtAlEcological2010; @McManamayEtAlApplication2013] approaches generate flow standards for particular rivers, and are a top-down method for determining the flow needs of the whole ecosystem, but cannot translate specific management decisions into hydrologic outcomes, or predict specific ecological outcomes of the described alteration [@RichterEtAlCollaborative2006; @CartwrightEtAlPutting2017]. Additionally, identifying natural flow regimes may be less immediately relevant to water resource management than an approach which can quantify ecological responses to "designer" or functional flows (which can often be controlled or influenced by dam releases) [@ArthingtonEtAlTEMPORARY2014; @WebbEtAlAdaptive2018], with the caveat that the designer flows approach may risk overlooking ecological flow needs that are not currently monitored [@BowerEtAlQuantifying2022].

An ideal framework for supporting decision-making would involve two key steps, firstly connecting land and water management actions to flow changes ("management-to-flow"), and secondly connecting flow changes to ecological responses ("flow-to-ecology") [@PetersonFreemanIntegrating2016; @DeWeberPetersonComparing2020; @AceroTrianaEtAlAssessing2021]. Both steps can involve complex models and substantial uncertainty, often representing an interdisciplinary challenge. Threshold values for "sufficient" flows would be ideal for a management context [@RosenfeldDeveloping2017], but can be difficult to identify and in some cases may not exist [@LuedersMcManamaySpecies2023].  Finally, stakeholders in at least one study requested flow-ecology relationships based on empirical monitoring, rather than more easily-simulated proxies like flow changes or thermal exposure [@DeWeberPetersonComparing2020].

The present study is a longitudinal "bottom-up" analysis, using empirical data and a case study, to identify flows most critical to support two specific species, and thus address the "flow-to-ecology" link described above. We use empirical data to develop a predictive model of a biological response to measurable (and simulatable) changes in flow metrics. We refer to this model as a "hydrologic benefit" function (i.e., intending to quantify the ecological services provided by flow) for a single species. A forthcoming companion study will investigate the "management-to-flow" link, simulating flow changes from watershed management actions using an appropriate hydrologic model, as a basis for studying unavoidable water management tradeoffs within the watershed.

<!-- This provides the critical link to evaluate fish outcomes resulting from future alternative watershed management practices which affect the hydrology of a stream ecosystem. -->

## Historical assessments of Scott River flow-ecology relationships

Flow-ecology relationships have been investigated before in the Scott River Watershed, but the empirical "flow-to-ecology" link described above has not been quantified. Over the past three decades, several organizations and agencies have conducted extensive monitoring and published a series of reports and plans regarding the salmon fisheries in the Scott River watershed. In the 1990s, fall flows in the Scott River were reported to be too low in some years to allow for Chinook spawning in September-November [CRMP and SRWC -@CoordinatedResourceManagementPlanningCommitteeScottRiverWatershedCouncilFINAL2000], but in the mid-2000s it was reported that low fall flows rarely affected the later (November-January) spawning runs of steelhead and coho salmon [SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilSiskiyouResourceConservationDistrictInitial2005]. More recently, fall flows have affected coho salmon as well as Chinook, as the late onset of winter storms has delayed coho spawning in some water years [e.g., CDFW -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015]. In the mid-2000s, a local conservation organization identified the lack of suitable summer and winter rearing habitat as a probable limitation on Scott River coho smolt production [SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilLimiting2005]. Several years later, in a NOAA Fisheries Coho Recovery Plan, NMFS identified the juvenile life stage as the most limited in the population [NMFS -@NationalMarineFisheriesServiceFinal2014]. 
<!-- **Add Klamath run estimates after first 2 sentences? EDIT THIS PARAGRAPH TO REDUCE REDUNDANCY** -->



# Methods: Case study setting and species of concern

Exploring the empirical relationship between river hydrology and an ecological response requires both spatial and temporal overlap in a study area's hydrologic and ecological monitoring data. 

These requirements are met to some degree in Scott Valley, though as is typical, ecological data is the limiting factor. Hydrologic data is provided by daily river flow monitoring, which has been ongoing since the 1940s at the USGS stream gauge downstream of the town of Fort Jones (Station ID #11519500, or the Fort Jones Gauge or FJ Gauge; Figure \@ref(fig:ScottWatershedMap)). The flow at this gauge is correlated with flow in tributary streams [@FogliaEtAlScott2013], and though a single monitoring location may not be able represent flow status in the full stream system at all times, it has been used in recent water planning documents as an indicator of overall hydrologic conditions [Siskiyou County -@SiskiyouCountyScott2021]. Because most water use in Scott Valley occurs upgradient of this gauge, its measurements are used to inform water management decisions in the populated areas of the valley (see *Supplement* for more detail on Scott Valley management history, geography and climate).

<!-- Ecologic data in Scott Valley is available due to routine monitoring of spawning anadromous fish, which has been ongoing in the broader Klamath basin since at least 1978 [@KnechtleChesneyScott2013]. More in-depth monitoring of multiple salmonid life stages in the Scott River watershed has occurred since 2003 [e.g., @MaurerScott2003; @KnechtleGiudice20222023]. This study takes advantage of this nearly two-decade record of adult spawner and juvenile salmon abundance to draw preliminary conclusions regarding this hydrology-ecology relationship. Spawners and outmigrating juveniles are observed at the Scott River Fish Counting Facility and the Scott River Rotary Screw Trap, respectively (Figure \@ref(fig:ScottWatershedMap)) [@KnechtleGiudice20222023; @RomeroRobinson20232024]. -->


```{r ScottWatershedMap, echo = F, message = F, warning =F, fig.height = 8.5, fig.cap = "The Scott River watershed, with regional geographic context (see inset) and local features.\\label{fig:ScottWatershedMap}"}

if(replace_setting_fig == TRUE){save_setting_figure()}

if(save_imgs==T){
  file.copy(from = file.path(graphics_dir, "Graphics source","scott valley setting.png"),
            to = file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

if(include_figs==T){
  knitr::include_graphics(file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

fig_i = fig_i +1

```



## Species of concern: coho and Chinook salmon

This study intends to identify key hydrologic needs of two species, coho and Chinook salmon. To this end, we used several decades worth of hydrologic and ecological data collected in the Scott River watershed. Although both species need fall flows to migrate from the ocean to natal spawning streams, the life history strategies of these two salmonids are distinct in several ways, and consequently they are expected to have different functional flow requirements (see Supplement for additional life history information). 
Chinook and coho salmon are distinct in several ways relevant to this study and to management considerations:

<!-- * Chinook in this watershed hatch in the spring and migrate to the ocean in their first year of life, in contrast to coho, which spend a full year in the stream before migrating  . -->

* The vast majority of Scott River coho salmon outmigrate at 1+ years and return to spawn at 2+ years of age, producing a distinct cohort every 3 years [@KnechtleGiudice20192020], while the amount of time spent by Chinook in the ocean is more variable and more dependent on ocean conditions, and distinct cohort structure is not observed [@GrootMargolisLife1991; @BourretEtAlDiversity2016].
* Juvenile coho salmon are affected by 2 years of freshwater conditions, while juvenile Chinook are affected by only one year of freshwater conditions (Figure \@ref(fig:cohoLifeCycleFigure)) [@AgrawalEtAlPREDICTING2005; @KnechtleGiudice20192020].
* In most years Chinook spawning migration takes place earlier (September-December) than coho (October-January).
* Coho salmon prefer to spawn in reaches with smaller spawning gravels than Chinook salmon. Consequently the majority of coho redds are found in Scott River tributaries, while Chinook redds are more commonly found in the mainstem Scott River [e.g., @MagranetYokelScott2017; @MagranetScott2017]. Though several tributaries tend to disconnect from the mainstem Scott River, a key mainstem reach, known as the "tailings" due to historical mining activity (Figure \@ref(fig:ScottWatershedMap)), often dewaters during average-to-dry years, restricting spawning access to headwaters habitat [@ScottRiverWatershedCouncilRestoring2018].
* Declining populations of coho salmon have been noted in the Klamath basin and more broadly in coastal California streams since the 1990s [e.g., @BrownEtAlHistorical1994], while regional Chinook populations have historically been more robust [@WainwrightEtAlCCIEA2013]. However, a declining trend was observed in the Klamath run of Chinook in the 2010s, and this trend was more significant in the Scott River system than the broader Klamath basin [@KnechtleGiudice20222023]. These trends have prompted additional monitoring of Scott Valley Chinook in the past decade [e.g., spawning surveys such as @MagranetScott2015; @MagranetScott2017].

```{r cohoLifeCycleFigure, echo = F, message = F, warning =F, out.height= "8.5in", fig.cap = "Seasons (as defined in the California Environmental Flows Framework; Yarnell et al. 2020) and life stages experienced by a coho and a Chinook salmon cohort in the Scott River watershed. Season identifiers listed here are used throughout the document."}

if(include_figs==T){
knitr::include_graphics(file.path(graphics_dir, "Graphics source", 
                                  "Salmon life cycle and seasons graphic.jpg"))
}
```

# Methods: Quantitative analysis

First, we used functional flow metrics to describe the history of the Scott River as observed over eight decades at the Fort Jones gauge. Then we used correlation coefficients to explore relatedness between Z-scored hydrologic metrics and log-transformed ecological records (Supplemental Figure A). 
We then conducted twelve total statistical modeling exercises: two modeling techniques, LASSO [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] and MARSS [@SeeHolmesReducing2015], to predict three different predictor-response pairs (juvenile abundance and juvenile-to-spawner ratio) for each species (coho and Chinook salmon). We compared the advantages and drawbacks of each exercise and ultimately selected LASSO regression of the juvenile-to-spawner ratio as the basis for a final predictive model, referred to as a "hydrologic benefit" function. The hydrologic benefit function is a linear combination of hydrologic metrics that can be used to estimate the relative value of flows in each water year provided to each fish species. 


## Step 1. Calculate predictors and screen for collinearity: Flow metrics to describe Scott River flow regime

Firstly, we used functional flows algorithms tuned for "flashy" (or ephemeral) river systems [@YarnellMeeting2025] **(Better flashy calculator citation?)** to calculate a set of hydrologic predictor metrics for the Scott River (Figure \@ref(fig:fig2Yarnell2020)) [@YarnellEtAlFunctional2020; @PattersonEtAlHydrologic2020]. These hydrologic predictors were calculated from the daily flow record at the Fort Jones river gauge from 1942-2023 using the approach of Patterson et al. [-@PattersonEtAlHydrologic2020]. The full suite of 30 annual metrics is calculated on a water-year basis (i.e., each type of metric produces one value for each water year; *Supplemental Table 1*). Abbreviations, relevant time periods (including salmon life stage alignment; see Section 3.3), and metric calculation details are listed in Supplemental Table \@ref(tab:funcFlowTermsTab); additional information is available in @PattersonEtAlHydrologic2020 and supporting documentation.

All selected functional flow metrics have some known ecological function or interpretation, e.g., total annual flow is used to evaluate water year type. Phenomena measured with fall metrics, such as fall pulse magnitude and fall pulse timing, provide olfactory migration signals and spawning access to anadromous fish; however, a discrete fall pulse does not occur in every water year. Wet season metrics, such as wet season onset timing and baseflow magnitude, can be used to gauge conditions during egg incubation or the overwintering period for juvenile coho salmon. In particular, frequency and duration of wet season high-flow events (i.e. daily average flow above exceeding a 2-, 5- and 10-year flood) indicate the potential presence of scouring flows. Spring metrics, such as spring flow recession rate of change, occur during the transition from wet to dry season, and indicate conditions during early juvenile salmon rearing as well as the flow available for outmigration from Scott Valley to the ocean. Finally, metrics like the duration and median flow of the dry season indicate the timing and severity of low-flow conditions in which spatial habitat is constrained and connectivity between reaches may be limited. 

Secondly, two additional metrics were devised for this study area related to timing of anadromous fish access to preferred spawning habitat (illustrated in Figure \@ref(fig:reconnectExplainerHydrograph)). These metrics are referred to as "reconnection" and "disconnection" dates. They assume a flow threshold, defined at the Fort Jones gauge, that corresponds to a certain degree of "connectivity" in the Scott River stream system (with the assumption that higher connectivity corresponds to salmon access to more and better spawning  habitat). The date on which this connectivity is lost in the spring/summer or gained in the fall has implications for whether salmon passage exists during the preferred migrating time window. These metrics are related, but not identical, to the California-specific functional flows, namely, the timing and slope of spring recess and the timing of a fall pulse flow (Table \@ref(tab:customHydroMetricsTab)). More importantly, they add value to this analysis because of their direct relation to fish passage in the watershed.

Finally, to identify the presence of scouring flows [i.e., storm events that can mobilize large amounts of sediment and either bury or wash away salmonid eggs; @ScottRiverWatershedCouncilRestoring2018], which presumably have a detrimental effect on egg survival, we calculated the number of days in each year with average daily flow greater than the 90th flow percentile (for the full Fort Jones hydrologic record) (Table \@ref(tab:customHydroMetricsTab)). 

### Selecting flow thresholds for dis- and re-connection timing

<!-- after first sentence here, [**sentence about whether salmon can wait?**]  -->
In average-to-dry water years, after portions of the Scott River run dry (Figure \@ref(fig:ScottWatershedMap)), the timing of fall river reconnection determines when salmon can access mainstem and tributary spawning habitat [@ScottRiverWatershedCouncilRestoring2018]. To calculate the timing of river connectivity, three discrete thresholds were selected from the continuum of flows to represent a partially and a fully connected stream system. The thresholds correspond to two distinct events: first, 20 and 40 cfs (0.57 to 1.1 cms), corresponding to the low and high estimates of what constitutes connectivity within mainstem Scott River [@SiskiyouCountyScott2021]; and second, 120 cfs (3.4 cms), representing connectivity of the full stream network, allowing access to most tributary habitat. Because these flows are measured at the Fort Jones gauge, they are a proxy for conditions in the full stream network; however, hydrograph and precipitation analyses suggest that 120 cfs at the Fort Jones gauge is a good indicator of mostly-full soil and aquifer storage, or a "spilling" watershed condition that maintains a connected stream network [@KoubaHarterSeasonal2024].

### Screen predictors for collinearity

Because many metrics are influenced by the same phenomena taking place in wet and dry years, significant collinearity was present in the hydrologic metrics used in this predictive exercise. To account for this, collinear predictors, defined as predictors correlated with a Spearman's *R* greater than 0.7 [@DormannEtAlCollinearity2013], were grouped, and one predictor was selected to represent each group. In Supplemental text and Supplemental Table \@ref(tab:predCorrScreeningTable), we describe each group and the ultimate selected predictors in conceptual terms. In this screening we aimed to retain metrics occurring in each of the 8 seasons influencing coho rearing in freshwater (and for Chinook, 4 seasons) (Figure \@ref(fig:cohoLifeCycleFigure)).

## Step 2. Assemble responses: Ecological monitoring data

Seven total observed quantities (three for Chinook; four for coho) were evaluated as candidates to represent the ecological response (dependent variable) in the flow-ecology relationship. 

Factors influencing the population size of anadromous fish include ocean conditions and freshwater conditions. In this study focused on the conditions in their natal streams, we have focused on fish population metrics that are influenced by the freshwater system. The ecological observations considered for use in the final flow-ecology relationship are:

1. Number of adults migrating from the ocean to freshwater natal streams to spawn. This quantity, the 'escapement', is measured at the Scott River Fish Counting Facility, using a resistance board weir and video counting flume in the Scott River [e.g., @KnechtleGiudice20222023] (Figure \@ref(fig:ScottWatershedMap)). 
2. Number of juvenile yearling, or smolt, salmon. Smolt are counted as outmigrants, at the Scott River Rotary Screw Trap facility (Figure \@ref(fig:ScottWatershedMap)) [e.g., @MassieMorrow20202021; @RomeroRobinson20232024]] .
3. Number of salmon gravel nests, or redds, observed during spawning window [e.g., @MagranetScott2015] (for coho only).

Two combined metrics historically calculated and reported by regional agencies [@KnechtleGiudice20222023] were also considered. These metrics use data from multiple years to capture multiple life stages for a given cohort:

4. The number of outmigrating coho smolt produced per spawning female (coho spf) and the outmigrating Chinook juveniles per spawner (Chinook jpa).

<!-- **figure out order of this paragraph in this section?**  -->
These time series of observations are the result of decades of investment in local ecological monitoring. Monitoring activity in the past 20 years has included population estimates from a video counting flume and a rotary screw trap operated by CDFW [CDFW -@CaliforniaDepartmentofFishandWildlifeRecovery2015; @MassieMorrow20202021; @KnechtleGiudice20222023], and spawning surveys for Chinook [@MagranetScott2015a; @MagranetScott2017; @MagranetScott2018] and coho [@MaurerScott2003; Siskiyou RCD -@SiskiyouResourceConservationDistrictFinal2004; @QuigleyScott2005; @QuigleyFinal2006; @QuigleyFinal2007; @SiskiyouResourceConservationDistrictScott2010; @YokelScott2011; @FranklinScott2012; @YokelScott2013; @YokelScott2014; @MagranetScott2015; @MagranetYokelScott2017]. 


## Step 3. Align predictor and response metrics with timing of species cohorts

The empirical basis for this predictive modeling exercise is a table of hydrologic metrics (one per water year) and ecological observations influenced by this hydrology (*Supplemental Table 2*). However, the row-by-row basis for the table is somewhat complicated by the life history of the two species under consideration.

A cohort of coho salmon will experience conditions during multiple water years while residing in their spawning habitat, and flow impacts are specific to life-stage: the same flow will have a different effect on fish experiencing it as a hatchling fry than on those experiencing it as 1+ year old parr [@NislowArmstrongLifehistorybased2012]. Here we define the alignment (i.e., mapping) of a specific generation of fish (ecological outcome) with hydrologic metrics (predictors) observed across the portion of their life cycle spent in the Scott River system (*Supplemental Table 2*).

### Data alignment - coho

The relevant unit of time for identifying the impacts of Scott River freshwater hydrology on a coho salmon cohort is defined here as a ~2 year period spanning eight seasons, starting in the dry season preceding the parents' spawning, and ending in the spring of smolt outmigration (Figure \@ref(fig:cohoLifeCycleFigure)). The coho life cycle is largely regular in Scott Valley, with 3 defined cohorts in which the vast majority of individuals return to natal streams at 3 years of age [e.g., CDFW -@CaliforniaDepartmentofFishandWildlifeScott2021]. 

Following standard practice for functional flows [@PattersonEtAlHydrologic2020], each functional flow and hydrologic metric were labeled with the season in which it occurred. Additionally, each hydrologic metric was assigned to the brood year of each affected cohort of coho salmon, according to the year (first or second) in which the cohort experienced it. Specifically, the eight seasons are designated as the first and second dry, fall, wet and spring seasons (abbreviated d1, f1, w1, s1, d2, f2, w2, and s2; Figure \@ref(fig:cohoLifeCycleFigure)). In some rare cases, flow metrics may fall outside their designated subperiods (e.g., the extreme dry water year of 2014, in which the "fall reconnection" of flows in brood year 2013 did not occur until February of the following calendar year). Nonetheless, for consistency, even a January or February reconnection date will be referred to by the previous fall year designation. 

<!-- most spawning occurs in October or later, and most outmigration occurs in June or earlier [@MoyleCoho2002], but the September-July duration was chosen to capture critical life stages even in extreme water years.  -->


### Data alignment - Chinook

Because spawning occurs in the fall for both coho and Chinook salmon in the Scott River watershed [@CaliforniaDepartmentofFishandWildlifeScott2021], Chinook ecological data was aligned with hydrologic metrics in the same manner as coho observations. Distinct life histories produced one significant difference: because Chinook migrate to the ocean in their first year of life, the duration of freshwater residence for each Chinook cohort is shorter than for coho, ranging from fall spawning to the subsequent spring or summer. Thus, only metrics from the first year (d1, f1, w1, and s1) were considered for the Chinook model (Figure \@ref(fig:cohoLifeCycleFigure)). 




```{r smolt_year_metrics_master_tab, echo = F, warning =F}

# retrieve hydrology tabulated by STP
brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1999:2022,
                                                             smolt_years = 2001:2024)
# brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1978:2022,
#                                                              smolt_years = 1980:2024)

# thresh_for_corr_fig = c(8, 10, 15, 20, 40, 
#                         70, 100, 150, 200, 300, 
#                         400, 500, 750, 1000)
thresh_for_corr_fig = c(20,40,120)

metrics_tab = calc_metrics_hydro_by_affected_brood_year(
  hydro_by_brood_year = brood_year_hydro_tab,
  thresholds = thresh_for_corr_fig) 

# Clean metrics tab:
# 1) factorize water year category
metrics_tab$wy1_WY_Cat = as.numeric(factor(metrics_tab$wy1_WY_Cat,
                                   levels = c("dry year", "mod year", "wet year")))
metrics_tab$wy2_WY_Cat = as.numeric(factor(metrics_tab$wy2_WY_Cat,
                                   levels = c("dry year", "mod year", "wet year")))
# 2) remove outlier FA_Diff?

write.csv(x = metrics_tab, quote = F, row.names = F,
  file = file.path(graphics_dir,
                   "Supplemental Table 2. Flow Metrics by Brood Year.csv"))

# calculate number of predictors for text below

non_preds = c("brood_year", "smolt_year", yvlt$y_val)
num_predictors = length(colnames(metrics_tab))- length(non_preds)
preds_all = colnames(metrics_tab[,!colnames(metrics_tab) %in% non_preds])

```



```{r metrics_tab_diagnostics, echo = F, warning =F}

# log_transform_flow_metrics = F

if(zscore_flow_metrics == T){
  zscore_these = !(colnames(metrics_tab) %in% non_preds)
  metrics_mean = apply(X = metrics_tab[,zscore_these], MARGIN = 2, FUN = mean, na.rm=T)
  metrics_sd = apply(X = metrics_tab[,zscore_these], MARGIN = 2, FUN = sd, na.rm=T)
  metrics_tab[,zscore_these] = apply(X = metrics_tab[,zscore_these],
                                     MARGIN = 2, FUN = zscore_column_na_rm)
  
  metrics_tab$coho_spawners_zscored = 
    zscore_column_na_rm(x = metrics_tab$coho_spawner_abundance)
  metrics_tab$chinook_spawners_zscored = 
    zscore_column_na_rm(x = metrics_tab$chinook_spawner_abundance)
  non_preds = c(non_preds, "coho_spawners_zscored", "chinook_spawners_zscored")

}

if(log_transform_eco_metrics == T){
  metrics_tab[,yvlt$y_val] = log10(metrics_tab[,yvlt$y_val])
}

# zscore_column_na_rm = function(x){
#   mean_x = mean(x, na.rm=T)
#   sd_x = sd(x, na.rm=T)
#   return((x - mean_x) / sd_x)
# }


# if(log_transform_flow_metrics == T){
#   log_these = !(colnames(metrics_tab) %in% non_preds)
#   metrics_tab[,log_these] = log10(metrics_tab[,log_these])
# }

```

## Step 4. Transform data, calculate correlation coefficients, rule out temporally impossible relationships

After aligning the hydrologic predictors and ecological responses, we standardized (Z-scored) all hydrologic metrics to facilitate comparisons of modeled coefficients. Because the ecological observations typically covered multiple orders of magnitude, we transformed ($log_{10}$) the ecological responses for the predictive exercise. We then calculated Pearson correlation coefficients [@PearsonNote1895] $R$ between each Z-scored predictor and each log-transformed response. A significant number of potential predictor-response pairs do not represent a temporally plausible relationship: e.g., the wet season values in water year 2011 would not influence the number of spawners that arrived the previous season, in fall of 2010. These implausible pairs were excluded from the resulting $R$ matrix. Additionally, to assess the relative importance of biotic (i.e., spawner abundance) and abiotic (hydrologic) factors on ecological outcomes, we included Z-scored spawner abundances as "predictors" in the final $R$ matrix.
<!-- ; this means that predictions of ecological values in the 1000s will involve more uncertainty than predictions in the 10s -->

<!-- ## Step 5. Select ecological response metrics -->

<!-- To generate predictive models, we make an assumption of independence for each year of ecological observation data. Cohort effects may reduce the validity of this assumption (i.e. the number of coho spawners in year 2009 may be partly dependent on the number of spawners in 2006). In order to control somewhat for cohort effects, we selected the normalized metric available for each species as the ecological response variable: coho smolts per female spawner (coho spf) and Chinook juveniles per spawner spawner (Chinook jpa). We used the correlation coefficents between the hydrologic metrics and ecological observations to assess the relatedness of the two species outcomes with hydrology, and determined that one was significantly less related. For completeness, we also compared the $R$ values of the two selected metrics to the other (non-normalized) ecological data types. -->

## Step 5. Generate predictive models 

We conducted twelve total statistical modeling exercises: two modeling techniques, LASSO [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] and MARSS [@SeeHolmesReducing2015], to predict three different predictor-response pairs units (juvenile abundance on hydrology, juvenile abundance on hydrology plus spawner abundance, and juvenile-to-spawner ratio on hydrology) for each species (coho and Chinook salmon) (Table \@ref(tab:statsMethodsTable)). There are advantages and drawbacks to each approach.


```{r statsMethodsTable, echo = F, warning =F, results = 'asis'}

stats_tab = data.frame(Predicts = c("juveniles per adult", "juvenile abundance",
                                     "juvenile abundance", "juveniles per adult", 
                                     "juvenile abundance", "juvenile abundance"),
                       Method = c(rep("LASSO",3), rep("MARSS", 3)),
                         Predictors = c("hydrologic metrics", "hydrologic metrics",
                                        "hydrologic metrics and spawner abundance", 
                                        "hydrologic metrics", "hydrologic metrics", 
                                        "hydrologic metrics and spawner abundance"),
                         Location = c("Main text (selected as primary method)", 
                                      rep("Supplement",5)))

stats_tab = stats_tab[c(1,4,2,5,3,6),]

caption_text = paste0("Description of the four techniques considered in this study for modeling ecological outcomes using hydrologic metrics (and available ecological data, if applicable).")

st_ft = flextable(data=stats_tab)
st_ft = set_caption(st_ft, caption = caption_text)
st_ft = flextable::width(st_ft,j=1,  width = 2)
st_ft = flextable::width(st_ft,j=3,  width = 2)
st_ft = flextable::width(st_ft,j=4,  width = 1.5)
st_ft = flextable::set_header_labels(st_ft,
                                           values = list(
                                             Predicts ="Predicts (log-transformed obs.)",
                                             Method = "Method",
                                             Predictors = "Predictors (Z-scored)",
                                             Location = "Location"))
st_ft

```



### Statistical method comparison

LASSO (Least Absolute Shrinkage and Selection Operator) regression [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] is similar to multiple linear regression in that its output is a linear combination of coefficients multiplied by observed values of a set of predictors. However, LASSO regression also includes a "tuning" parameter lambda ($\lambda$), that penalizes model complexity. This is valuable in high-dimensional data settings, where overfitting is likely because the number of possible predictors (here, hydrologic metrics) approaches or exceeds the number of observations being predicted (here, ecological records) [@ReinekingSchroderConstrain2006]. Additionally, because it sets some coefficient values to 0, it can be used to perform predictor selection (i.e., identifying the most important predictors, or the predictors that explain the most variation in the response) [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018]. 

For purposes of the present study, a disadvantage of the LASSO approach is that, like multiple linear regression, it assumes each observation in a record is independent [@JamesEtAlIntroduction2013]. When working with ecological time series, this assumption of independence is often invalid, because a previous state of an ecosystem (i.e., the number of spawners in a salmonid cohort 3 years ago) has a direct influence on its present state; in other words, autocorrelation at some time lag is often present. 

Conversely, MARSS (Multiple Autoregression State Space) [@SeeHolmesReducing2015] was designed for working with autocorrelated ecological time series data. It can be used to generate predictive models based only on the observed quantity itself (i.e., an ecological record), or the observed quantity as well as covariate data (i.e., hydrologic metrics) [@SeeHolmesReducing2015]. However, its output is a more complex function than for LASSO, potentially limiting its utility to managers, and it lacks the advantages of predictor selection and an overfitting penalty.

### Prediction units and model structure

Though seven types of ecological data were available as prediction targets (see Section 3.2), we focused on predicting either absolute or relative abundance of outmigrating juveniles, because outmigrant abundance is directly related to the persistence of a fishery, and it represents the integrated output of the freshwater-dwelling period of life. Many biotic factors also influence juvenile abundance, and it is beyond the scope of this paper to account for all of them; however, spawner abundance, representing the "input" to the freshwater-dwelling period, would intuitively have a high degree of influence on juvenile abundance, and is a readily available biotic record. 

Consequently, we chose to include spawner abundance as a factor in this predictive exercise. We tested two ways of structuring our analysis: spawners were included either as the denominator of a juveniles-to-spawner ratio, or as a separate (Z-scored) predictor treated similar to hydrologic metrics (Table \@ref(tab:statsMethodsTable)). We constructed independent models for each species, rather than combining coho and Chinook observations, because we expected they would be sensitive to different hydrology and, in previous studies, multi-species forecasts conveyed no advantage over single-species forecasts [@WardEtAlLeveraging2024].

<!-- Simple linear regression or GAM models are as good or better than more complex models such as LASSO at predicting recruitment among ocean fisheries  [@WardEtAlLeveraging2024]. Environmental variables (which ones?) can predict substantial of variation in fish recruitment. [@WardEtAlLeveraging2024]  -->

<!-- "Ridge and LASSO are risk-averse model strategies that can be expected to perform well under a wide range of underlying species-habitat relationships, particularly at small sample sizes." [@ReinekingSchroderConstrain2006] -->


<!-- We used LASSO regression [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] to assess the feasibility of predicting an ecological response, in this case coho and Chinook reproductive outcomes, using dozens of potential hydrologic predictor metrics. The objectives of the LASSO exercise were to 1) perform predictor selection, i.e., empirically estimate which hydrologic metrics were most related to coho and Chinook reproductive outcomes; 2) estimate the degree of variation that could be predicted by the hydrology; and 3), develop a predictive Hydrologic Benefit formula, in which the selected set of hydrologic predictors and their calculated coefficients are used to predict the ecological response. Each step in the analysis is numbered and explained below. -->

<!-- With hydrologic metrics assigned to each salmon generation, indexed by brood-year (*Supplemental Table 2*), we assessed the potential for hydrologic metrics to predict biological outcomes by performing LASSO regression [@; EtAlIntroduction2013; @RanstamCookLASSO2018] between `r num_predictors` (standardized) hydrologic predictors and the two ecological data types selected in the previous step (one for coho and one for Chinook).  -->

### LASSO regression and hydrologic benefit function

We used the R programming environment [@TheRFoundationProject2025] and the linear modeling function `glmnet()` [@FriedmanEtAlRegularization2010] to calculate and cross-validate two LASSO models for each species (Table \@ref(tab:statsMethodsTable)). 

We used k-fold cross validation to calculate test error based on different penalty values and determine the value of $\lambda$ that minimized test error. In the case of one model (LASSO prediction of coho spf), we proposed an alternative lambda value that produced an error nearly identical to the minimum error but which explained a higher degree of variance. 

<!-- * cross-validation using $k$ folds, in which the data is split into to test and training data sets. default number of folds is 10; reduced number of folds to the maximum number in which the number of observations per fold was greater than 3. -->

The final lambda value selection produced the linear model which can be used to predict ecological outcomes with hydrologic metrics. We referred to this model as the hydrologic benefit (HB) function. The ecological outcome in water year $wy$ is obtained for $wy = brood~year + 1$ for both salmon species.

<!-- The predicted HB value, with units of $log_{10}(ecological~obs.)$, in brood year $i$ is calculated as: -->

<!-- $$HB_i = \beta_0 +\sum_{j=1}^{p}{\beta_j x_{ij}}$$ -->

<!-- Where: -->
<!-- $x_{ij}$ is the value of hydrologic predictor $j$ in the cohort with brood year $i$, -->
<!-- $\beta_0$ is the intercept value, and -->
<!-- $\beta_j$ is the coefficient value for hydrologic predictor $j$. -->


### MARSS method

We used the R programming environment [@TheRFoundationProject2025] and the autoregressive modeling function `MARSS()` [@SeeHolmesReducing2015] to calculate two types of MARSS models models for each species (Table \@ref(tab:statsMethodsTable)). In the first type, we calculated a single-covariate model of juveniles-to-spawner ratio based on each relevant hydrologic metric. In the second type, we calculated a set of two-covariate models of juvenile abundance, where the two covariates were a single hydrologic metric and (Z-scored) spawner abundance. In contrast to the hydrologic benefit formulation, prediction using an autoregressive model is more complex in that it can be used to make predictions based on all observations, or on all observations up to the point of prediction [@SeeHolmesReducing2015]. 

<!-- A more complex predictive function. Can be used to predict outcomes based on T (all time) or t-1 (all time before prediction).  -->

<!-- ### Predictor restriction based on sample size -->

<!-- Some ecological records have gaps (e.g., when funding was not available in one year to conduct a redd survey). Additionally, some predictor metrics are not available in all years (for example, FA_Mag, or magnitude of a fall pulse flow, cannot be calculated if no discrete fall pulse flow is observed). For the LASSO regression exercise, we restricted the set of considered predictors to those which had at least 10 years of overlap with the selected ecological response. **MARSS: could have 0 gaps in covariates** -->



# Results

## Flow history of the Scott River, described in functional flow metrics

Diagnostic metrics of Scott River flow have demonstrated clear trends over the past 8 decades. Between 1942 and 2021, total annual flow measured at the Fort Jones gauge has dropped from an average of approximately 600 to 400 thousand acre-feet (TAF, or from >800 to <600 million m^3^) (Figure \@ref(fig:funcFlowTimeseries), panel A). Annual flows have always shown large variability, ranging across an order of magnitude, from 67 TAF (in water year 1977) to 1,336 TAF (in water year 1974). More recently, the frequency of years with low annual flows (200 TAF or less) has significantly increased: 3 such years over the first four decades of the gauge record, but 10 such years over the second four decades. In contrast, very high annual flows of over 600 TAF were exceeded in at least five years for each two-decade period between 1941 and 2000, but only twice in the most recent two-decade record. 

Ecosystem functional flow metrics, calculated with signal-processing techniques [@PattersonEtAlHydrologic2020] (illustrated in Supplemental Figure \@ref(fig:fig2Yarnell2020)), also show clear trends over time (Figure \@ref(fig:funcFlowTimeseries), panels B-H). The fall pulse onset date has trended slightly later (though a distinct fall pulse flow does not occur every year), and the magnitude of the fall pulse flows has decreased.  Years with a fall pulse flow magnitudes of less than 400 cfs have become more frequent, resulting in a visible downward trend in fall pulse magnitude over the period of record (Figure \@ref(fig:funcFlowTimeseries), panel B).

<!-- Remarkably, a fall pulse onset during the first half of October occurred four times between 1940 and 1980, but not since then (Figure \@ref(fig:funcFlowTimeseries), panel C). -->
<!-- Reflecting the large variability in annual flows, the magnitude of the fall pulse flow varies widely, across 2.5 orders of magnitude, from less than 50 cfs to 1500 cfs. Extremely high fall pulse flows (>800 cfs), occurring three times in the earlier period, were missing in the second half of the 80-year record. -->

The onset of the wet season has trended slightly later, though wet season median baseflows (i.e., flows not occurring during storm pulses) have remained stable on average (with a very slight downward trend). Wet season baseflow rates vary from less than 50 cfs (1977) to over 2000 cfs (1997) with typical winter flow ranging from 400 to 1000 cfs (Figure \@ref(fig:funcFlowTimeseries), panel E).

After April, the chance of large precipitation events becomes minimal leading to a gradual, near-exponential decline of streamflow rates during May through July as the snowpack in the upper watershed melts off. While a very consistent feature in the annual hydrograph (e.g., Supplemental Figure \@ref(fig:reconnectExplainerHydrograph)), the rate of flow reduction (i.e., the exponential decline) during the spring has increased over the period of record. The spring recession curve has grown steeper and accelerated the annual recession process: the rate of decline was just above 0.05%/day in 1940, and it was nearly 0.07%/day in 2020 (Figure \@ref(fig:funcFlowTimeseries), panel F).

The median dry season flow has dropped by approximately 50%, with many years since 1977 seeing flows below 30 cfs, a condition not seen prior to 1977 and largely related discontinuation of inefficient flood irrigation with surface water during the 1970s and the introduction of efficient sprinkler irrigation with groundwater allowing for an extended irrigation season [@TolleyEtAlSensitivity2019]. The onset of the dry season is earlier, and the duration of the dry season has increased, in some of the most recent years to over 200 days (Figure \@ref(fig:funcFlowTimeseries), panels G and H). 

The reconnection and disconnection dates also show significant trends over time. As a result, the wet season has notably narrowed over time with (approximate) fall onset trending later and the spring flow recession trending to begin earlier. In 2020, the expected reconnection at the 120 cfs threshold occurs more than a month later than in 1940, and the expected summer disconnection more than two weeks earlier (Figure \@ref(fig:reAndDisconTimeseries)).

In aggregate over the past 80 years, these metrics show an increasing prevalence of unfavorable hydrologic conditions for salmonids, in terms of the flows needed during critical life stages. The primary causes of this reduced ecological functionality are a changing climate (especially a reduced snowpack and earlier snowmelt) and long-term changes in local consumptive water uses [@DrakeEtAlAnalysis2000; @VanKirkNamanRelative2008; @FogliaEtAlScott2013].


```{r funcFlowTimeseries, echo = F, warning =F, fig.height = 8.6, fig.cap = "Total annual flow volume (panel A) and functional flow metrics (panels B-H; Patterson et al. 2020), derived from daily average flow measurements at the Fort Jones USGS flow gauge (ID 11519500) for water years 1942-2023.\\label{fig:funcFlowTimeseries}"}

fflows_hist_obs = read_fflows_FJ(calculator = "Flashy")#read_fflows_csv(scen_id = "hist_obs")

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 9, units = "in", res = res_dpi)
  
func_flow_timeseries_fig(fj_flow = fj_flow, fflows = fflows_hist_obs)
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


```{r reAndDisconTimeseries, echo = F, warning =F, fig.height = 8, fig.cap = "Disconnection and reconnection dates for the 120 cfs (3.4 cms) flow threshold, water years 1942-2023. The disconnection date refers to the first day in the spring on which flow drops below the designated threshold (120 cfs); the reconnection date refers to the first date in the fall on which flow rises above the designated threshold. Trends over the past 80 years suggest that the spring flow recession is trending earlier, and the fall river reconnection is trending later. \\label{fig:reAndDisconTimeseries}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 6, units = "in", res = res_dpi)
  
re_and_discon_timeseries_figure()
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


## Hydrology-ecology correlations


```{r suppEcoVSTimeFigs, echo = F, warning =F, fig.height = 8, fig.cap = "Explanatory plots of Chinook spawner abundance versus various hydro metrics and over time. \\label{fig:suppEcoVSTimeFigs}"}

# fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
# if(save_imgs == TRUE){
# png(filename = fig_path, width = 7, height = 6, units = "in", res = res_dpi)

resave_eco_hydro_scatter_plots = F

if(resave_eco_hydro_scatter_plots == T){
  for(id in yvlt$y_val){
    eco_vs_pred_figs(y_val_id = id)
    
    eco_vs_time_figs(y_val_id = id)
  }
  
}


# dev.off()

# }
# if(include_figs==T){knitr::include_graphics(fig_path)}
# fig_i = fig_i +1



```

```{r inter_corr_matrix_supp_fig, echo = F, warning =F, comment = F}

nthresh = length (thresh_for_corr_fig)
nthresh_gt_70 = sum(thresh_for_corr_fig >= 70)

# Calculate correlation matrix 
corr_tab_all_metrics = cor(metrics_tab, use = "pairwise.complete.obs",
                           method = "spearman")

# and remove values that don't make temporal sense 
# (i.e., the wet season values in water year 2011 would not influence the
# number of spawners that arrived in fall of 2010)

pred_season = substr(x = colnames(metrics_tab[,preds_all]), start = 1, stop = 2)
names(pred_season) = colnames(metrics_tab[,preds_all])
for(i in 1:nrow(yvlt)){
  # possible to do: figure out how the wy1 and wy2 metrics would map out here. 
  # for which eco responses do they get NA vals?
  pred = yvlt$y_val[i]
  season_set = unlist(strsplit(yvlt$influencing_seasons[i], split = ", "))
  keep_these = c(non_preds, names(pred_season)[pred_season %in% season_set])
  exclude_these = colnames(metrics_tab)[!(colnames(metrics_tab) %in% keep_these)]
  corr_tab_all_metrics[pred, exclude_these] = NA
}

# set up for plot
metrics_tab_column_colors = c(rep("black", 2),  # brood and smolt years
                              rep("darkgray",7), # fish outcome metrics
                              rep(fall_col,nthresh), # BY fall recon 
                              rep(spring_col,nthresh), # RY spring discon
                              rep(fall_col,nthresh),   # RY fall discon
                              rep(spring_col, nthresh_gt_70), #SY spring discon
                              # rep("darkorchid",3), # min. flow metrics
                              # rep("peachpuff3",4),    # total flow metrics
                              # rep("peachpuff4", 4),    # log total flow metrics
                              rep(c(
                                rep(dry_sn_col, 4),
                                rep(fall_col, 4),
                                rep(wet_sn_col, 16),
                                rep(spring_col, 5),
                                rep("peachpuff3",2)), 2),    # annual metrics
                              rep("peachpuff4",2)        # scouring flow days
)

if(save_imgs==T){
  pdf(file = file.path(graphics_dir, "Supplemental Figure A. Correlation Matrix.pdf"), width = 40, height = 40)
par(mar=c(5,4,6,2))
corrplot(corr_tab_all_metrics,
         tl.col = metrics_tab_column_colors, tl.cex = 1.1, 
         # col.lim = rev(c(-1.1,1.1)),
         # col.lim = c(-1, -0.7, -0.4, -0.1, 0.1, 0.4, 0.7, 2),
         col = c(rep("orangered3"), rep("lightpink",2),rep("mistyrose",2),
                 # rep("white",2), 
                 rep("lightcyan",2), 
                 rep("lightskyblue",2),rep("deepskyblue4")),
         na.label = "--", main = NA) 


}

```


```{r corrMatrixFigSetup, echo = F, warning =F, }

# identify which columns we should keep in our correlation analysis
ctl = collinear_screening_exercise(metrics_tab = metrics_tab,
                                              corr_tab_all_metrics = corr_tab_all_metrics,
                                   return_tab = "corr_tab_long_screened")

keepers_co = c(non_preds, as.character(unique(ctl$Var1)))
metrics_tab_screened = metrics_tab[,keepers_co]

# Addl screening for temporal relevance to Chinook freshwater period
metrics_before_chinook_outmigrate = 
  colnames(metrics_tab_screened) %in% non_preds |
  grepl(pattern = "d1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "f1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "w1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "s1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "wy1", x = colnames(metrics_tab_screened)) 
keepers_ch = intersect(x = keepers_co, colnames(metrics_tab_screened)[metrics_before_chinook_outmigrate])

metrics_tab_screened_chinook = metrics_tab_screened[,keepers_ch]

# Run correlations for all metrics in coho table (which includes all metrics in chinook table)

  corr_matrix_pearson = calc_corr_matrix(metrics_tab = metrics_tab_screened, 
                                       preds_all = c(spawner_z_records, preds_all), 
                                       corr_method = "pearson", min_pairs = 10)
  # For results description, find features of max abs R value
  max_loc = which.max(abs(as.matrix(corr_matrix_pearson)))
  x_i = max_loc %% nrow(corr_matrix_pearson)
  y_i = ceiling(max_loc/nrow(corr_matrix_pearson))
  max_corr = round(corr_matrix_pearson[x_i, y_i],2)
  max_corr_x = rownames(corr_matrix_pearson)[x_i]
  max_corr_y = colnames(corr_matrix_pearson[y_i])
  
  gt_0.5 = sum(abs(corr_matrix_pearson) > 0.5, na.rm = T)
```

Correlations between Z-scored hydrologic and log-transformed ecologic metrics were not particularly strong (Figure \@ref(fig:corrMatrixFig); *Supplemental Figure A*). The maximum absolute $R$ value was `r max_corr`, calculated between baseflow median of the first wet season (`r max_corr_x`) and Chinook smolt abundance, and only `r gt_0.5` absolute $R$ values were greater than 0.5. This is consistent with the understanding that hydrology is only one factor influencing salmonid reproductive outcomes. 

The correlation coefficients do not show uniform effects of hydrology on both species: for example, a high baseflow magnitude in the first wet season is negatively correlated with Chinook juveniles but has no or a slight positive correlation with coho juveniles (Figure \@ref(fig:corrMatrixFig)). Furthermore, hydrology tends to have different effects on different life stages: the magnitude of the fall flow increase (`FA_Dif_num`) and coho juvenile abundance are positively correlated when it occurs in the first fall (`f1`), during their parents spawning, but are negatively correlated when it occurs in the second fall (`f2`), when they are overwintering juveniles. 

Though it is outside the scope of this study to capture all biological influences on fish production, it would be remiss to overlook some of the obvious relationships between the ecological data series used in this study. A full set of $R$ values among ecological observations is shown in *Supplemental Figure A*, but only spawner abundances (Z-scored for consistency with hydrologic metrics) were highlighted as predictors in Figure \@ref(fig:corrMatrixFig). As we might expect, spawner abundance is positively correlated with smolt abundance (and observed redds, for coho). However, hydrology seems to have an equivalent or slightly higher influence on juvenile production as spawner abundance: for both species, the spawner-juvenile $|R|$ is lower than at least one hydrologic-juvenile $|R|$ value (Figure \@ref(fig:corrMatrixFig)).

```{r corrMatrixFig, echo = F, warning =F, fig.height = 8.5, fig.width = 7, fig.cap = "Correlations between 20 Z-scored predictors (2 spawner observation records and 18 hydrologic metrics, prescreened for collinearity) and 7 log-transformed ecological monitoring records for Chinook (left three columns) and coho (right four columns). Large blue circles indicate that the quantity (such as the first wet season median baseflow, or w1_Wet_BFL_Mag_50) is positively correlated with observed fish metrics. For dates, a blue dot indicates that a later date is correlated with higher fish values, while a red dot indicates that an earlier date is correlated with higher fish values. The full suite of calculated R values is shown in Supplemental Figure A.\\label{fig:corrMatrixFig}"}
  
# find prediction subset for figure.
# inclusion_threshold = 0.45
# greater_than_thresh_finder = apply(X= corr_matrix_pearson, MARGIN = 1,
#                                 function(x){sum(abs(x) >= inclusion_threshold,
#                                                 na.rm=T) > 0})
# pred_subset = row.names(corr_matrix_pearson)[greater_than_thresh_finder]
pred_subset = row.names(corr_matrix_pearson) # include all screened metrics

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  
  corr_matrix_fig_2(corr_matrix = corr_matrix_pearson,
                    pred_subset = pred_subset,
                    preds_in_order = c(spawner_z_records, preds_all))
}

dev.off()

if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1

#After the correlation figure, remove spawners from LASSO exercise if not using as a predictor
if(predict_eco != "juveniles abundance, hydro and spawners"){
  metrics_tab_screened[,spawner_z_records] = NULL
  metrics_tab_screened_chinook[,spawner_z_records] = NULL
}


```


## Predictive modeling

### Comparison of statistical model structures

Six different statistical model structures were tested for predicting each species (see *Supplement Section S6* for method details). To select the final model structure we weighed LASSO advantages (overfitting penalty, predictor selection, interpretable output) and disadvantages (assumes independent observations), MARSS advantages (built for working with small ecological time series records, accounts for autocorrelation) and disadvantages (more complex output function), and model performance against observed data. 
 

```{r findingsTab, echo = F, warning =F, results = 'asis'}


findingsTab = read.csv(file.path(data_dir, "stats method findings tab.csv"))


caption_text = "Description of six different techniques for modeling two types of ecological outcomes using hydrologic metrics (and available ecological data, if applicable). Coefficient values and results figures located in Supplemental Section S7 and S8."

ft_ft = flextable(data=findingsTab)
ft_ft = set_caption(ft_ft, caption = caption_text)
ft_ft = flextable::width(ft_ft,j=1,  width = 0.7)
ft_ft = flextable::width(ft_ft,j=2,  width = 0.6)
ft_ft = flextable::width(ft_ft,j=3,  width = 0.7)
ft_ft = flextable::width(ft_ft,j=4,  width = 1.55)
ft_ft = flextable::width(ft_ft,j=5,  width = 1.55)
ft_ft = flextable::width(ft_ft,j=6,  width = 1)
ft_ft = flextable::width(ft_ft,j=7,  width = 1)
ft_ft = flextable::width(ft_ft,j=8,  width = 0.5)
ft_ft = flextable::width(ft_ft,j=9,  width = 0.5)
# add complex header

ft_ft = flextable::set_header_labels(ft_ft,
                                           values = list(
                                             Predicts ="",
                                             Using = "",
                                             Method = "",
                                             MostImportantHydroCoho = "Coho",
                                             MostImportantHydroChinook = "Chinook",
                                             H2SRatioCo = "Coho", H2SRatioCh= "Chinook",
                                             CohoMinAICc = "Co.", ChinookMinAICc = "Ch."))

ft_ft = add_header_row(ft_ft, values = c("Predicts","Using","Method","Most Important Hydrologic Metrics","Hydrologic vs. Spawner Influence (Coef. Ratios)", "Min. AICc"), colwidths = c(1,1,1,2,2,2), top = T)
ft_ft
```


We also used three framing questions to evaluate the combined results of all statistical model structures, and to decide on a single model for each species to represent the hydrologic benefit provided by each water year.

1.	Do MARSS and LASSO models identify the same hydrologic metrics as important?

The two methods produced different sets of important metrics, though there is some clear overlap (Table \@ref(tab:findingsTab)). For juveniles-per-adult models, most important predictor for coho (`f1_recon_120`, or earlier river reconnection during parents' spawning) is the same in both MARSS and LASSO models. The second-most important hydrologic metric for Chinook juveniles-per-spawner identified by MARSS (`s1_SP_ROC_Max`, or slower maximum spring recession rate) matches the highest-importance one identified using LASSO. 

In juvenile abundance models for coho, all four methods identified `f1_Fall_dif_num`, or a larger fall flow increase during parents' spawning, as high-importance. Similarly, for juvenile abundance models of Chinook, all four methods (LASSO and MARSS, with and without a spawner predictor/covariate) identified `w1_Wet_BFL_Mag_50`, or lower wet season baseflows, as an important metric.

2.	With different prediction units (i.e., juvenile abundance and juveniles-per-spawner), are the same hydrologic metrics identified as important?

No, different ecological prediction units produced different high-importance hydrologic metrics: for coho, juveniles-per-spawner and juvenile abundance models identified earlier first fall river reconnection versus larger first fall flow increase, respectively. For Chinook the two prediction units identified a slower maximum spring recession for juveniles-per-spawner versus lower wet season baseflows for juvenile abundance.

3.	For models of juvenile abundance, what is the relative importance (based on coefficients and AICc values) of spawners versus hydrology?

Across all model structures, the influence of hydrology ranged from approximately equivalent to the influence of spawners to more than eight times as important (based on coefficient ratios; (Table \@ref(tab:findingsTab)). The addition of spawners to the LASSO model of juvenile abundance made a significant difference in the predictors selected for Chinook but not for coho. This is corroborated by the change in AICc values among MARSS models: adding spawners as a covariate produced a lower AICc (better model) for Chinook but a higher AICc (worse model) for coho (Table \@ref(tab:findingsTab)). 

### Final model selection rationale

The objective of this study is to generate a prediction of ecological outcomes based on hydrology alone, to apply to simulated future flow changes. The model structures that include spawners as a predictor or a covariate are not suitable for this purpose; they were included in this analysis for comparative purposes. Additionally, a prediction in units of juvenile abundance would have the most direct relevance for water managers intending to sustain the Scott River salmonid fishery.

These two considerations would lead us to select the LASSO or MARSS models of juvenile abundance based only on hydrologic predictors as the final predictive model. However, the LASSO model for this prediction structure in coho has poor performance (explaining ~20% of deviance at a low-error $\lambda$ value; Figure \@ref(fig:juvAbunHydOnlyLassoCohoChinook), middle left panel). For coho results, LASSO models of juvenile abundance for coho performed much better (explained ~50% deviance) with hydrological and spawner predictors than with hydrology alone (Figures \@ref(fig:juvAbunHydOnlyLassoCohoChinook) and \@ref(fig:juvAbunLassoCohoChinook)). Similarly, MARSS models cover a larger fraction of coho juvenile abundance variation when spawners are added as a covariate (Figures \@ref(fig:MARSSSingleCovars) and \@ref(fig:MARSSHydroPlusSpawn)). For both statistical methods, Chinook also performed better when spawners were added as a predictor/covariate (~60%  with hydrology only vs ~75% with spawners) but the improvement was less dramatic. Thus, a LASSO or MARSS model of juvenile abundance based on hydrology may be a satisfactory structure for a Chinook prediction, but it seems irresponsible to select this model structure for coho, knowing that adding spawner data improves model performance so dramatically.

Predicting juvenile-to-spawner ratios present an alternative. These models are based only on hydrologic predictors, but implicitly include spawner data in the prediction target; this ratio also eliminates the influence of the cohort time lag and effectively makes each annual data point an independent observation. 

Lastly, we considered whether to use LASSO or MARSS. The two quantities of interest (juveniles-per-spawner for coho and juvenile abundance for Chinook) show no significant autocorrelation (Figure \@ref(fig:acfEcoRecords)), reducing the MARSS method advantage. 

All of these factors led us to select the following structure for the final predictive models:

* Chinook: LASSO model of juvenile abundance based on hydrologic metric predictors
* Coho: LASSO model of juvenile-per-spawner ratio based on hydrologic metric predictors

For each species, the final predictive model was referred to as the hydrologic benefit (HB) function. The HB function for each species is composed of an intercept and three non-zero coefficients, of which the first is approximately an order of magnitude greater than the trailing two (Tables \@ref(tab:coefTableCoho) and \@ref(tab:coefTableChinook)).


```{r kfold_lambda_finding, echo = FALSE, warning = F}

# without spawners
# if(predict_eco %in% c("juveniles per spawner", "juvenile abundance, hydro only")){
#   
#   # calculate LASSO regression model and cross-validation objects
#   # (LASSO: alpha = 1; ridge: alpha = 0)
#   mod_obj_co = kfold_cv(mt = metrics_tab_screened, y_val = y_val_coho, alpha = 1)
#   mod_co = mod_obj_co$mod; cv_co = mod_obj_co$cv
#   mod_obj_ch = kfold_cv(mt = metrics_tab_screened_chinook, alpha = 1,
#                         y_val = y_val_chinook)
#   mod_ch = mod_obj_ch$mod; cv_ch = mod_obj_ch$cv
#   # extract coefficients from the model using alt. lambda value
#   alt_lambda_co = .145
#   coefs_co = get_pred_coefs(mod = mod_co, cv = cv_co, coef_digits = 3, alt_lambda = alt_lambda_co)
#   coefs_ch = get_pred_coefs(mod = mod_ch, cv = cv_ch, coef_digits = 3)
# }

# ### With spawners
# if(predict_eco == "juvenile abundance, hydro and spawners"){
#   mod_obj_co = kfold_cv_plus_spawn(mt = metrics_tab_screened, 
#                                    y_val = y_val_coho,
#                                    alpha = 1)
#   mod_co = mod_obj_co$mod; cv_co = mod_obj_co$cv
#   
#   mod_obj_ch = kfold_cv_plus_spawn(mt = metrics_tab_screened_chinook, alpha =1, 
#                                    y_val = y_val_chinook)
#   mod_ch = mod_obj_ch$mod; cv_ch = mod_obj_ch$cv
#   # extract coefficients from the model using the optimal lambda value found in cross-validation
#   coefs_co = get_pred_coefs(mod = mod_co, cv = cv_co, coef_digits = 3)
#   coefs_ch = get_pred_coefs(mod = mod_ch, cv = cv_ch, coef_digits = 3)
# }


# FINAL ECO PREDICTIONS
if(predict_eco %in% c("final eco prediction selection")){
  y_val_coho = "coho_smolt_per_fem"; y_val_chinook = "chinook_juvenile_abundance"
  # calculate LASSO regression model and cross-validation objects
  # (LASSO: alpha = 1; ridge: alpha = 0)
  mod_obj_co = kfold_cv(mt = metrics_tab_screened, y_val = y_val_coho, alpha = 1)
  mod_co = mod_obj_co$mod; cv_co = mod_obj_co$cv
  mod_obj_ch = kfold_cv(mt = metrics_tab_screened_chinook, alpha = 1,
                        y_val = y_val_chinook)
  mod_ch = mod_obj_ch$mod; cv_ch = mod_obj_ch$cv
  # extract coefficients from the model using alt. lambda value
  alt_lambda_co = .145
  coefs_co = get_pred_coefs(mod = mod_co, cv = cv_co, coef_digits = 3, alt_lambda = alt_lambda_co)
  coefs_ch = get_pred_coefs(mod = mod_ch, cv = cv_ch, coef_digits = 3)
}


```


```{r LASSOResultsCohoChinook, echo = F, warning = F, fig.height = 8, fig.cap = "Results of LASSO regression to predict log-transformed coho and Chinook outcomes with Z-scored hydrologic metrics. Models with more coefficients explain a greater fraction of deviance in the dataset (middle panel), but also produce higher test errors (top panel), indicating some overfitting at lower lambda values. Higher values of lambda tend to shrink the absolute values of regression coefficients toward 0 (bottom panel).\\label{fig:LASSOResultsChinook}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)}

# if(predict_eco %in% c("juvenile abundance, hydro and spawners")){
#   lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, mod_ch = mod_ch)
# 
# }
# if(predict_eco %in% c("juveniles per spawner", "juvenile abundance, hydro only")){
# lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, 
#               mod_ch = mod_ch, alt_lambda_co = alt_lambda_co)
# }
if(predict_eco %in% c("final eco prediction selection")){
lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, 
              mod_ch = mod_ch, alt_lambda_co = alt_lambda_co)
}


if(save_imgs == TRUE){
  dev.off()
  # save predictor appearance tab
  pred_tab_filename = "Supplemental Table 3. Coho Salmon LASSO Coefficients.csv"
  write.csv(x=coefs_co$coef_all, file=file.path(graphics_dir,pred_tab_filename),
            quote=F, row.names = F)
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1




```


```{r coefTableCoho, echo = F, warning =F, results = 'asis'}

# Retrieve coefficients from LASSO model

coefs_interp_names = names(coefs_co$coef_non0_only)
coefs_interp = as.character(coefs_co$coef_non0_only)
names(coefs_interp) = coefs_interp_names
# add interpretation to each non-0 coefficientS
# if(predict_eco == "juveniles per spawner"){
#   coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
#   coefs_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and hatchlings)"
#   coefs_interp$f2_FA_Dif_num = "Smaller fall pulse (as juvenile fish)"
#   # coefs_interp$s2_SP_ROC = "Faster rate of change (as outmigrating smolt)"
# }
# if(predict_eco == "juvenile abundance, hydro and spawners"){
#   # coefs_interp$coho_spawner_abundance = "Greater number of spawners (cohort's parents)"
#   # coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
#   coefs_interp$f1_FA_Dif_num = "Greater fall flow increase (during parents' spawning)"
#   coefs_interp$f2_FA_Dif_num = "Smaller fall pulse (as juvenile fish)"
#   coefs_interp$s1_SP_ROC = "Slower rate of change (as juvenile fish)"
# }
# if(predict_eco == "juvenile abundance, hydro only"){
#   # coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
#     coefs_interp$f1_FA_Dif_num = "Greater fall flow increase (during parents' spawning)"
#     coefs_interp$f2_FA_Dif_num = "Smaller fall flow increase (as juvenile fish)"
#   coefs_interp$s2_SP_ROC = "Faster rate of change (as outmigrating smolt)"
# 
# }

if(predict_eco == "final eco prediction selection"){
  coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
  coefs_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and hatchlings)"
  coefs_interp$f2_FA_Dif_num = "Smaller fall pulse (as juvenile fish)"

}

coefs_co_vals = c(round(coefs_co$int_and_coefs$coef, 3))
coefs_co_interp = c("(Intercept)", unlist(coefs_interp[coefs_co!="0"]))
coefs_co_ft = data.frame(Predictor = c(names(coefs_co_interp)),
                         Value = as.vector(coefs_co_vals),
                         Description = coefs_co_interp)

caption_text = paste0("Values for the intercept and coefficient terms in the hydrologic benefit function for ",
                      yvlt$y_val_title[yvlt$y_val==y_val_coho],
                      " abundance, including a description of which phenomena are associated with higher ecological outcome values.")


coco_tab_ft = flextable(data=coefs_co_ft)
coco_tab_ft = set_caption(coco_tab_ft, caption = caption_text)
coco_tab_ft = flextable::width(coco_tab_ft,j=1,  width = 1.5)
coco_tab_ft = flextable::width(coco_tab_ft,j=2,  width = 1)
coco_tab_ft = flextable::width(coco_tab_ft,j=3,  width = 3)
coco_tab_ft = flextable::set_header_labels(coco_tab_ft,
                                           values = list(
                                             Predictor ="Predictor", 
                                             Value = "Value",
                                             Description = "Greater hydrologic benefit value associated with"))
coco_tab_ft


```



```{r coefTableChinook, echo = F, warning =F, results = 'asis'}

# Retrieve coefficients from LASSO model
coefs_interp_names = names(coefs_ch$coef_non0_only)
coefs_ch_interp = as.character(coefs_ch$coef_non0_only)
names(coefs_ch_interp) = coefs_interp_names

# add interpretation to each coefficient
if(y_val_chinook == "chinook_juv_per_adult"){
  coefs_ch_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
  coefs_ch_interp$s1_SP_ROC_Max = "Slower max. spring recession rate (as outmigrating smolt)"
}
if(predict_eco == "juvenile abundance, hydro and spawners"){
  coefs_ch_interp$chinook_spawners_zscored = "Greater number of spawners (cohort's parents)"
  coefs_ch_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
  # coefs_ch_interp$w2_Wet_BFL_Dur = "Longer wet season (wet season 2, they're not here)"
    coefs_ch_interp$s1_SP_ROC_Max = "Slower max. spring recession rate (as outmigrating smolt)"

}

if(predict_eco == "juvenile abundance, hydro only"){
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
}

if(predict_eco == "final eco prediction selection"){
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
}


coefs_ch_vals = coefs_ch$int_and_coefs$coef
coefs_ch_interp = c("Intercept", unlist(coefs_ch_interp[coefs_ch!="0"]))
coefs_ch_ft = data.frame(Predictor = c(names(coefs_ch_interp)),
                         Value = as.vector(round(coefs_ch_vals,3)),
                         Description = coefs_ch_interp)


caption_text = paste0("Values for the intercept and coefficient terms in the hydrologic benefit function for ",
                      yvlt$y_val_title[yvlt$y_val==y_val_chinook],
                      " abundance, including a description of which phenomena are associated with higher ecological outcome values.")

coch_tab_ft = flextable(data=coefs_ch_ft)
coch_tab_ft = set_caption(coch_tab_ft, caption = caption_text)
coch_tab_ft = flextable::width(coch_tab_ft,j=1,  width = 1.8)
coch_tab_ft = flextable::width(coch_tab_ft,j=2,  width = 1)
coch_tab_ft = flextable::width(coch_tab_ft,j=3,  width = 3)
coch_tab_ft = flextable::set_header_labels(
  coch_tab_ft,
  values = list(
    Predictor ="Predictor", 
    Value = "Value",
    Description = "Greater hydrologic benefit value associated with"))
coch_tab_ft
```


```{r calc_hbf_values_tabs, echo = F, warning =F}

if(predict_eco %in% c("juveniles per spawner", "juvenile abundance, hydro only",
                      "final eco prediction selection")){
# retrieve hydrology for all years of FJ flow
  brood_year_hydro_tab_long = tabulate_hydro_by_affected_brood_year(
    brood_years = 1942:2022, smolt_years = 1944:2024)

  metrics_tab_long = calc_metrics_hydro_by_affected_brood_year(
    hydro_by_brood_year = brood_year_hydro_tab_long,
    thresholds = thresh_for_corr_fig,
    reduce_to_eco_data_years_only = F)

  metrics_tab_long = metrics_tab_long[,intersect(colnames(metrics_tab_screened),
                                                 colnames(metrics_tab_long))]
  if(log_transform_eco_metrics == T){
    metrics_tab_long[,yvlt$y_val] = log10(metrics_tab_long[,yvlt$y_val])
  }

  if(zscore_flow_metrics == T){
    zscore_these = !(colnames(metrics_tab_long) %in% non_preds)
    metrics_tab_long[,zscore_these] = apply(X = metrics_tab_long[,zscore_these],
                                            MARGIN = 2, FUN = zscore_column_na_rm)
  }

  mt_co_hbf = metrics_tab_long; mt_ch_hbf = metrics_tab_long
} else { #if spawners needed as a predictor, restrict time series plot to years
  # with spawners and obs data
  # metrics_tab_long = metrics_tab_screened
  co_vals_i = which(!is.na(metrics_tab$coho_spawner_abundance) &
                      !is.na(metrics_tab$coho_smolt_abun_est))
  co_i = min(co_vals_i):max(co_vals_i)
  mt_co_hbf = metrics_tab_screened[co_i,]

  ch_vals_i = which(!is.na(metrics_tab$chinook_spawner_abundance))
  ch_i = min(ch_vals_i):max(ch_vals_i)
  mt_ch_hbf = metrics_tab_screened[ch_i,]
}

# calculate hbf for all years in which there are hydrodata
hbf_coho = get_hbf_tab(mt = mt_co_hbf,
                       coefs = coefs_co$coef_non0_only,
                       int = coefs_co$intercept)
hbf_chinook = get_hbf_tab(mt = mt_ch_hbf,
                          coefs = coefs_ch$coef_non0_only,
                          int = coefs_ch$intercept)

# convert to absolute ecological observation numbers
# if(log_transform_eco_metrics == T){
#   hbf_coho$hbf_total_log = hbf_coho$hbf_total
#   hbf_coho$hbf_total = 10^(hbf_coho$hbf_total_log)
#   hbf_chinook$hbf_total_log = hbf_chinook$hbf_total
#   hbf_chinook$hbf_total = 10^(hbf_chinook$hbf_total_log)
# }
# calculate lowest hbf value
lowest_coho_spf_pred=10^min(hbf_coho$hbf_total)

```



### Predicted Hydrologic Benefit value over time

The visual match between predicted and observed values in the selected model structure is rather poor, particularly for coho: predicted values do not range either as low or as high as observed values (Figure \@ref(fig:hbfOverTime)). This matches the expectation that the minimum-error LASSO model will explain only ~40% of the deviation from the mean for coho and 60% for Chinook (Figure \@ref(fig:LASSOResultsCohoChinook), middle panels).

Matching the historical flow trends discussed above (and tabulated in *Supplemental Table 2*), the predicted value of $log_{10}(coho~spf~equiv.)$ produced by a given water year has trended downward over time (Figure \@ref(fig:hbfOverTime), top panel), while no clear trend is present in the predicted value for Chinook $log_{10}(Chinook~jpa~equiv.)$ (though a string of low predicted values in the 1990s corresponds to a series of high-flow winters). 

<!-- The lowest predicted value, `r round(lowest_coho_spf_pred,1)` coho spf in brood year 2013, corresponds to the severe drought year of 2014. Conditions were so extreme in water year 2014 that emergency measures were taken by local agencies and conservation organizations to facilitate transport of salmon around disconnected river reaches [CDFW et al. -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015]. -->


```{r hbfOverTime, echo = F, warning = F, fig.height = 8, fig.cap = "Annual observed and predicted values of coho smolt produced per female spawner (coho spf, top panel) and abundance of outmigrating Chinook juveniles (lower panel). Predicted quantities (black dots) are shown as Hydrologic Benefit (HB) function values of log10(ecological observation); this is transformed back to straight numerical values of the observation on the right side axis. The predicted and observed values are plotted by each cohort's brood year. \\label{fig:hbfOverTime}"}

# Negative prediction values (considered physically impossible) are flagged but are retained to visually demonstrate the uncertainty in the exercise of predicting fish outcomes from hydrologic metrics alone, based on a small sample size.

# convert to absolute ecological observation numbers

# if(log_transform_eco_metrics == T &
#    sum(grepl(pattern = "_log", colnames(metrics_tab_screened)))==0 ){# if it hasn't already been transformed back
#   metrics_tab_screened[,paste0(y_val_coho,"_log")] = metrics_tab_screened[,y_val_coho]
#   metrics_tab_screened[,y_val_coho] = 10^metrics_tab_screened[,paste0(y_val_coho,"_log")]
#   metrics_tab_screened[,paste0(y_val_chinook,"_log")] = metrics_tab_screened[,y_val_chinook]
#   metrics_tab_screened[,y_val_chinook] = 10^metrics_tab_screened[,paste0(y_val_chinook,"_log")]
# }

if(predict_eco == "juvenile abundance, hydro and spawners"){ # if needs spawner as a predictor
  keep_yrs = metrics_tab_screened$brood_year[!is.na(metrics_tab_screened$coho_spawner_abundance) |
                                               !is.na(metrics_tab_screened$chinook_spawner_abundance)]
  plot_yrs = min(keep_yrs):max(keep_yrs)
} else {plot_yrs = NA}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  par(mfrow=c(2,1))
  # Panel 1. Coho
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_coho]
  hbf_over_time_fig(mt = metrics_tab_screened,
                    hbf_tab = hbf_coho,
                    y_val = y_val_coho,
                    y_val_axis = y_axis_label,
                    plot_yrs = plot_yrs)

  # Panel 2. Chinook
  hbf_chinook$hbf_total[!is.finite(hbf_chinook$hbf_total)]=NA
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_chinook]
  hbf_over_time_fig(mt = metrics_tab_screened,
                    hbf_tab = hbf_chinook,
                    y_val = y_val_chinook,
                    y_val_axis = y_axis_label,
                    plot_yrs = plot_yrs,
                    show_legend = F)




  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1


```


# Discussion


The findings described above suggest that, in this case study, hydrology can explain about 40% and 60% the variation in a key ecological outcome for coho and Chinook salmon, respectively, though as a predictive tool it has some limitations. 

## Correlations and predictor selection results suggest potential mechanisms for flow-ecology relationships

While the primary aim of this paper [as categorized in @TredennickEtAlPractical2021] is to develop a predictive model of ecological responses to flow, we can make some interpretations as to the mechanisms behind these predictions from the parameters of this model, which are interrogated further below. 

The correlation and predictor selection analyses support several findings (wet season duration, scouring flows, fall flow timing and outmigrants) that match existing understanding of coho ecohydrology, as well as one finding (fall flow timing and spawners) that does not match the current understanding. Mechanisms supporting some flow-ecology relationships are discussed below.

As one would expect, the Chinook spawner record is correlated with outmigrating Chinook smolts, and coho spawners are correlated with redds and outmigrating coho smolts. Interestingly, Chinook spawners are not correlated with any coho records, and the reverse is also true: all cross-species spawner-ecological $|R|$ values are less than 0.3 (Figure \@ref(fig:corrMatrixFig)).

Chinook juvenile abundance seems to be sensitive to, and negatively affected by, high median wet season baseflow magnitude; this corroborates findings that being swept downstream by high average winter flowrates has a significant influence on survival of recently-hatched juveniles [@NislowArmstrongLifehistorybased2012]. Chinook, due to laying eggs in the mainstem river, would be more vulnerable to these high flowrates than coho. 

Correlation coefficients and multiple model results suggest that coho smolt production, both in absolute abundance terms and relative to spawners, is sensitive to conditions during the end-of-dry-season flow increase, during their parents' spawning. Earlier fall reconnection or a larger fall flow increase could allow spawners more time or greater physical access to reach preferred tributary habitat or higher-quality local nesting sites. larger fall flow increase during parents' spawning. Notably, coho smolt abundance with the fall flow increase is positively correlated when it occurs during the first fall when a cohort's parents are spawning, but is negatively correlated  when it occurs in the second fall, when coho are oversummering juveniles. This matches findings that fall pulse flows can have a positive or negative effect on salmonids depending on life stage or timing [@NislowArmstrongLifehistorybased2012].


<!-- Coho spf: earlier fall reconnection, longer winter baseflow duration, and smaller fall pulse as oversummering juveniles. Smaller max recession rate (but larger average recession rate), outmigrating spring; could be that higher average rates reduce transit time to the ocean (and thus vulnerability to predation en route), but very steep parts of the recession limb abruptly reduce connectivity or spatial habitat. -->

<!-- Conversely, the hydrology identified as important in Chinook juveniles-per-spawner is more variable, though a negative effect by rapid spring recessions was identified in multiple model structures. A faster spring flow recession could mean smolts are outmigrating through slower flow velocities, which could increase transit time and vulnerability to predation [@McCormickEtAlMovement1998].  -->


<!-- Additionally, in one of the strongest correlation signals, earlier fall reconnection timing (earlier fall spawning flows) is associated with higher coho spf. In general, earlier fall flows in the brood year are thought to be beneficial to coho salmon, but here it appears that this is only true for the absolute number of outmigrating juveniles (with a weak $R$ value of -0.22).  -->

<!-- This supports an interpretation that spawning conditions may exert a significant influence on the mortality rates of the hatching juveniles. One potential mechanism is that during dry water years, when fall reconnection dates are delayed, coho have been known to spawn in suboptimal habitat [e.g., @MagranetScott2015]. Eggs laid in suboptimal conditions suffer from higher mortality rates for multiple reasons, including egg burial by transported sediment, channel bed scouring, or unfavorable water quality [@BjornnReiserInfluences1991]. In wetter years, early reconnection flows and related access to more and higher-quality habitat may allow spawning salmon to select more favorable nesting sites. -->

<!-- This variation between model structures suggests that Chinook smolt production is more dependent on spawner abundance and less sensitive to flow. The influence of spawners as a predictor/covariate (Table \@ref(tab:findingsTab)) suggests that coho smolt production may be less dependent on spawner abundance than Chinook, though for both species there is a positive smolt-spawner correlation (Figure \@ref(fig:corrMatrixFig)). -->



## Biotic and abiotic influence on coho and Chinook outcomes

We intended to identify in which species juvenile production was more limited by or sensitive to the hydrology rather than the number of parental spawners, but the picture is murky.

Chinook juvenile production seems more sensitive to spawner abundance in that, when spawners were added to the LASSO model of Chinook juvenile abundance, it increased the number of selected predictors from one to four, including spawner abundance (Tables \@ref(juvAbunHydOnlyCoefTableCoho and \@ref(tab:juvAbunCoefTableCoho)). Conversely, when spawners were added to the model of coho juvenile abundance, it retained the first two predictors and only influenced the selection of the third (Tables \@ref(juvAbunHydOnlyCoefTableChinook and \@ref(tab:juvAbunCoefTableChinook)). However, in MARSS models, adding spawners as a covariate produced a lower AICc (better model) for coho but a higher AICc (worse model) for Chinook (Table \@ref(tab:findingsTab)). 

It is possible that the small sample size is a limiting factor for this question. In any case, both spawner abundance and a variety of hydrologic metrics are correlated with absolute and relative smolt production (Figure \@ref(fig:corrMatrixFig)).

## Other flow-salmon relationships in the literature **revise title**

**forecasting papers**
[@DietzeEtAlIterative2018]
[@PennekampEtAlPractice2017]
[@DaugaardEtAlForecasting2022]

**reference Previous California section**

## Implications for water and fisheries management

This study contributes a novel approach and insights to the large body of work seeking to understand and conserve aquatic ecosystems in the Klamath basin, and in aquatic ecosystems in Mediterranean climates more generally. 

The predictive exercise for coho spf and Chinook juvenile abundance suggests that using flow alone to predict fish outcomes involves non-negligible uncertainties: HB function error terms (predicted minus observed values) are substantial (Figure \@ref(fig:hbfOverTime)). This is partly a consequence of LASSO regression imposing a penalty on model flexibility, and represents a conservative estimate of the degree of variation in ecological outcomes that can be explained with flow metrics.

At a regional scale, this predictive tool could be used to assess simulated hydrologic outcomes of management actions in terms of the direct effect they would have on coho salmon reproduction. If used in that context, its limitations should be highlighted, including its average test error and the fact that the hydrology explains only about 40% and 60% of the variation in the coho and Chinook observations, respectively.

We expect that the proposed approach could be employed in other regional studies, though in systems with shorter or minimal ecological monitoring records, opportunities to find correlations between flow and biological metrics may be sample size-limited to an even greater degree than in this study. However, this study may show the value of even a dozen years of monitoring data in a range of water year types, and could provide motivation to continue investing in data collection and the monitoring of sensitive species. 

# Conclusions

This case study uses calculated functional flows and long-term biological monitoring to relate hydrologic conditions to watershed-scale anadromous fish reproduction rates. The empirical flow-biology relationships evaluated here also suggest hypotheses regarding the watershed- and species-specific mechanisms of ecological response to flow variability.

To learn if it was possible to empirically identify important features of the hydrograph corresponding to ecological needs of Scott River coho and Chinook salmon, we examined correlations between eighteen hydrologic metrics and seven types of local salmon observations. Correlation coefficients between functional flows  [@PattersonEtAlHydrologic2020; @YarnellEtAlFunctional2020] and new hydrologic metrics (e.g. Figure \@ref(fig:reconnectExplainerHydrograph)) suggested that both spawner abundance and several specifc hydrologic flow metrics were related in different ways to ecological observation records (Figure \@ref(fig:corrMatrixFig)). 

To formulate a prediction of an ecological response to flow, we compared six different statistical model structures for each species, and ultimately selected LASSO regression, predicting coho spf and Chinook juvenile abundance (Figures \@ref(fig:LASSOResultsCohoChinook); Tables \@ref(tab:coefTableCoho) and \@ref(tab:coefTableChinook)).   

The metric contributing the most to predicted coho spf values occurs during the fall window of their parents' spawning, while Chinook seem most sensitive to high winter baseflows shortly after hatching. This supports an interpretation that spawning and early rearing conditions may exert a significant influence on the mortality rates of the hatching coho juveniles.

With continuing trends of a narrowing wet season in the Scott River watershed (e.g., Figure \@ref(fig:reAndDisconTimeseries)), entities aiming to sustain local fisheries may find themselves working with ever-thinner margins for error. Globally, in communities living and working with local natural resources, climate change may transform biodiversity-preservation activities into long-term engineering of novel ecosystems. If this occurs, long-term monitoring and frequently re-evaluated flow-ecology relationships will be necessary to support such efforts.

\newpage


# References

<div id="refs"></div>

\newpage

```{r call_supplement, child=if (INCLUDE_SUPP) 'Kouba_2024_Fish_hydrometrics_Supplement.Rmd'}
```


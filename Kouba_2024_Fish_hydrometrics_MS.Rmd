---
title: A watershed-specific formula to predict salmon reproduction using functional flow metrics
author: "Claire Kouba, Leland Scantlebury, Jason Wiener, Sarah Yarnell and Thomas Harter"
date: "June 2025"
output: 
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
bibliography: draft_library.bib
---

```{r setup_dirs_load_data, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)


library(lubridate)
library(httr)
library(ggplot2) # for barplots 
library(gridExtra)
library(corrplot)  # for data exploration/correlation plots
library(dataRetrieval) # for usgs data
library(data.table) #month function
library(zoo) # rolling means
library(sf)
library(terra)
library(tmap)
library(grid) # for inset maps
library(cowplot) # for inset maps
library(ggthemes) # for colorblind palette
library(flextable)
library(glmnet) # LASSO regression
library(MARSS)
library(here)

# Directories
ms_dir = here::here()
scratch_dir = file.path(ms_dir, "scratch_work")
data_dir = file.path(ms_dir, "Data")
graphics_dir = file.path(ms_dir, "Graphics and Supplements")

# Load spatial and tabular data

# If the data files don't exist locally,
# pull data from internet and local files
if(!file.exists(file.path(ms_dir,"manuscript_data.RData"))){
  source(file.path(ms_dir,"01_DataRetrieval_Cleaning_SaveLocal.R")) 
}
load(file.path(ms_dir, "manuscript_data.RData")) # Load data layers/tables
source(file.path(ms_dir,"02_Figure_Functions.R"))   # Load figure and table functions

#Append supplement?
INCLUDE_SUPP = T
# Save figures as images, yes or no?
save_figs_here = graphics_dir
save_imgs=F# generate the figures in the folder
include_figs = T
replace_setting_fig = F# setting to F can save time if no need to re-render map
fig_i = 1

# pick last water year for the HB function to calculate a value for
last_wy = 2023
```

```{r load_FF_metrics, include = FALSE}
fflows = read_fflows_FJ(calculator = "Flashy")
# fflows = read_fflows_FJ(calculator = "Regular")
# data transformations
log_transform_eco_metrics = T
zscore_flow_metrics = T

```


```{r select_eco_metric_3, echo = F, warning =F, comment = F}

# predict_eco = "juvenile abundance, hydro and spawners" #"juveniles per spawner" # "juveniles per spawner"
# predict_eco = "juveniles per spawner"
# predict_eco = "juvenile abundance, hydro only"

predict_eco = "final eco prediction selection"
  # Based on the need for a normalized metric, going to select the juvenile per adult metric.

# Hydro-only predictors
# Hydro-only predictors
if(predict_eco == "juveniles per spawner"){
  y_val_chinook = "chinook_juvenile_abundance"
  y_val_coho = "coho_smolt_per_fem"
}
if(predict_eco == "juveniles per spawner"){
  y_val_chinook = "chinook_juv_per_adult"
  y_val_coho = "coho_smolt_per_fem"
}
if(predict_eco == "juvenile abundance, hydro only"){
  y_val_chinook = "chinook_juvenile_abundance"
  y_val_coho = "coho_smolt_abun_est"
  }
# Number of spawners included as predictor
if(predict_eco == "juvenile abundance, hydro and spawners"){
  y_val_chinook = "chinook_juvenile_abundance"
  y_val_coho = "coho_smolt_abun_est"
  }


#table of ecological record identifiers
yvlt = y_val_label_tab()
spawner_z_records = c("coho_spawners_zscored", "chinook_spawners_zscored")

```

# Abstract {-}

In many rural areas of arid and semi-arid regions, balancing agricultural and environmental water needs is a key challenge facing resource managers. This is complicated by the tendency for the water needs of cultivated crops to be better understood than those of aquatic ecosystems. This work aims to quantify hydrologic conditions that support persistence of key ecosystem species using functional flows, not in the context of a prescribed flow regime, but in terms of identifying features of the hydrograph that are empirically correlated with specific ecological outcomes. We use the coho (*Oncorhynchus kisutch*) and Chinook (*Oncorhynchus tshawytscha*) salmon runs in Scott Valley, a 2,109 km^2^ undammed rural watershed in northern California, USA, as a case study.

Taking advantage of a nearly two-decade ecological monitoring dataset and long-term stream gauge measurements, we first examined hydrological-ecological correlations, then compared six different statistical modeling structures, using two techniques: LASSO and MARSS. In LASSO regressions, to balance the explanatory power of the models with the risk of overfitting, we used k-fold cross-validation to find the lowest-error value of the tuning parameter lambda. In MARSS we calculated models for each individual hydrologic metric and compared them using AICc values.

Correlation coefficients indicate that hydrologic factors and spawner abundance both exert influence on juvenile fish production. The hydrologic metrics with the highest coefficients are earlier river reconnection and greater fall flow magnitude during parents' spawning for coho, and lower wet season baseflow and slower spring recession rate for Chinook (though this could change with additional years of data, especially for the smaller coho dataset). The influence of some metrics, notably fall flow difference, was positive or negative depending on the fish life stage in which the flow occurred.

This approach for empirically identifying hydrologic metrics with high ecological importance for a threatened species may be useful in other watersheds, where sufficient ecological data are available, and could be used to evaluate trade-offs and support water management decisions in human-altered novel ecosystems.

<!-- * RTC doc notes for Reviewer 2 -->

\newpage

# Practitioner points {-}

1. Correlation coefficients indicate that production of juvenile outmigrant fish is not dominantly controlled by hydrologic factors or by spawner abundance but is influenced by both.
2. The most important hydrologic metrics were earlier river reconnection/preferred habitat access during parents' spawning, and larger fall flow magnitude, for coho; and lower wet season median baseflow and slower maximum spring recession rate for Chinook. 
3. This supports an interpretation that conditions during coho parents' spawning (potentially, more fall flow and earlier tributary reconnection providing more habitat or time to find a better nesting site) or as Chinook eggs (potentially, higher average winter flowrates causing egg burial or increasing energetic costs of foraging) and Chinook outmigrating smolt (potentially, slower spring recession producing more favorable outmigration conditions) may exert a significant influence on the mortality rates of the hatching juveniles in this study area.


\newpage

# Introduction


## Motivation and objectives 

Reconciliation ecology posits that some human-impacted ecosystems should be considered irrevocably-altered, "novel" systems [@MoyleNOVEL2014], with their own specific management concerns. To implement this philosophy, rather than working to restore novel ecosystems to pre-human conditions, a natural resource manager would actively manage biodiversity in human-altered landscapes as a co-equal goal with extracting and cultivating natural resources to provide for human material needs [e.g., @RobertsonSwintonReconciling2005; @ArthingtonEtAlTEMPORARY2014; @AcremanEtAlEnvironmental2014; @YarnellEtAlFunctional2015]. Ideally management would be based on an empirical or mechanistic understanding of two key linkages: firstly, how management actions affect availability and quality of water, and secondly, how those hydrologic changes affect human beneficial uses and ecological receptors [@RosenfeldDeveloping2017]. 

A large body of research has focused on general methods for quantifying connections between water management, flow, and ecological responses, as discussed below; however, in practice, such natural resource management is often local [@TarlockLocal1993]. Accordingly, the authors of this study have posed research questions tailored to conserving two specific salmon species, the threatened coho salmon (*Oncorhynchus kisutch*) and the less-threatened Chinook salmon (*Onchorhynchus tshawytscha*), in a specific study area: the Scott River watershed in northern California, USA. In this undammed, rural watershed, water use is primarily managed by managing land use. Balancing the competing water needs of fish and farmers is a key challenge for local water managers [@SiskiyouCountyScott2021]. Agricultural water needs are well-known and can be estimated and scheduled [@SiskiyouResourceConservationDistrictScott1994; @ParryEvaluation2013; CDFW -@CaliforniaDepartmentofWaterResourcesAgricultural2021], but, in spite of decades of investigation by local, state and federal actors [e.g., SRWC and Siskiyou RCD -@ScottRiverWatershedCouncilSiskiyouResourceConservationDistrictScott2003; NMFS -@NationalMarineFisheriesServiceFinal2014; CDFW et al. -@CaliforniaDepartmentofFishandWildlifeEtAlCooperative2015; CDFW -@CaliforniaDepartmentofFishandWildlifeScott2021], the ecological water needs in this balancing act are not as well constrained. 

One method for estimating ecological water needs, developed for the Mediterranean climate and hydrologic landscape of California,is the functional flows approach [@Escobar-AriasPasternackHydrogeomorphic2010; @YarnellEtAlFunctional2015; @GranthamEtAlMaking2020; @YarnellEtAlFunctional2020; @SteinEtAlCalifornia2021]. Functional flow metrics are used to quantify potential ecological services provided by river flow in terms of flowrate magnitude, timing, frequency, and duration in distinct seasons of a water year, where water year is here defined to begin on October 1 of the year preceding the calendar year of the same number (i.e., water year 2020 begins on October 1, 2019). These metrics can be calculated for any location with daily river data using signal-processing algorithms [@PattersonEtAlHydrologic2020; @CarpenterAccurately2024]. While much environmental flows work has been dedicated to "top down" approaches [@TharmeGlobal2003] that characterize a natural or altered flow regime in its entirety [e.g., @YarnellEtAlFunctional2020; @SteinEtAlCalifornia2021], in this study we use a functional flows approach to quantify meaningful flow components and assess which aspects of the natural flow regime are more influential in different life stages of two different species. In addition to functional flows, we define two other useful hydrologic metrics.

Using this framework, we here address the second ("flow-to-ecology") linkage referenced above: we assess the potential to empirically identify and prioritize hydrologic features that support the ecological needs of specific species (coho and Chinook salmon) in a specific ecological region (the Scott River watershed). We focus on the questions: while we expect both biotic (e.g., number of spawners) and abiotic (e.g., hydrological) factors to influence fishery success [@WardEtAlLeveraging2024], which hydrologic metrics are more correlated with specific ecological outcomes, and thus amenable to this predictive exercise? Is the predictive power of hydrology different for two different species? Can we identify and prioritize important hydrologic metrics that could then be used by managers for evaluating the effects of different management actions on this aquatic ecosystem? 


## Utility of modeling ecological responses to flow

Juvenile outmigrant production is one of the most obvious indicators of the health of an anadromous fishery [@JagerRoseDesigning2003], but is predicting outmigrant production (or any ecological response) using flow alone a worthwhile exercise, given the many interacting non-hydrologic factors (channel geomorphology, water quality, food resources, internal population dynamics) influencing a fishery [@McMahonHabitat1983; @BradfordEtAlEmpirical1997; @Escobar-AriasPasternackHydrogeomorphic2010; @WillisEtAlInstream2016]?

For some applications, it is not. Flow observations alone cannot represent site-specific hydraulics, which dictate the physical conditions for aquatic life; indeed, in different geomorphology, the same flow can produce very different hydraulic environments (Turner and Stewardson 2014). Flow observations also fail to capture other critical ecological drivers such as water quality, habitat quality, or food resources [e.g., @WillisEtAlInstream2016]. Thus it is often fruitless to attempt to predict numerical fish recruitment based solely on hydrologic data; more complex approaches such as combining hydraulics with bioenergetic models [@Bellido-LeivaEtAlModeling2021], fish population and mortality [@JagerRoseDesigning2003] or considering flow and water temperature [@NislowArmstrongLifehistorybased2012] may produce better recruitment forecasts.

Nevertheless, in the absence of data such as site-specific flow-hydraulic relationships and dynamic population models, hydrologic-only approaches may be suitable for some types of natural resource planning (assuming the objective is more abstract than predicting numerical fish recruitment) [@NislowArmstrongLifehistorybased2012; @TurnerStewardsonHydrologic2014]. Furthermore, they may enhance efforts to balance environmental and resource-extraction objectives [@JagerSmithSustainable2008] while being  based on relatively cheap and abundant hydrologic data. Among hydrologic-only methods, "top-down" approaches aim to support the flow needs of the entire ecosystem, often based on alteration of calculated hydrologic metrics from a pre-development flow regime [e.g., @PoffEtAlEcological2010; @ArthingtonEnvironmental2012; @YarnellEtAlFunctional2020], while "bottom-up" approaches aim to identify the individual flow features most critical to supporting a given objective [@TharmeGlobal2003]. This study falls into the latter category.

<!-- **You already have a sentence near the end of section 1.1 that mentions top-down. Why not just explain the distinction there? I feel a bit like you're repeating yourself here, although I get there's more context here.**  -->
## Previous findings on California salmon flow requirements

Even within the geographic context of California, specific flows identified as being important to salmonids have varied by the study region, objective, and species under consideration. They include, in Central Valley rivers, winter minimum flows [@JagerRoseDesigning2003]; early summer pulse flows and late winter overbank pulse flows [@JagerThinking2014]; but also an indication that juvenile survival was highest in an intermediate flow range in the Sacramento River [@MichelEtAlNonlinear2021]. In one adaptive management retrospective, two individual dam release pulse events improved habitat conditions for rearing juveniles during a critically dry year [@SellheimEtAlInformed2020]. Optimal flow regimes are also different for different species-specific environmental objectives, and vary based on water year type (provide high spring flows in wet years) [@JagerRoseDesigning2003]. Conversely, in at least one study, flow differences had little effect on migration timing or growth of South Fork Eel River steelhead [@KelsonCarlsonPrecipitation2019]. 

Such variability reflects the diversity of habitat and ecological effects across different geomorphic and hydroclimate contexts. This study aims to contribute to this body of work by proposing a method for identifying empirical relationships between flows and species focusing on the scale of a single watershed at which several other types of management choices are made.


## History of flow-ecology relationships

A river's flow regime is often referred to as a "master variable" controlling geomorphic, chemical, and other conditions in its aquatic ecosystems, and organisms that have evolved to persist in specific flow regimes are commonly negatively affected by flow alteration [@BunnArthingtonBasic2002; @PoffEtAlEcological2010]. Consequently, in recent decades a diverse body of research has sought to identify and quantify ecological responses to changes in flow. 

Bridging the gap between science and policy has been a persistent challenge and ongoing focus of work in this field. In many cases a key research motivation is to support decision-making in a variety of contexts, including dam operation, river restoration, and regulations of water extraction and land use [@RichterEtAlCollaborative2006; @HanEtAlEcohydrological2015; @SinnathambyEtAlEcohydrological2018; @BradleyEtAlHydroecological2017; @BrummerEtAlQuantitative2016]. But historical approaches based on relationship-finding are several steps removed from the policy-making process [@WebbEtAlAdaptive2018]. For example, the Indicators of Hydrologic Alteration [@RichterEtAlMethod1996; @RichterEtAlProtection2017] and Ecological Limits of Hydrologic Alteration (ELOHA) [@PoffEtAlEcological2010; @McManamayEtAlApplication2013] approaches generate flow standards for particular rivers, and are a top-down method for determining the flow needs of the whole ecosystem, but cannot translate specific management decisions into hydrologic outcomes, or predict specific ecological outcomes of the described alteration [@RichterEtAlCollaborative2006; @CartwrightEtAlPutting2017]. Additionally, identifying natural flow regimes may be less immediately relevant to water resource management than an approach which can quantify ecological responses to "designer" or functional flows (which can often be controlled or influenced by dam releases) [@ArthingtonEtAlTEMPORARY2014; @WebbEtAlAdaptive2018], with the caveat that the designer flows approach may risk overlooking ecological flow needs that are not currently monitored [@BowerEtAlQuantifying2022].

An ideal framework for supporting decision-making would involve two key steps, firstly connecting land and water management actions to flow changes ("management-to-flow"), and secondly connecting flow changes to ecological responses ("flow-to-ecology") [@PetersonFreemanIntegrating2016; @DeWeberPetersonComparing2020; @AceroTrianaEtAlAssessing2021]. Both steps can involve complex models and substantial uncertainty, often representing an interdisciplinary challenge. Threshold values for "sufficient" flows would be ideal for a management context [@RosenfeldDeveloping2017], but can be difficult to identify and in some cases may not exist [@LuedersMcManamaySpecies2023].  Finally, stakeholders in at least one study requested flow-ecology relationships based on empirical monitoring, rather than more easily-simulated proxies like flow changes or thermal exposure [@DeWeberPetersonComparing2020].

The present study is a longitudinal "bottom-up" analysis, using empirical data and a case study, to identify characteristics of flow most critical to support two specific species, and thus address the "flow-to-ecology" linkage described above. We use empirical data to develop multiple predictive models of a biological response to measurable (and simulatable) changes in flow metrics. A forthcoming companion study will investigate the "management-to-flow" link, simulating flow changes from watershed management actions using an appropriate hydrologic model, as a basis for studying unavoidable water management tradeoffs within the watershed.


# Methods: Case study setting and species of concern

Exploring the empirical relationship between river hydrology and an ecological response requires both spatial and temporal overlap in a study area's hydrologic and ecological monitoring data. 

These requirements are met to some degree in Scott Valley, though as is typical, ecological data is the limiting factor. Hydrologic data is provided by daily river flow monitoring, which has been ongoing since the 1940s at the USGS stream gauge downstream of the town of Fort Jones (Station ID #11519500, or the Fort Jones Gauge or FJ Gauge; Figure \@ref(fig:ScottWatershedMap)). The flow at this gauge is correlated with flow in tributary streams [@FogliaEtAlScott2013], and though a single monitoring location may not be able represent flow status in the full stream system at all times, it has been used in recent water planning documents as an indicator of overall hydrologic conditions [Siskiyou County -@SiskiyouCountyScott2021]. Because most water use in Scott Valley occurs upgradient of this gauge, its measurements are used to inform water management decisions in the populated areas of the valley (see *Supplement* for more detail on Scott Valley management history, historical flow-ecology work, geography and climate).


```{r ScottWatershedMap, echo = F, message = F, warning =F, fig.height = 8.5, fig.cap = "The Scott River watershed, with regional geographic context (see inset) and local features, including the Scott River Fish Counting Facility (FCF) and Scott River Rotary Screw Trap (RST).\\label{fig:ScottWatershedMap}"}

if(replace_setting_fig == TRUE){save_setting_figure()}

if(save_imgs==T){
  file.copy(from = file.path(graphics_dir, "Graphics source","scott valley setting.png"),
            to = file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

if(include_figs==T){
  knitr::include_graphics(file.path(save_figs_here, paste0("Figure ",fig_i,".png")))
}

fig_i = fig_i +1

```



## Species of concern: coho and Chinook salmon

This study intends to identify key hydrologic characteristics that correlate with reproductive success of two species, coho and Chinook salmon. To this end, we used long records of hydrologic and ecological data (more than eight and two decades, respectively) collected in the Scott River watershed. Although both species utilize fall flows (including fall pulses, when they occur) to migrate from the ocean to natal spawning streams, the life history strategies of these two salmonids are distinct in several ways, and consequently their outcomes are expected to be correlated with different functional flows (see Supplement for detailed life history information). 
Chinook and coho salmon are distinct in several ways relevant to this study and to management considerations:

* The vast majority of Scott River coho salmon outmigrate at 1+ years and return to spawn at 2+ years of age, producing a distinct cohort every 3 years [@KnechtleGiudice20192020], while the amount of time spent by Chinook in the ocean is more variable and more dependent on ocean conditions, and distinct cohort structure is not observed [@GrootMargolisLife1991; @BourretEtAlDiversity2016].
* Juvenile coho salmon are affected by 2 years of freshwater conditions, while juvenile Chinook are affected by only one year of freshwater conditions (Figure \@ref(fig:cohoLifeCycleFigure)) [@AgrawalEtAlPREDICTING2005; @KnechtleGiudice20192020]. This means Chinook avoid summer low flow conditions by migrating to the ocean, while coho often over-summer in freshwater habitats fed by springs or snowmelt, or supported by wetlands [@LusardiEtAlOversummer2020; @LusardiEtAlNot2021].
* In most years Chinook spawning migration takes place earlier (September-December) than coho (October-January).
* Due to multiple factors, including preferred gravel size and requirements for habitat during summer low-flow conditions, the majority of coho redds are found in (higher-gradient, snow-fed) Scott River tributaries, while Chinook redds are more commonly found in the mainstem Scott River [e.g., @MagranetYokelScott2017; @MagranetScott2017]. Several tributaries tend to disconnect from the mainstem Scott River. Additionally, due to historical mining activity, a key mainstem reach known as the "tailings" (Figure \@ref(fig:ScottWatershedMap)) often dewaters during average-to-dry years, restricting spawning access to some headwaters habitat [@ScottRiverWatershedCouncilRestoring2018].
* Declining populations of coho salmon have been noted in the Klamath basin and more broadly in coastal California streams since the 1990s [e.g., @BrownEtAlHistorical1994], while regional Chinook populations have historically been more robust [@WainwrightEtAlCCIEA2013]. However, a declining trend was observed in the Klamath run of Chinook in the 2010s, and this trend was more significant in the Scott River system than the broader Klamath basin [@KnechtleGiudice20222023]. These trends have prompted additional monitoring of Scott Valley Chinook in the past decade [e.g., spawning surveys such as @MagranetScott2015; @MagranetScott2017] (Table \@ref(tab:ecoMetricsMonitoringTab)). 

```{r cohoLifeCycleFigure, echo = F, message = F, warning =F, out.height= "8.5in", fig.cap = "Seasons (as defined in the California Environmental Flows Framework; Yarnell et al. 2020) and life stages experienced by a coho and a Chinook salmon cohort in the Scott River watershed. Season identifiers listed here are used throughout the document."}

if(save_imgs==T){
  file.copy(from = file.path(graphics_dir, "Graphics source", 
                                  "Salmon life cycle and seasons graphic.jpg"),
            to = file.path(graphics_dir, file.path(save_figs_here, paste0("Figure ",fig_i,".jpg"))))
}
if(include_figs==T){
knitr::include_graphics(file.path(graphics_dir, paste0("Figure ",fig_i,".jpg")))
}

fig_i = fig_i+1
```

# Methods: Quantitative analysis

We used functional flow metrics to describe the history of the Scott River as observed over eight decades at the Fort Jones gauge. Then, we used correlation coefficients to explore relatedness between Z-scored hydrologic metrics and log-transformed ecological records (*Supplemental Figure A*). We then conducted twelve total statistical modeling exercises: two modeling techniques, LASSO [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] and MARSS [@SeeHolmesReducing2015], to predict three different predictor-response pairs for each species (Table \@ref(tab:statsMethodsTable)).  


## Step 1. Calculate predictors and screen for collinearity: Flow metrics to describe Scott River flow regime

To calculate a set of hydrologic predictor metrics for the Scott River, we used functional flows algorithms tuned for "flashy" (or flow regimes with rapid changes in flows common to rain-driven or altered systems) river systems (Figure \@ref(fig:fig2Yarnell2020)) [@YarnellEtAlFunctional2020; @PattersonEtAlHydrologic2020; @CarpenterAccurately2024]. These functional flows were calculated from the daily flow record at the Fort Jones river gauge from 1942-2023 using the general approach of Patterson et al. [-@PattersonEtAlHydrologic2020], updated to better reflect the characteristics of ephemeral streams [@CarpenterAccurately2024]. The full suite of 30 annual metrics is calculated on a water-year basis (i.e., each type of metric produces one value for each water year; Tables \@ref(tab:funcFlowsAnnualValuesTab1) through \@ref(tab:funcFlowsAnnualValuesTab6)). Descriptions, abbreviations, relevant time periods (including salmon life stage alignment; see Section 3.3), and metric calculation details are listed in Table \@ref(tab:funcFlowTermsTab); additional information is available in @PattersonEtAlHydrologic2020 and supporting documentation.

All functional flow metrics have some known ecological function or interpretation, e.g., total annual flow is used to evaluate water year type. Phenomena measured with fall metrics, such as magnitude of the fall pulse [defined as at least two times the dry season baseflow; @PattersonEtAlHydrologic2020]) and fall pulse timing, provide olfactory migration signals and spawning access to anadromous fish; however, a sufficiently large fall pulse does not occur in every water year, so a magnitude-agnostic fall pulse difference metric was included that can be calculated annually [after @BaruchEtAlMimicking2024]. Wet season metrics, such as wet season onset timing and median flow magnitude, can be used to gauge conditions during egg incubation or the overwintering period for juvenile coho salmon. Spring metrics, such as spring flow recession magnitude and rate of change, occur during the transition from wet to dry season, and indicate conditions during early juvenile salmon rearing as well as the flow available for outmigration from Scott Valley to the ocean. Finally, metrics like the duration and median flow of the dry season indicate the timing and severity of low-flow conditions in which spatial habitat is constrained and connectivity between reaches may be limited, and which set conditions preceding fall spawning runs. 

Secondly, two additional metrics were devised for this study area related to timing of anadromous fish access to preferred spawning habitat in this specific watershed (illustrated in Figure \@ref(fig:reconnectExplainerHydrograph)). These metrics are referred to as "reconnection" and "disconnection" dates, and are defined further in the following section and in the Supplement (Table \@ref(tab:customHydroMetricsTab)). 


### Selecting flow thresholds for dis- and re-connection timing

In average-to-dry water years, after portions of the Scott River and tributaries run dry (Figure \@ref(fig:ScottWatershedMap)), the timing of end-of-dry-season fall river reconnection determines when salmon can access mainstem and tributary spawning habitat and thus whether salmon passage exists during the preferred migration time window [@ScottRiverWatershedCouncilRestoring2018]. Conversely, at the end of the wet season, the timing of river disconnection in the spring and summer can influence conditions for outmigrating smolt.

To calculate the timing of river connectivity, three discrete thresholds were selected from the continuum of flows to represent a partially and a fully connected stream system. The thresholds correspond to two distinct events: first, 20 and 40 cfs (0.57 to 1.1 cms), corresponding to the low and high estimates of what constitutes connectivity within mainstem Scott River [@SiskiyouCountyScott2021]; and second, 120 cfs (3.4 cms), representing connectivity of the full stream network, allowing access to most tributary habitat. These values are calculated as number of days after Aug. 31 of the preceding water year, to account for rare September storms; if connectivity is never lost, the reconnection or disconnection date is assumed to be the first or last day of the modified water year, respectively. These metrics are similar to several California-specific functional flows, namely, the timing and slope of spring recess and the timing of a fall pulse flow (Table \@ref(tab:customHydroMetricsTab)), but differ in the simplicity of their calculation and their direct relevance to salmon access to two distinct Scott River habitat zones. 

Because these flows are measured at the Fort Jones gauge, they are a proxy for conditions in the full stream network; however, hydrograph and precipitation analyses suggest that 120 cfs at the Fort Jones gauge is a good indicator of mostly-full soil and aquifer storage, or a "spilling" watershed condition that maintains a connected stream network [@KoubaHarterSeasonal2024].


### Screen predictors for collinearity

Because many metrics are influenced by the same phenomena taking place in wet and dry years, significant collinearity was present in the hydrologic metrics used in this predictive exercise. To account for this, collinear predictors, defined as predictors correlated with each other [a Spearman's *R* greater than 0.7 or less than -0.7; @DormannEtAlCollinearity2013], were grouped, and one predictor was selected to represent each group. In Supplemental text and Table \@ref(tab:predCorrScreeningTable), we describe each group and the ultimate selected predictors in conceptual terms. In this screening we aimed to retain metrics occurring in each of the eight seasons influencing coho rearing in freshwater (and for Chinook, four seasons) (Figure \@ref(fig:cohoLifeCycleFigure)).

## Step 2. Assemble responses: Ecological monitoring data

Seven total observed quantities (three for Chinook; four for coho) were evaluated as candidates to represent the ecological response (dependent variable) in the flow-ecology relationship. 
These records were pulled from public monitoring reports published by the California Department of Fish and Wildlife (CDFW). 

Factors influencing the population size of anadromous fish include ocean conditions and freshwater conditions. This study focused on the conditions in their natal streams. Hence, we focus on fish population metrics that are influenced by the freshwater system. The ecological observations considered for use in the final flow-ecology relationship are:

1. Number of adults migrating from the ocean to freshwater natal streams to spawn. This quantity, the 'escapement', is measured at the Scott River Fish Counting Facility, using a resistance board weir and video counting flume in the Scott River [e.g., @KnechtleGiudice20222023] (Figure \@ref(fig:ScottWatershedMap)). 
2. Number of juvenile yearling, or smolt, salmon. Smolt are counted as outmigrants, at the Scott River Rotary Screw Trap facility (Figure \@ref(fig:ScottWatershedMap)) [e.g., @MassieMorrow20202021; @RomeroRobinson20232024] .
3. Number of salmon gravel nests, or redds, observed during spawning window [e.g., @MagranetScott2015] (for coho only).

Two combined metrics historically calculated and reported by regional agencies [@KnechtleGiudice20222023] were also considered. These metrics use data from multiple years to capture multiple life stages for a given cohort:

4. The number of outmigrating coho smolt produced per spawning female (coho spf) and the outmigrating Chinook juveniles per spawner (Chinook jpa).

These time series of observations are the result of decades of investment in local ecological monitoring. Monitoring activity in the past 20 years has included population estimates from a video counting flume and a rotary screw trap operated by CDFW [CDFW -@CaliforniaDepartmentofFishandWildlifeRecovery2015; @MassieMorrow20202021; @KnechtleGiudice20222023], and spawning surveys for Chinook [@MagranetScott2015a; @MagranetScott2017; @MagranetScott2018] and coho [@MaurerScott2003; Siskiyou RCD -@SiskiyouResourceConservationDistrictFinal2004; @QuigleyScott2005; @QuigleyFinal2006; @QuigleyFinal2007; @SiskiyouResourceConservationDistrictScott2010; @YokelScott2011; @FranklinScott2012; @YokelScott2013; @YokelScott2014; @MagranetScott2015; @MagranetYokelScott2017]. 


## Step 3. Align predictor and response metrics with timing of species cohorts

The empirical basis for this predictive modeling exercise is a table of hydrologic metrics (one per water year) and ecological observations influenced by this hydrology (Tables \@ref(tab:hydroAndEcoTab1) through \@ref(tab:hydroAndEcoTab12)). However, the row-by-row basis for the table must account for the life history of the two species under consideration.

A cohort of coho salmon will experience conditions during multiple water years while residing in their spawning habitat, and flow impacts are specific to life-stage. Vice versa, a specific hydrologic event will have a different effect on fish experiencing it as a hatchling fry than on those experiencing it as 1+ year old parr [@NislowArmstrongLifehistorybased2012]. Here we define the alignment (i.e., mapping) of a specific generation of fish (ecological outcome) with observed hydrologic metrics (predictors) via their specific life stage (Tables \@ref(tab:hydroAndEcoTab1) through \@ref(tab:hydroAndEcoTab12)).

### Data alignment - coho

The relevant unit of time for identifying the impacts of Scott River freshwater hydrology on a coho salmon cohort is defined as a ~2 year period spanning eight seasons, starting in the dry season preceding the parents' spawning, and ending in the spring of smolt outmigration (Figure \@ref(fig:cohoLifeCycleFigure)). The coho life cycle is largely regular in Scott Valley, with 3 defined cohorts in which the vast majority of individuals return to natal streams at 3 years of age [e.g., CDFW -@CaliforniaDepartmentofFishandWildlifeScott2021]. 

Following standard practice for functional flows [@PattersonEtAlHydrologic2020], each functional flow and hydrologic metric were labeled with the season in which it occurred. Additionally, each hydrologic metric was assigned to the brood year of each affected cohort of coho salmon, according to the year (first or second) in which the cohort experienced it. Specifically, the eight seasons are designated as the first and second dry, fall, wet and spring seasons (abbreviated d1, f1, w1, s1, d2, f2, w2, and s2; Figure \@ref(fig:cohoLifeCycleFigure)). In some rare cases, flow metrics may fall outside their designated subperiods (e.g., the extreme dry water year of 2014, in which the "fall reconnection" of flows in brood year 2013 did not occur until February of the following calendar year). Nonetheless, for consistency, even a January or February reconnection date will be referred to by the previous fall year designation. 

### Data alignment - Chinook

Because spawning occurs in the fall for both coho and Chinook salmon in the Scott River watershed [@CaliforniaDepartmentofFishandWildlifeScott2021], Chinook ecological data was aligned with hydrologic metrics in the same manner as coho observations. Distinct life histories produced one significant difference: because Chinook migrate to the ocean in their first year of life, the duration of freshwater residence for each Chinook cohort is shorter than for coho, ranging from fall spawning to the subsequent spring or summer. Thus, only metrics from the first year (d1, f1, w1, and s1) were considered for the Chinook model (Figure \@ref(fig:cohoLifeCycleFigure)). 




```{r smolt_year_metrics_master_tab, echo = F, warning =F}

# retrieve hydrology tabulated by STP
brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1999:2022,
                                                             smolt_years = 2001:2024)
# brood_year_hydro_tab = tabulate_hydro_by_affected_brood_year(brood_years = 1978:2022,
#                                                              smolt_years = 1980:2024)

# thresh_for_corr_fig = c(8, 10, 15, 20, 40, 
#                         70, 100, 150, 200, 300, 
#                         400, 500, 750, 1000)
thresh_for_corr_fig = c(20,40,120)

metrics_tab = calc_metrics_hydro_by_affected_brood_year(
  hydro_by_brood_year = brood_year_hydro_tab,
  thresholds = thresh_for_corr_fig) 

# Clean metrics tab:
# 1) factorize water year category
metrics_tab$wy1_WY_Cat = as.numeric(factor(metrics_tab$wy1_WY_Cat,
                                   levels = c("dry year", "mod year", "wet year")))
metrics_tab$wy2_WY_Cat = as.numeric(factor(metrics_tab$wy2_WY_Cat,
                                   levels = c("dry year", "mod year", "wet year")))
# 2) remove outlier FA_Diff?

write.csv(x = metrics_tab, quote = F, row.names = F,
  file = file.path(graphics_dir,
                   "Supplemental Table B. Flow Metrics by Brood Year.csv"))
metrics_tab_untransformed = metrics_tab

# calculate number of predictors for text below

non_preds = c("brood_year", "smolt_year", yvlt$y_val)
num_predictors = length(colnames(metrics_tab))- length(non_preds)
preds_all = colnames(metrics_tab[,!colnames(metrics_tab) %in% non_preds])

```



```{r metrics_tab_diagnostics, echo = F, warning =F}

# log_transform_flow_metrics = F

if(zscore_flow_metrics == T){
  zscore_these = !(colnames(metrics_tab) %in% non_preds)
  metrics_mean = apply(X = metrics_tab[,zscore_these], MARGIN = 2, FUN = mean, na.rm=T)
  metrics_sd = apply(X = metrics_tab[,zscore_these], MARGIN = 2, FUN = sd, na.rm=T)
  metrics_tab[,zscore_these] = apply(X = metrics_tab[,zscore_these],
                                     MARGIN = 2, FUN = zscore_column_na_rm)
  
  metrics_tab$coho_spawners_zscored = 
    zscore_column_na_rm(x = metrics_tab$coho_spawner_abundance)
  metrics_tab$chinook_spawners_zscored = 
    zscore_column_na_rm(x = metrics_tab$chinook_spawner_abundance)
  non_preds = c(non_preds, "coho_spawners_zscored", "chinook_spawners_zscored")

}

if(log_transform_eco_metrics == T){
  metrics_tab[,yvlt$y_val] = log10(metrics_tab[,yvlt$y_val])
}

# zscore_column_na_rm = function(x){
#   mean_x = mean(x, na.rm=T)
#   sd_x = sd(x, na.rm=T)
#   return((x - mean_x) / sd_x)
# }


# if(log_transform_flow_metrics == T){
#   log_these = !(colnames(metrics_tab) %in% non_preds)
#   metrics_tab[,log_these] = log10(metrics_tab[,log_these])
# }

```

## Step 4. Transform data, calculate correlation coefficients, rule out temporally impossible relationships

After aligning the hydrologic predictors and ecological responses, we standardized (converted to Z-scores) all hydrologic metrics to facilitate comparisons of modeled coefficients. Because the ecological observations typically covered multiple orders of magnitude, we transformed ($log_{10}$) the ecological responses for the predictive exercise. We then calculated Pearson correlation coefficients [@PearsonNote1895] $R$ between the Z-score for each predictor and each log-transformed response. A significant number of potential predictor-response pairs do not represent a temporally plausible relationship: e.g., the wet season values in water year 2011 would not influence the number of spawners that arrived the previous season, in fall of 2010. These implausible pairs were excluded from the resulting $R$ matrix. Additionally, to assess the relative importance of biotic (i.e., spawner abundance) and abiotic (hydrologic) factors on ecological outcomes, we included spawner abundance Z-scores as "predictors" in the final $R$ matrix.

## Step 5. Generate predictive models 

We conducted twelve total statistical modeling exercises: two modeling techniques, LASSO [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] and MARSS [@SeeHolmesReducing2015], to predict three different predictor/response pairs (hydrology/juvenile-to-spawner ratio, hydrology/juvenile abundance, and hydrology plus spawner abundance/juvenile abundance) for each species (coho and Chinook salmon) (Table \@ref(tab:statsMethodsTable)). 

```{r statsMethodsTable, echo = F, warning =F, results = 'asis'}

stats_tab = data.frame(ID = LETTERS[1:6],
                       Predicts = c("juveniles per adult", "juveniles per adult",
                                    rep("juvenile abundance",4)),
                       Method = c(rep(c("LASSO", "MARSS"), 3)),
                       Predictors = c(rep("hydrologic metrics",4),
                                      rep("hydrologic metrics and spawner abundance", 2)))

caption_text = paste0("Description of the six techniques considered in this study for modeling ecological outcomes using hydrologic metrics (and in some cases, spawner abundance).")

st_ft = flextable(data=stats_tab)
st_ft = set_caption(st_ft, caption = caption_text)
st_ft = flextable::width(st_ft,j=1,  width = .5)
st_ft = flextable::width(st_ft,j=2,  width = 2)
st_ft = flextable::width(st_ft,j=4,  width = 2)
st_ft = flextable::set_header_labels(st_ft,
                                           values = list(
                                             Predicts ="Predicts (log-transformed obs.)",
                                             Method = "Method",
                                             Predictors = "Predictors (Z-scored)"))
st_ft

```



### Comparison of two statistical methods

To assess robustness of the predictive modeling results, we employed two statistical techniques: LASSO and MARSS.

LASSO (Least Absolute Shrinkage and Selection Operator) regression [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018] is similar to multiple linear regression in that its output is a linear combination of coefficients multiplied by observed values of a set of predictors. However, LASSO regression also includes a lambda ($\lambda$) "tuning" parameter, that penalizes model complexity. This is valuable in high-dimensional data settings, where overfitting is likely because the number of possible predictors (here, hydrologic metrics) approaches or exceeds the number of observations being predicted (here, ecological records) [@ReinekingSchroderConstrain2006]. Additionally, because it sets some coefficient values to 0, it can be used to identify the most important predictors, or the predictors that explain the most variation in the response (i.e., perform predictor selection) [@JamesEtAlIntroduction2013; @RanstamCookLASSO2018]. 

For purposes of the present study, a disadvantage of the LASSO approach is that, like multiple linear regression, it assumes each observation in a record is independent [@JamesEtAlIntroduction2013] and thus is not a time series modeling approach. When working with ecological time series, this assumption of independence is often invalid, because a previous state of an ecosystem (i.e., the number of spawners in a salmonid cohort 3 years ago) has a direct influence on its present state; in other words, autocorrelation at some time lag is often present. 

Conversely, MARSS (Multiple Autoregression State Space) [@SeeHolmesReducing2015] was designed for working with autocorrelated ecological time series data. It can be used to generate predictive models based only on the observed quantity itself (i.e., an ecological record), or the observed quantity as well as covariate data (i.e., hydrologic metrics) [@SeeHolmesReducing2015]. However, it lacks the advantages of predictor selection and an overfitting penalty.

### Prediction units and model structure

Though seven types of ecological data were available as prediction targets (see Section 3.2), we focused on predicting either absolute or relative abundance of outmigrating juveniles, because outmigrant abundance is directly related to the persistence of a fishery, and it represents the integrated output of the freshwater-dwelling period of life. Many biotic factors also influence juvenile abundance, and it is beyond the scope of this paper to account for all of them; however, spawner abundance, representing the "input" to the freshwater-dwelling period, would intuitively have a high degree of influence on juvenile abundance, and is a readily available biotic record. 

Consequently, we chose to include spawner abundance as a factor in this predictive exercise for comparative purposes. We tested two ways of structuring our analysis: spawners were included either as the denominator of a juveniles-to-spawner ratio, or as a separate (Z-score) predictor treated similar to hydrologic metrics (Table \@ref(tab:statsMethodsTable)). We made separate models for each species, rather than combining coho and Chinook observations, because of their distinctly different exposure to hydrologic events.

### LASSO regression

We used the R programming environment [@TheRFoundationProject2025] and the linear modeling package `glmnet` [@FriedmanEtAlRegularization2010] to calculate and cross-validate two LASSO models for each species (Table \@ref(tab:statsMethodsTable)). We used k-fold cross validation to calculate test error based on different penalty values and determine the value of $\lambda$ that minimized test error. In the case of model structures A and C for coho, we selected an alternative lambda value that produced an error nearly identical to the minimum error but which explained a higher percent of deviance. 

### MARSS method

We used the R programming environment [@TheRFoundationProject2025] and the autoregressive modeling package `MARSS` [@SeeHolmesReducing2015] to calculate three types of MARSS models models for each species (Table \@ref(tab:statsMethodsTable)). In structures B and D, we calculated for juveniles-to-spawner and juvenile abundance, respectively, a single-covariate model based on each relevant hydrologic metric. In structure F, we calculated a set of two-covariate models of juvenile abundance, where the two covariates were a single hydrologic metric and (Z-scored) spawner abundance. In contrast to the output from LASSO, prediction using an autoregressive model is more complex in that it can be used to make predictions based on all observations, or on all observations up to the point of prediction [@SeeHolmesReducing2015]. 

# Results

## History of the Scott River, described in functional flow metrics

Diagnostic metrics of Scott River flow have demonstrated clear trends over the past 8 decades. Between 1942 and 2021, total annual flow measured at the Fort Jones gauge has dropped from an average of approximately 600 to 400 thousand acre-feet (TAF, or from >800 to <600 million m^3^) (Figure \@ref(fig:funcFlowTimeseries), panel A). Annual flows have always shown large variability, ranging across an order of magnitude, from 67 TAF (in water year 1977) to 1,336 TAF (in water year 1974). More recently, the frequency of years with low annual flows (200 TAF or less) has significantly increased: 3 such years over the first four decades of the gauge record, but 10 such years over the second four decades. In contrast, very high annual flows of over 600 TAF were exceeded in at least five years for each two-decade period between 1941 and 2000, but only twice in the most recent two-decade record. 

Ecosystem functional flow metrics, calculated with signal-processing techniques [@PattersonEtAlHydrologic2020; @CarpenterAccurately2024] (illustrated in Supplemental Figure \@ref(fig:fig2Yarnell2020)), also show clear trends over time (Figure \@ref(fig:funcFlowTimeseries), panels B-H). The fall pulse onset date has trended slightly later (though a distinct fall pulse flow does not occur every year), and the magnitude of the fall pulse flows has decreased.  Years with a fall pulse flow magnitudes of less than 400 cfs have become more frequent, resulting in a visible downward trend in fall pulse magnitude over the period of record (Figure \@ref(fig:funcFlowTimeseries), panel B).

The onset of the wet season has trended slightly later, though wet season median baseflows have remained stable on average (with a very slight downward trend). Wet season baseflow rates vary from less than 50 cfs (1977) to over 2000 cfs (1997) with typical winter flow ranging from 400 to 1000 cfs (Figure \@ref(fig:funcFlowTimeseries), panel E).

After April, the chance of large precipitation events becomes minimal leading to a gradual, near-exponential decline of streamflow rates during May through July as the snowpack in the upper watershed melts off. While a very consistent feature in the annual hydrograph (e.g., Supplemental Figure \@ref(fig:reconnectExplainerHydrograph)), the rate of flow reduction (i.e., the rate of exponential decline) during the spring has increased over the period of record. The spring recession curve has grown steeper and accelerated the annual recession process: the rate of decline was just above 0.05%/day in 1940, and it was nearly 0.07%/day in 2020 (Figure \@ref(fig:funcFlowTimeseries), panel F).

The median dry season flow has dropped by approximately 50%, with many years since 1977 seeing flows below 30 cfs, a condition not seen prior to 1977 and largely related discontinuation of inefficient flood irrigation with surface water during the 1970s and the introduction of efficient sprinkler irrigation with groundwater allowing for an extended irrigation season [@TolleyEtAlSensitivity2019]. The onset of the dry season is earlier, and the duration of the dry season has increased, in some of the most recent years to over 200 days (Figure \@ref(fig:funcFlowTimeseries), panels G and H). 

The reconnection and disconnection dates also show significant trends over time. As a result, the wet season has notably narrowed over time with (approximate) fall onset trending later and the spring flow recession trending to begin earlier. In 2020, the expected reconnection at the 120 cfs threshold occurs more than a month later than in 1940, and the expected summer disconnection more than two weeks earlier (Figure \@ref(fig:reAndDisconTimeseries)).

In aggregate over the past 80 years, these metrics show an increasing prevalence of unfavorable hydrologic conditions for salmonids, in terms of the flows needed during critical life stages. The primary causes of this reduced ecological functionality are a changing climate (especially a reduced snowpack and earlier snowmelt) and long-term changes in local consumptive water use and use patterns [@DrakeEtAlAnalysis2000; @VanKirkNamanRelative2008; @FogliaEtAlScott2013].


```{r funcFlowTimeseries, echo = F, warning =F, fig.height = 8.6, fig.cap = "Total annual flow volume (panel A) and functional flow metrics (panels B-H; Patterson et al. 2020), derived from daily average flow measurements at the Fort Jones USGS flow gauge (ID 11519500) for water years 1942-2023.\\label{fig:funcFlowTimeseries}"}

fflows_hist_obs = read_fflows_FJ(calculator = "Flashy")#read_fflows_csv(scen_id = "hist_obs")

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 9, units = "in", res = res_dpi)
  
func_flow_timeseries_fig(fj_flow = fj_flow, fflows = fflows_hist_obs)
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


```{r reAndDisconTimeseries, echo = F, warning =F, fig.height = 8, fig.cap = "Disconnection and reconnection dates for the 120 cfs (3.4 cms) flow threshold, water years 1942-2023. The disconnection date refers to the first day in the spring on which flow drops below the designated threshold (120 cfs); the reconnection date refers to the first date in the fall on which flow rises above the designated threshold. Trends over the past 80 years suggest that the summer river disconnection is trending earlier, and the fall river reconnection is trending later. \\label{fig:reAndDisconTimeseries}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 6, units = "in", res = res_dpi)
  
re_and_discon_timeseries_figure()
  
  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1



```


## Hydrology-ecology correlations


```{r suppEcoVSTimeFigs, echo = F, warning =F, fig.height = 8, fig.cap = "Explanatory plots of Chinook spawner abundance versus various hydro metrics and over time. \\label{fig:suppEcoVSTimeFigs}"}

# fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
# if(save_imgs == TRUE){
# png(filename = fig_path, width = 7, height = 6, units = "in", res = res_dpi)

resave_eco_hydro_scatter_plots = F

if(resave_eco_hydro_scatter_plots == T){
  for(id in yvlt$y_val){
    eco_vs_pred_figs(y_val_id = id)
    
    eco_vs_time_figs(y_val_id = id)
  }
  
}


# dev.off()

# }
# if(include_figs==T){knitr::include_graphics(fig_path)}
# fig_i = fig_i +1



```

```{r inter_corr_matrix_supp_fig, echo = F, warning =F, comment = F}

nthresh = length (thresh_for_corr_fig)
nthresh_gt_70 = sum(thresh_for_corr_fig >= 70)

# Calculate correlation matrix 
corr_tab_all_metrics = cor(metrics_tab, use = "pairwise.complete.obs",
                           method = "spearman")

# and remove values that don't make temporal sense 
# (i.e., the wet season values in water year 2011 would not influence the
# number of spawners that arrived in fall of 2010)

pred_season = substr(x = colnames(metrics_tab[,preds_all]), start = 1, stop = 2)
names(pred_season) = colnames(metrics_tab[,preds_all])
for(i in 1:nrow(yvlt)){
  # possible to do: figure out how the wy1 and wy2 metrics would map out here. 
  # for which eco responses do they get NA vals?
  pred = yvlt$y_val[i]
  season_set = unlist(strsplit(yvlt$influencing_seasons[i], split = ", "))
  keep_these = c(non_preds, names(pred_season)[pred_season %in% season_set])
  exclude_these = colnames(metrics_tab)[!(colnames(metrics_tab) %in% keep_these)]
  corr_tab_all_metrics[pred, exclude_these] = NA
}

# set up for plot
metrics_tab_column_colors = c(rep("black", 2),  # brood and smolt years
                              rep("darkgray",7), # fish outcome metrics
                              rep(fall_col,nthresh), # BY fall recon 
                              rep(spring_col,nthresh), # RY spring discon
                              rep(fall_col,nthresh),   # RY fall discon
                              rep(spring_col, nthresh_gt_70), #SY spring discon
                              # rep("darkorchid",3), # min. flow metrics
                              # rep("peachpuff3",4),    # total flow metrics
                              # rep("peachpuff4", 4),    # log total flow metrics
                              rep(c(
                                rep(dry_sn_col, 4),
                                rep(fall_col, 4),
                                rep(wet_sn_col, 16),
                                rep(spring_col, 5),
                                rep("peachpuff3",2)), 2),    # annual metrics
                              rep("peachpuff4",2)        # scouring flow days
)

if(save_imgs==T){
  pdf(file = file.path(graphics_dir, "Supplemental Figure A. Correlation Matrix.pdf"), width = 40, height = 40)
par(mar=c(5,4,6,2))
corrplot(corr_tab_all_metrics,
         tl.col = metrics_tab_column_colors, tl.cex = 1.1, 
         # col.lim = rev(c(-1.1,1.1)),
         # col.lim = c(-1, -0.7, -0.4, -0.1, 0.1, 0.4, 0.7, 2),
         col = c(rep("orangered3"), rep("lightpink",2),rep("mistyrose",2),
                 # rep("white",2), 
                 rep("lightcyan",2), 
                 rep("lightskyblue",2),rep("deepskyblue4")),
         na.label = "--", main = NA) 


}

```


```{r corrMatrixFigSetup, echo = F, warning =F, }

# identify which columns we should keep in our correlation analysis
ctl = collinear_screening_exercise(metrics_tab = metrics_tab,
                                              corr_tab_all_metrics = corr_tab_all_metrics,
                                   return_tab = "corr_tab_long_screened")

keepers_co = c(non_preds, as.character(unique(ctl$Var1)))
metrics_tab_screened = metrics_tab[,keepers_co]

# Addl screening for temporal relevance to Chinook freshwater period
metrics_before_chinook_outmigrate = 
  colnames(metrics_tab_screened) %in% non_preds |
  grepl(pattern = "d1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "f1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "w1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "s1", x = colnames(metrics_tab_screened)) | 
  grepl(pattern = "wy1", x = colnames(metrics_tab_screened)) 
keepers_ch = intersect(x = keepers_co, colnames(metrics_tab_screened)[metrics_before_chinook_outmigrate])

metrics_tab_screened_chinook = metrics_tab_screened[,keepers_ch]

# Run correlations for all metrics in coho table (which includes all metrics in chinook table)

  corr_matrix_pearson = calc_corr_matrix(metrics_tab = metrics_tab_screened, 
                                       preds_all = c(spawner_z_records, preds_all), 
                                       corr_method = "pearson", min_pairs = 10)
  # For results description, find features of max abs R value
  max_loc = which.max(abs(as.matrix(corr_matrix_pearson)))
  x_i = max_loc %% nrow(corr_matrix_pearson)
  y_i = ceiling(max_loc/nrow(corr_matrix_pearson))
  max_corr = round(corr_matrix_pearson[x_i, y_i],2)
  max_corr_x = rownames(corr_matrix_pearson)[x_i]
  max_corr_y = colnames(corr_matrix_pearson[y_i])
  
  gt_0.5 = sum(abs(corr_matrix_pearson) > 0.5, na.rm = T)
```

Seventeen hydrologic predictors remained after screening the initial set of 79 metrics for collinearity greater than $|R|>0.7$ (Table \@ref(tab:predCorrScreeningTable); Figure \@ref(fig:corrMatrixFig)). Notably, the screened set of metrics retained no metrics from the second dry season `d2`. This is because metrics in this season are highly collinear with metrics from the preceding and following seasons. This high degree of collinearity between `d2` metrics and those calculated from other seasons suggests that conditions during the dry season may be set during the surrounding rainfall and snowmelt events (assuming relatively consistent water use patterns year-to-year). This is exploited in recent work to predict Scott River dry season minimum flows about five months in advance [@KoubaHarterSeasonal2024].  

Correlations between Z-scored hydrologic and log-transformed ecologic metrics were not particularly strong (Figure \@ref(fig:corrMatrixFig); *Supplemental Figure A*); nonetheless, the relative relatedness of individual predictor-response pairs provide context for a predictive multivariable modeling exercise. The maximum absolute $R$ value was `r max_corr`, calculated between baseflow median of the first wet season (`r max_corr_x`) and Chinook smolt abundance, indicating that a higher wet season median flow is associated with lower Chinook smolt production. Only `r gt_0.5` absolute $R$ values were greater than 0.5. This is consistent with the understanding that hydrology is only one factor influencing salmonid reproductive outcomes. 

The correlation coefficients do not show uniform effects of hydrology on both species: for example, a high baseflow magnitude in the first wet season is negatively correlated with Chinook juveniles but has no or a slight positive correlation with coho juveniles (Figure \@ref(fig:corrMatrixFig)). Furthermore, hydrology tends to have different effects on different life stages: the magnitude of the fall flow increase (`FA_Dif_num`) and coho juvenile abundance are positively correlated when it occurs in the first fall (`f1`), during their parents spawning, but are negatively correlated when it occurs in the second fall (`f2`), when they are overwintering juveniles. 

Though it is outside the scope of this study to capture all biological influences on fish production, it would be remiss to overlook some of the obvious relationships between the ecological data series used in this study. A full set of $R$ values among ecological observations is shown in *Supplemental Figure A*, but only spawner abundances (Z-scored for consistency with hydrologic metrics) were highlighted as predictors in Figure \@ref(fig:corrMatrixFig). As we might expect, spawner abundance is positively correlated with smolt abundance (and observed redds, for coho). However, hydrology seems to have an equivalent or slightly higher influence on juvenile production as spawner abundance: for both species, the spawner-juvenile $|R|$ is lower than at least one hydrologic-juvenile $|R|$ value (Figure \@ref(fig:corrMatrixFig)).

```{r corrMatrixFig, echo = F, warning =F, fig.height = 8.5, fig.width = 7, fig.cap = "Correlations between 19 Z-scored predictors (2 spawner observation records and 17 hydrologic metrics, prescreened for collinearity) and 7 log-transformed ecological monitoring records for Chinook (left three columns) and coho (right four columns). Large blue circles indicate that the quantity (such as the first wet season median baseflow, or w1_Wet_BFL_Mag_50) is positively correlated with observed fish metrics. For dates, a blue dot indicates that a later date is correlated with higher fish values, while a red dot indicates that an earlier date is correlated with higher fish values. The full suite of calculated R values is shown in Supplemental Figure A.\\label{fig:corrMatrixFig}"}
  
# find prediction subset for figure.
# inclusion_threshold = 0.45
# greater_than_thresh_finder = apply(X= corr_matrix_pearson, MARGIN = 1,
#                                 function(x){sum(abs(x) >= inclusion_threshold,
#                                                 na.rm=T) > 0})
# pred_subset = row.names(corr_matrix_pearson)[greater_than_thresh_finder]
pred_subset = row.names(corr_matrix_pearson) # include all screened metrics

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  
  corr_matrix_fig_2(corr_matrix = corr_matrix_pearson,
                    pred_subset = pred_subset,
                    preds_in_order = c(spawner_z_records, preds_all))
}

dev.off()

if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1

#After the correlation figure, remove spawners from LASSO exercise if not using as a predictor
if(predict_eco != "juveniles abundance, hydro and spawners"){
  metrics_tab_screened[,spawner_z_records] = NULL
  metrics_tab_screened_chinook[,spawner_z_records] = NULL
}


```


## Predictive modeling

To assess robustness of the results, six different statistical model structures, using two statistical techniques, were tested for predicting each species (Table \@ref(tab:findingsTab)) (see Supplement for additional details). 

### Roadmap for highlighted and full model results

Two example LASSO model structures are illustrated in Figure \@ref(fig:LASSOResultsCohoChinook), with the full set shown in the Supplement (Figures \@ref(fig:jpsLassoCohoChinook) throuh \@ref(fig:juvAbunLassoCohoChinook) and Tables \@ref(tab:jpsCoefTableCoho) through \@ref(tab:juvAbunCoefTableChinook)). Additionally, a time series of predicted and observed values of the example LASSO models shown in Figure \@ref(fig:hbfOverTime). In LASSO results, a $\lambda$ value was selected through k-fold cross-validation, or an alternate $\lambda$ value was used that preserved a low test error but explained a higher deviance (e.g., Figure \@ref(fig:LASSOResultsCohoChinook), panels A and B). For each of the six LASSO models the $\lambda$ value was used to calculate the percent of null deviance explained (e.g., Figure \@ref(fig:LASSOResultsCohoChinook), panels C and D) and linear coefficient values for the prediction equation (e.g., Figure \@ref(fig:LASSOResultsCohoChinook), panels E and F; Tables \@ref(tab:coefTableCoho) and \@ref(tab:coefTableChinook)). 

In MARSS results, shown in the Supplment, individual models were calculated for each individual hydrologic predictor, and compared using AICc values (Tables \@ref(tab:MARSSSingleCovarTableCoho) through \@ref(tab:MARSSFlowAndSpawnCovarTableChinook)). The three models with the lowest AICc values for each model structure are shown as time series of predicted and observed values (Figures \@ref(fig:MARSSSingleCovars) through \@ref(fig:MARSSHydroPlusSpawn)).

### Comparison of statistical model structures and results

We used side-by-side comparison (Table \@ref(tab:findingsTab)) and four framing questions to evaluate the combined results of all statistical model structures. In the text below, "important" serves as shorthand to refer to predictors selected in low-error LASSO regression, or metrics with higher absolute coefficient values, or metrics producing a lower value of the small-sample-size-corrected Akaike Information Criterion (AICc) in MARSS methods.

```{r findingsTab, echo = F, warning =F, results = 'asis'}


findingsTab = read.csv(file.path(data_dir, "stats method findings tab.csv"))


caption_text = "Description of six different techniques for modeling two types of ecological outcomes (column 1) based on hydrologic metrics and, in some cases, spawner abundance (column 2). The type of flow associated with higher values of ecological outcome (i.e., the sign of the coefficient) is described in columns 4 and 5, Most Important Hydrologic Metrics (i.e., earlier first fall reconnection). Full tables of coefficient values and results figures are located in the Supplement."

ft_ft = flextable(data=findingsTab)
ft_ft = set_caption(ft_ft, caption = caption_text)
ft_ft = flextable::width(ft_ft,j=1,  width = 0.7)
ft_ft = flextable::width(ft_ft,j=2,  width = 0.6)
ft_ft = flextable::width(ft_ft,j=3,  width = 0.7)
ft_ft = flextable::width(ft_ft,j=4,  width = 1.55)
ft_ft = flextable::width(ft_ft,j=5,  width = 1.55)
ft_ft = flextable::width(ft_ft,j=6,  width = 1)
ft_ft = flextable::width(ft_ft,j=7,  width = 1)
ft_ft = flextable::width(ft_ft,j=8,  width = 0.5)
ft_ft = flextable::width(ft_ft,j=9,  width = 0.5)

ft_ft <- hline(ft_ft, part = "all")#, border =  fp_border(color = "gray"))
# add complex header

ft_ft = flextable::set_header_labels(ft_ft,
                                           values = list(
                                             Predicts ="",
                                             Using = "",
                                             Method = "",
                                             MostImportantHydroCoho = "Coho",
                                             MostImportantHydroChinook = "Chinook",
                                             H2SRatioCo = "Coho", 
                                             H2SRatioCh= "Chinook",
                                             CohoMinAICc = "Co.", 
                                             ChinookMinAICc = "Ch."))

ft_ft = add_header_row(ft_ft, values = c("Predicts","Using","Method","Most Important Hydrologic Metrics","Hydrologic vs. Spawner Influence (Coef. Ratios)", "Min. AICc"), colwidths = c(1,1,1,2,2,2), top = T)
ft_ft
```


1.	Do MARSS and LASSO models identify the same hydrologic metrics as important?

The two statistical methods produced different sets of important metrics, though there is some clear overlap (Table \@ref(tab:findingsTab)). For juveniles-per-adult models, most important predictor for coho (`f1_recon_120`, or earlier full-system river reconnection during parents' spawning) is the same in both MARSS and LASSO models. For Chinook juveniles-per-adult the MARSS and LASSO results are more dissimilar, with only one overlapping predictor identified in the top three in both methods (`s1_SP_ROC_Max`, or slower maximum spring recession rate). 

In juvenile abundance models for coho, all four structures (LASSO and MARSS, with and without a spawner predictor/covariate) identified `f1_FA_Dif_num`, or a larger fall pulse during parents' spawning, as high-importance, and three out of four identified a *smaller* second fall pulse (`f2_FA_Dif_num`) as the second-most important. Similarly, for juvenile abundance models of Chinook, all four structures identified `w1_Wet_BFL_Mag_50` (lower wet season baseflows), and three of four identified `s1_SP_ROC_Max` (slower maximum spring recession rate), as the first or second-most important metric.

2.	Between the two different prediction units (i.e., juvenile abundance and juveniles-per-spawner), are the same hydrologic metrics identified as important?

Hydrologic metrics were more consistent for Chinook than for coho. For Chinook, lower wet season baseflow (`w1_Wet_BFL_Mag_50`) was the most important (or a close second) in five out of six model structures, but was third in the MARSS model of juveniles-per-spawner. For coho, first fall metrics were highlighted as important for both prediction units, but the timing was more important in predicting juveniles-per-spawner outcomes (earlier first fall river reconnection or `f1_recon_120`), while the magnitude was more important in predicting juvenile abundance (`f1_FA_Dif_num`).

3.	For models of juvenile abundance, what is the relative importance (based on coefficients and AICc values) of spawners versus hydrology?

Across all model structures, the influence of hydrology ranged from approximately equivalent to the influence of spawners to more than eight times as important (based on coefficient ratios; Table \@ref(tab:findingsTab)). The addition of spawners to the LASSO model of juvenile abundance made a significant difference in the predictors selected for Chinook but not for coho (Tables \@ref(tab:juvAbunHydOnlyCoefTableCoho) through \@ref(tab:juvAbunCoefTableChinook)). This is corroborated by the change in AICc values among MARSS models: adding spawners as a covariate produced a lower AICc (better model) for Chinook but a higher AICc (worse model) for coho (Table \@ref(tab:findingsTab); Tables \@ref(tab:MARSSJuvAbunSingleCovarTableCoho) through \@ref(tab:MARSSFlowAndSpawnCovarTableChinook)). 

4. Are the coefficient signs (positive or negative) for hydrologic metrics consistent across statistical model structures and life stages, or is the same flow related to both more and less juvenile production in different contexts?

Some flows are assigned the same coefficient sign: earlier fall reconnections, earlier wet season starts, and later spring recession starts are consistently associated with increased juvenile abundance (absolute and relative to spawners). However, both positive and negative coefficients were calculated for some hydrologic metrics: variations in wet season median flows (larger or smaller), fall pulse differences (larger or smaller), and spring recession rates of change (slower or faster) are associated with higher ecological outcomes for different model structures and life stages. This suggests flow variation from year to year may support different life stage needs in Chinook and coho.


```{r kfold_lambda_finding, echo = FALSE, warning = F}

# without spawners
if(predict_eco %in% c("final eco prediction selection")){
  y_val_coho = "coho_smolt_per_fem"; y_val_chinook = "chinook_juvenile_abundance"
  # calculate LASSO regression model and cross-validation objects
  # (LASSO: alpha = 1; ridge: alpha = 0)
  mod_obj_co = kfold_cv(mt = metrics_tab_screened, y_val = y_val_coho, alpha = 1)
  mod_co = mod_obj_co$mod; cv_co = mod_obj_co$cv
  mod_obj_ch = kfold_cv(mt = metrics_tab_screened_chinook, alpha = 1,
                        y_val = y_val_chinook)
  mod_ch = mod_obj_ch$mod; cv_ch = mod_obj_ch$cv
  # extract coefficients from the model using alt. lambda value
  alt_lambda_co = 0.15
  coefs_co = get_pred_coefs(mod = mod_co, cv = cv_co, coef_digits = 3
                            , alt_lambda = alt_lambda_co
                            )
  coefs_ch = get_pred_coefs(mod = mod_ch, cv = cv_ch, coef_digits = 3)
}


```


```{r LASSOResultsCohoChinook, echo = F, warning = F, fig.height = 8, fig.cap = "Results of two example LASSO regressions to predict log-transformed coho and Chinook outcomes with Z-scored hydrologic metrics. Models with more coefficients explain a greater fraction of deviance in the dataset (middle panel), but also produce higher test errors (top panel), indicating some overfitting at lower lambda values. Higher values of lambda tend to shrink the absolute values of regression coefficients toward 0 (bottom panel).\\label{fig:LASSOResultsChinook}"}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  
  # if(predict_eco %in% c("juvenile abundance, hydro and spawners")){
  #   lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, mod_ch = mod_ch)
  # 
  # }
  # if(predict_eco %in% c("juveniles per spawner", "juvenile abundance, hydro only")){
  # lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, 
  #               mod_ch = mod_ch, alt_lambda_co = alt_lambda_co)
  # }
  if(predict_eco %in% c("final eco prediction selection")){
    lasso_results(cv_co = cv_co, cv_ch = cv_ch, mod_co = mod_co, 
                  mod_ch = mod_ch
                  , alt_lambda_co = alt_lambda_co
    )
  }
  
  dev.off()
  # save predictor appearance tab
  pred_tab_filename = "Supplemental Table C. Coho Salmon LASSO Coefficients.csv"
  write.csv(x=coefs_co$coef_all, file=file.path(graphics_dir,pred_tab_filename),
            quote=F, row.names = F)
  pred_tab_filename = "Supplemental Table D. Chinook Salmon LASSO Coefficients.csv"
  write.csv(x=coefs_ch$coef_all, file=file.path(graphics_dir,pred_tab_filename),
            quote=F, row.names = F)
}

if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1




```


```{r coefTableCoho, echo = F, warning =F, results = 'asis'}

# Retrieve coefficients from LASSO model

coefs_interp_names = names(coefs_co$coef_non0_only)
coefs_interp = as.character(coefs_co$coef_non0_only)
names(coefs_interp) = coefs_interp_names

if(predict_eco == "final eco prediction selection"){
  # coefs_interp$d1_DS_Dur_WS = "Shorter dry season (preceding parents' spawning)"
  coefs_interp$f1_recon_120 = "Earlier fall reconnection (during parents' spawning)"
  coefs_interp$f2_FA_Dif_num = "Smaller fall pulse (as juvenile fish)"
  # coefs_interp$s2_SP_ROC = "Faster rate of change, spring recession (as outmigrating smolts)"
  # coefs_interp$s1_SP_ROC = "Slower rate of change, spring recession (as recent hatchlings)"
  if("w1_Wet_Tim" %in% coefs_interp){
    coefs_interp$w1_Wet_Tim = "Earlier wet season onset (during parents' spawning or as eggs)"
  }

}

coefs_co_vals = c(round(coefs_co$int_and_coefs$coef, 3))
coefs_co_interp = c("(Intercept)", unlist(coefs_interp[coefs_co!="0"]))
coefs_co_ft = data.frame(Predictor = c(names(coefs_co_interp)),
                         Value = as.vector(coefs_co_vals),
                         Description = coefs_co_interp)

caption_text = paste0("Values for the intercept and coefficient terms in the predictive function for ",
                      yvlt$y_val_title[yvlt$y_val==y_val_coho],
                      " abundance, including a description of which phenomena are associated with higher ecological outcome values.")


coco_tab_ft = flextable(data=coefs_co_ft)
coco_tab_ft = set_caption(coco_tab_ft, caption = caption_text)
coco_tab_ft = flextable::width(coco_tab_ft,j=1,  width = 1.5)
coco_tab_ft = flextable::width(coco_tab_ft,j=2,  width = 1)
coco_tab_ft = flextable::width(coco_tab_ft,j=3,  width = 3)
coco_tab_ft = flextable::set_header_labels(coco_tab_ft,
                                           values = list(
                                             Predictor ="Predictor", 
                                             Value = "Value",
                                             Description = "Greater predicted ecological outcome associated with"))
coco_tab_ft


```



```{r coefTableChinook, echo = F, warning =F, results = 'asis'}

# Retrieve coefficients from LASSO model
coefs_interp_names = names(coefs_ch$coef_non0_only)
coefs_ch_interp = as.character(coefs_ch$coef_non0_only)
names(coefs_ch_interp) = coefs_interp_names

# add interpretation to each coefficient
if(y_val_chinook == "chinook_juv_per_adult"){
  coefs_ch_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
  coefs_ch_interp$s1_SP_ROC_Max = "Slower max. spring recession rate (as outmigrating smolt)"
}
if(predict_eco == "juvenile abundance, hydro and spawners"){
  coefs_ch_interp$chinook_spawners_zscored = "Greater number of spawners (cohort's parents)"
  coefs_ch_interp$w1_Wet_BFL_Dur = "Longer wet season (as eggs and fry)"
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
  # coefs_ch_interp$w2_Wet_BFL_Dur = "Longer wet season (wet season 2, they're not here)"
    coefs_ch_interp$s1_SP_ROC_Max = "Slower max. spring recession rate (as outmigrating smolt)"

}

if(predict_eco == "juvenile abundance, hydro only"){
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
}

if(predict_eco == "final eco prediction selection"){
  coefs_ch_interp$w1_Wet_BFL_Mag_50 = "Lower wet season baseflows (first wet season, as eggs and fry)"
}


coefs_ch_vals = coefs_ch$int_and_coefs$coef
coefs_ch_interp = c("Intercept", unlist(coefs_ch_interp[coefs_ch!="0"]))
coefs_ch_ft = data.frame(Predictor = c(names(coefs_ch_interp)),
                         Value = as.vector(round(coefs_ch_vals,3)),
                         Description = coefs_ch_interp)


caption_text = paste0("Values for the intercept and coefficient terms in the predictive function for ",
                      yvlt$y_val_title[yvlt$y_val==y_val_chinook],
                      " abundance, including a description of which phenomena are associated with higher ecological outcome values.")

coch_tab_ft = flextable(data=coefs_ch_ft)
coch_tab_ft = set_caption(coch_tab_ft, caption = caption_text)
coch_tab_ft = flextable::width(coch_tab_ft,j=1,  width = 1.8)
coch_tab_ft = flextable::width(coch_tab_ft,j=2,  width = 1)
coch_tab_ft = flextable::width(coch_tab_ft,j=3,  width = 3)
coch_tab_ft = flextable::set_header_labels(
  coch_tab_ft,
  values = list(
    Predictor ="Predictor", 
    Value = "Value",
    Description = "Greater predicted ecological outcome value associated with"))
coch_tab_ft
```


```{r calc_hbf_values_tabs, echo = F, warning =F}

if(predict_eco %in% c("juveniles per spawner", "juvenile abundance, hydro only",
                      "final eco prediction selection")){
# retrieve hydrology for all years of FJ flow
  brood_year_hydro_tab_long = tabulate_hydro_by_affected_brood_year(
    brood_years = 1942:2022, smolt_years = 1944:2024)

  metrics_tab_long = calc_metrics_hydro_by_affected_brood_year(
    hydro_by_brood_year = brood_year_hydro_tab_long,
    thresholds = thresh_for_corr_fig,
    reduce_to_eco_data_years_only = F)

  metrics_tab_long = metrics_tab_long[,intersect(colnames(metrics_tab_screened),
                                                 colnames(metrics_tab_long))]
  if(log_transform_eco_metrics == T){
    metrics_tab_long[,yvlt$y_val] = log10(metrics_tab_long[,yvlt$y_val])
  }

  if(zscore_flow_metrics == T){
    zscore_these = !(colnames(metrics_tab_long) %in% non_preds)
    metrics_tab_long[,zscore_these] = apply(X = metrics_tab_long[,zscore_these],
                                            MARGIN = 2, FUN = zscore_column_na_rm)
  }

  mt_co_hbf = metrics_tab_long; mt_ch_hbf = metrics_tab_long
} else { #if spawners needed as a predictor, restrict time series plot to years
  # with spawners and obs data
  # metrics_tab_long = metrics_tab_screened
  co_vals_i = which(!is.na(metrics_tab$coho_spawner_abundance) &
                      !is.na(metrics_tab$coho_smolt_abun_est))
  co_i = min(co_vals_i):max(co_vals_i)
  mt_co_hbf = metrics_tab_screened[co_i,]

  ch_vals_i = which(!is.na(metrics_tab$chinook_spawner_abundance))
  ch_i = min(ch_vals_i):max(ch_vals_i)
  mt_ch_hbf = metrics_tab_screened[ch_i,]
}

# calculate hbf for all years in which there are hydrodata
hbf_coho = get_hbf_tab(mt = mt_co_hbf,
                       coefs = coefs_co$coef_non0_only,
                       int = coefs_co$intercept)
hbf_chinook = get_hbf_tab(mt = mt_ch_hbf,
                          coefs = coefs_ch$coef_non0_only,
                          int = coefs_ch$intercept)

# calculate lowest hbf value
lowest_coho_spf_pred=10^min(hbf_coho$hbf_total)

```



```{r hbfOverTime, echo = F, warning = F, fig.height = 8, fig.cap = "Annual observed and predicted values of coho smolt produced per female spawner (coho spf, top panel) and abundance of outmigrating Chinook juveniles (lower panel). Predicted quantities (black dots) are shown as log10(ecological observation); this is transformed back to straight numerical values of the observation on the right side axis. The predicted and observed values are plotted by each cohort's brood year. \\label{fig:hbfOverTime}"}

# Negative prediction values (considered physically impossible) are flagged but are retained to visually demonstrate the uncertainty in the exercise of predicting fish outcomes from hydrologic metrics alone, based on a small sample size.


if(predict_eco == "juvenile abundance, hydro and spawners"){ # if needs spawner as a predictor
  keep_yrs = metrics_tab_screened$brood_year[!is.na(metrics_tab_screened$coho_spawner_abundance) |
                                               !is.na(metrics_tab_screened$chinook_spawner_abundance)]
  plot_yrs = min(keep_yrs):max(keep_yrs)
} else {plot_yrs = NA}

fig_path = file.path(save_figs_here, paste0("Figure ",fig_i,".png"))
if(save_imgs == TRUE){
  png(filename = fig_path, width = 7, height = 8, units = "in", res = res_dpi)
  par(mfrow=c(2,1))
  # Panel 1. Coho
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_coho]
  hbf_over_time_fig(mt = metrics_tab_screened,
                    hbf_tab = hbf_coho,
                    y_val = y_val_coho,
                    y_val_axis = y_axis_label,
                    plot_yrs = plot_yrs)

  # Panel 2. Chinook
  hbf_chinook$hbf_total[!is.finite(hbf_chinook$hbf_total)]=NA
  y_axis_label =  yvlt$y_val_label[yvlt$y_val==y_val_chinook]
  hbf_over_time_fig(mt = metrics_tab_screened,
                    hbf_tab = hbf_chinook,
                    y_val = y_val_chinook,
                    y_val_axis = y_axis_label,
                    plot_yrs = plot_yrs,
                    show_legend = F)




  dev.off()
}
if(include_figs==T){knitr::include_graphics(fig_path)}
fig_i = fig_i +1


```


# Discussion

## Correlations and predictor selection results suggest potential mechanisms for flow-ecology relationships

As one would expect, the Chinook spawner record is correlated with outmigrating Chinook smolts, and coho spawners are correlated with redds and outmigrating coho smolts. Interestingly, Chinook spawners are not correlated with any coho records, and the reverse is also true: all cross-species spawner-ecological $|R|$ values are less than 0.3 (Figure \@ref(fig:corrMatrixFig)).

Correlation coefficients and results from both LASSO and MARSS models suggest that coho smolt production, both in absolute abundance terms and relative to spawners, is sensitive to conditions during the end of the dry season and the fall river reconnection, especially during  their parents' spawning (Figure \@ref(fig:corrMatrixFig); Table \@ref(tab:findingsTab)). Earlier fall reconnection or a larger fall flow differences could allow spawners more time or greater physical access to reach preferred tributary habitat or higher-quality local nesting sites. Notably, coho smolt abundance with the fall flow difference is positively correlated when it occurs during the first fall when a cohort's parents are spawning, but is negatively correlated  when it occurs in the second fall, when coho are oversummering juveniles (Figure \@ref(fig:corrMatrixFig)). This matches findings that fall pulse flows can have a positive or negative effect on salmonids depending on life stage or timing [@NislowArmstrongLifehistorybased2012].

LASSO model results also suggest than Chinook juvenile abundance seems to be sensitive to, and negatively affected by, high median wet season baseflow magnitude; this corroborates findings that being swept downstream by high average winter flowrates has a significant influence on survival of recently-hatched juveniles [@NislowArmstrongLifehistorybased2012]. Chinook, which preferentially lay eggs in the mainstem river, would be more vulnerable to these high flowrates than coho, which prefer tributary habitats. MARSS models of Chinook abundance agree in identifying a negative correlation with wet season baseflow, but also highlight a relationship with spring flow conditions: a steeper maximum recession rate of recession is negatively related to juvenile abundance. A more abrupt spring flow recession could mean smolts are outmigrating through slower flow velocities, which could increase transit time and vulnerability to predation [@McCormickEtAlMovement1998].

Lastly, due to the small available sample size, we caveat these results by noting that the hydrologic metrics identified as important may shift if this analysis is recapitulated in the future with additional years of data. Additionally, the results are sensitive to decisions made during the prescreening step, which is why we carefully considered which metrics are most conceptually central in representing the collinear predictor groups (Table \@ref(tab:predCorrScreeningTable)). 

## Biotic and abiotic influence on coho and Chinook outcomes

Based on coefficient ratios, all model structures comparing spawner and hydrologic influence suggested that hydrologic influence was equivalent or greater than spawner influence (Table \@ref(tab:findingsTab)). This is corroborated by the fact that both spawner abundance and a variety of hydrologic metrics are correlated with absolute and relative smolt production (Figure \@ref(fig:corrMatrixFig)). We intended to identify in which species juvenile production was more limited by, or sensitive to, the hydrology versus the number of parental spawners, but the picture is murky.

LASSO models explain a greater percent of deviance in Chinook data than in corresponding coho models, suggesting that Chinook are more limited by flow (Figures \@ref(fig:jpsLassoCohoChinook) through \@ref(fig:juvAbunLassoCohoChinook)). However, Chinook juvenile production also seems more sensitive to spawner abundance in that, when spawners were added to the LASSO model of Chinook juvenile abundance, it increased the number of selected predictors from one to four, including spawner abundance (Tables \@ref(tab:juvAbunHydOnlyCoefTableCoho) and \@ref(tab:juvAbunCoefTableCoho)); conversely, when spawners were added to the model of coho juvenile abundance, it retained the first two predictors and only influenced the selection of the third (Tables \@ref(tab:juvAbunHydOnlyCoefTableChinook) and \@ref(tab:juvAbunCoefTableChinook)). On the other hand, coho salmon seem more sensitive to the introduction of a spawner factor in MARSS models, as adding spawners as a covariate produced a lower AICc (better model) for coho but a higher AICc (worse model) for Chinook (Table \@ref(tab:findingsTab)). In any case, neither spawner abundance nor hydrology seems completely dominant in explaining smolt production for either species.

Using flow alone to predict fish outcomes involves non-negligible uncertainties: in the example time series shown, error terms (predicted minus observed values) are substantial (Figure \@ref(fig:hbfOverTime)). This is partly a consequence of LASSO regression imposing a penalty on model flexibility, and represents a conservative estimate of the degree of variation in ecological outcomes that can be explained with flow metrics, although MARSS results in most cases produced similarly large error terms (Figures \@ref(fig:MARSSSingleCovars) through \@ref(fig:MARSSHydroPlusSpawn)). Though this exercise includes only hydrology and the number of spawners as predictors, many additional biotic and abiotic factors influence juvenile salmonid growth and survival, such as water quality, temperature, habitat structure, or food resources [e.g., @McMahonHabitat1983; @WillisEtAlInstream2016; @LusardiEtAlOversummer2020]. Interactions between hydrology, these other factors, and juvenile production could be investigated in future work.

## Implications for Scott River water and fisheries management

Critical management questions in Scott Valley include, at what flow can salmonids pass key chokepoints (in the vicinity of the Fort Jones gauge; Figure \@ref(fig:ScottWatershedMap)) and/or access their preferred tributary habitat? And at what flow do Scott River salmon become more productive? We do not provide short or confident answers to these questions in this study, but can elaborate on them.

Interestingly, for both species, the number of spawners is not highly correlated with freshwater hydrologic metrics in the dry season preceding, or the fall season during, their spawning window; i.e., the $|R|$ values between coho and Chinook spawners for any hydrologic metric did not exceed 0.25 (Figure \@ref(fig:corrMatrixFig)). This means predicting spawner passage based on dry season flows or end-of-dry-season timing would be a prohibitively uncertain exercise. Questions about what flow metric(s) is (are) sufficient for spawning passage may be more suited to weekly or daily scale observations of flow and migrating spawners, as recorded in observation reports [e.g., @KnechtleGiudice20222023], and are beyond the scope of this study of seasonal metrics.

Minimum flow regimes are a valuable management tool, but in this analysis we find more evidence for a gradient of benefit provided by flow, rather than any clear empirical threshold. Although flow tends to provide ecological services to fish in a nonlinear fashion [@RosenfeldDeveloping2017], simple linear representations often perform as well or better than nonlinear ones [@WardEtAlLeveraging2024], and in scatterplots of (untransformed) hydrology versus ecological observations, we did not see clear evidence of threshold behavior. Consequently, this empirical analysis does not quantify flow metric thresholds that would sustain the Scott River salmonid fisheries, but it does highlight metrics or seasons that are especially correlated with observed fish outcomes.

## Implications for general water and fisheries management

This study contributes a novel approach and insights to the large body of work seeking to understand and conserve aquatic ecosystems in the Klamath basin, and in aquatic ecosystems in Mediterranean climates more generally. We expect that the proposed approach could be employed in other regional studies [e.g., @BaruchEtAlMimicking2024], though in systems with shorter or minimal ecological monitoring records, opportunities to find correlations between flow and biological metrics may be sample size-limited to an even greater degree than in this study. However, this study may show the value of even a dozen years of monitoring data in a range of water year types, and could provide motivation to continue investing in data collection and the monitoring of sensitive species. 

# Conclusions

This case study uses calculated functional flows and long-term biological monitoring to relate hydrologic conditions to watershed-scale anadromous fish reproduction rates. The empirical flow-biology relationships evaluated here also suggest hypotheses regarding the watershed- and species-specific mechanisms of ecological response to flow variability.

To learn if it was possible to empirically identify important features of the hydrograph corresponding to ecological needs of Scott River coho and Chinook salmon, we examined correlation coefficients between seventeen hydrologic metrics and seven types of local salmon observations (Figure \@ref(fig:corrMatrixFig)). We then formulated multiple predictions of an ecological response to flow, by comparing six different statistical model structures for each species.   

This empirical analysis does not quantify flow metric thresholds that would sustain the Scott River salmonid fisheries, but it does highlight metrics or seasons that are especially correlated with observed fish outcomes. The flows identified as most important in predicting relative coho reproduction occur during the dry-to-wet-season transition: earlier and higher-magnitude fall flows during a cohort's parents' spawning are associated with higher reproductive outcomes, as well as greater wet season baseflow. Fall flow magnitude and spring flow recession rates are associated with positive and negative effects for coho, depending on the life stage in which they occur. In contrast, higher Chinook production is predicted by lower winter baseflows, as well as slower spring recession rates during their outmigration. 

With continuing trends of a narrowing wet season in the Scott River watershed (e.g., Figure \@ref(fig:reAndDisconTimeseries)), entities aiming to sustain local fisheries may find themselves working with ever-thinner margins for error. Globally, in communities living and working with local natural resources, climate change may transform biodiversity-preservation activities into long-term engineering of novel ecosystems. If this occurs, long-term monitoring and frequently re-evaluated flow-ecology relationships will be necessary to support such efforts.

\newpage


# References

<div id="refs"></div>

\newpage

```{r call_supplement, child=if (INCLUDE_SUPP) 'Kouba_2024_Fish_hydrometrics_Supplement.Rmd'}
```

